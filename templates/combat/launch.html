{% extends "base.html" %}
{% block title %}Lancer un Combat RPG{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-sm border-0" style="background: #1a1a2e; color: #e2e8f0;">
                <div class="card-header text-center" style="background: #16213e; border-bottom: 2px solid #ef4444;">
                    <h3 class="mb-0">
                        <i class="fas fa-swords me-2"></i>‚öîÔ∏è Lancer un Combat RPG
                    </h3>
                    <p class="text-muted mt-1 mb-0">Les √©l√®ves combattent des monstres en r√©pondant √† des questions</p>
                </div>
                <div class="card-body p-4">
                    <!-- S√©lection de la classe -->
                    <div class="mb-4">
                        <label class="form-label fw-bold" style="color: #94a3b8;">
                            üè´ Classe
                        </label>
                        <select id="classroomSelect" class="form-select"
                                style="background: #16213e; color: #e2e8f0; border-color: #334155;">
                            <option value="">‚Äî Choisir une classe ‚Äî</option>
                            {% for classroom in classrooms %}
                            <option value="{{ classroom.id }}">{{ classroom.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- S√©lection de l'exercice -->
                    <div class="mb-4">
                        <label class="form-label fw-bold" style="color: #94a3b8;">
                            üìù Exercice (questions pour le combat)
                        </label>
                        <select id="exerciseSelect" class="form-select"
                                style="background: #16213e; color: #e2e8f0; border-color: #334155;">
                            <option value="">‚Äî Choisir un exercice ‚Äî</option>
                            {% for exercise in exercises %}
                            <option value="{{ exercise.id }}">{{ exercise.title }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Difficult√© -->
                    <div class="mb-4">
                        <label class="form-label fw-bold" style="color: #94a3b8;">
                            ‚ö° Difficult√©
                        </label>
                        <div class="row g-2">
                            <div class="col-3">
                                <input type="radio" class="btn-check" name="difficulty" id="diff-easy" value="easy">
                                <label class="btn btn-outline-success w-100" for="diff-easy">
                                    üü¢ Facile<br><small>3 Slimes</small>
                                </label>
                            </div>
                            <div class="col-3">
                                <input type="radio" class="btn-check" name="difficulty" id="diff-medium" value="medium" checked>
                                <label class="btn btn-outline-warning w-100" for="diff-medium">
                                    üü° Moyen<br><small>Gobelins + Slimes</small>
                                </label>
                            </div>
                            <div class="col-3">
                                <input type="radio" class="btn-check" name="difficulty" id="diff-hard" value="hard">
                                <label class="btn btn-outline-danger w-100" for="diff-hard">
                                    üî¥ Difficile<br><small>Orcs + Squelettes</small>
                                </label>
                            </div>
                            <div class="col-3">
                                <input type="radio" class="btn-check" name="difficulty" id="diff-boss" value="boss">
                                <label class="btn btn-outline-primary w-100" for="diff-boss">
                                    üêâ Boss<br><small>Dragon + Gobelins</small>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Bouton de lancement -->
                    <div class="text-center mt-4">
                        <button id="launchBtn" class="btn btn-lg px-5 py-3"
                                style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white; border: none; border-radius: 12px; font-size: 1.2rem;"
                                onclick="launchCombat()">
                            ‚öîÔ∏è Lancer le Combat !
                        </button>
                    </div>

                    <div id="errorMsg" class="alert alert-danger mt-3 d-none"></div>
                    <div id="successMsg" class="alert alert-success mt-3 d-none"></div>
                </div>
            </div>

            <!-- Combats actifs -->
            {% if active_sessions %}
            <div class="card shadow-sm border-0 mt-4" style="background: #1a1a2e; color: #e2e8f0;">
                <div class="card-header" style="background: #16213e;">
                    <h5 class="mb-0">üéÆ Combats en cours</h5>
                </div>
                <div class="card-body">
                    {% for s in active_sessions %}
                    <div class="d-flex justify-content-between align-items-center p-3 mb-2 rounded"
                         style="background: #16213e;">
                        <div>
                            <strong>Combat #{{ s.id }}</strong> ‚Äî Round {{ s.current_round }}
                            <br>
                            <small class="text-muted">{{ s.participants.count() }} √©l√®ves ‚Äî {{ s.difficulty }}</small>
                        </div>
                        <a href="{{ url_for('combat.arena', session_id=s.id) }}"
                           class="btn btn-outline-light btn-sm" target="_blank">
                            üì∫ Ouvrir l'ar√®ne
                        </a>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function launchCombat() {
    const classroomId = document.getElementById('classroomSelect').value;
    const exerciseId = document.getElementById('exerciseSelect').value;
    const difficulty = document.querySelector('input[name="difficulty"]:checked')?.value || 'medium';

    if (!classroomId || !exerciseId) {
        showError('Veuillez s√©lectionner une classe et un exercice.');
        return;
    }

    const btn = document.getElementById('launchBtn');
    btn.disabled = true;
    btn.innerHTML = '‚è≥ Cr√©ation...';

    fetch('/combat/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}' },
        body: JSON.stringify({
            classroom_id: parseInt(classroomId),
            exercise_id: parseInt(exerciseId),
            difficulty: difficulty,
        }),
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showSuccess(`Combat cr√©√© ! Redirection vers l'ar√®ne...`);
            setTimeout(() => {
                window.open(`/combat/${data.session.id}/arena`, '_blank');
                btn.disabled = false;
                btn.innerHTML = '‚öîÔ∏è Lancer le Combat !';
            }, 1000);
        } else {
            showError(data.error || 'Erreur lors de la cr√©ation');
            btn.disabled = false;
            btn.innerHTML = '‚öîÔ∏è Lancer le Combat !';
        }
    })
    .catch(err => {
        showError('Erreur r√©seau: ' + err.message);
        btn.disabled = false;
        btn.innerHTML = '‚öîÔ∏è Lancer le Combat !';
    });
}

function showError(msg) {
    const el = document.getElementById('errorMsg');
    el.textContent = msg;
    el.classList.remove('d-none');
    document.getElementById('successMsg').classList.add('d-none');
}

function showSuccess(msg) {
    const el = document.getElementById('successMsg');
    el.textContent = msg;
    el.classList.remove('d-none');
    document.getElementById('errorMsg').classList.add('d-none');
}
</script>
{% endblock %}
