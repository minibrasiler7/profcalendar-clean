{% extends "base.html" %}

{% block title %}Gestion des bons - Admin{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pricing.css') }}">
{% endblock %}

{% block content %}
<div class="admin-page">
    <div class="admin-header">
        <h1><i class="fas fa-shield-alt"></i> Administration</h1>
        <div class="admin-nav">
            <a href="{{ url_for('admin.dashboard') }}" class="admin-tab">Tableau de bord</a>
            <a href="{{ url_for('admin.vouchers') }}" class="admin-tab active">Bons</a>
            <a href="{{ url_for('admin.subscribers') }}" class="admin-tab">Utilisateurs</a>
        </div>
    </div>

    <div class="admin-section">
        <div class="section-header-row">
            <h2><i class="fas fa-ticket-alt"></i> Gestion des bons</h2>
            <button class="btn-create" onclick="toggleCreateForm()">
                <i class="fas fa-plus"></i> Nouveau bon
            </button>
        </div>

        <!-- Formulaire de création -->
        <div id="createForm" class="create-form" style="display: none;">
            <h3>Créer un nouveau bon</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label>Code (vide = auto-généré)</label>
                    <input type="text" id="vCode" placeholder="Ex: PROMO2026" maxlength="50" style="text-transform: uppercase;">
                </div>
                <div class="form-group">
                    <label>Type</label>
                    <select id="vType" onchange="updateTypeFields()">
                        <option value="free_days">Durée limitée (jours)</option>
                        <option value="unlimited">Illimité</option>
                    </select>
                </div>
                <div class="form-group" id="daysGroup">
                    <label>Durée (jours)</label>
                    <input type="number" id="vDays" min="1" max="3650" value="365">
                </div>
                <div class="form-group">
                    <label>Nombre max d'utilisations (vide = illimité)</label>
                    <input type="number" id="vMaxUses" min="1" placeholder="Illimité">
                </div>
                <div class="form-group">
                    <label>Date d'expiration du bon (optionnel)</label>
                    <input type="datetime-local" id="vExpires">
                </div>
            </div>
            <div class="form-actions">
                <button class="btn-create" onclick="createVoucher()">
                    <i class="fas fa-check"></i> Créer
                </button>
                <button class="btn-cancel" onclick="toggleCreateForm()">Annuler</button>
            </div>
        </div>

        <!-- Liste des bons -->
        <table class="admin-table">
            <thead>
                <tr>
                    <th>Code</th>
                    <th>Type</th>
                    <th>Durée</th>
                    <th>Utilisations</th>
                    <th>Statut</th>
                    <th>Créé le</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for voucher in vouchers %}
                <tr>
                    <td><code class="voucher-code">{{ voucher.code }}</code></td>
                    <td>{{ 'Jours limités' if voucher.voucher_type == 'free_days' else 'Illimité' }}</td>
                    <td>{{ (voucher.duration_days|string ~ ' jours') if voucher.duration_days else '∞' }}</td>
                    <td>{{ voucher.current_uses }}{% if voucher.max_uses %} / {{ voucher.max_uses }}{% else %} / ∞{% endif %}</td>
                    <td>
                        <span class="badge-{{ 'active' if voucher.is_active else 'canceled' }}" id="badge-{{ voucher.id }}">
                            {{ 'Actif' if voucher.is_active else 'Inactif' }}
                        </span>
                    </td>
                    <td>{{ voucher.created_at.strftime('%d/%m/%Y') }}</td>
                    <td>
                        <button class="btn-toggle" onclick="toggleVoucher({{ voucher.id }})" title="{{ 'Désactiver' if voucher.is_active else 'Activer' }}">
                            <i class="fas fa-{{ 'toggle-on' if voucher.is_active else 'toggle-off' }}" id="toggle-{{ voucher.id }}"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
                {% if not vouchers %}
                <tr>
                    <td colspan="7" style="text-align: center; color: #999; padding: 2rem;">
                        Aucun bon créé pour le moment
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function toggleCreateForm() {
    const form = document.getElementById('createForm');
    form.style.display = form.style.display === 'none' ? 'block' : 'none';
}

function updateTypeFields() {
    const type = document.getElementById('vType').value;
    document.getElementById('daysGroup').style.display = type === 'free_days' ? 'block' : 'none';
}

async function createVoucher() {
    const data = {
        code: document.getElementById('vCode').value || null,
        type: document.getElementById('vType').value,
        duration_days: document.getElementById('vType').value === 'free_days' ? parseInt(document.getElementById('vDays').value) : null,
        max_uses: document.getElementById('vMaxUses').value ? parseInt(document.getElementById('vMaxUses').value) : null,
        expires_at: document.getElementById('vExpires').value || null,
    };

    try {
        const response = await fetch('{{ url_for("admin.create_voucher") }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const result = await response.json();
        if (result.success) {
            alert('Bon créé : ' + result.code);
            location.reload();
        } else {
            alert('Erreur: ' + result.error);
        }
    } catch (error) {
        console.error('Erreur:', error);
        alert('Erreur de connexion');
    }
}

async function toggleVoucher(id) {
    try {
        const response = await fetch('/admin/vouchers/' + id + '/toggle', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        const result = await response.json();
        if (result.success) {
            location.reload();
        }
    } catch (error) {
        console.error('Erreur:', error);
    }
}
</script>
{% endblock %}
