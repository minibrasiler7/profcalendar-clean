{% extends "base.html" %}

{% block title %}Paramètres{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Paramètres</h2>
    
    <!-- Navigation des sections -->
    <div class="settings-nav mb-4">
        <a href="#account" class="settings-nav-link active" onclick="showSection('account', this)">
            <i class="fas fa-user-circle"></i>
            Compte
        </a>
        <a href="#accommodations" class="settings-nav-link" onclick="showSection('accommodations', this)">
            <i class="fas fa-universal-access"></i>
            Aménagements
        </a>
        <a href="#danger" class="settings-nav-link" onclick="showSection('danger', this)">
            <i class="fas fa-trash-alt"></i>
            Supprimer mon compte
        </a>
    </div>
    
    <!-- Section Compte -->
    <div id="account-section" class="settings-section">
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-envelope"></i> Informations du compte</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label text-muted">Nom d'utilisateur</label>
                    <p class="form-control-plaintext fw-bold">{{ current_user.username }}</p>
                </div>
                <div class="mb-3">
                    <label class="form-label text-muted">Adresse email</label>
                    <p class="form-control-plaintext fw-bold">{{ current_user.email }}</p>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-lock"></i> Changer le mot de passe</h5>
            </div>
            <div class="card-body">
                <form id="change-password-form">
                    <div class="mb-3">
                        <label for="current_password" class="form-label">Mot de passe actuel</label>
                        <input type="password" class="form-control" id="current_password" name="current_password" required>
                    </div>
                    <div class="mb-3">
                        <label for="new_password" class="form-label">Nouveau mot de passe</label>
                        <input type="password" class="form-control" id="new_password" name="new_password" required minlength="6">
                        <small class="text-muted">Minimum 6 caractères</small>
                    </div>
                    <div class="mb-3">
                        <label for="confirm_password" class="form-label">Confirmer le nouveau mot de passe</label>
                        <input type="password" class="form-control" id="confirm_password" name="confirm_password" required>
                    </div>
                    <div id="password-alert" style="display: none;"></div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Changer le mot de passe
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Section Aménagements -->
    <div id="accommodations-section" class="settings-section" style="display: none;">
        <div class="card">
            <div class="card-header">
                <h5>Affichage des aménagements</h5>
            </div>
            <div class="card-body">
                <p>Choisissez comment les aménagements des élèves doivent être affichés dans la vue des cours :</p>
                
                <div class="form-group">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="accommodations_display" id="accommodations_none" value="none" {% if preferences.show_accommodations == 'none' %}checked{% endif %}>
                        <label class="form-check-label" for="accommodations_none">
                            Ne pas afficher les aménagements
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="accommodations_display" id="accommodations_emoji" value="emoji" {% if preferences.show_accommodations == 'emoji' %}checked{% endif %}>
                        <label class="form-check-label" for="accommodations_emoji">
                            Afficher uniquement l'émoticône des aménagements
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="accommodations_display" id="accommodations_name" value="name" {% if preferences.show_accommodations == 'name' %}checked{% endif %}>
                        <label class="form-check-label" for="accommodations_name">
                            Afficher le nom complet des aménagements
                        </label>
                    </div>
                </div>
                
                <button type="button" class="btn btn-primary" onclick="saveAccommodationsSettings()">
                    Enregistrer les paramètres
                </button>
            </div>
        </div>
    </div>

    <!-- Section Zone de danger -->
    <div id="danger-section" class="settings-section" style="display: none;">
        <div class="card mb-4" style="border-color: #EF4444;">
            <div class="card-header" style="background: #FEF2F2; border-bottom-color: #EF4444;">
                <h5 style="color: #DC2626;"><i class="fas fa-exclamation-triangle"></i> Supprimer mon compte</h5>
            </div>
            <div class="card-body">
                <div id="delete-alert" class="alert mb-3" style="display: none;"></div>

                <div style="background: #FEF2F2; border: 1px solid #FECACA; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                    <p style="color: #991B1B; margin-bottom: 0.5rem; font-weight: 600;">
                        <i class="fas fa-warning"></i> Cette action est irréversible !
                    </p>
                    <p style="color: #991B1B; margin-bottom: 0;">
                        La suppression de votre compte entraînera la perte définitive de toutes vos données :
                        classes, élèves, évaluations, notes, remarques, sanctions, planifications, et fichiers.
                    </p>
                </div>

                <div style="background: #FFF7ED; border: 1px solid #FED7AA; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                    <p style="color: #9A3412; margin-bottom: 0;">
                        <i class="fas fa-info-circle"></i>
                        Si vous êtes maître de classe et que des enseignants spécialisés sont liés à vos classes,
                        un rapport PDF contenant les données des élèves (notes, remarques, sanctions) leur sera
                        automatiquement envoyé avant la suppression.
                    </p>
                </div>

                <div class="mb-3">
                    <label for="delete_password" class="form-label" style="color: #DC2626; font-weight: 600;">
                        Confirmez avec votre mot de passe :
                    </label>
                    <input type="password" class="form-control" id="delete_password"
                           placeholder="Entrez votre mot de passe" required
                           style="border-color: #FECACA;">
                </div>

                <button type="button" class="btn" onclick="deleteAccount()"
                        style="background: #DC2626; color: white; font-weight: 600; padding: 0.75rem 1.5rem;">
                    <i class="fas fa-trash"></i> Supprimer définitivement mon compte
                </button>
            </div>
        </div>
    </div>

</div>

<style>
.settings-nav {
    display: flex;
    gap: 1rem;
    border-bottom: 2px solid var(--border-color);
    margin-bottom: 2rem;
}

.settings-nav-link {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 1rem 1.5rem;
    text-decoration: none;
    color: var(--gray-color);
    border-bottom: 3px solid transparent;
    transition: all 0.3s ease;
}

.settings-nav-link:hover {
    color: var(--primary-color);
    text-decoration: none;
}

.settings-nav-link.active {
    color: var(--primary-color);
    border-bottom-color: var(--primary-color);
    font-weight: 600;
}

.settings-section {
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}
</style>

<script>
function showSection(sectionName, linkElement) {
    // Masquer toutes les sections
    document.querySelectorAll('.settings-section').forEach(section => {
        section.style.display = 'none';
    });
    
    // Retirer la classe active de tous les liens
    document.querySelectorAll('.settings-nav-link').forEach(link => {
        link.classList.remove('active');
    });
    
    // Afficher la section sélectionnée
    document.getElementById(sectionName + '-section').style.display = 'block';
    
    // Ajouter la classe active au lien cliqué
    linkElement.classList.add('active');
}

async function saveAccommodationsSettings() {
    const selectedValue = document.querySelector('input[name="accommodations_display"]:checked').value;
    
    try {
        const response = await fetch('/settings/update-accommodations-display', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                show_accommodations: selectedValue
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Afficher un message de succès
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show mt-3';
            alertDiv.innerHTML = `
                ${result.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('#accommodations-section .card-body').appendChild(alertDiv);
            
            // Supprimer l'alerte après 3 secondes
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 3000);
        } else {
            throw new Error(result.message);
        }
    } catch (error) {
        console.error('Erreur lors de la sauvegarde:', error);
        alert('Erreur lors de la sauvegarde des paramètres: ' + error.message);
    }
}

// Gestion du formulaire de changement de mot de passe
document.getElementById('change-password-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const currentPassword = document.getElementById('current_password').value;
    const newPassword = document.getElementById('new_password').value;
    const confirmPassword = document.getElementById('confirm_password').value;
    const alertDiv = document.getElementById('password-alert');

    // Réinitialiser l'alerte
    alertDiv.style.display = 'none';

    // Vérifier que les nouveaux mots de passe correspondent
    if (newPassword !== confirmPassword) {
        alertDiv.className = 'alert alert-danger mb-3';
        alertDiv.textContent = 'Les nouveaux mots de passe ne correspondent pas.';
        alertDiv.style.display = 'block';
        return;
    }

    // Vérifier la longueur minimale
    if (newPassword.length < 6) {
        alertDiv.className = 'alert alert-danger mb-3';
        alertDiv.textContent = 'Le nouveau mot de passe doit contenir au moins 6 caractères.';
        alertDiv.style.display = 'block';
        return;
    }

    try {
        const response = await fetch('/settings/change-password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                current_password: currentPassword,
                new_password: newPassword
            })
        });

        const result = await response.json();

        if (result.success) {
            alertDiv.className = 'alert alert-success mb-3';
            alertDiv.textContent = result.message;
            alertDiv.style.display = 'block';

            // Réinitialiser le formulaire
            document.getElementById('change-password-form').reset();

            // Masquer l'alerte après 5 secondes
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 5000);
        } else {
            alertDiv.className = 'alert alert-danger mb-3';
            alertDiv.textContent = result.message;
            alertDiv.style.display = 'block';
        }
    } catch (error) {
        console.error('Erreur lors du changement de mot de passe:', error);
        alertDiv.className = 'alert alert-danger mb-3';
        alertDiv.textContent = 'Une erreur est survenue. Veuillez réessayer.';
        alertDiv.style.display = 'block';
    }
});

async function deleteAccount() {
    const password = document.getElementById('delete_password').value;
    const alertDiv = document.getElementById('delete-alert');
    alertDiv.style.display = 'none';

    if (!password) {
        alertDiv.className = 'alert alert-danger mb-3';
        alertDiv.textContent = 'Veuillez entrer votre mot de passe.';
        alertDiv.style.display = 'block';
        return;
    }

    if (!confirm('Êtes-vous sûr de vouloir supprimer votre compte ? Cette action est IRRÉVERSIBLE.')) {
        return;
    }

    if (!confirm('DERNIÈRE CONFIRMATION : Toutes vos données seront définitivement supprimées. Continuer ?')) {
        return;
    }

    try {
        const btn = document.querySelector('[onclick="deleteAccount()"]');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Suppression en cours...';

        const response = await fetch('/settings/delete-account', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ password: password })
        });

        const result = await response.json();

        if (result.success) {
            window.location.href = result.redirect || '/auth/login';
        } else {
            alertDiv.className = 'alert alert-danger mb-3';
            alertDiv.textContent = result.message;
            alertDiv.style.display = 'block';
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-trash"></i> Supprimer définitivement mon compte';
        }
    } catch (error) {
        console.error('Erreur:', error);
        alertDiv.className = 'alert alert-danger mb-3';
        alertDiv.textContent = 'Une erreur est survenue. Veuillez réessayer.';
        alertDiv.style.display = 'block';
        const btn = document.querySelector('[onclick="deleteAccount()"]');
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-trash"></i> Supprimer définitivement mon compte';
    }
}
</script>
{% endblock %}