{% extends "base.html" %}

{% block title %}Paramètres{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Paramètres</h2>
    
    <!-- Navigation des sections -->
    <div class="settings-nav mb-4">
        <a href="#account" class="settings-nav-link active" onclick="showSection('account', this)">
            <i class="fas fa-user-circle"></i>
            Compte
        </a>
        <a href="#accommodations" class="settings-nav-link" onclick="showSection('accommodations', this)">
            <i class="fas fa-universal-access"></i>
            Aménagements
        </a>
        <a href="#security" class="settings-nav-link" onclick="showSection('security', this)">
            <i class="fas fa-shield-alt"></i>
            Sécurité
        </a>
        <a href="#subscription" class="settings-nav-link" onclick="showSection('subscription', this)">
            <i class="fas fa-crown"></i>
            Abonnement
        </a>
        <a href="#danger" class="settings-nav-link" onclick="showSection('danger', this)">
            <i class="fas fa-trash-alt"></i>
            Supprimer mon compte
        </a>
    </div>
    
    <!-- Section Compte -->
    <div id="account-section" class="settings-section">
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-envelope"></i> Informations du compte</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label text-muted">Nom d'utilisateur</label>
                    <p class="form-control-plaintext fw-bold">{{ current_user.username }}</p>
                </div>
                <div class="mb-3">
                    <label class="form-label text-muted">Adresse email</label>
                    <p class="form-control-plaintext fw-bold">{{ current_user.email }}</p>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-lock"></i> Changer le mot de passe</h5>
            </div>
            <div class="card-body">
                <form id="change-password-form">
                    <div class="mb-3">
                        <label for="current_password" class="form-label">Mot de passe actuel</label>
                        <input type="password" class="form-control" id="current_password" name="current_password" required>
                    </div>
                    <div class="mb-3">
                        <label for="new_password" class="form-label">Nouveau mot de passe</label>
                        <input type="password" class="form-control" id="new_password" name="new_password" required minlength="6">
                        <small class="text-muted">Minimum 6 caractères</small>
                    </div>
                    <div class="mb-3">
                        <label for="confirm_password" class="form-label">Confirmer le nouveau mot de passe</label>
                        <input type="password" class="form-control" id="confirm_password" name="confirm_password" required>
                    </div>
                    <div id="password-alert" style="display: none;"></div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Changer le mot de passe
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Section Aménagements -->
    <div id="accommodations-section" class="settings-section" style="display: none;">
        <div class="card">
            <div class="card-header">
                <h5>Affichage des aménagements</h5>
            </div>
            <div class="card-body">
                <p>Choisissez comment les aménagements des élèves doivent être affichés dans la vue des cours :</p>
                
                <div class="form-group">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="accommodations_display" id="accommodations_none" value="none" {% if preferences.show_accommodations == 'none' %}checked{% endif %}>
                        <label class="form-check-label" for="accommodations_none">
                            Ne pas afficher les aménagements
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="accommodations_display" id="accommodations_emoji" value="emoji" {% if preferences.show_accommodations == 'emoji' %}checked{% endif %}>
                        <label class="form-check-label" for="accommodations_emoji">
                            Afficher uniquement l'émoticône des aménagements
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="accommodations_display" id="accommodations_name" value="name" {% if preferences.show_accommodations == 'name' %}checked{% endif %}>
                        <label class="form-check-label" for="accommodations_name">
                            Afficher le nom complet des aménagements
                        </label>
                    </div>
                </div>
                
                <button type="button" class="btn btn-primary" onclick="saveAccommodationsSettings()">
                    Enregistrer les paramètres
                </button>
            </div>
        </div>
    </div>

    <!-- Section Sécurité (2FA) -->
    <div id="security-section" class="settings-section" style="display: none;">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-shield-alt"></i> Double authentification (2FA)</h5>
            </div>
            <div class="card-body">
                <div id="2fa-alert" class="alert mb-3" style="display: none;"></div>

                {% if current_user.totp_enabled %}
                <!-- 2FA activée -->
                <div style="background: #F0FDF4; border: 1px solid #BBF7D0; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                    <p style="color: #166534; margin-bottom: 0; font-weight: 600;">
                        <i class="fas fa-check-circle"></i> La double authentification est activée
                    </p>
                    <p style="color: #166534; margin-bottom: 0; margin-top: 0.5rem; font-size: 0.9rem;">
                        Un code de votre application d'authentification est requis à chaque connexion.
                    </p>
                </div>

                <div class="mb-3">
                    <label for="disable_2fa_password" class="form-label">Mot de passe pour désactiver :</label>
                    <input type="password" class="form-control" id="disable_2fa_password" placeholder="Entrez votre mot de passe">
                </div>

                <button type="button" class="btn btn-outline-danger" onclick="disable2FA()">
                    <i class="fas fa-unlock"></i> Désactiver la double authentification
                </button>

                {% else %}
                <!-- 2FA désactivée -->
                <p>Protégez votre compte avec une application d'authentification. Un code à 6 chiffres sera demandé à chaque connexion en plus de votre mot de passe.</p>

                <!-- Tutoriel animé -->
                <div id="2fa-tutorial" style="margin-bottom: 1.5rem;">
                    <button type="button" class="btn btn-outline-primary btn-sm mb-3" onclick="toggleTutorial()">
                        <i class="fas fa-question-circle"></i> <span id="tuto-toggle-text">Comment ça marche ?</span>
                    </button>

                    <div id="tuto-content" style="display: none;">
                        <div class="tuto-steps">
                            <!-- Étape 1 -->
                            <div class="tuto-step tuto-step-active" id="tuto-step-1">
                                <div class="tuto-step-number">1</div>
                                <div class="tuto-step-body">
                                    <h6 class="tuto-step-title">Installez une app d'authentification</h6>
                                    <p class="tuto-step-desc">Téléchargez une de ces applications gratuites sur votre téléphone :</p>
                                    <div class="tuto-apps">
                                        <div class="tuto-app">
                                            <div class="tuto-app-icon" style="background: #4285F4;">
                                                <i class="fas fa-key"></i>
                                            </div>
                                            <span>Google Authenticator</span>
                                        </div>
                                        <div class="tuto-app">
                                            <div class="tuto-app-icon" style="background: #00A4EF;">
                                                <i class="fas fa-shield-alt"></i>
                                            </div>
                                            <span>Microsoft Authenticator</span>
                                        </div>
                                        <div class="tuto-app">
                                            <div class="tuto-app-icon" style="background: linear-gradient(135deg, #007AFF, #5856D6);">
                                                <i class="fas fa-lock"></i>
                                            </div>
                                            <span>Mots de passe (Apple)</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Étape 2 -->
                            <div class="tuto-step" id="tuto-step-2">
                                <div class="tuto-step-number">2</div>
                                <div class="tuto-step-body">
                                    <h6 class="tuto-step-title">Scannez le QR code</h6>
                                    <p class="tuto-step-desc">Cliquez sur "Configurer" ci-dessous, puis scannez le QR code avec votre application.</p>
                                    <div class="tuto-demo">
                                        <div class="tuto-phone">
                                            <div class="tuto-phone-screen">
                                                <div class="tuto-scan-animation">
                                                    <i class="fas fa-qrcode" style="font-size: 2rem; color: #CBD5E1;"></i>
                                                    <div class="tuto-scan-line"></div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="tuto-arrow">
                                            <i class="fas fa-arrow-right"></i>
                                        </div>
                                        <div class="tuto-result">
                                            <div class="tuto-result-card">
                                                <span style="font-size: 0.7rem; color: #64748B;">profcalendar.org</span>
                                                <div class="tuto-code-display">
                                                    <span class="tuto-digit">4</span>
                                                    <span class="tuto-digit">8</span>
                                                    <span class="tuto-digit">2</span>
                                                    <span class="tuto-digit">7</span>
                                                    <span class="tuto-digit">1</span>
                                                    <span class="tuto-digit">6</span>
                                                </div>
                                                <div class="tuto-timer-bar">
                                                    <div class="tuto-timer-fill"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Étape 3 -->
                            <div class="tuto-step" id="tuto-step-3">
                                <div class="tuto-step-number">3</div>
                                <div class="tuto-step-body">
                                    <h6 class="tuto-step-title">Entrez le code pour confirmer</h6>
                                    <p class="tuto-step-desc">L'application génère un code à 6 chiffres qui change toutes les 30 secondes. Entrez-le pour activer la 2FA.</p>
                                </div>
                            </div>

                            <!-- Étape 4 -->
                            <div class="tuto-step" id="tuto-step-4">
                                <div class="tuto-step-number"><i class="fas fa-check"></i></div>
                                <div class="tuto-step-body">
                                    <h6 class="tuto-step-title">Lors de la connexion</h6>
                                    <p class="tuto-step-desc">Après votre mot de passe, le code sera demandé. Sur iPhone, il se remplit automatiquement via l'app Mots de passe !</p>
                                    <div class="tuto-autofill-demo">
                                        <div class="tuto-input-mock">
                                            <span style="color: #94A3B8;">000000</span>
                                        </div>
                                        <div class="tuto-suggestion-bubble">
                                            <i class="fas fa-key" style="font-size: 0.7rem;"></i>
                                            <span>482716</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Navigation tuto -->
                        <div style="display: flex; justify-content: center; gap: 0.5rem; margin-top: 1rem;">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="tutoNav(-1)" id="tuto-prev" disabled>
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <span id="tuto-indicator" style="display: flex; gap: 0.35rem; align-items: center;"></span>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="tutoNav(1)" id="tuto-next">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div id="2fa-setup-container" style="display: none;">
                    <div style="background: #F0F9FF; border: 1px solid #BAE6FD; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
                        <p style="font-weight: 600; margin-bottom: 1rem;">1. Scannez ce QR code avec votre application :</p>
                        <div style="text-align: center; margin-bottom: 1rem;">
                            <img id="2fa-qr-code" src="" alt="QR Code" style="border-radius: 8px;">
                        </div>
                        <p style="font-size: 0.85rem; color: var(--gray-color); margin-bottom: 0.5rem;">
                            Ou entrez ce code manuellement : <code id="2fa-secret-display" style="font-size: 1rem; user-select: all;"></code>
                        </p>
                    </div>

                    <div style="background: #F0F9FF; border: 1px solid #BAE6FD; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
                        <p style="font-weight: 600; margin-bottom: 1rem;">2. Entrez le code affiché par l'application :</p>
                        <div style="text-align: center;">
                            <input type="text" id="2fa-verify-code" class="form-control"
                                   maxlength="6" pattern="[0-9]{6}" inputmode="numeric" autocomplete="one-time-code"
                                   placeholder="000000"
                                   style="text-align: center; font-size: 1.5rem; font-weight: 700; letter-spacing: 0.5rem; max-width: 220px; margin: 0 auto;">
                        </div>
                    </div>

                    <button type="button" class="btn btn-success" onclick="confirm2FA()">
                        <i class="fas fa-check"></i> Activer la double authentification
                    </button>
                    <button type="button" class="btn btn-outline-secondary ms-2" onclick="cancel2FASetup()">
                        Annuler
                    </button>
                </div>

                <div id="2fa-start-container">
                    <button type="button" class="btn btn-primary" onclick="start2FASetup()">
                        <i class="fas fa-shield-alt"></i> Configurer la double authentification
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Section Abonnement -->
    <div id="subscription-section" class="settings-section" style="display: none;">
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-crown" style="color: #F59E0B;"></i> Mon abonnement</h5>
            </div>
            <div class="card-body">
                {% if current_user.has_premium_access() %}
                <div style="background: #F0FDF4; border: 1px solid #BBF7D0; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                    <p style="color: #166534; margin-bottom: 0; font-weight: 600;">
                        <i class="fas fa-check-circle"></i> Vous avez un abonnement <strong>Premium</strong>
                    </p>
                    {% if current_user.premium_until %}
                    <p style="color: #166534; margin-bottom: 0; margin-top: 0.5rem; font-size: 0.9rem;">
                        Valide jusqu'au {{ current_user.premium_until.strftime('%d/%m/%Y') }}
                    </p>
                    {% else %}
                    <p style="color: #166534; margin-bottom: 0; margin-top: 0.5rem; font-size: 0.9rem;">
                        Accès illimité
                    </p>
                    {% endif %}
                </div>
                {% if current_user.stripe_subscription_id %}
                <a href="{{ url_for('subscription.manage') }}" class="btn btn-primary">
                    <i class="fas fa-cog"></i> Gérer mon abonnement
                </a>
                {% endif %}
                {% else %}
                <div style="background: #FFF7ED; border: 1px solid #FED7AA; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                    <p style="color: #9A3412; margin-bottom: 0;">
                        <i class="fas fa-info-circle"></i> Vous utilisez la version <strong>Freemium</strong>.
                        Passez à Premium pour accéder à la gestion de classe, aux évaluations, au suivi des présences et bien plus.
                    </p>
                </div>
                <a href="{{ url_for('subscription.pricing') }}" class="btn btn-primary" style="background: linear-gradient(135deg, #F59E0B, #D97706); border: none;">
                    <i class="fas fa-crown"></i> Voir les offres Premium
                </a>
                {% endif %}
            </div>
        </div>

        <!-- Section Bon / Voucher -->
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-ticket-alt"></i> Utiliser un bon</h5>
            </div>
            <div class="card-body">
                <p>Si vous avez reçu un code promotionnel, entrez-le ci-dessous pour activer votre accès Premium.</p>
                <div id="voucher-alert" class="alert mb-3" style="display: none;"></div>
                <div style="display: flex; gap: 0.5rem; max-width: 400px;">
                    <input type="text" class="form-control" id="voucher_code" placeholder="Entrez votre code" style="text-transform: uppercase; font-weight: 600; letter-spacing: 0.1rem;">
                    <button type="button" class="btn btn-primary" onclick="redeemVoucherSettings()">
                        <i class="fas fa-check"></i> Appliquer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Section Zone de danger -->
    <div id="danger-section" class="settings-section" style="display: none;">
        <div class="card mb-4" style="border-color: #EF4444;">
            <div class="card-header" style="background: #FEF2F2; border-bottom-color: #EF4444;">
                <h5 style="color: #DC2626;"><i class="fas fa-exclamation-triangle"></i> Supprimer mon compte</h5>
            </div>
            <div class="card-body">
                <div id="delete-alert" class="alert mb-3" style="display: none;"></div>

                <div style="background: #FEF2F2; border: 1px solid #FECACA; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                    <p style="color: #991B1B; margin-bottom: 0.5rem; font-weight: 600;">
                        <i class="fas fa-warning"></i> Cette action est irréversible !
                    </p>
                    <p style="color: #991B1B; margin-bottom: 0;">
                        La suppression de votre compte entraînera la perte définitive de toutes vos données :
                        classes, élèves, évaluations, notes, remarques, sanctions, planifications, et fichiers.
                    </p>
                </div>

                <div style="background: #FFF7ED; border: 1px solid #FED7AA; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                    <p style="color: #9A3412; margin-bottom: 0;">
                        <i class="fas fa-info-circle"></i>
                        Si vous êtes maître de classe et que des enseignants spécialisés sont liés à vos classes,
                        un rapport PDF contenant les données des élèves (notes, remarques, sanctions) leur sera
                        automatiquement envoyé avant la suppression.
                    </p>
                </div>

                <div class="mb-3">
                    <label for="delete_password" class="form-label" style="color: #DC2626; font-weight: 600;">
                        Confirmez avec votre mot de passe :
                    </label>
                    <input type="password" class="form-control" id="delete_password"
                           placeholder="Entrez votre mot de passe" required
                           style="border-color: #FECACA;">
                </div>

                <button type="button" class="btn" onclick="deleteAccount()"
                        style="background: #DC2626; color: white; font-weight: 600; padding: 0.75rem 1.5rem;">
                    <i class="fas fa-trash"></i> Supprimer définitivement mon compte
                </button>
            </div>
        </div>
    </div>

</div>

<style>
.settings-nav {
    display: flex;
    gap: 1rem;
    border-bottom: 2px solid var(--border-color);
    margin-bottom: 2rem;
}

.settings-nav-link {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 1rem 1.5rem;
    text-decoration: none;
    color: var(--gray-color);
    border-bottom: 3px solid transparent;
    transition: all 0.3s ease;
}

.settings-nav-link:hover {
    color: var(--primary-color);
    text-decoration: none;
}

.settings-nav-link.active {
    color: var(--primary-color);
    border-bottom-color: var(--primary-color);
    font-weight: 600;
}

.settings-section {
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

/* ─── Tutoriel 2FA ─── */
.tuto-steps { display: flex; flex-direction: column; gap: 0rem; }
.tuto-step {
    display: flex; gap: 1rem; padding: 1rem; border-radius: 10px;
    opacity: 0.35; transform: scale(0.97); transition: all 0.4s ease;
    max-height: 60px; overflow: hidden;
}
.tuto-step-active {
    opacity: 1; transform: scale(1);
    background: #F8FAFC; max-height: 500px;
}
.tuto-step-number {
    width: 32px; height: 32px; min-width: 32px; border-radius: 50%;
    background: var(--primary-color); color: white; font-weight: 700;
    display: flex; align-items: center; justify-content: center; font-size: 0.85rem;
}
.tuto-step-active .tuto-step-number { box-shadow: 0 0 0 4px rgba(59,130,246,0.2); }
.tuto-step-title { font-weight: 600; margin-bottom: 0.25rem; font-size: 0.95rem; }
.tuto-step-desc { font-size: 0.85rem; color: #64748B; margin-bottom: 0.75rem; }

/* Apps */
.tuto-apps { display: flex; gap: 0.75rem; flex-wrap: wrap; }
.tuto-app {
    display: flex; align-items: center; gap: 0.5rem;
    background: white; border: 1px solid #E2E8F0; border-radius: 8px;
    padding: 0.4rem 0.75rem; font-size: 0.8rem;
}
.tuto-app-icon {
    width: 24px; height: 24px; border-radius: 6px; color: white;
    display: flex; align-items: center; justify-content: center; font-size: 0.7rem;
}

/* Demo scan */
.tuto-demo { display: flex; align-items: center; gap: 1rem; justify-content: center; }
.tuto-phone {
    width: 80px; height: 110px; border: 3px solid #334155; border-radius: 14px;
    padding: 6px; background: white;
}
.tuto-phone-screen {
    width: 100%; height: 100%; background: #F1F5F9; border-radius: 8px;
    display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden;
}
.tuto-scan-animation { position: relative; }
.tuto-scan-line {
    position: absolute; left: -10px; right: -10px; height: 2px;
    background: #3B82F6; top: 0;
    animation: scanMove 2s ease-in-out infinite;
}
@keyframes scanMove { 0%,100% { top: -15px; } 50% { top: 25px; } }

.tuto-arrow { color: #94A3B8; font-size: 1.2rem; animation: arrowPulse 1.5s ease-in-out infinite; }
@keyframes arrowPulse { 0%,100% { transform: translateX(0); } 50% { transform: translateX(5px); } }

.tuto-result-card {
    background: white; border: 1px solid #E2E8F0; border-radius: 10px;
    padding: 0.5rem 0.75rem; text-align: center;
}
.tuto-code-display { display: flex; gap: 3px; margin: 0.3rem 0; }
.tuto-digit {
    width: 22px; height: 28px; background: #EFF6FF; border: 1px solid #BFDBFE;
    border-radius: 4px; display: flex; align-items: center; justify-content: center;
    font-weight: 700; font-size: 0.9rem; color: #1E40AF;
    animation: digitAppear 0.3s ease backwards;
}
.tuto-digit:nth-child(1) { animation-delay: 0.1s; }
.tuto-digit:nth-child(2) { animation-delay: 0.2s; }
.tuto-digit:nth-child(3) { animation-delay: 0.3s; }
.tuto-digit:nth-child(4) { animation-delay: 0.4s; }
.tuto-digit:nth-child(5) { animation-delay: 0.5s; }
.tuto-digit:nth-child(6) { animation-delay: 0.6s; }
@keyframes digitAppear { from { opacity:0; transform:translateY(5px); } to { opacity:1; transform:translateY(0); } }

.tuto-timer-bar { height: 3px; background: #E2E8F0; border-radius: 2px; overflow: hidden; }
.tuto-timer-fill { height: 100%; background: #3B82F6; border-radius: 2px; animation: timerShrink 4s linear infinite; }
@keyframes timerShrink { from { width: 100%; } to { width: 0%; } }

/* Autofill demo */
.tuto-autofill-demo { display: flex; flex-direction: column; align-items: center; gap: 0.4rem; }
.tuto-input-mock {
    width: 160px; padding: 0.4rem 0.75rem; border: 2px solid #CBD5E1;
    border-radius: 8px; text-align: center; font-size: 1rem; font-weight: 600;
    letter-spacing: 0.3rem; background: white;
}
.tuto-suggestion-bubble {
    background: #1E293B; color: white; border-radius: 6px;
    padding: 0.25rem 0.75rem; font-size: 0.8rem; font-weight: 600;
    display: flex; align-items: center; gap: 0.4rem;
    animation: bubbleBounce 2s ease-in-out infinite;
}
@keyframes bubbleBounce { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }

/* Dots indicator */
.tuto-dot {
    width: 8px; height: 8px; border-radius: 50%; background: #CBD5E1;
    transition: all 0.3s ease; cursor: pointer;
}
.tuto-dot-active { background: var(--primary-color); transform: scale(1.3); }
</style>

<script>
function showSection(sectionName, linkElement) {
    // Masquer toutes les sections
    document.querySelectorAll('.settings-section').forEach(section => {
        section.style.display = 'none';
    });
    
    // Retirer la classe active de tous les liens
    document.querySelectorAll('.settings-nav-link').forEach(link => {
        link.classList.remove('active');
    });
    
    // Afficher la section sélectionnée
    document.getElementById(sectionName + '-section').style.display = 'block';
    
    // Ajouter la classe active au lien cliqué
    linkElement.classList.add('active');
}

async function saveAccommodationsSettings() {
    const selectedValue = document.querySelector('input[name="accommodations_display"]:checked').value;
    
    try {
        const response = await fetch('/settings/update-accommodations-display', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                show_accommodations: selectedValue
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Afficher un message de succès
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show mt-3';
            alertDiv.innerHTML = `
                ${result.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('#accommodations-section .card-body').appendChild(alertDiv);
            
            // Supprimer l'alerte après 3 secondes
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 3000);
        } else {
            throw new Error(result.message);
        }
    } catch (error) {
        console.error('Erreur lors de la sauvegarde:', error);
        alert('Erreur lors de la sauvegarde des paramètres: ' + error.message);
    }
}

// Gestion du formulaire de changement de mot de passe
document.getElementById('change-password-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const currentPassword = document.getElementById('current_password').value;
    const newPassword = document.getElementById('new_password').value;
    const confirmPassword = document.getElementById('confirm_password').value;
    const alertDiv = document.getElementById('password-alert');

    // Réinitialiser l'alerte
    alertDiv.style.display = 'none';

    // Vérifier que les nouveaux mots de passe correspondent
    if (newPassword !== confirmPassword) {
        alertDiv.className = 'alert alert-danger mb-3';
        alertDiv.textContent = 'Les nouveaux mots de passe ne correspondent pas.';
        alertDiv.style.display = 'block';
        return;
    }

    // Vérifier la longueur minimale
    if (newPassword.length < 6) {
        alertDiv.className = 'alert alert-danger mb-3';
        alertDiv.textContent = 'Le nouveau mot de passe doit contenir au moins 6 caractères.';
        alertDiv.style.display = 'block';
        return;
    }

    try {
        const response = await fetch('/settings/change-password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                current_password: currentPassword,
                new_password: newPassword
            })
        });

        const result = await response.json();

        if (result.success) {
            alertDiv.className = 'alert alert-success mb-3';
            alertDiv.textContent = result.message;
            alertDiv.style.display = 'block';

            // Réinitialiser le formulaire
            document.getElementById('change-password-form').reset();

            // Masquer l'alerte après 5 secondes
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 5000);
        } else {
            alertDiv.className = 'alert alert-danger mb-3';
            alertDiv.textContent = result.message;
            alertDiv.style.display = 'block';
        }
    } catch (error) {
        console.error('Erreur lors du changement de mot de passe:', error);
        alertDiv.className = 'alert alert-danger mb-3';
        alertDiv.textContent = 'Une erreur est survenue. Veuillez réessayer.';
        alertDiv.style.display = 'block';
    }
});

// ─── 2FA Tutorial ───
let tutoStep = 0;
const tutoTotal = 4;

function toggleTutorial() {
    const content = document.getElementById('tuto-content');
    const text = document.getElementById('tuto-toggle-text');
    if (content.style.display === 'none') {
        content.style.display = 'block';
        text.textContent = 'Masquer le tutoriel';
        initTutoDots();
        showTutoStep(0);
    } else {
        content.style.display = 'none';
        text.textContent = 'Comment ça marche ?';
    }
}

function initTutoDots() {
    const indicator = document.getElementById('tuto-indicator');
    indicator.innerHTML = '';
    for (let i = 0; i < tutoTotal; i++) {
        const dot = document.createElement('span');
        dot.className = 'tuto-dot' + (i === 0 ? ' tuto-dot-active' : '');
        dot.onclick = () => showTutoStep(i);
        indicator.appendChild(dot);
    }
}

function showTutoStep(idx) {
    tutoStep = idx;
    for (let i = 1; i <= tutoTotal; i++) {
        const el = document.getElementById('tuto-step-' + i);
        if (el) {
            if (i - 1 === idx) {
                el.classList.add('tuto-step-active');
            } else {
                el.classList.remove('tuto-step-active');
            }
        }
    }
    const dots = document.querySelectorAll('.tuto-dot');
    dots.forEach((d, i) => {
        if (i === idx) d.classList.add('tuto-dot-active');
        else d.classList.remove('tuto-dot-active');
    });
    document.getElementById('tuto-prev').disabled = idx === 0;
    document.getElementById('tuto-next').disabled = idx === tutoTotal - 1;
}

function tutoNav(dir) {
    const next = tutoStep + dir;
    if (next >= 0 && next < tutoTotal) showTutoStep(next);
}

// ─── 2FA Functions ───
let pending2FASecret = null;

async function start2FASetup() {
    const alertDiv = document.getElementById('2fa-alert');
    alertDiv.style.display = 'none';

    try {
        const response = await fetch('/settings/setup-2fa');
        const result = await response.json();

        if (result.success) {
            pending2FASecret = result.secret;
            document.getElementById('2fa-qr-code').src = result.qr_code;
            document.getElementById('2fa-secret-display').textContent = result.secret;
            document.getElementById('2fa-setup-container').style.display = 'block';
            document.getElementById('2fa-start-container').style.display = 'none';

            // Auto-focus sur l'input du code
            setTimeout(() => document.getElementById('2fa-verify-code').focus(), 300);
        } else {
            throw new Error(result.message);
        }
    } catch (error) {
        alertDiv.className = 'alert alert-danger mb-3';
        alertDiv.textContent = 'Erreur: ' + error.message;
        alertDiv.style.display = 'block';
    }
}

function cancel2FASetup() {
    pending2FASecret = null;
    document.getElementById('2fa-setup-container').style.display = 'none';
    document.getElementById('2fa-start-container').style.display = 'block';
    document.getElementById('2fa-verify-code').value = '';
}

async function confirm2FA() {
    const code = document.getElementById('2fa-verify-code').value.trim();
    const alertDiv = document.getElementById('2fa-alert');
    alertDiv.style.display = 'none';

    if (!code || code.length !== 6) {
        alertDiv.className = 'alert alert-danger mb-3';
        alertDiv.textContent = 'Veuillez entrer un code à 6 chiffres.';
        alertDiv.style.display = 'block';
        return;
    }

    try {
        const response = await fetch('/settings/enable-2fa', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ secret: pending2FASecret, code: code })
        });

        const result = await response.json();

        if (result.success) {
            alertDiv.className = 'alert alert-success mb-3';
            alertDiv.textContent = result.message;
            alertDiv.style.display = 'block';
            // Recharger la page pour afficher le nouvel état
            setTimeout(() => location.reload(), 1500);
        } else {
            alertDiv.className = 'alert alert-danger mb-3';
            alertDiv.textContent = result.message;
            alertDiv.style.display = 'block';
        }
    } catch (error) {
        alertDiv.className = 'alert alert-danger mb-3';
        alertDiv.textContent = 'Erreur: ' + error.message;
        alertDiv.style.display = 'block';
    }
}

async function disable2FA() {
    const password = document.getElementById('disable_2fa_password').value;
    const alertDiv = document.getElementById('2fa-alert');
    alertDiv.style.display = 'none';

    if (!password) {
        alertDiv.className = 'alert alert-danger mb-3';
        alertDiv.textContent = 'Veuillez entrer votre mot de passe.';
        alertDiv.style.display = 'block';
        return;
    }

    if (!confirm('Voulez-vous vraiment désactiver la double authentification ?')) {
        return;
    }

    try {
        const response = await fetch('/settings/disable-2fa', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ password: password })
        });

        const result = await response.json();

        if (result.success) {
            alertDiv.className = 'alert alert-success mb-3';
            alertDiv.textContent = result.message;
            alertDiv.style.display = 'block';
            setTimeout(() => location.reload(), 1500);
        } else {
            alertDiv.className = 'alert alert-danger mb-3';
            alertDiv.textContent = result.message;
            alertDiv.style.display = 'block';
        }
    } catch (error) {
        alertDiv.className = 'alert alert-danger mb-3';
        alertDiv.textContent = 'Erreur: ' + error.message;
        alertDiv.style.display = 'block';
    }
}

// Filtrage numérique pour l'input 2FA
document.addEventListener('DOMContentLoaded', function() {
    const verifyInput = document.getElementById('2fa-verify-code');
    if (verifyInput) {
        verifyInput.addEventListener('input', function() {
            this.value = this.value.replace(/[^0-9]/g, '');
        });
    }
});

// ─── Voucher Redemption ───
async function redeemVoucherSettings() {
    const code = document.getElementById('voucher_code').value.trim();
    const alertDiv = document.getElementById('voucher-alert');
    alertDiv.style.display = 'none';

    if (!code) {
        alertDiv.className = 'alert alert-danger mb-3';
        alertDiv.textContent = 'Veuillez entrer un code.';
        alertDiv.style.display = 'block';
        return;
    }

    try {
        const response = await fetch('/subscription/redeem-voucher', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code: code })
        });

        const result = await response.json();

        if (result.success) {
            alertDiv.className = 'alert alert-success mb-3';
            alertDiv.textContent = result.message;
            alertDiv.style.display = 'block';
            setTimeout(() => location.reload(), 2000);
        } else {
            alertDiv.className = 'alert alert-danger mb-3';
            alertDiv.textContent = result.message;
            alertDiv.style.display = 'block';
        }
    } catch (error) {
        alertDiv.className = 'alert alert-danger mb-3';
        alertDiv.textContent = 'Une erreur est survenue. Veuillez réessayer.';
        alertDiv.style.display = 'block';
    }
}

// ─── Delete Account ───
async function deleteAccount() {
    const password = document.getElementById('delete_password').value;
    const alertDiv = document.getElementById('delete-alert');
    alertDiv.style.display = 'none';

    if (!password) {
        alertDiv.className = 'alert alert-danger mb-3';
        alertDiv.textContent = 'Veuillez entrer votre mot de passe.';
        alertDiv.style.display = 'block';
        return;
    }

    if (!confirm('Êtes-vous sûr de vouloir supprimer votre compte ? Cette action est IRRÉVERSIBLE.')) {
        return;
    }

    if (!confirm('DERNIÈRE CONFIRMATION : Toutes vos données seront définitivement supprimées. Continuer ?')) {
        return;
    }

    try {
        const btn = document.querySelector('[onclick="deleteAccount()"]');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Suppression en cours...';

        const response = await fetch('/settings/delete-account', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ password: password })
        });

        const result = await response.json();

        if (result.success) {
            window.location.href = result.redirect || '/auth/login';
        } else {
            alertDiv.className = 'alert alert-danger mb-3';
            alertDiv.textContent = result.message;
            alertDiv.style.display = 'block';
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-trash"></i> Supprimer définitivement mon compte';
        }
    } catch (error) {
        console.error('Erreur:', error);
        alertDiv.className = 'alert alert-danger mb-3';
        alertDiv.textContent = 'Une erreur est survenue. Veuillez réessayer.';
        alertDiv.style.display = 'block';
        const btn = document.querySelector('[onclick="deleteAccount()"]');
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-trash"></i> Supprimer définitivement mon compte';
    }
}
</script>
{% endblock %}