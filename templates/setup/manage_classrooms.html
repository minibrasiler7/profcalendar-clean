{% extends "base.html" %}

{% block title %}Gestion des classes - TeacherPlanner{% endblock %}

{% block extra_css %}
<style>
.setup-container {
    max-width: 800px;
    margin: 0 auto;
}

/* Styles pour les modaux am√©lior√©s */
.improved-class-selection-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.improved-class-item {
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    padding: 1rem;
    cursor: pointer;
    transition: all 0.2s ease;
    background-color: #fafafa;
}

.improved-class-item:hover {
    border-color: var(--primary-color);
    background-color: #f8fafc;
    transform: translateY(-2px);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

.improved-class-item.selected {
    border-color: var(--primary-color);
    background-color: #f0f9ff;
    box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
}

.class-item-content {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.class-color-indicator {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    flex-shrink: 0;
    border: 2px solid #fff;
    box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.1);
}

.class-item-info {
    flex: 1;
    min-width: 0;
}

.class-item-name {
    font-size: 1rem;
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 0.25rem;
}

.class-item-details {
    display: flex;
    gap: 1rem;
    font-size: 0.875rem;
    color: #6b7280;
}

.class-subject,
.class-student-count {
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.class-subject i,
.class-student-count i {
    font-size: 0.75rem;
    opacity: 0.7;
}

.class-item-checkbox {
    flex-shrink: 0;
}

.class-item-checkbox input[type="checkbox"] {
    display: none;
}

.checkbox-label {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    border: 2px solid #d1d5db;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s ease;
    background-color: #fff;
}

.checkbox-label i {
    font-size: 0.875rem;
    color: #fff;
    opacity: 0;
    transition: opacity 0.2s ease;
}

.class-item-checkbox input[type="checkbox"]:checked + .checkbox-label {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
}

.class-item-checkbox input[type="checkbox"]:checked + .checkbox-label i {
    opacity: 1;
}

/* Correction du style des boutons dans les modaux */
.modal-footer .btn {
    margin-right: 0.5rem;
    font-size: 0.875rem;
    padding: 0.5rem 1rem;
}

.modal-footer .btn:last-child {
    margin-right: 0;
}

.modal-footer .btn-outline-secondary {
    border-color: #d1d5db;
    color: #6b7280;
}

.modal-footer .btn-outline-secondary:hover {
    background-color: #f3f4f6;
    border-color: #9ca3af;
    color: #374151;
}

.setup-progress {
    display: flex;
    justify-content: space-between;
    margin-bottom: 3rem;
    position: relative;
}

.setup-progress::before {
    content: '';
    position: absolute;
    top: 20px;
    left: 0;
    right: 0;
    height: 2px;
    background-color: var(--primary-color);
    z-index: 0;
    width: 60%; /* 3/5 pour l'√©tape 4 */
}

.progress-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    z-index: 1;
}

.progress-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: var(--light-gray);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    color: var(--gray-color);
    margin-bottom: 0.5rem;
    transition: all 0.3s ease;
}

.progress-step.active .progress-circle {
    background-color: var(--primary-color);
    color: var(--white);
    transform: scale(1.1);
}

.progress-step.completed .progress-circle {
    background-color: var(--success-color);
    color: var(--white);
}

.add-classroom-section {
    background-color: var(--white);
    border-radius: var(--border-radius);
    padding: 2rem;
    box-shadow: var(--shadow-sm);
    margin-bottom: 2rem;
}

.classrooms-list {
    background-color: var(--white);
    border-radius: var(--border-radius);
    padding: 2rem;
    box-shadow: var(--shadow-sm);
}

.classroom-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem;
    border: 1px solid var(--light-gray);
    border-radius: var(--border-radius);
    margin-bottom: 1rem;
    transition: all 0.3s ease;
}

.classroom-item:hover {
    border-color: var(--primary-color);
    box-shadow: var(--shadow-sm);
}

.classroom-info {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.classroom-color {
    width: 40px;
    height: 40px;
    border-radius: var(--border-radius);
    box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.1);
}

.classroom-details h3 {
    margin: 0;
    font-size: 1.125rem;
    font-weight: 600;
}

.classroom-details p {
    margin: 0;
    color: var(--gray-color);
    font-size: 0.875rem;
}

.color-picker-wrapper {
    position: relative;
    display: inline-block;
}

.color-value {
    position: absolute;
    right: -80px;
    top: 50%;
    transform: translateY(-50%);
    font-family: monospace;
    font-size: 0.875rem;
    color: var(--gray-color);
}

.empty-state {
    text-align: center;
    padding: 3rem;
    color: var(--gray-color);
}

.empty-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

.setup-section {
    background-color: var(--white);
    border-radius: var(--border-radius);
    padding: 2rem;
    box-shadow: var(--shadow-sm);
    margin-bottom: 2rem;
}

.form-help {
    font-size: 0.875rem;
    color: var(--gray-color);
    margin-top: 0.25rem;
}
</style>

{% endblock %}

{% block content %}
<div class="setup-container">
    <!-- Barre de progression (masqu√©e si on vient du dashboard) -->
    {% if not from_dashboard %}
    {% set current_step = 4 %}
    {% include 'setup/progress_bar.html' %}
    {% endif %}

    <!-- Section de configuration -->
    <div class="setup-section">
        <h2><i class="fas fa-chalkboard-teacher"></i> Configuration des classes</h2>
        
        <!-- Formulaire de cr√©ation de classe -->
        <div class="add-classroom-section">
            <h3><i class="fas fa-plus-circle"></i> Cr√©er une nouvelle classe</h3>
            
            <!-- S√©lection du type de classe -->
            <div class="class-type-selection">
                <div class="class-type-options">
                    <label class="class-type-option selected" for="class-type-normal">
                        <input type="radio" id="class-type-normal" name="class_type" value="normal" checked>
                        <span class="class-type-icon">üéì</span>
                        <div class="class-type-title">Classe normale</div>
                        <div class="class-type-desc">Une classe traditionnelle avec vos propres √©l√®ves</div>
                    </label>
                    
                    <label class="class-type-option" for="class-type-mixed">
                        <input type="radio" id="class-type-mixed" name="class_type" value="mixed">
                        <span class="class-type-icon">üîó</span>
                        <div class="class-type-title">Classe mixte</div>
                        <div class="class-type-desc">M√©langez des √©l√®ves de diff√©rentes classes</div>
                    </label>
                </div>
            </div>
            
            <!-- Formulaire pour classe normale -->
            <form method="POST" action="{{ url_for('setup.manage_classrooms') }}" id="normal-class-form">
                {{ form.hidden_tag() }}
                <input type="hidden" name="action_type" value="create">
                
                <div class="form-row">
                    <div class="form-group">
                        {{ form.name.label(class="form-label") }}
                        {{ form.name(class="form-control", placeholder="Ex: 6√®me A") }}
                        {% if form.name.errors %}
                            <div class="form-error">
                                {% for error in form.name.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        {{ form.subject.label(class="form-label") }}
                        {{ form.subject(class="form-control", placeholder="Ex: Math√©matiques") }}
                        {% if form.subject.errors %}
                            <div class="form-error">
                                {% for error in form.subject.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Boutons pour rejoindre des classes existantes -->
                <div class="form-group">
                    <label class="form-label">Options pour rejoindre des classes existantes</label>
                    <div class="join-options" style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                        <button type="button" class="btn btn-outline-primary" id="join-with-code-btn">
                            <i class="fas fa-key"></i> Rejoindre avec un code d'acc√®s
                        </button>
                        <button type="button" class="btn btn-outline-secondary" id="join-with-invitation-btn">
                            <i class="fas fa-envelope"></i> Rejoindre avec une invitation
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    {{ form.color.label(class="form-label") }}
                    <div class="color-palette">
                        <input type="hidden" id="color" name="color" value="#4F46E5">
                        <div class="color-options">
                            <div class="color-option active" data-color="#4F46E5" style="background-color: #4F46E5;" title="Violet"></div>
                            <div class="color-option" data-color="#EF4444" style="background-color: #EF4444;" title="Rouge"></div>
                            <div class="color-option" data-color="#F59E0B" style="background-color: #F59E0B;" title="Orange"></div>
                            <div class="color-option" data-color="#84CC16" style="background-color: #84CC16;" title="Vert lime"></div>
                            <div class="color-option" data-color="#22C55E" style="background-color: #22C55E;" title="Vert"></div>
                            <div class="color-option" data-color="#06B6D4" style="background-color: #06B6D4;" title="Cyan"></div>
                            <div class="color-option" data-color="#3B82F6" style="background-color: #3B82F6;" title="Bleu"></div>
                            <div class="color-option" data-color="#8B5CF6" style="background-color: #8B5CF6;" title="Violet clair"></div>
                            <div class="color-option" data-color="#EC4899" style="background-color: #EC4899;" title="Rose"></div>
                            <div class="color-option" data-color="#F97316" style="background-color: #F97316;" title="Orange fonc√©"></div>
                            <div class="color-option" data-color="#10B981" style="background-color: #10B981;" title="Emeraude"></div>
                            <div class="color-option" data-color="#14B8A6" style="background-color: #14B8A6;" title="Sarcelle"></div>
                            <div class="color-option" data-color="#6366F1" style="background-color: #6366F1;" title="Indigo"></div>
                            <div class="color-option" data-color="#A855F7" style="background-color: #A855F7;" title="Violet profond"></div>
                            <div class="color-option" data-color="#F43F5E" style="background-color: #F43F5E;" title="Rose rouge"></div>
                            <div class="color-option" data-color="#FDE047" style="background-color: #FDE047;" title="Jaune vif"></div>
                        </div>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Cr√©er la classe
                </button>
            </form>
            
            <!-- Configuration pour classe mixte -->
            <div class="mixed-class-config" id="mixed-class-config">
                <h4><i class="fas fa-cog"></i> Configuration de la classe mixte</h4>
                <p>Configurez votre classe mixte en ajoutant des √©l√®ves de diff√©rentes classes sources.</p>
                
                <form method="POST" action="{{ url_for('setup.manage_classrooms') }}" id="mixed-class-form">
                    <input type="hidden" name="action_type" value="create_mixed">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Nom de la classe mixte</label>
                            <input type="text" name="mixed_name" class="form-control" placeholder="Ex: Groupe de soutien maths" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Mati√®re</label>
                            <input type="text" name="mixed_subject" class="form-control" placeholder="Ex: Math√©matiques" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Couleur</label>
                        <div class="color-palette">
                            <input type="hidden" id="mixed_color" name="mixed_color" value="#4F46E5">
                            <div class="color-options">
                                <div class="color-option active" data-color="#4F46E5" style="background-color: #4F46E5;" title="Violet"></div>
                                <div class="color-option" data-color="#EF4444" style="background-color: #EF4444;" title="Rouge"></div>
                                <div class="color-option" data-color="#F59E0B" style="background-color: #F59E0B;" title="Orange"></div>
                                <div class="color-option" data-color="#84CC16" style="background-color: #84CC16;" title="Vert lime"></div>
                                <div class="color-option" data-color="#22C55E" style="background-color: #22C55E;" title="Vert"></div>
                                <div class="color-option" data-color="#06B6D4" style="background-color: #06B6D4;" title="Cyan"></div>
                                <div class="color-option" data-color="#3B82F6" style="background-color: #3B82F6;" title="Bleu"></div>
                                <div class="color-option" data-color="#8B5CF6" style="background-color: #8B5CF6;" title="Violet clair"></div>
                                <div class="color-option" data-color="#EC4899" style="background-color: #EC4899;" title="Rose"></div>
                                <div class="color-option" data-color="#F97316" style="background-color: #F97316;" title="Orange fonc√©"></div>
                                <div class="color-option" data-color="#10B981" style="background-color: #10B981;" title="Emeraude"></div>
                                <div class="color-option" data-color="#14B8A6" style="background-color: #14B8A6;" title="Sarcelle"></div>
                                <div class="color-option" data-color="#6366F1" style="background-color: #6366F1;" title="Indigo"></div>
                                <div class="color-option" data-color="#A855F7" style="background-color: #A855F7;" title="Violet profond"></div>
                                <div class="color-option" data-color="#F43F5E" style="background-color: #F43F5E;" title="Rose rouge"></div>
                                <div class="color-option" data-color="#FDE047" style="background-color: #FDE047;" title="Jaune vif"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Section d'ajout de classes sources -->
                    <div class="source-classes-section">
                        <h5><i class="fas fa-users"></i> Ajouter des classes sources</h5>
                        <div class="source-classes-buttons">
                            <button type="button" class="source-class-btn" data-modal="own-classes">
                                <i class="fas fa-chalkboard-teacher"></i>
                                Mes classes
                            </button>
                            <button type="button" class="source-class-btn" data-modal="code-classes">
                                <i class="fas fa-key"></i>
                                Avec code d'acc√®s
                            </button>
                            <button type="button" class="source-class-btn" data-modal="invite-classes">
                                <i class="fas fa-envelope"></i>
                                Envoyer invitation
                            </button>
                            <button type="button" class="source-class-btn" data-modal="external-classes">
                                <i class="fas fa-external-link-alt"></i>
                                Classe externe
                            </button>
                        </div>
                        
                        <div class="added-source-classes" id="added-source-classes">
                            <!-- Les classes ajout√©es appara√Ætront ici -->
                        </div>
                    </div>
                    
                    <!-- Section de s√©lection des √©l√®ves -->
                    <div class="student-selection-section" id="student-selection-section">
                        <h5><i class="fas fa-user-check"></i> S√©lection des √©l√®ves</h5>
                        <div id="student-groups">
                            <!-- Les groupes d'√©l√®ves appara√Ætront ici -->
                        </div>
                        
                        <div class="mixed-class-summary" id="mixed-class-summary">
                            <div class="summary-stats">
                                <div class="summary-stat">
                                    <div class="summary-stat-number" id="total-students">0</div>
                                    <div class="summary-stat-label">√âl√®ves s√©lectionn√©s</div>
                                </div>
                                <div class="summary-stat">
                                    <div class="summary-stat-number" id="total-classes">0</div>
                                    <div class="summary-stat-label">Classes sources</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Hidden inputs pour les donn√©es de la classe mixte -->
                    <input type="hidden" name="selected_students" id="selected_students_input">
                    <input type="hidden" name="source_classes" id="source_classes_input">
                    
                    <button type="submit" class="btn btn-primary" id="create-mixed-class-btn" disabled>
                        <i class="fas fa-plus"></i> Cr√©er la classe mixte
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Formulaire pour rejoindre une classe (uniquement pour classe normale) -->
        <div class="add-classroom-section" id="join-class-section" style="margin-top: 2rem;">
            <h3><i class="fas fa-link"></i> Rejoindre une classe existante</h3>
            <p>En tant qu'enseignant sp√©cialis√©, liez-vous √† une classe d'un ma√Ætre de classe.</p>
            
            <!-- Modal pour rejoindre avec code d'acc√®s -->
            <div class="modal" id="join-with-code-modal" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4><i class="fas fa-key"></i> Rejoindre avec un code d'acc√®s</h4>
                        <span class="close" data-modal="join-with-code-modal">&times;</span>
                    </div>
                    <div class="modal-body">
                <form method="POST" action="{{ url_for('setup.manage_classrooms') }}">
                    {{ form.hidden_tag() }}
                    <input type="hidden" name="action_type" value="join">
                    
                    <div class="form-group">
                        <label class="form-label">Code d'acc√®s</label>
                        <input type="text" name="access_code" class="form-control" placeholder="Entrez le code fourni par le ma√Ætre de classe" maxlength="8" style="text-transform: uppercase;">
                        <p class="form-help">Code √† 8 caract√®res fourni par le ma√Ætre de classe</p>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Nom du ma√Ætre de classe</label>
                        <div class="autocomplete-container">
                            <input type="text" name="master_teacher_name" id="join_master_teacher_name" class="form-control" placeholder="Commencez √† taper le nom..." autocomplete="off">
                            <div id="join_master_teacher_suggestions" class="autocomplete-suggestions"></div>
                        </div>
                        <p class="form-help">Pour v√©rifier que vous rejoignez la bonne classe</p>
                    </div>
                    
                    <div class="form-group" id="join_class_selection" style="display: none;">
                        <label class="form-label">Classe √† rejoindre</label>
                        <select name="join_target_classroom_id" id="join_target_classroom_id" class="form-control">
                            <option value="">S√©lectionnez une classe...</option>
                        </select>
                        <p class="form-help">Choisissez la classe du ma√Ætre que vous souhaitez rejoindre</p>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Nom personnalis√© de votre classe</label>
                        <input type="text" name="personal_class_name" class="form-control" placeholder="Ex: 11VG2" required>
                        <p class="form-help">Ce nom sera utilis√© pour toutes vos disciplines de cette classe</p>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Vos disciplines pour cette classe</label>
                        <div id="join_disciplines_container">
                            <!-- La premi√®re discipline -->
                            <div class="discipline-item" data-index="0">
                                <div class="form-row" style="display: flex; gap: 1rem; align-items: flex-end; margin-bottom: 1rem; padding: 1rem; border: 1px solid #e5e7eb; border-radius: 0.375rem;">
                                    <div class="form-group" style="flex: 2; margin: 0;">
                                        <label class="form-label">Mati√®re</label>
                                        <input type="text" name="join_disciplines[0][subject]" class="form-control" placeholder="Ex: Histoire" required>
                                    </div>
                                    <div class="form-group" style="margin: 0;">
                                        <label class="form-label">Couleur</label>
                                        <div class="color-palette-small">
                                            <input type="hidden" name="join_disciplines[0][color]" value="#4F46E5">
                                            <div class="color-preview" style="width: 40px; height: 40px; border-radius: 0.375rem; background-color: #4F46E5; border: 2px solid #e5e7eb; cursor: pointer;" title="Cliquer pour changer"></div>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-danger btn-sm remove-join-discipline" style="margin: 0; height: fit-content;" disabled>
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <button type="button" id="add_join_discipline" class="btn btn-secondary btn-sm">
                            <i class="fas fa-plus"></i> Ajouter une autre discipline
                        </button>
                        <p class="form-help">Ajoutez toutes les mati√®res que vous enseignez pour cette classe</p>
                        <small style="color: #6b7280;">‚ú® Exemple: Histoire, Fran√ßais, G√©ographie (toutes avec le m√™me nom de classe)</small>
                    </div>
                    
                        <div class="modal-footer">
                            <button type="button" class="btn btn-outline-secondary" onclick="closeModal('join-with-code-modal')">
                                <i class="fas fa-times"></i> Annuler
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-link"></i> Rejoindre avec le code
                            </button>
                        </div>
                    </form>
                    </div>
                </div>
            </div>
            
            <!-- Modal pour rejoindre avec invitation -->
            <div class="modal" id="join-with-invitation-modal" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4><i class="fas fa-envelope"></i> Rejoindre avec une invitation</h4>
                        <span class="close" data-modal="join-with-invitation-modal">&times;</span>
                    </div>
                    <div class="modal-body">
                        <p style="font-size: 0.9rem; color: #6b7280; margin-bottom: 1rem;">Si vous n'avez pas de code, envoyez une invitation au ma√Ætre de classe.</p>
                
                <form method="POST" action="{{ url_for('setup.manage_classrooms') }}">
                    {{ form.hidden_tag() }}
                    <input type="hidden" name="action_type" value="invite">
                    
                    <div class="form-group">
                        <label class="form-label">Nom du ma√Ætre de classe</label>
                        <div class="autocomplete-container">
                            <input type="text" name="invite_master_teacher_name" id="invite_master_teacher_name" class="form-control" placeholder="Commencez √† taper le nom..." autocomplete="off">
                            <div id="invite_master_teacher_suggestions" class="autocomplete-suggestions"></div>
                        </div>
                        <p class="form-help">Enseignants de votre √©tablissement qui sont ma√Ætres de classe</p>
                    </div>
                    
                    <div class="form-group" id="target_class_selection" style="display: none;">
                        <label class="form-label">Classe √† rejoindre</label>
                        <select name="target_classroom_id" id="target_classroom_id" class="form-control">
                            <option value="">S√©lectionnez une classe...</option>
                        </select>
                        <p class="form-help">Choisissez la classe du ma√Ætre que vous souhaitez rejoindre</p>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Nom personnalis√© de votre classe</label>
                        <input type="text" name="personal_class_name" class="form-control" placeholder="Ex: 11VG2" required>
                        <p class="form-help">Ce nom sera utilis√© pour toutes vos disciplines de cette classe</p>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Vos disciplines pour cette classe</label>
                        <div id="disciplines_container">
                            <!-- La premi√®re discipline -->
                            <div class="discipline-item" data-index="0">
                                <div class="form-row" style="display: flex; gap: 1rem; align-items: flex-end; margin-bottom: 1rem; padding: 1rem; border: 1px solid #e5e7eb; border-radius: 0.375rem;">
                                    <div class="form-group" style="flex: 2; margin: 0;">
                                        <label class="form-label">Mati√®re</label>
                                        <input type="text" name="disciplines[0][subject]" class="form-control" placeholder="Ex: Histoire" required>
                                    </div>
                                    <div class="form-group" style="margin: 0;">
                                        <label class="form-label">Couleur</label>
                                        <div class="color-palette-small">
                                            <input type="hidden" name="disciplines[0][color]" value="#4F46E5">
                                            <div class="color-preview" style="width: 40px; height: 40px; border-radius: 0.375rem; background-color: #4F46E5; border: 2px solid #e5e7eb; cursor: pointer;" title="Cliquer pour changer"></div>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-danger btn-sm remove-discipline" style="margin: 0; height: fit-content;" disabled>
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <button type="button" id="add_discipline" class="btn btn-secondary btn-sm">
                            <i class="fas fa-plus"></i> Ajouter une autre discipline
                        </button>
                        <p class="form-help">Ajoutez toutes les mati√®res que vous enseignez pour cette classe</p>
                        <small style="color: #6b7280;">‚ú® Exemple: Histoire, Fran√ßais, G√©ographie (toutes avec le m√™me nom de classe)</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Message (optionnel)</label>
                        <textarea name="invite_message" class="form-control" rows="3" placeholder="Expliquez pourquoi vous souhaitez rejoindre cette classe..."></textarea>
                    </div>
                    
                        <div class="modal-footer">
                            <button type="button" class="btn btn-outline-secondary" onclick="closeModal('join-with-invitation-modal')">
                                <i class="fas fa-times"></i> Annuler
                            </button>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-paper-plane"></i> Envoyer la demande
                            </button>
                        </div>
                    </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Liste des classes -->
    <div class="classrooms-list">
        <h2><i class="fas fa-list"></i> Mes classes</h2>
        
        <!-- Classes propres -->
        {% if classrooms %}
            {% for classroom in classrooms %}
            <div class="classroom-item">
                <div class="classroom-info">
                    <div class="classroom-color" style="background-color: {{ classroom.color }};"></div>
                    <div class="classroom-details">
                        <h3>{{ classroom.name }}</h3>
                        <p>{{ classroom.subject }}</p>
                        {% if classroom.mixed_groups_list %}
                            <!-- Afficher les classes sources pour les classes mixtes -->
                            {% set mixed_group = classroom.mixed_groups_list[0] %}
                            <div class="mixed-class-sources" style="font-size: 0.8rem; color: #6b7280; margin-top: 0.25rem;">
                                <i class="fas fa-layer-group" style="margin-right: 0.25rem;"></i>
                                {% if mixed_group.description and mixed_group.description.startswith('SOURCES:') %}
                                    {% set source_names = mixed_group.description[8:].split(',') %}
                                    Sources: {% for source_name in source_names %}{{ source_name.strip() }}{% if not loop.last %}, {% endif %}{% endfor %}
                                {% else %}
                                    {% set source_classrooms = mixed_group.get_classrooms_involved() %}
                                    {% if source_classrooms %}
                                        Sources: {% for src_classroom in source_classrooms %}{{ src_classroom.name }}{% if not loop.last %}, {% endif %}{% endfor %}
                                    {% else %}
                                        Sources: Classes externes ou en attente
                                    {% endif %}
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="classroom-actions" style="display: flex; gap: 0.5rem; align-items: center;">
                    {% if classroom.is_temporary %}
                        <!-- Classe temporaire en attente -->
                        <span class="badge" style="background-color: #fbbf24; color: #92400e; padding: 0.25rem 0.75rem; border-radius: 20px;">
                            <i class="fas fa-clock"></i> En attente d'approbation
                        </span>
                    {% elif classroom.id in all_class_masters %}
                        {% if classroom.id in master_classroom_ids %}
                            <!-- L'utilisateur est d√©j√† ma√Ætre de cette classe -->
                            <button type="button" class="btn btn-info btn-sm master-status" disabled title="Vous √™tes ma√Ætre de cette classe">
                                <i class="fas fa-crown"></i> Vous √™tes ma√Ætre de classe
                            </button>
                        {% else %}
                            <!-- Quelqu'un d'autre est d√©j√† ma√Ætre de cette classe -->
                            {% if all_class_masters[classroom.id].get('is_derived') %}
                                <!-- Classe d√©riv√©e - classe rejointe via collaboration -->
                                <span class="derived-class" title="Classe en collaboration avec: {{ all_class_masters[classroom.id].teacher_name }}">
                                    <i class="fas fa-handshake" style="color: #059669;"></i> 
                                    Collaboration: {{ all_class_masters[classroom.id].teacher_name }}
                                </span>
                            {% else %}
                                <!-- Classe normale avec un autre ma√Ætre -->
                                <span class="existing-master" title="Ma√Ætre de classe: {{ all_class_masters[classroom.id].teacher_name }}">
                                    <i class="fas fa-crown" style="color: #f59e0b;"></i> 
                                    Ma√Ætre: {{ all_class_masters[classroom.id].teacher_name }}
                                </span>
                            {% endif %}
                        {% endif %}
                    {% else %}
                        <!-- Aucun ma√Ætre pour cette classe -->
                        {% if classroom.mixed_groups_list %}
                            <!-- Classe mixte - pas de ma√Ætre, √©tiquette sp√©ciale -->
                            <span class="badge" style="background-color: #8b5cf6; color: white; padding: 0.25rem 0.75rem; border-radius: 20px;">
                                <i class="fas fa-users"></i> Classe mixte
                            </span>
                        {% else %}
                            <!-- Classe normale - permettre de devenir ma√Ætre -->
                            <form method="POST" action="{{ url_for('setup.become_class_master', classroom_id=classroom.id) }}" style="margin: 0;">
                                <button type="submit" class="btn btn-success btn-sm" title="Devenir ma√Ætre de cette classe">
                                    <i class="fas fa-crown"></i> Devenir ma√Ætre
                                </button>
                            </form>
                        {% endif %}
                    {% endif %}
                    
                    <form method="POST" action="{{ url_for('setup.delete_classroom', id=classroom.id) }}" style="margin: 0;">
                        <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('√ätes-vous s√ªr de vouloir supprimer cette classe ?');" title="Supprimer cette classe">
                            <i class="fas fa-trash"></i>
                        </button>
                    </form>
                </div>
            </div>
            {% endfor %}
        {% endif %}
        
        <!-- Classes li√©es (sp√©cialis√©) -->
        {% if linked_classrooms %}
            <h3 style="font-size: 1.1rem; margin-top: 2rem; margin-bottom: 1rem; color: var(--gray-color);">
                <i class="fas fa-link"></i> Classes en collaboration
            </h3>
            {% for item in linked_classrooms %}
            <div class="classroom-item">
                <div class="classroom-info">
                    <div class="classroom-color" style="background-color: {{ item.classroom.color }};"></div>
                    <div class="classroom-details">
                        <h3>{{ item.classroom.name }}</h3>
                        <p>{{ item.classroom.subject }} - Ma√Ætre: {{ item.master_teacher.username }}</p>
                    </div>
                </div>
                
                <span class="badge" style="background-color: #e3f2fd; color: #1565c0; padding: 0.25rem 0.75rem; border-radius: 20px;">
                    <i class="fas fa-handshake"></i> Collaboration
                </span>
            </div>
            {% endfor %}
        {% endif %}
        
        <!-- √âtat vide -->
        {% if not classrooms and not linked_classrooms %}
            <div class="empty-state">
                <i class="fas fa-chalkboard-teacher"></i>
                <p>Aucune classe configur√©e pour le moment.</p>
                <p>Cr√©ez vos propres classes ou rejoignez une classe existante.</p>
            </div>
        {% endif %}
    </div>

    <!-- Section des invitations -->
    {% if received_invitations or sent_invitations %}
    <div class="classrooms-list" style="margin-top: 2rem;">
        <h2><i class="fas fa-envelope"></i> Invitations</h2>
        
        <!-- Invitations re√ßues -->
        {% if received_invitations %}
        <h3 style="font-size: 1.1rem; margin-top: 1rem; margin-bottom: 1rem; color: var(--gray-color);">
            <i class="fas fa-inbox"></i> Invitations re√ßues ({{ received_invitations|length }})
        </h3>
        
        {% for invitation in received_invitations %}
        <div class="classroom-item" style="border-left: 4px solid #10b981;">
            <div class="classroom-info">
                <div class="classroom-color" style="background-color: #10b981;"></div>
                <div class="classroom-details">
                    <h3>{{ invitation.proposed_class_name }}</h3>
                    <p><strong>Mati√®re:</strong> {{ invitation.proposed_subject }}</p>
                    <p><strong>Demandeur:</strong> {{ invitation.requesting_teacher.username }} ({{ invitation.requesting_teacher.email }})</p>
                    {% if invitation.message %}
                    <p><strong>Message:</strong> <em>{{ invitation.message }}</em></p>
                    {% endif %}
                    <small style="color: var(--gray-color);">Re√ßu le {{ invitation.created_at.strftime('%d/%m/%Y √† %H:%M') }}</small>
                </div>
            </div>
            
            <div class="invitation-actions" style="display: flex; flex-direction: column; gap: 0.5rem;">
                <form method="POST" action="{{ url_for('setup.respond_to_invitation', invitation_id=invitation.id) }}" style="margin: 0;">
                    <input type="hidden" name="action" value="accept">
                    <div class="form-group" style="margin-bottom: 0.5rem;">
                        <textarea name="response_message" class="form-control" rows="2" placeholder="Message de r√©ponse (optionnel)" style="font-size: 0.8rem;"></textarea>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button type="submit" class="btn btn-success btn-sm">
                            <i class="fas fa-check"></i> Accepter
                        </button>
                        <button type="button" class="btn btn-danger btn-sm" onclick="rejectInvitation({{ invitation.id }})">
                            <i class="fas fa-times"></i> Rejeter
                        </button>
                    </div>
                </form>
            </div>
        </div>
        {% endfor %}
        {% endif %}
        
        <!-- Invitations envoy√©es -->
        {% if sent_invitations %}
        <h3 style="font-size: 1.1rem; margin-top: 2rem; margin-bottom: 1rem; color: var(--gray-color);">
            <i class="fas fa-paper-plane"></i> Vos demandes envoy√©es
        </h3>
        
        {% for invitation in sent_invitations %}
        <div class="classroom-item" style="border-left: 4px solid {% if invitation.status == 'pending' %}#fbbf24{% elif invitation.status == 'accepted' %}#10b981{% else %}#ef4444{% endif %};">
            <div class="classroom-info">
                <div class="classroom-color" style="background-color: {% if invitation.status == 'pending' %}#fbbf24{% elif invitation.status == 'accepted' %}#10b981{% else %}#ef4444{% endif %};"></div>
                <div class="classroom-details">
                    <h3>{{ invitation.proposed_class_name }}</h3>
                    <p><strong>Destin√© √†:</strong> {{ invitation.target_master_teacher.username }} ({{ invitation.target_master_teacher.email }})</p>
                    <p><strong>Mati√®re:</strong> {{ invitation.proposed_subject }}</p>
                    {% if invitation.response_message %}
                    <p><strong>R√©ponse:</strong> <em>{{ invitation.response_message }}</em></p>
                    {% endif %}
                    <small style="color: var(--gray-color);">Envoy√© le {{ invitation.created_at.strftime('%d/%m/%Y √† %H:%M') }}</small>
                </div>
            </div>
            
            <div class="invitation-status">
                {% if invitation.status == 'pending' %}
                <span class="badge" style="background-color: #fbbf24; color: #92400e; padding: 0.5rem 1rem; border-radius: 20px;">
                    <i class="fas fa-clock"></i> En attente
                </span>
                {% elif invitation.status == 'accepted' %}
                <span class="badge" style="background-color: #10b981; color: white; padding: 0.5rem 1rem; border-radius: 20px;">
                    <i class="fas fa-check"></i> Accept√©e
                </span>
                {% elif invitation.status == 'rejected' %}
                <span class="badge" style="background-color: #ef4444; color: white; padding: 0.5rem 1rem; border-radius: 20px;">
                    <i class="fas fa-times"></i> Rejet√©e
                </span>
                {% endif %}
            </div>
        </div>
        {% endfor %}
        {% endif %}
    </div>
    {% endif %}

    <!-- Boutons de navigation (masqu√©s si on vient du dashboard) -->
    {% if not from_dashboard %}
    <div class="action-buttons" style="margin-top: 2rem;">
        <!-- Bouton gauche : Pauses -->
        <a href="{{ url_for('setup.manage_breaks') }}" class="btn btn-outline">
            <i class="fas fa-coffee"></i> Pauses
        </a>
        
        <!-- Bouton droit : Horaire type -->
        <a href="{{ url_for('schedule.weekly_schedule') }}" class="btn btn-primary">
            Horaire type <i class="fas fa-calendar-week"></i>
        </a>
    </div>
    {% endif %}
</div>

<style>
.btn-sm {
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
}

/* S√©lecteur de couleurs personnalis√© */
.color-palette {
    margin-top: 0.5rem;
}

.color-options {
    display: grid;
    grid-template-columns: repeat(8, 1fr);
    gap: 0.75rem;
    max-width: 400px;
}

.color-option {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    border: 3px solid transparent;
    transition: all 0.2s ease;
    position: relative;
}

.color-option:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

.color-option.active {
    border-color: #333;
    transform: scale(1.15);
    box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.8), 0 4px 12px rgba(0, 0, 0, 0.3);
}

.color-option.active::after {
    content: '‚úì';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-weight: bold;
    font-size: 16px;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
}

/* Responsive pour petits √©crans */
@media (max-width: 600px) {
    .color-options {
        grid-template-columns: repeat(4, 1fr);
        gap: 0.5rem;
    }
    
    .color-option {
        width: 35px;
        height: 35px;
    }
}

/* Styles pour les classes mixtes */
.class-type-selection {
    margin-bottom: 1.5rem;
    padding: 1rem;
    border: 2px solid var(--light-gray);
    border-radius: var(--border-radius);
    transition: border-color 0.3s ease;
}

.class-type-selection.active {
    border-color: var(--primary-color);
    background-color: #f8f9ff;
}

.class-type-options {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
}

.class-type-option {
    flex: 1;
    padding: 1rem;
    border: 2px solid var(--light-gray);
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
    position: relative;
}

.class-type-option:hover {
    border-color: var(--primary-color);
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.class-type-option.selected {
    border-color: var(--primary-color);
    background-color: var(--primary-color);
    color: white;
}

.class-type-option input[type="radio"] {
    position: absolute;
    opacity: 0;
    width: 0;
    height: 0;
}

.class-type-icon {
    font-size: 2rem;
    margin-bottom: 0.5rem;
    display: block;
}

.class-type-title {
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.class-type-desc {
    font-size: 0.875rem;
    opacity: 0.8;
}

.mixed-class-config {
    display: none;
    margin-top: 1.5rem;
    padding: 1.5rem;
    border: 1px solid var(--light-gray);
    border-radius: var(--border-radius);
    background-color: #fafbff;
}

.mixed-class-config.active {
    display: block !important;
    animation: slideDown 0.3s ease;
}

@keyframes slideDown {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

.source-classes-section {
    margin-top: 1.5rem;
}

.source-classes-buttons {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.source-class-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    border: 2px solid var(--light-gray);
    border-radius: var(--border-radius);
    background: white;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    color: var(--dark-color);
}

.source-class-btn:hover {
    border-color: var(--primary-color);
    background-color: #f8f9ff;
    transform: translateY(-1px);
}

.source-class-btn i {
    color: var(--primary-color);
}

.added-source-classes {
    margin-top: 1rem;
}

.source-class-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem;
    margin-bottom: 0.5rem;
    border: 1px solid var(--light-gray);
    border-radius: var(--border-radius);
    background: white;
}

.source-class-info {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.source-class-badge {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background-color: var(--success-color);
}

.source-class-details h4 {
    margin: 0 0 0.25rem 0;
    font-size: 1rem;
}

.source-class-details span {
    font-size: 0.875rem;
    color: var(--gray-color);
}

.source-class-actions {
    display: flex;
    gap: 0.5rem;
}

.student-selection-section {
    display: none;
    margin-top: 2rem;
    padding: 1.5rem;
    border: 1px solid var(--light-gray);
    border-radius: var(--border-radius);
    background: white;
}

.student-selection-section.active {
    display: block;
    animation: slideDown 0.3s ease;
}

.student-group {
    margin-bottom: 2rem;
    border: 1px solid var(--light-gray);
    border-radius: var(--border-radius);
    overflow: hidden;
}

.student-group-header {
    background: var(--light-gray);
    padding: 1rem;
    font-weight: 600;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.student-group-content {
    padding: 1rem;
}

.student-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 0.5rem;
}

.student-checkbox-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem;
    border-radius: var(--border-radius);
    transition: background-color 0.2s;
}

.student-checkbox-item:hover {
    background-color: var(--light-gray);
}

.student-checkbox-item input[type="checkbox"] {
    margin: 0;
}

.group-actions {
    display: flex;
    gap: 0.5rem;
}

.mixed-class-summary {
    margin-top: 1.5rem;
    padding: 1rem;
    background: var(--light-gray);
    border-radius: var(--border-radius);
    text-align: center;
}

.summary-stats {
    display: flex;
    justify-content: center;
    gap: 2rem;
    margin-bottom: 1rem;
}

.summary-stat {
    text-align: center;
}

.summary-stat-number {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--primary-color);
}

.summary-stat-label {
    font-size: 0.875rem;
    color: var(--gray-color);
}

.badge-new {
    background: var(--warning-color);
    color: white;
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    border-radius: 1rem;
    margin-left: 0.5rem;
}

/* Style pour le bouton ma√Ætre d√©sactiv√© */
.btn.master-status[disabled] {
    opacity: 0.9;
    cursor: not-allowed;
    background-color: #17a2b8; /* Bleu turquoise */
    border-color: #17a2b8;
    color: #fff;
}

.btn.master-status[disabled]:hover {
    background-color: #17a2b8;
    border-color: #17a2b8;
}

/* Style pour afficher le ma√Ætre existant */
.existing-master {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    font-size: 0.875rem;
    color: #d97706;
    font-weight: 500;
    padding: 0.375rem 0.75rem;
    background-color: #fef3c7;
    border: 1px solid #f59e0b;
    border-radius: 0.375rem;
}

.existing-master:hover {
    background-color: #fde68a;
}

/* Style pour afficher les classes d√©riv√©es (collaboration) */
.derived-class {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    font-size: 0.875rem;
    color: #059669;
    font-weight: 500;
    padding: 0.375rem 0.75rem;
    background-color: #d1fae5;
    border: 1px solid #10b981;
    border-radius: 0.375rem;
}

.derived-class:hover {
    background-color: #a7f3d0;
}

/* Styles pour l'autocompl√©tion */
.autocomplete-container {
    position: relative;
}

/* Styles pour les checkboxes de classes */
.class-checkbox-item {
    display: flex;
    align-items: center;
    padding: 0.75rem;
    border-bottom: 1px solid #f3f4f6;
    transition: background-color 0.2s;
}

.class-checkbox-item:last-child {
    border-bottom: none;
}

.class-checkbox-item:hover {
    background-color: #f9fafb;
}

.class-checkbox-item input[type="checkbox"] {
    margin-right: 0.75rem;
    transform: scale(1.2);
}

.class-info {
    flex: 1;
}

.class-name {
    font-weight: 600;
    color: #374151;
    margin-bottom: 0.25rem;
}

.class-subjects {
    font-size: 0.875rem;
    color: #6b7280;
}

/* Styles pour les disciplines multiples */
.discipline-item {
    margin-bottom: 0.5rem;
}

.discipline-item .form-row {
    background-color: #f9fafb;
    transition: all 0.2s;
}

.discipline-item .form-row:hover {
    background-color: #f3f4f6;
    border-color: var(--primary-color);
}

.color-palette-small {
    position: relative;
}

.color-preview {
    transition: all 0.2s;
    position: relative;
}

.color-preview:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

.color-options-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 0.375rem;
    padding: 0.5rem;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    z-index: 1000;
    display: none;
    grid-template-columns: repeat(4, 1fr);
    gap: 0.25rem;
    width: 160px;
}

.color-option-small {
    width: 30px;
    height: 30px;
    border-radius: 0.25rem;
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.2s;
}

.color-option-small:hover {
    border-color: #374151;
    transform: scale(1.1);
}

.autocomplete-suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #e5e7eb;
    border-top: none;
    border-radius: 0 0 0.375rem 0.375rem;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    display: none;
}

.autocomplete-suggestion {
    padding: 0.75rem;
    cursor: pointer;
    border-bottom: 1px solid #f3f4f6;
    transition: background-color 0.2s;
}

.autocomplete-suggestion:hover,
.autocomplete-suggestion.active {
    background-color: #f3f4f6;
}

.autocomplete-suggestion:last-child {
    border-bottom: none;
}

.suggestion-name {
    font-weight: 600;
    color: #374151;
}

.suggestion-email {
    font-size: 0.875rem;
    color: #6b7280;
}

.suggestion-badge {
    display: inline-block;
    background-color: #10b981;
    color: white;
    font-size: 0.75rem;
    padding: 0.125rem 0.5rem;
    border-radius: 1rem;
    margin-left: 0.5rem;
}

/* Styles pour les modals */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.modal-content {
    background: white;
    border-radius: var(--border-radius);
    max-width: 600px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid var(--light-gray);
}

.modal-header h4 {
    margin: 0;
    font-size: 1.25rem;
    color: var(--dark-color);
}

.close-modal {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--gray-color);
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.close-modal:hover {
    color: var(--dark-color);
}

.modal-body {
    padding: 1.5rem;
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    padding: 1.5rem;
    border-top: 1px solid var(--light-gray);
}

.close {
    color: #9ca3af;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    background: none;
    border: none;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.2s ease;
}

.close:hover,
.close:focus {
    color: #374151;
    background-color: #f3f4f6;
    text-decoration: none;
}

.class-selection-list {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid var(--light-gray);
    border-radius: var(--border-radius);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Gestionnaire pour tous les s√©lecteurs de couleurs
    document.querySelectorAll('.color-palette').forEach((palette, index) => {
        const colorOptions = palette.querySelectorAll('.color-option');
        const hiddenInput = palette.querySelector('input[type="hidden"]');
        
        if (!hiddenInput) return;
        
        colorOptions.forEach(option => {
            option.addEventListener('click', function() {
                // Retirer la classe active de toutes les options de cette palette
                colorOptions.forEach(opt => opt.classList.remove('active'));
                
                // Ajouter la classe active √† l'option cliqu√©e
                this.classList.add('active');
                
                // Mettre √† jour la valeur de l'input cach√©
                const selectedColor = this.getAttribute('data-color');
                hiddenInput.value = selectedColor;
                
                console.log(`Couleur s√©lectionn√©e pour ${hiddenInput.id}:`, selectedColor);
            });
        });
    });
    
    // Gestionnaire pour les boutons d'options de jointure (modaux)
    const joinWithCodeBtn = document.getElementById('join-with-code-btn');
    const joinWithInvitationBtn = document.getElementById('join-with-invitation-btn');
    
    if (joinWithCodeBtn) {
        joinWithCodeBtn.addEventListener('click', function() {
            openModal('join-with-code-modal');
        });
    }
    
    if (joinWithInvitationBtn) {
        joinWithInvitationBtn.addEventListener('click', function() {
            openModal('join-with-invitation-modal');
        });
    }
    
    // Gestionnaire pour les croix de fermeture des modaux
    document.querySelectorAll('.close').forEach(closeBtn => {
        closeBtn.addEventListener('click', function() {
            const modalId = this.getAttribute('data-modal');
            if (modalId) {
                closeModal(modalId);
            }
        });
    });
    
    // Fermer le modal en cliquant sur l'arri√®re-plan
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal(this.id);
            }
        });
    });
    
    // Fonction d'autocompl√©tion g√©n√©rique
    function setupAutocomplete(inputId, suggestionsId) {
        console.log(`Setting up autocomplete for ${inputId} -> ${suggestionsId}`);
        const input = document.getElementById(inputId);
        const suggestions = document.getElementById(suggestionsId);
        let currentSelection = -1;
        let lastQuery = '';
        
        console.log(`Input found for ${inputId}:`, !!input);
        console.log(`Suggestions found for ${suggestionsId}:`, !!suggestions);
        
        if (!input || !suggestions) {
            console.error(`Missing elements for autocomplete: input=${!!input}, suggestions=${!!suggestions}`);
            return;
        }
        
        let autocompleteTimeout;
        input.addEventListener('input', function() {
            const query = this.value.trim();
            
            // Utiliser un d√©lai pour √©viter les conflits avec la s√©lection de classe
            clearTimeout(autocompleteTimeout);
            autocompleteTimeout = setTimeout(() => {
                if (query.length < 2) {
                    suggestions.style.display = 'none';
                    return;
                }
                
                if (query === lastQuery) return;
                lastQuery = query;
                
                console.log(`Searching teachers for query: "${query}"`);
                fetch('/setup/search-teachers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query: query })
                })
                .then(response => {
                    console.log('Search teachers response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Search teachers data:', data);
                    suggestions.innerHTML = '';
                    currentSelection = -1;
                    
                    if (data.teachers && data.teachers.length > 0) {
                        data.teachers.forEach(teacher => {
                            const div = document.createElement('div');
                            div.className = 'autocomplete-suggestion';
                            div.innerHTML = `
                                <div class="suggestion-name">${teacher.username}${teacher.is_master ? '<span class="suggestion-badge">Ma√Ætre de classe</span>' : ''}</div>
                                <div class="suggestion-email">${teacher.email}</div>
                            `;
                            
                            div.addEventListener('click', function() {
                                input.value = teacher.username;
                                suggestions.style.display = 'none';
                                
                                // Charger les classes de cet enseignant
                                if (input.id === 'invite_master_teacher_name' || input.id === 'join_master_teacher_name') {
                                    console.log('Loading classes for teacher:', teacher.username);
                                    loadTeacherClasses(teacher.id, input.id);
                                }
                            });
                            
                            suggestions.appendChild(div);
                        });
                        
                        suggestions.style.display = 'block';
                    } else {
                        suggestions.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Erreur autocompl√©tion:', error);
                    suggestions.style.display = 'none';
                });
            }, 300); // D√©lai de 300ms pour l'autocompl√©tion
        });
        
        // Gestion clavier
        input.addEventListener('keydown', function(e) {
            const items = suggestions.querySelectorAll('.autocomplete-suggestion');
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                currentSelection = (currentSelection + 1) % items.length;
                updateSelection(items);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                currentSelection = (currentSelection - 1 + items.length) % items.length;
                updateSelection(items);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (currentSelection >= 0 && items[currentSelection]) {
                    items[currentSelection].click();
                }
            } else if (e.key === 'Escape') {
                suggestions.style.display = 'none';
            }
        });
        
        function updateSelection(items) {
            items.forEach((item, index) => {
                item.classList.toggle('active', index === currentSelection);
            });
        }
        
        // Fermer quand on clique ailleurs
        document.addEventListener('click', function(e) {
            if (!input.contains(e.target) && !suggestions.contains(e.target)) {
                suggestions.style.display = 'none';
            }
        });
    }
    
    // Configuration de l'autocompl√©tion pour les formulaires de classe normale
    console.log('Setting up autocomplete for normal class forms...');
    setupAutocomplete('join_master_teacher_name', 'join_master_teacher_suggestions');
    setupAutocomplete('invite_master_teacher_name', 'invite_master_teacher_suggestions');
    
    // Gestion des disciplines pour les formulaires de classe normale
    setupDisciplineManagement();
    
    function setupDisciplineManagement() {
        // Bouton d'ajout de discipline pour le formulaire avec code d'acc√®s
        const addJoinDisciplineBtn = document.getElementById('add_join_discipline');
        if (addJoinDisciplineBtn) {
            addJoinDisciplineBtn.addEventListener('click', function() {
                addDiscipline('join_disciplines_container', 'join_disciplines');
            });
        }
        
        // Bouton d'ajout de discipline pour le formulaire d'invitation
        const addDisciplineBtn = document.getElementById('add_discipline');
        if (addDisciplineBtn) {
            addDisciplineBtn.addEventListener('click', function() {
                addDiscipline('disciplines_container', 'disciplines');
            });
        }
        
        // Configuration initiale des boutons de suppression
        setupRemoveButtons('join_disciplines_container');
        setupRemoveButtons('disciplines_container');
        
        // Configuration des s√©lecteurs de couleur
        setupColorPickers();
    }
    
    function addDiscipline(containerId, prefix) {
        const container = document.getElementById(containerId);
        if (!container) return;
        
        const items = container.querySelectorAll('.discipline-item');
        const nextIndex = items.length;
        
        const newItem = document.createElement('div');
        newItem.className = 'discipline-item';
        newItem.setAttribute('data-index', nextIndex);
        
        // Structure diff√©rente pour join vs invite
        if (prefix === 'join_disciplines') {
            newItem.innerHTML = `
                <div class="form-row" style="display: flex; gap: 1rem; align-items: flex-end; margin-bottom: 1rem; padding: 1rem; border: 1px solid #e5e7eb; border-radius: 0.375rem;">
                    <div class="form-group" style="flex: 2; margin: 0;">
                        <label class="form-label">Mati√®re</label>
                        <input type="text" name="${prefix}[${nextIndex}][subject]" class="form-control" placeholder="Ex: Histoire" required>
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label class="form-label">Couleur</label>
                        <div class="color-palette-small">
                            <input type="hidden" name="${prefix}[${nextIndex}][color]" value="#4F46E5">
                            <div class="color-preview" style="width: 40px; height: 40px; border-radius: 0.375rem; background-color: #4F46E5; border: 2px solid #e5e7eb; cursor: pointer;" title="Cliquer pour changer"></div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-danger btn-sm remove-discipline-btn" style="margin: 0; height: fit-content;">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
        } else {
            // Modal d'invitation - seulement mati√®re + couleur (pas de class_name)
            newItem.innerHTML = `
                <div class="form-row" style="display: flex; gap: 1rem; align-items: flex-end; margin-bottom: 1rem; padding: 1rem; border: 1px solid #e5e7eb; border-radius: 0.375rem;">
                    <div class="form-group" style="flex: 2; margin: 0;">
                        <label class="form-label">Mati√®re</label>
                        <input type="text" name="${prefix}[${nextIndex}][subject]" class="form-control" placeholder="Ex: Histoire" required>
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label class="form-label">Couleur</label>
                        <div class="color-palette-small">
                            <input type="hidden" name="${prefix}[${nextIndex}][color]" value="#4F46E5">
                            <div class="color-preview" style="width: 40px; height: 40px; border-radius: 0.375rem; background-color: #4F46E5; border: 2px solid #e5e7eb; cursor: pointer;" title="Cliquer pour changer"></div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-danger btn-sm remove-discipline-btn" style="margin: 0; height: fit-content;">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
        }
        
        container.appendChild(newItem);
        
        // Configurer le s√©lecteur de couleur pour le nouvel √©l√©ment
        const colorPreview = newItem.querySelector('.color-preview');
        const hiddenInput = newItem.querySelector('input[type="hidden"]');
        setupColorPicker(colorPreview, hiddenInput);
        
        // Configurer le bouton de suppression
        const removeButton = newItem.querySelector('.remove-discipline-btn');
        removeButton.addEventListener('click', function() {
            newItem.remove();
            updateRemoveButtons(containerId);
        });
        
        updateRemoveButtons(containerId);
    }
    
    function setupRemoveButtons(containerId) {
        const container = document.getElementById(containerId);
        if (!container) return;
        
        const removeButtons = container.querySelectorAll('.remove-discipline-btn, .remove-discipline, .remove-join-discipline');
        removeButtons.forEach(button => {
            button.addEventListener('click', function() {
                this.closest('.discipline-item').remove();
                updateRemoveButtons(containerId);
            });
        });
        
        updateRemoveButtons(containerId);
    }
    
    function updateRemoveButtons(containerId) {
        const container = document.getElementById(containerId);
        if (!container) return;
        
        const items = container.querySelectorAll('.discipline-item');
        items.forEach((item, index) => {
            const removeButton = item.querySelector('.remove-discipline-btn, .remove-discipline, .remove-join-discipline');
            if (removeButton) {
                removeButton.disabled = items.length <= 1;
            }
        });
    }
    
    function setupColorPickers() {
        document.querySelectorAll('.color-preview').forEach(preview => {
            const hiddenInput = preview.parentElement.querySelector('input[type="hidden"]');
            if (hiddenInput) {
                setupColorPicker(preview, hiddenInput);
            }
        });
    }
    
    function setupColorPicker(preview, hiddenInput) {
        const colors = [
            '#4F46E5', '#EF4444', '#F59E0B', '#84CC16', 
            '#22C55E', '#06B6D4', '#3B82F6', '#8B5CF6',
            '#EC4899', '#F97316', '#10B981', '#14B8A6',
            '#6366F1', '#A855F7', '#F43F5E', '#FDE047'
        ];
        
        preview.addEventListener('click', function() {
            // Supprimer toute dropdown existante
            document.querySelectorAll('.color-options-dropdown').forEach(dropdown => {
                dropdown.remove();
            });
            
            // Cr√©er la dropdown
            const dropdown = document.createElement('div');
            dropdown.className = 'color-options-dropdown';
            dropdown.style.display = 'grid';
            
            colors.forEach(color => {
                const colorOption = document.createElement('div');
                colorOption.className = 'color-option-small';
                colorOption.style.backgroundColor = color;
                colorOption.title = color;
                
                colorOption.addEventListener('click', function() {
                    hiddenInput.value = color;
                    preview.style.backgroundColor = color;
                    dropdown.remove();
                });
                
                dropdown.appendChild(colorOption);
            });
            
            preview.parentElement.appendChild(dropdown);
            
            // Fermer en cliquant ailleurs
            setTimeout(() => {
                document.addEventListener('click', function closeDropdown(e) {
                    if (!preview.parentElement.contains(e.target)) {
                        dropdown.remove();
                        document.removeEventListener('click', closeDropdown);
                    }
                });
            }, 10);
        });
    }
    
    
    
    // Fermer les dropdowns de couleur quand on clique ailleurs
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.color-palette-small')) {
            document.querySelectorAll('.color-options-dropdown').forEach(dropdown => {
                dropdown.style.display = 'none';
            });
        }
    });
    
    // DEBUG: V√©rifier que les √©l√©ments existent
    console.log('=== DEBUG CLASS TYPE SELECTION ===');
    
    const classTypeOptions = document.querySelectorAll('input[name="class_type"]');
    const mixedClassConfig = document.getElementById('mixed-class-config');
    const normalClassForm = document.getElementById('normal-class-form');
    
    console.log('classTypeOptions found:', classTypeOptions.length);
    console.log('mixedClassConfig found:', !!mixedClassConfig);
    console.log('normalClassForm found:', !!normalClassForm);
    
    // Trouver la section "Rejoindre une classe" avec son ID sp√©cifique
    const joinClassSection = document.getElementById('join-class-section');
    console.log('joinClassSection found:', !!joinClassSection);
    
    // DEBUG: Lister toutes les sections add-classroom-section
    console.log('=== ALL ADD-CLASSROOM-SECTIONS ===');
    document.querySelectorAll('.add-classroom-section').forEach((section, index) => {
        console.log(`Section ${index}:`, section.querySelector('h3') ? section.querySelector('h3').textContent : 'No title');
    });
    
    function updateClassTypeDisplay() {
        console.log('updateClassTypeDisplay called');
        const selectedOption = document.querySelector('input[name="class_type"]:checked');
        console.log('selectedOption:', selectedOption ? selectedOption.value : 'none');
        
        if (!selectedOption) {
            console.log('No selected option found');
            return;
        }
        
        // Mettre √† jour les styles des options
        document.querySelectorAll('.class-type-option').forEach(opt => {
            opt.classList.remove('selected');
        });
        selectedOption.parentElement.classList.add('selected');
        
        // Afficher/masquer les sections appropri√©es
        if (selectedOption.value === 'mixed') {
            console.log('Switching to MIXED class mode');
            if (mixedClassConfig) {
                // D'abord s'assurer que TOUS les parents sont visibles
                const parentSection = mixedClassConfig.closest('.add-classroom-section');
                if (parentSection) {
                    parentSection.style.display = 'block';
                    parentSection.style.visibility = 'visible';
                    console.log('Ensured parent section is visible');
                }
                
                // Puis activer la section mixte
                mixedClassConfig.classList.add('active');
                mixedClassConfig.style.display = 'block';
                mixedClassConfig.style.visibility = 'visible';
                console.log('Added active class to mixedClassConfig');
                
                // R√©initialiser le tracking des groupes d'√©l√®ves pour √©viter les doublons
                studentGroupsByClassGroup = {};
            }
            if (normalClassForm) {
                normalClassForm.style.display = 'none';
                console.log('Hidden normalClassForm');
            }
            if (joinClassSection && joinClassSection !== mixedClassConfig.closest('.add-classroom-section')) {
                joinClassSection.style.display = 'none';
                console.log('Hidden joinClassSection');
            }
        } else {
            console.log('Switching to NORMAL class mode');
            if (mixedClassConfig) {
                mixedClassConfig.classList.remove('active');
                mixedClassConfig.style.display = 'none';
                mixedClassConfig.style.visibility = 'hidden';
                console.log('Removed active class from mixedClassConfig and hidden it');
            }
            if (normalClassForm) {
                normalClassForm.style.display = 'block';
                console.log('Shown normalClassForm');
            }
            if (joinClassSection) {
                joinClassSection.style.display = 'block';
                console.log('Shown joinClassSection');
            }
        }
    }
    
    if (classTypeOptions.length > 0) {
        classTypeOptions.forEach((option, index) => {
            console.log(`Setting up event listener for option ${index}:`, option.value);
            option.addEventListener('change', function() {
                console.log('Change event triggered for:', this.value);
                updateClassTypeDisplay();
            });
            option.addEventListener('click', function() {
                console.log('Click event triggered for:', this.value);
                updateClassTypeDisplay();
            });
        });
        
        // Appliquer l'√©tat initial
        console.log('Applying initial state');
        
        // S'assurer que le panneau classe mixte est cach√© par d√©faut
        if (mixedClassConfig) {
            mixedClassConfig.classList.remove('active');
            mixedClassConfig.style.display = 'none';
            mixedClassConfig.style.visibility = 'hidden';
            console.log('Forced mixed class config to be hidden initially');
        }
        
        updateClassTypeDisplay();
    } else {
        console.error('No class type options found!');
    }
    
    // TEST DIRECT: Forcer l'affichage de la section mixte pour voir si le probl√®me vient du CSS
    console.log('=== MANUAL TEST ===');
    window.testMixedClass = function() {
        console.log('Manual test: showing mixed class section');
        if (mixedClassConfig) {
            mixedClassConfig.style.display = 'block';
            mixedClassConfig.classList.add('active');
            console.log('Forced mixedClassConfig to display');
        }
    };
    console.log('Run testMixedClass() in console to manually show the section');
    
    // Fonction pour charger les classes d'un enseignant
    function loadTeacherClasses(teacherId, inputId) {
        console.log(`Loading classes for teacher ID: ${teacherId}, input: ${inputId}`);
        
        fetch(`/setup/api/teacher-classes/${teacherId}`)
        .then(response => {
            console.log('Teacher classes response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Teacher classes data:', data);
            
            // D√©terminer quel select utiliser selon l'input
            let selectId, containerId;
            if (inputId === 'join_master_teacher_name') {
                selectId = 'join_target_classroom_id';
                containerId = 'join_class_selection';
            } else if (inputId === 'invite_master_teacher_name') {
                selectId = 'target_classroom_id';
                containerId = 'target_class_selection';
            }
            
            const select = document.getElementById(selectId);
            const container = document.getElementById(containerId);
            
            if (select && container) {
                // Vider et remplir le select
                select.innerHTML = '<option value="">S√©lectionnez une classe...</option>';
                
                if (data.classes && data.classes.length > 0) {
                    data.classes.forEach(classroom => {
                        const option = document.createElement('option');
                        option.value = classroom.id;
                        option.textContent = classroom.name + ' - ' + classroom.subject;
                        select.appendChild(option);
                    });
                    
                    // Afficher le conteneur
                    container.style.display = 'block';
                    console.log(`Displayed ${data.classes.length} classes`);
                } else {
                    console.log('No classes found for this teacher');
                    container.style.display = 'none';
                }
            } else {
                console.error('Select or container not found:', selectId, containerId);
            }
        })
        .catch(error => {
            console.error('Error loading teacher classes:', error);
        });
    }
    
    // Fonction pour charger les classes d'un enseignant dans les modaux dynamiques
    function loadTeacherClassesForModal(teacherId, inputElement) {
        console.log(`Loading classes for teacher ID: ${teacherId} in modal`);
        
        fetch(`/setup/api/teacher-classes/${teacherId}`)
        .then(response => {
            console.log('Teacher classes response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Teacher classes data:', data);
            
            // Trouver le select dans le m√™me modal que l'input
            const modal = inputElement.closest('.modal');
            const select = modal.querySelector('select[name="join_target_classroom_id"], select[name="target_classroom_id"]');
            const selectContainer = select ? select.closest('.form-group') : null;
            
            if (select && selectContainer) {
                // Vider les options existantes
                select.innerHTML = '<option value="">S√©lectionnez une classe...</option>';
                
                if (data.classes && data.classes.length > 0) {
                    data.classes.forEach(cls => {
                        const option = document.createElement('option');
                        option.value = cls.id;
                        option.textContent = `${cls.name} - ${cls.subject}`;
                        select.appendChild(option);
                    });
                    
                    // Afficher le conteneur de s√©lection
                    selectContainer.style.display = 'block';
                    console.log(`Displayed ${data.classes.length} classes for teacher`);
                } else {
                    selectContainer.style.display = 'none';
                    console.log('No classes found for this teacher');
                    
                    // Cr√©er un message d'information
                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'alert alert-info';
                    infoDiv.style.marginTop = '1rem';
                    infoDiv.innerHTML = '<i class="fas fa-info-circle"></i> Cet enseignant n\'a pas de classes configur√©es en tant que ma√Ætre de classe.';
                    
                    // Supprimer les anciens messages
                    const oldInfo = modal.querySelector('.alert');
                    if (oldInfo) oldInfo.remove();
                    
                    // Ajouter le nouveau message apr√®s l'input
                    inputElement.closest('.form-group').insertAdjacentElement('afterend', infoDiv);
                }
            } else {
                console.error('Select element not found in modal');
            }
        })
        .catch(error => {
            console.error('Error loading teacher classes:', error);
            
            // Afficher un message d'erreur
            const modal = inputElement.closest('.modal');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-error';
            errorDiv.style.marginTop = '1rem';
            errorDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Erreur lors du chargement des classes.';
            
            // Supprimer les anciens messages
            const oldError = modal.querySelector('.alert');
            if (oldError) oldError.remove();
            
            // Ajouter le message d'erreur
            inputElement.closest('.form-group').insertAdjacentElement('afterend', errorDiv);
        });
    }
    
    // Gestionnaire pour les boutons de classe source
    const sourceClassButtons = document.querySelectorAll('.source-class-btn');
    sourceClassButtons.forEach(button => {
        button.addEventListener('click', function() {
            const modalType = this.dataset.modal;
            handleSourceClassModal(modalType);
        });
    });
    
    // Variables pour g√©rer les classes sources
    let sourceClasses = [];
    let selectedStudents = new Set();
    let allStudents = [];  // Tous les √©l√®ves de toutes les classes sources
    
    // Fonction pour g√©rer les modals de classe source
    function handleSourceClassModal(modalType) {
        switch(modalType) {
            case 'own-classes':
                showOwnClassesModal();
                break;
            case 'code-classes':
                showCodeClassesModal();
                break;
            case 'invite-classes':
                showInviteClassesModal();
                break;
            case 'external-classes':
                showExternalClassesModal();
                break;
        }
    }
    
    // Fonction pour afficher le modal des classes propres
    function showOwnClassesModal() {
        console.log('DEBUG: showOwnClassesModal called');
        // R√©cup√©rer les classes de l'utilisateur
        fetch('/setup/api/own-classes')
            .then(response => response.json())
            .then(data => {
                console.log('DEBUG: API response:', data);
                if (data.classes && data.classes.length > 0) {
                    console.log('DEBUG: Showing modal with', data.classes.length, 'classes');
                    showImprovedClassSelectionModal('Mes classes', data.classes, 'own');
                } else {
                    console.log('DEBUG: No classes found, showing empty state');
                    showEmptyStateModal('Aucune classe trouv√©e', 'Vous n\'avez pas encore de classes cr√©√©es. Cr√©ez d\'abord une classe normale pour pouvoir l\'utiliser dans une classe mixte.');
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                showEmptyStateModal('Erreur', 'Erreur lors de la r√©cup√©ration de vos classes.');
            });
    }
    
    // Fonction pour afficher le modal avec code d'acc√®s
    function showCodeClassesModal() {
        // R√©cup√©rer le token CSRF du formulaire existant
        const csrfToken = document.querySelector('input[name="csrf_token"]').value;
        
        const modal = document.createElement('div');
        modal.className = 'modal';
        
        // Cr√©er le contenu du modal sans template literals pour √©viter les conflits avec Jinja
        const modalContent = document.createElement('div');
        modalContent.className = 'modal-content';
        modalContent.style.maxWidth = '600px';
        
        modalContent.innerHTML = 
            '<div class="modal-header">' +
                '<h4><i class="fas fa-key"></i> Rejoindre avec code d\'acc√®s</h4>' +
                '<button type="button" class="close-modal">&times;</button>' +
            '</div>' +
            '<div class="modal-body">' +
                '<form method="POST" action="/setup/classrooms" id="join-code-form">' +
                    '<input type="hidden" name="csrf_token" value="' + csrfToken + '">' +
                    '<input type="hidden" name="action_type" value="join">' +
                    
                    '<div class="form-group">' +
                        '<label class="form-label">Code d\'acc√®s</label>' +
                        '<input type="text" name="access_code" class="form-control" placeholder="Entrez le code fourni par le ma√Ætre de classe" maxlength="8" style="text-transform: uppercase;" required>' +
                        '<p class="form-help">Code √† 8 caract√®res fourni par le ma√Ætre de classe</p>' +
                    '</div>' +
                    
                    '<div class="form-group">' +
                        '<label class="form-label">Nom du ma√Ætre de classe</label>' +
                        '<div class="autocomplete-container">' +
                            '<input type="text" name="master_teacher_name" class="form-control" placeholder="Commencez √† taper le nom..." autocomplete="off" required>' +
                            '<div class="autocomplete-suggestions"></div>' +
                        '</div>' +
                        '<p class="form-help">Pour v√©rifier que vous rejoignez la bonne classe</p>' +
                    '</div>' +
                    
                    '<div class="form-group" style="display: none;">' +
                        '<label class="form-label">Classe √† rejoindre</label>' +
                        '<select name="join_target_classroom_id" class="form-control">' +
                            '<option value="">S√©lectionnez une classe...</option>' +
                        '</select>' +
                        '<p class="form-help">Choisissez la classe du ma√Ætre que vous souhaitez rejoindre</p>' +
                    '</div>' +
                '</form>' +
            '</div>' +
            '<div class="modal-footer">' +
                '<button type="button" class="btn btn-secondary close-modal">Annuler</button>' +
                '<button type="button" class="btn btn-primary" onclick="addClassAsSource(\'join-code-form\')">' +
                    '<i class="fas fa-plus"></i> Ajouter comme classe source' +
                '</button>' +
            '</div>';
        
        modal.appendChild(modalContent);
        document.body.appendChild(modal);
        
        // Gestionnaire pour fermer le modal
        modal.querySelectorAll('.close-modal').forEach(btn => {
            btn.addEventListener('click', () => {
                if (modal && modal.parentNode) {
                    modal.parentNode.removeChild(modal);
                }
            });
        });
        
        // Fermer le modal en cliquant √† l'ext√©rieur
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                if (modal && modal.parentNode) {
                    modal.parentNode.removeChild(modal);
                }
            }
        });
        
        // Configurer l'autocompl√©tion dans le modal
        setupModalAutocomplete(modal);
    }
    
    // Fonction pour afficher le modal d'invitation
    function showInviteClassesModal() {
        // R√©cup√©rer le token CSRF du formulaire existant
        const csrfToken = document.querySelector('input[name="csrf_token"]').value;
        
        const modal = document.createElement('div');
        modal.className = 'modal';
        
        // Cr√©er le contenu du modal sans template literals pour √©viter les conflits avec Jinja
        const modalContent = document.createElement('div');
        modalContent.className = 'modal-content';
        modalContent.style.maxWidth = '600px';
        
        modalContent.innerHTML = 
            '<div class="modal-header">' +
                '<h4><i class="fas fa-envelope"></i> Envoyer une demande d\'invitation</h4>' +
                '<button type="button" class="close-modal">&times;</button>' +
            '</div>' +
            '<div class="modal-body">' +
                '<p style="font-size: 0.9rem; color: #6b7280; margin-bottom: 1rem;">Si vous n\'avez pas de code, envoyez une invitation au ma√Ætre de classe.</p>' +
                
                '<form method="POST" action="/setup/classrooms" id="invite-form">' +
                    '<input type="hidden" name="csrf_token" value="' + csrfToken + '">' +
                    '<input type="hidden" name="action_type" value="invite">' +
                    
                    '<div class="form-group">' +
                        '<label class="form-label">Nom du ma√Ætre de classe</label>' +
                        '<div class="autocomplete-container">' +
                            '<input type="text" name="invite_master_teacher_name" class="form-control" placeholder="Commencez √† taper le nom..." autocomplete="off" required>' +
                            '<div class="autocomplete-suggestions"></div>' +
                        '</div>' +
                        '<p class="form-help">Enseignants de votre √©tablissement qui sont ma√Ætres de classe</p>' +
                    '</div>' +
                    
                    '<div class="form-group" style="display: none;">' +
                        '<label class="form-label">Classe √† rejoindre</label>' +
                        '<select name="target_classroom_id" class="form-control">' +
                            '<option value="">S√©lectionnez une classe...</option>' +
                        '</select>' +
                        '<p class="form-help">Choisissez la classe du ma√Ætre que vous souhaitez rejoindre</p>' +
                    '</div>' +
                    
                    '<div class="form-group">' +
                        '<label class="form-label">Message (optionnel)</label>' +
                        '<textarea name="invite_message" class="form-control" rows="3" placeholder="Expliquez pourquoi vous souhaitez rejoindre cette classe..."></textarea>' +
                    '</div>' +
                '</form>' +
            '</div>' +
            '<div class="modal-footer">' +
                '<button type="button" class="btn btn-secondary close-modal">Annuler</button>' +
                '<button type="button" class="btn btn-success" onclick="addClassAsSource(\'invite-form\')">' +
                    '<i class="fas fa-plus"></i> Ajouter comme classe source' +
                '</button>' +
            '</div>';
        
        modal.appendChild(modalContent);
        document.body.appendChild(modal);
        
        // Gestionnaire pour fermer le modal
        modal.querySelectorAll('.close-modal').forEach(btn => {
            btn.addEventListener('click', () => {
                if (modal && modal.parentNode) {
                    modal.parentNode.removeChild(modal);
                }
            });
        });
        
        // Fermer le modal en cliquant √† l'ext√©rieur
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                if (modal && modal.parentNode) {
                    modal.parentNode.removeChild(modal);
                }
            }
        });
        
        // Configurer l'autocompl√©tion dans le modal
        setupModalAutocomplete(modal);
    }
    
    // Fonction pour afficher le modal de classe externe
    function showExternalClassesModal() {
        const className = prompt('Nom de la classe externe:');
        if (className) {
            // Ajouter une classe externe (sans √©l√®ves)
            const externalClass = {
                id: 'external_' + Date.now(),
                name: className,
                type: 'external',
                students: []
            };
            addSourceClass(externalClass);
        }
    }
    
    // Fonction pour afficher un modal d'√©tat vide
    function showEmptyStateModal(title, message) {
        const modal = document.createElement('div');
        modal.className = 'modal';
        
        const modalContent = document.createElement('div');
        modalContent.className = 'modal-content';
        modalContent.style.maxWidth = '400px';
        
        modalContent.innerHTML = 
            '<div class="modal-header">' +
                '<h4><i class="fas fa-info-circle"></i> ' + title + '</h4>' +
                '<button type="button" class="close-modal">&times;</button>' +
            '</div>' +
            '<div class="modal-body" style="text-align: center; padding: 2rem;">' +
                '<div style="font-size: 3rem; color: var(--gray-color); margin-bottom: 1rem;">' +
                    '<i class="fas fa-inbox"></i>' +
                '</div>' +
                '<p style="color: var(--gray-color); margin-bottom: 0;">' + message + '</p>' +
            '</div>' +
            '<div class="modal-footer">' +
                '<button type="button" class="btn btn-secondary close-modal">Fermer</button>' +
            '</div>';
        
        modal.appendChild(modalContent);
        document.body.appendChild(modal);
        
        // Gestionnaire pour fermer le modal
        modal.querySelectorAll('.close-modal').forEach(btn => {
            btn.addEventListener('click', () => {
                if (modal && modal.parentNode) {
                    modal.parentNode.removeChild(modal);
                }
            });
        });
        
        // Fermer le modal en cliquant √† l'ext√©rieur
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                if (modal && modal.parentNode) {
                    modal.parentNode.removeChild(modal);
                }
            }
        });
    }
    
    // Fonction pour afficher un modal de s√©lection de classe am√©lior√©
    function showImprovedClassSelectionModal(title, classes, type) {
        console.log('DEBUG: showImprovedClassSelectionModal called with:', title, classes.length, 'classes, type:', type);
        const modal = document.createElement('div');
        modal.className = 'modal';
        
        const modalContent = document.createElement('div');
        modalContent.className = 'modal-content';
        modalContent.style.maxWidth = '600px';
        
        // Cr√©er le header
        const modalHeader = document.createElement('div');
        modalHeader.className = 'modal-header';
        modalHeader.innerHTML = '<h4><i class="fas fa-chalkboard-teacher"></i> ' + title + '</h4><button type="button" class="close-modal">&times;</button>';
        
        // Cr√©er le body
        const modalBody = document.createElement('div');
        modalBody.className = 'modal-body';
        modalBody.style.padding = '1.5rem';
        
        const classList = document.createElement('div');
        classList.className = 'improved-class-selection-list';
        
        // Ajouter les classes avec un design am√©lior√©
        classes.forEach(cls => {
            const classItem = document.createElement('div');
            classItem.className = 'improved-class-item';
            classItem.innerHTML = 
                '<div class="class-item-content">' +
                    '<div class="class-color-indicator" style="background-color: ' + (cls.color || '#4F46E5') + ';"></div>' +
                    '<div class="class-item-info">' +
                        '<div class="class-item-name">' + cls.name + '</div>' +
                        '<div class="class-item-details">' +
                            '<span class="class-subject"><i class="fas fa-book"></i> ' + (cls.subject || 'Mati√®re non sp√©cifi√©e') + '</span>' +
                            '<span class="class-student-count"><i class="fas fa-users"></i> ' + (cls.student_count || 0) + ' √©l√®ves</span>' +
                        '</div>' +
                    '</div>' +
                    '<div class="class-item-checkbox">' +
                        '<input type="checkbox" id="improved_class_' + cls.id + '" value="' + cls.id + '">' +
                        '<label for="improved_class_' + cls.id + '" class="checkbox-label">' +
                            '<i class="fas fa-check"></i>' +
                        '</label>' +
                    '</div>' +
                '</div>';
            
            // Ajouter un gestionnaire de clic pour cocher/d√©cocher la checkbox
            classItem.addEventListener('click', function(e) {
                // Ne pas d√©clencher si on clique sur la checkbox elle-m√™me
                if (e.target.type === 'checkbox' || e.target.tagName === 'LABEL') {
                    return;
                }
                
                const checkbox = this.querySelector('input[type="checkbox"]');
                if (checkbox) {
                    checkbox.checked = !checkbox.checked;
                    console.log('DEBUG: checkbox toggled for class', cls.id, 'checked:', checkbox.checked);
                    
                    // Mettre √† jour l'apparence
                    if (checkbox.checked) {
                        this.classList.add('selected');
                    } else {
                        this.classList.remove('selected');
                    }
                }
            });
            
            classList.appendChild(classItem);
        });
        
        modalBody.appendChild(classList);
        
        // Cr√©er le footer
        const modalFooter = document.createElement('div');
        modalFooter.className = 'modal-footer';
        modalFooter.innerHTML = 
            '<button type="button" class="btn btn-outline-secondary close-modal">Annuler</button>' +
            '<button type="button" class="btn btn-primary" onclick="addSelectedClasses(\'' + type + '\')">Ajouter les classes s√©lectionn√©es</button>';
        
        modalContent.appendChild(modalHeader);
        modalContent.appendChild(modalBody);
        modalContent.appendChild(modalFooter);
        modal.appendChild(modalContent);
        
        document.body.appendChild(modal);
        
        // Gestionnaire pour fermer le modal
        modal.querySelectorAll('.close-modal').forEach(btn => {
            btn.addEventListener('click', () => {
                if (modal && modal.parentNode) {
                    modal.parentNode.removeChild(modal);
                }
            });
        });
        
        // Fermer le modal en cliquant √† l'ext√©rieur
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                if (modal && modal.parentNode) {
                    modal.parentNode.removeChild(modal);
                }
            }
        });
        
        // Gestionnaire pour les clics sur les √©l√©ments de classe
        modal.querySelectorAll('.improved-class-item').forEach(item => {
            item.addEventListener('click', (e) => {
                if (e.target.type !== 'checkbox') {
                    const checkbox = item.querySelector('input[type="checkbox"]');
                    checkbox.checked = !checkbox.checked;
                    item.classList.toggle('selected', checkbox.checked);
                }
            });
        });
        
        // Gestionnaire pour les checkboxes
        modal.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                this.closest('.improved-class-item').classList.toggle('selected', this.checked);
            });
        });
    }
    
    // Fonction pour afficher le modal de s√©lection de classe
    function showClassSelectionModal(title, classes, type) {
        // Cr√©er le modal
        const modal = document.createElement('div');
        modal.className = 'modal';
        
        const modalContent = document.createElement('div');
        modalContent.className = 'modal-content';
        
        // Cr√©er le header
        const modalHeader = document.createElement('div');
        modalHeader.className = 'modal-header';
        modalHeader.innerHTML = '<h4>' + title + '</h4><button type="button" class="close-modal">&times;</button>';
        
        // Cr√©er le body
        const modalBody = document.createElement('div');
        modalBody.className = 'modal-body';
        
        const classList = document.createElement('div');
        classList.className = 'class-selection-list';
        
        // Ajouter les classes
        classes.forEach(cls => {
            const classItem = document.createElement('div');
            classItem.className = 'class-checkbox-item';
            classItem.innerHTML = 
                '<input type="checkbox" id="class_' + cls.id + '" value="' + cls.id + '">' +
                '<label for="class_' + cls.id + '" class="class-info">' +
                    '<div class="class-name">' + cls.name + '</div>' +
                    '<div class="class-subjects">' + (cls.subject || 'Mati√®re non sp√©cifi√©e') + '</div>' +
                '</label>';
            classList.appendChild(classItem);
        });
        
        modalBody.appendChild(classList);
        
        // Cr√©er le footer
        const modalFooter = document.createElement('div');
        modalFooter.className = 'modal-footer';
        modalFooter.innerHTML = 
            '<button type="button" class="btn btn-secondary close-modal">Annuler</button>' +
            '<button type="button" class="btn btn-primary" onclick="addSelectedClasses(\'' + type + '\')">Ajouter</button>';
        
        modalContent.appendChild(modalHeader);
        modalContent.appendChild(modalBody);
        modalContent.appendChild(modalFooter);
        modal.appendChild(modalContent);
        
        document.body.appendChild(modal);
        
        // Gestionnaire pour fermer le modal
        modal.querySelectorAll('.close-modal').forEach(btn => {
            btn.addEventListener('click', () => {
                if (modal && modal.parentNode) {
                    modal.parentNode.removeChild(modal);
                }
            });
        });
        
        // Fermer le modal en cliquant √† l'ext√©rieur
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                if (modal && modal.parentNode) {
                    modal.parentNode.removeChild(modal);
                }
            }
        });
    }
    
    // Fonction pour ajouter les classes s√©lectionn√©es
    function addSelectedClasses(type) {
        console.log('DEBUG: addSelectedClasses called with type:', type);
        
        // V√©rifier tous les modaux disponibles
        const allModals = document.querySelectorAll('.modal');
        console.log('DEBUG: total modals found:', allModals.length);
        
        // Chercher le modal visible
        const visibleModal = Array.from(allModals).find(modal => 
            modal.style.display === 'block' || 
            (!modal.style.display && window.getComputedStyle(modal).display !== 'none')
        );
        
        console.log('DEBUG: visible modal found:', !!visibleModal);
        
        if (!visibleModal) {
            alert('Aucun modal visible trouv√©.');
            return;
        }
        
        // Trouver TOUS les checkboxes dans le modal visible
        const allCheckboxes = visibleModal.querySelectorAll('input[type="checkbox"]');
        console.log('DEBUG: allCheckboxes found:', allCheckboxes.length);
        
        // Filtrer manuellement les checkboxes coch√©es car les checkboxes cach√©es ne sont pas trouv√©es par :checked
        const checkedBoxes = Array.from(allCheckboxes).filter(checkbox => checkbox.checked);
        console.log('DEBUG: checkedBoxes found:', checkedBoxes.length);
        
        // Debug: afficher l'√©tat de toutes les checkboxes
        allCheckboxes.forEach((checkbox, index) => {
            console.log(`DEBUG: checkbox ${index}: id=${checkbox.id}, value=${checkbox.value}, checked=${checkbox.checked}`);
        });
        
        if (checkedBoxes.length === 0) {
            alert('Veuillez s√©lectionner au moins une classe.');
            return;
        }
        
        // Utiliser le modal visible au lieu du premier modal trouv√©
        const modal = visibleModal;
        
        checkedBoxes.forEach(checkbox => {
            const classId = checkbox.value;
            
            // Chercher l'√©l√©ment parent qui contient les informations de la classe
            const classItem = checkbox.closest('.improved-class-item, .class-item');
            
            let className, classSubject;
            
            // D√©terminer le type de modal (am√©lior√© ou simple)
            if (classItem.classList.contains('improved-class-item')) {
                // Modal am√©lior√©
                className = classItem.querySelector('.class-item-name').textContent;
                classSubject = classItem.querySelector('.class-subject').textContent.replace(/.*?\s+/, '').trim();
            } else {
                // Modal simple
                className = classItem.querySelector('.class-name').textContent;
                classSubject = classItem.querySelector('.class-subjects').textContent;
            }
            
            const classInfo = {
                id: classId,
                name: className,
                subject: classSubject,
                type: type
            };
            
            addSourceClass(classInfo);
        });
        
        // Fermer le modal de mani√®re s√©curis√©e
        if (modal && modal.parentNode) {
            modal.parentNode.removeChild(modal);
        }
    }
    
    // Fonction pour ajouter une classe source
    function addSourceClass(classInfo) {
        // V√©rifier si la classe n'est pas d√©j√† ajout√©e
        if (sourceClasses.find(cls => cls.id === classInfo.id)) {
            alert('Cette classe est d√©j√† ajout√©e.');
            return;
        }
        
        sourceClasses.push(classInfo);
        renderSourceClasses();
        
        // R√©cup√©rer les √©l√®ves de la classe selon son type
        if (classInfo.type === 'code_access' || classInfo.type === 'invitation') {
            // Les √©l√®ves sont d√©j√† charg√©s par loadStudentsForSourceClass
            if (classInfo.students && classInfo.students.length > 0) {
                // Ajouter le source_type √† chaque √©l√®ve pour diff√©rencier les sources
                const studentsWithSourceType = classInfo.students.map(student => ({
                    ...student,
                    source_type: classInfo.type  // 'code_access' ou 'invitation'
                }));
                
                // Ajouter les √©l√®ves au global allStudents
                allStudents = allStudents.concat(studentsWithSourceType);
                // Ajouter le groupe d'√©l√®ves √† l'interface avec le type de source
                addStudentGroup(classInfo.id, classInfo.name, studentsWithSourceType, classInfo.type);
            }
        } else if (classInfo.type !== 'external') {
            // Pour les classes "own", utiliser l'ancienne m√©thode
            fetchClassStudents(classInfo.id, classInfo.name);
        }
        
        updateMixedClassSummary();
    }
    
    // Fonction pour afficher les classes sources
    function renderSourceClasses() {
        const container = document.getElementById('added-source-classes');
        container.innerHTML = '';
        
        sourceClasses.forEach(cls => {
            const sourceItem = document.createElement('div');
            sourceItem.className = 'source-class-item';
            sourceItem.setAttribute('data-class-id', cls.id);
            sourceItem.innerHTML = 
                '<div class="source-class-info">' +
                    '<div class="source-class-badge"></div>' +
                    '<div class="source-class-details">' +
                        '<h4>' + cls.name + '</h4>' +
                        '<span>' + cls.subject + '</span>' +
                    '</div>' +
                '</div>' +
                '<div class="source-class-actions">' +
                    '<button type="button" class="btn btn-sm btn-danger" onclick="removeSourceClass(\'' + cls.id + '\')">' +
                        '<i class="fas fa-trash"></i>' +
                    '</button>' +
                '</div>';
            container.appendChild(sourceItem);
        });
    }
    
    // Fonction pour supprimer une classe source
    function removeSourceClass(classId) {
        sourceClasses = sourceClasses.filter(cls => cls.id !== classId);
        renderSourceClasses();
        
        // Supprimer les √©l√®ves de cette classe de la s√©lection
        const classStudents = document.querySelectorAll('#student-groups .student-group[data-class-id="' + classId + '"]');
        classStudents.forEach(group => {
            if (group.parentNode) {
                group.parentNode.removeChild(group);
            }
        });
        
        updateMixedClassSummary();
        
        // Masquer la section de s√©lection si plus de classes
        if (sourceClasses.length === 0) {
            document.getElementById('student-selection-section').classList.remove('active');
            // R√©initialiser le tracking des groupes d'√©l√®ves
            studentGroupsByClassGroup = {};
        }
    }
    
    // Variable globale pour stocker les groupes d'√©l√®ves par class_group
    let studentGroupsByClassGroup = {};
    
    // Fonction pour r√©cup√©rer les √©l√®ves d'une classe
    function fetchClassStudents(classId, className) {
        fetch('/setup/api/class-students/' + classId)
            .then(response => response.json())
            .then(data => {
                if (data.students) {
                    addStudentGroupByClassGroup(classId, className, data.students, data.class_group);
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
            });
    }
    
    // Fonction pour ajouter des √©l√®ves regroup√©s par class_group (√©vite les doublons)
    function addStudentGroupByClassGroup(classId, className, students, classGroup) {
        if (!classGroup) {
            // Fallback pour les classes sans class_group
            addStudentGroup(classId, className, students);
            return;
        }
        
        // Si on a d√©j√† ce class_group, on ne l'ajoute pas √† nouveau
        if (studentGroupsByClassGroup[classGroup]) {
            console.log(`Groupe ${classGroup} d√©j√† affich√©, ignoring duplicate`);
            return;
        }
        
        // Marquer ce class_group comme affich√©
        studentGroupsByClassGroup[classGroup] = true;
        
        // Utiliser le nom du class_group comme titre du groupe
        addStudentGroup(classId, classGroup, students);
    }
    
    // Fonction pour ajouter un groupe d'√©l√®ves
    function addStudentGroup(classId, className, students, sourceType = 'own') {
        const studentGroups = document.getElementById('student-groups');
        const studentSelectionSection = document.getElementById('student-selection-section');
        
        // Afficher la section de s√©lection
        studentSelectionSection.classList.add('active');
        
        // Pour les classes "own", ajouter les √©l√®ves √† allStudents s'ils n'y sont pas d√©j√†
        if (sourceType === 'own') {
            const studentsWithSourceType = students.map(student => ({
                ...student,
                source_type: 'own',
                student_id: student.id,  // Assurer la coh√©rence de l'ID
                source_class_name: className
            }));
            
            // Ajouter seulement les √©l√®ves qui ne sont pas d√©j√† dans allStudents
            studentsWithSourceType.forEach(student => {
                const existingIndex = allStudents.findIndex(s => (s.student_id || s.id) == student.student_id);
                if (existingIndex === -1) {
                    allStudents.push(student);
                }
            });
        }
        
        const studentGroup = document.createElement('div');
        studentGroup.className = 'student-group';
        studentGroup.setAttribute('data-class-id', classId);
        
        const groupHeader = document.createElement('div');
        groupHeader.className = 'student-group-header';
        groupHeader.innerHTML = 
            '<span>' + className + '</span>' +
            '<div class="group-actions">' +
                '<button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllStudents(\'' + classId + '\')">' +
                    'Tout s√©lectionner' +
                '</button>' +
                '<button type="button" class="btn btn-sm btn-outline-secondary" onclick="deselectAllStudents(\'' + classId + '\')">' +
                    'Tout d√©s√©lectionner' +
                '</button>' +
            '</div>';
        
        const groupContent = document.createElement('div');
        groupContent.className = 'student-group-content';
        
        const studentGrid = document.createElement('div');
        studentGrid.className = 'student-grid';
        
        students.forEach(student => {
            const studentItem = document.createElement('div');
            studentItem.className = 'student-checkbox-item';
            studentItem.innerHTML = 
                '<input type="checkbox" id="student_' + student.id + '" value="' + student.id + '" ' +
                       'onchange="updateStudentSelection(\'' + student.id + '\', this.checked)">' +
                '<label for="student_' + student.id + '">' + student.full_name + '</label>';
            studentGrid.appendChild(studentItem);
        });
        
        groupContent.appendChild(studentGrid);
        studentGroup.appendChild(groupHeader);
        studentGroup.appendChild(groupContent);
        studentGroups.appendChild(studentGroup);
        
        updateMixedClassSummary();
    }
    
    // Fonction pour s√©lectionner tous les √©l√®ves d'une classe
    function selectAllStudents(classId) {
        const checkboxes = document.querySelectorAll('#student-groups .student-group[data-class-id="' + classId + '"] input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
            checkbox.checked = true;
            updateStudentSelection(checkbox.value, true);
        });
    }
    
    // Fonction pour d√©s√©lectionner tous les √©l√®ves d'une classe
    function deselectAllStudents(classId) {
        const checkboxes = document.querySelectorAll('#student-groups .student-group[data-class-id="' + classId + '"] input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
            checkbox.checked = false;
            updateStudentSelection(checkbox.value, false);
        });
    }
    
    // Fonction pour mettre √† jour la s√©lection d'√©l√®ves
    function updateStudentSelection(studentId, isSelected) {
        if (isSelected) {
            selectedStudents.add(studentId);
        } else {
            selectedStudents.delete(studentId);
        }
        updateMixedClassSummary();
    }
    
    // Fonction pour mettre √† jour le r√©sum√© de la classe mixte
    function updateMixedClassSummary() {
        const totalStudents = selectedStudents.size;
        const totalClasses = sourceClasses.length;
        
        document.getElementById('total-students').textContent = totalStudents;
        document.getElementById('total-classes').textContent = totalClasses;
        
        // Mettre √† jour les inputs cach√©s - convertir les IDs en objets avec les propri√©t√©s attendues
        const studentsData = Array.from(selectedStudents).map(studentId => {
            // Trouver les d√©tails de l'√©tudiant dans allStudents
            const studentDetails = allStudents.find(s => s.student_id == studentId || s.id == studentId);
            return {
                selected: true,
                student_id: parseInt(studentId),
                source_class_name: studentDetails ? studentDetails.source_class_name : 'Inconnue',
                source_type: studentDetails ? studentDetails.source_type : 'unknown'  // Ajouter le source_type
            };
        });
        
        document.getElementById('selected_students_input').value = JSON.stringify(studentsData);
        document.getElementById('source_classes_input').value = JSON.stringify(sourceClasses);
        
        // Activer/d√©sactiver le bouton de cr√©ation
        const createButton = document.getElementById('create-mixed-class-btn');
        // Une classe mixte n√©cessite au moins 2 classes sources (m√™me avec 0 √©l√®ve pour les classes externes)
        createButton.disabled = totalClasses < 2;
    }
    
    // Fonction pour configurer l'autocompl√©tion dans les modals
    function setupModalAutocomplete(modal) {
        const inputs = modal.querySelectorAll('input[name="master_teacher_name"], input[name="invite_master_teacher_name"]');
        
        inputs.forEach(input => {
            const suggestions = input.nextElementSibling;
            let currentSelection = -1;
            let lastQuery = '';
            
            if (!suggestions) return;
            
            let autocompleteTimeout;
            input.addEventListener('input', function() {
                const query = this.value.trim();
                
                clearTimeout(autocompleteTimeout);
                autocompleteTimeout = setTimeout(() => {
                    if (query.length < 2) {
                        suggestions.style.display = 'none';
                        return;
                    }
                    
                    if (query === lastQuery) return;
                    lastQuery = query;
                    
                    fetch('/setup/search-teachers', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ query: query })
                    })
                    .then(response => response.json())
                    .then(data => {
                        suggestions.innerHTML = '';
                        currentSelection = -1;
                        
                        if (data.teachers && data.teachers.length > 0) {
                            data.teachers.forEach(teacher => {
                                const div = document.createElement('div');
                                div.className = 'autocomplete-suggestion';
                                div.innerHTML = 
                                    '<div class="suggestion-name">' + teacher.username + '</div>' +
                                    '<div class="suggestion-email">' + teacher.email + '</div>';
                                
                                div.addEventListener('click', function() {
                                    input.value = teacher.username;
                                    suggestions.style.display = 'none';
                                    
                                    // Charger les classes de cet enseignant
                                    console.log('Loading classes for teacher from modal:', teacher.username, teacher.id);
                                    loadTeacherClassesForModal(teacher.id, input);
                                });
                                
                                suggestions.appendChild(div);
                            });
                            
                            suggestions.style.display = 'block';
                        } else {
                            suggestions.style.display = 'none';
                        }
                    })
                    .catch(error => {
                        console.error('Erreur:', error);
                        suggestions.style.display = 'none';
                    });
                }, 300);
            });
            
            // G√©rer les touches clavier pour la navigation
            input.addEventListener('keydown', function(e) {
                const suggestionItems = suggestions.querySelectorAll('.autocomplete-suggestion');
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    currentSelection = Math.min(currentSelection + 1, suggestionItems.length - 1);
                    updateSelection();
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    currentSelection = Math.max(currentSelection - 1, -1);
                    updateSelection();
                } else if (e.key === 'Enter' && currentSelection >= 0) {
                    e.preventDefault();
                    suggestionItems[currentSelection].click();
                } else if (e.key === 'Escape') {
                    suggestions.style.display = 'none';
                    currentSelection = -1;
                }
                
                function updateSelection() {
                    suggestionItems.forEach((item, index) => {
                        item.classList.toggle('active', index === currentSelection);
                    });
                }
            });
        });
        
        // Configurer les boutons d'ajout/suppression de disciplines
        const addButtons = modal.querySelectorAll('.add-discipline, .add-join-discipline');
        addButtons.forEach(button => {
            button.addEventListener('click', function() {
                const container = this.parentElement.querySelector('.disciplines-container, .join-disciplines-container');
                addDisciplineToModal(container);
            });
        });
        
        // Configurer les s√©lecteurs de couleur
        const colorPreviews = modal.querySelectorAll('.color-preview');
        colorPreviews.forEach(preview => {
            const hiddenInput = preview.parentElement.querySelector('input[type="hidden"]');
            if (hiddenInput) {
                setupColorPicker(preview, hiddenInput);
            }
        });
    }
    
    // Fonction pour ajouter une discipline dans un modal
    function addDisciplineToModal(container) {
        const items = container.querySelectorAll('.discipline-item');
        const nextIndex = items.length;
        const isJoin = container.classList.contains('join-disciplines-container');
        const prefix = isJoin ? 'join_disciplines' : 'disciplines';
        
        const newItem = document.createElement('div');
        newItem.className = 'discipline-item';
        newItem.setAttribute('data-index', nextIndex);
        
        newItem.innerHTML = 
            '<div class="form-row" style="display: flex; gap: 1rem; align-items: flex-end; margin-bottom: 1rem; padding: 1rem; border: 1px solid #e5e7eb; border-radius: 0.375rem;">' +
                '<div class="form-group" style="flex: 2; margin: 0;">' +
                    '<label class="form-label">Nom de votre classe</label>' +
                    '<input type="text" name="' + prefix + '[' + nextIndex + '][class_name]" class="form-control" placeholder="Ex: 11VG2 - Histoire" required>' +
                '</div>' +
                '<div class="form-group" style="flex: 1; margin: 0;">' +
                    '<label class="form-label">Mati√®re</label>' +
                    '<input type="text" name="' + prefix + '[' + nextIndex + '][subject]" class="form-control" placeholder="Ex: Histoire" required>' +
                '</div>' +
                '<div class="form-group" style="margin: 0;">' +
                    '<label class="form-label">Couleur</label>' +
                    '<div class="color-palette-small">' +
                        '<input type="hidden" name="' + prefix + '[' + nextIndex + '][color]" value="#4F46E5">' +
                        '<div class="color-preview" style="width: 40px; height: 40px; border-radius: 0.375rem; background-color: #4F46E5; border: 2px solid #e5e7eb; cursor: pointer;" title="Cliquer pour changer"></div>' +
                    '</div>' +
                '</div>' +
                '<button type="button" class="btn btn-danger btn-sm ' + (isJoin ? 'remove-join-discipline' : 'remove-discipline') + '" style="margin: 0; height: fit-content;">' +
                    '<i class="fas fa-trash"></i>' +
                '</button>' +
            '</div>';
        
        container.appendChild(newItem);
        
        // Configurer le s√©lecteur de couleur pour le nouvel √©l√©ment
        const colorPreview = newItem.querySelector('.color-preview');
        const hiddenInput = newItem.querySelector('input[type="hidden"]');
        setupColorPicker(colorPreview, hiddenInput);
        
        // Configurer le bouton de suppression
        const removeButton = newItem.querySelector('.btn-danger');
        removeButton.addEventListener('click', function() {
            newItem.remove();
            updateRemoveButtonsInModal(container);
        });
        
        updateRemoveButtonsInModal(container);
    }
    
    // Fonction pour mettre √† jour les boutons de suppression dans un modal
    function updateRemoveButtonsInModal(container) {
        const items = container.querySelectorAll('.discipline-item');
        items.forEach((item, index) => {
            const removeButton = item.querySelector('.btn-danger');
            removeButton.disabled = items.length <= 1;
        });
    }
    
    // Fonction pour ajouter une classe comme source au lieu de cr√©er imm√©diatement
    function addClassAsSource(formId) {
        const form = document.getElementById(formId);
        const modal = form.closest('.modal');
        
        // R√©cup√©rer les donn√©es du formulaire
        const formData = new FormData(form);
        const accessCode = formData.get('access_code');
        const teacherName = formData.get('master_teacher_name') || formData.get('invite_master_teacher_name');
        const targetClassroomId = formData.get('join_target_classroom_id') || formData.get('target_classroom_id');
        const inviteMessage = formData.get('invite_message');
        
        // Validation
        if (formId === 'join-code-form') {
            if (!accessCode || !teacherName || !targetClassroomId) {
                alert('Veuillez remplir tous les champs requis et s√©lectionner une classe.');
                return;
            }
            
            // Valider le code d'acc√®s c√¥t√© serveur
            const validateBtn = modal.querySelector('.btn-primary');
            validateBtn.disabled = true;
            validateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Validation...';
            
            fetch('/setup/api/validate-access-code', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    access_code: accessCode,
                    target_classroom_id: targetClassroomId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (!data.valid) {
                    alert('Erreur: ' + data.error);
                    validateBtn.disabled = false;
                    validateBtn.innerHTML = '<i class="fas fa-plus"></i> Ajouter comme classe source';
                    return;
                }
                
                // Code d'acc√®s valide, continuer avec l'ajout
                proceedWithAddingSource();
            })
            .catch(error => {
                console.error('Erreur lors de la validation:', error);
                alert('Erreur lors de la validation du code d\'acc√®s');
                validateBtn.disabled = false;
                validateBtn.innerHTML = '<i class="fas fa-plus"></i> Ajouter comme classe source';
            });
            
            return; // Arr√™ter ici, proceedWithAddingSource() prendra le relais
            
        } else if (formId === 'invite-form') {
            if (!teacherName || !targetClassroomId) {
                alert('Veuillez s√©lectionner un enseignant et une classe.');
                return;
            }
        }
        
        // Pour les autres types (pas code d'acc√®s), continuer directement
        proceedWithAddingSource();
        
        function proceedWithAddingSource() {
        
        // V√©rifier si cette classe n'est pas d√©j√† ajout√©e avec le m√™me type d'acc√®s
        const currentType = formId === 'join-code-form' ? 'code_access' : 'invitation';
        console.log('DEBUG: Checking for duplicates');
        console.log('Current:', { targetClassroomId, currentType, accessCode, teacherName });
        console.log('Existing sources:', sourceClasses);
        
        const alreadyExists = sourceClasses.some(existingClass => {
            // Pour les classes avec code d'acc√®s ou invitation, v√©rifier la combinaison classe + type
            if (existingClass.target_classroom_id == targetClassroomId && existingClass.type === currentType) {
                // M√™me classe ET m√™me type d'acc√®s = doublon
                if (currentType === 'code_access' && existingClass.access_code === accessCode) {
                    return true; // M√™me classe avec m√™me code d'acc√®s
                }
                if (currentType === 'invitation' && existingClass.teacher_name === teacherName) {
                    return true; // M√™me classe avec invitation au m√™me enseignant
                }
            }
            
            // V√©rifier par ID de classe directe (pour les classes "own")
            if (existingClass.id && existingClass.id == targetClassroomId) {
                return true;
            }
            
            return false;
        });
        
        if (alreadyExists) {
            alert('Cette classe est d√©j√† ajout√©e comme source.');
            document.body.removeChild(modal);
            return;
        }
        
        // Cr√©er un objet classe source
        const sourceClass = {
            id: `${formId}_${targetClassroomId}_${Date.now()}`,
            name: form.querySelector('select[name="join_target_classroom_id"], select[name="target_classroom_id"]').selectedOptions[0].text.split(' - ')[0],
            subject: form.querySelector('select[name="join_target_classroom_id"], select[name="target_classroom_id"]').selectedOptions[0].text.split(' - ')[1] || 'Mati√®re inconnue',
            type: formId === 'join-code-form' ? 'code_access' : 'invitation',
            teacher_name: teacherName,
            target_classroom_id: targetClassroomId,
            access_code: accessCode,
            invite_message: inviteMessage,
            students: [], // Sera rempli quand on charge les √©l√®ves
            pending: true // Indique que c'est en attente
        };
        
        // Si c'est une invitation, l'envoyer r√©ellement au serveur
        if (sourceClass.type === 'invitation') {
            console.log('Sending real invitation to server for:', teacherName);
            
            // Pr√©parer les donn√©es pour l'invitation
            const inviteFormData = new FormData();
            inviteFormData.append('csrf_token', document.querySelector('input[name="csrf_token"]').value);
            inviteFormData.append('action_type', 'invite_mixed');
            inviteFormData.append('mixed_master_teacher_name', teacherName);
            inviteFormData.append('mixed_target_classroom_id', targetClassroomId);
            inviteFormData.append('mixed_invite_message', inviteMessage || 'Invitation pour participer √† une classe mixte.');
            
            // Envoyer l'invitation au serveur
            fetch('/setup/classrooms', {
                method: 'POST',
                body: inviteFormData
            })
            .then(response => {
                if (response.ok) {
                    console.log('Invitation sent successfully');
                    // Continuer avec le chargement des √©l√®ves
                    proceedWithStudentLoading();
                } else {
                    console.error('Error sending invitation');
                    alert('Erreur lors de l\'envoi de l\'invitation. Veuillez r√©essayer.');
                }
            })
            .catch(error => {
                console.error('Error sending invitation:', error);
                alert('Erreur lors de l\'envoi de l\'invitation. Veuillez r√©essayer.');
            });
        } else {
            // Pour les codes d'acc√®s, continuer directement
            proceedWithStudentLoading();
        }
        
        function proceedWithStudentLoading() {
            // Charger les √©l√®ves de cette classe
            loadStudentsForSourceClass(sourceClass, () => {
                console.log('Students loaded for source class:', sourceClass.name, 'Count:', sourceClass.students.length);
                // Ajouter la classe comme source apr√®s avoir charg√© les √©l√®ves
                addSourceClass(sourceClass);
            });
        }
        
        // Fermer le modal
        document.body.removeChild(modal);
        
        // Afficher un message de confirmation
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-info';
        alertDiv.style.position = 'fixed';
        alertDiv.style.top = '20px';
        alertDiv.style.right = '20px';
        alertDiv.style.zIndex = '9999';
        alertDiv.style.maxWidth = '400px';
        alertDiv.innerHTML = `
            <i class="fas fa-info-circle"></i> 
            Classe "${sourceClass.name}" ajout√©e comme source. 
            ${sourceClass.type === 'code_access' ? 'Code d\'acc√®s sauvegard√©.' : 'Invitation pr√©par√©e.'}
        `;
        
        document.body.appendChild(alertDiv);
        
        // Supprimer le message apr√®s 5 secondes
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.parentNode.removeChild(alertDiv);
            }
        }, 5000);
        }
    }
    
    // Fonction pour charger les √©l√®ves d'une classe source
    function loadStudentsForSourceClass(sourceClass, callback) {
        console.log('loadStudentsForSourceClass called for:', sourceClass);
        
        // Pour les classes avec code d'acc√®s ou invitation, on doit r√©cup√©rer les √©l√®ves
        if (sourceClass.type === 'code_access' || sourceClass.type === 'invitation') {
            const targetClassroomId = sourceClass.target_classroom_id;
            console.log('Loading students for target classroom ID:', targetClassroomId);
            
            if (targetClassroomId) {
                // Pr√©parer les donn√©es √† envoyer
                const requestData = {};
                if (sourceClass.access_code) {
                    requestData.access_code = sourceClass.access_code;
                }
                console.log('Sending request with data:', requestData);
                
                fetch(`/setup/api/mixed-class-students/${targetClassroomId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Response from mixed-class-students API:', data);
                    if (data.students) {
                        sourceClass.students = data.students.map(student => ({
                            id: student.id,  // Utilis√© par addStudentGroup
                            student_id: student.id,  // Utilis√© pour la soumission du formulaire
                            full_name: student.full_name,
                            selected: false,
                            source_class_name: sourceClass.name
                        }));
                        console.log(`Loaded ${data.students.length} students for class ${sourceClass.name}:`, data.students);
                    } else if (data.error) {
                        console.error('Error from API:', data.error);
                        sourceClass.students = [];
                    } else {
                        console.warn('No students found for class', sourceClass.name);
                        sourceClass.students = [];
                    }
                    
                    if (callback) callback();
                })
                .catch(error => {
                    console.error('Error loading students for class:', error);
                    sourceClass.students = [];
                    
                    // Afficher un message d'erreur
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-warning';
                    alertDiv.style.position = 'fixed';
                    alertDiv.style.top = '20px';
                    alertDiv.style.right = '20px';
                    alertDiv.style.zIndex = '9999';
                    alertDiv.style.maxWidth = '400px';
                    alertDiv.innerHTML = `
                        <i class="fas fa-exclamation-triangle"></i> 
                        Impossible de charger les √©l√®ves de "${sourceClass.name}". 
                        La classe a √©t√© ajout√©e mais aucun √©l√®ve n'est disponible.
                    `;
                    
                    document.body.appendChild(alertDiv);
                    
                    setTimeout(() => {
                        if (alertDiv.parentNode) {
                            alertDiv.parentNode.removeChild(alertDiv);
                        }
                    }, 5000);
                    
                    if (callback) callback();
                });
            } else {
                console.error('No target classroom ID for source class');
                sourceClass.students = [];
                if (callback) callback();
            }
        } else {
            // Pour les autres types (own, external), les √©l√®ves sont d√©j√† charg√©s ou g√©r√©s ailleurs
            if (callback) callback();
        }
    }
    
    // Rendre les fonctions globales pour les onclick
    window.addSelectedClasses = addSelectedClasses;
    window.removeSourceClass = removeSourceClass;
    window.selectAllStudents = selectAllStudents;
    window.deselectAllStudents = deselectAllStudents;
    window.updateStudentSelection = updateStudentSelection;
    window.addClassAsSource = addClassAsSource;
});

// Fonction pour rejeter une invitation
function rejectInvitation(invitationId) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/setup/invitations/' + invitationId + '/respond';
    
    const actionInput = document.createElement('input');
    actionInput.type = 'hidden';
    actionInput.name = 'action';
    actionInput.value = 'reject';
    
    const messageInput = document.createElement('input');
    messageInput.type = 'hidden';
    messageInput.name = 'response_message';
    messageInput.value = 'Invitation rejet√©e';
    
    form.appendChild(actionInput);
    form.appendChild(messageInput);
    
    document.body.appendChild(form);
    form.submit();
}

// Fonctions pour g√©rer les modaux
function openModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden'; // Emp√™cher le scroll de la page
    }
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = ''; // Restaurer le scroll
    }
}

// Fermer les modaux avec la touche √âchap
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        document.querySelectorAll('.modal').forEach(modal => {
            if (modal.style.display === 'flex') {
                closeModal(modal.id);
            }
        });
    }
});
</script>
{% endblock %}
