{% extends "base.html" %}

{% block title %}Gestion des classes - TeacherPlanner{% endblock %}

{% block extra_css %}
<style>
.manage-classes-container {
    max-width: 1400px;
    margin: 0 auto;
}

.classes-header {
    background-color: var(--white);
    padding: 1.5rem;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-sm);
    margin-bottom: 2rem;
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.header-title {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.header-title h1 {
    margin: 0;
    font-size: 1.75rem;
}

.class-selector {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.class-selector select {
    padding: 0.5rem 1rem;
    border: 1px solid var(--light-gray);
    border-radius: var(--border-radius);
    font-size: 1rem;
    background-color: var(--white);
}

/* Tabs */
.tabs-container {
    border-bottom: 2px solid var(--light-gray);
    margin-bottom: 2rem;
    width: 100%;
}

.tabs {
    display: flex;
    gap: 0;
    width: 100%;
    flex-wrap: nowrap;
}

.tab-button {
    padding: 0.75rem 0.5rem;
    background: none;
    border: none;
    border-bottom: 3px solid transparent;
    color: var(--gray-color);
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    white-space: nowrap;
    flex: 1;
    min-width: 0;
    font-size: 0.75rem;
    text-align: center;
}

.tab-button i {
    margin-right: 0.25rem;
    font-size: 0.8rem;
}

/* Styles pour masquer le texte et ne montrer que l'icône sur les très petits écrans */
@media (max-width: 1000px) {
    .tab-button {
        padding: 0.75rem 0.25rem;
        font-size: 0.7rem;
    }
    
    .tab-button i {
        margin-right: 0.2rem;
    }
}

.tab-button:hover {
    color: var(--primary-color);
}

.tab-button.active {
    color: var(--primary-color);
    border-bottom-color: var(--primary-color);
}

.tab-content {
    display: none;
    animation: fadeIn 0.3s ease;
}

.tab-content.active {
    display: block;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Students section */
.students-section {
    background-color: var(--white);
    padding: 2rem;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-sm);
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.header-actions {
    display: flex;
    gap: 1rem;
}

.section-title {
    font-size: 1.25rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.students-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.student-card {
    background-color: var(--light-gray);
    padding: 1rem;
    border-radius: var(--border-radius);
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.2s ease;
}

.student-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-sm);
}

.student-info {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex: 1;
    min-width: 0;
}

.student-avatar {
    width: 40px;
    height: 40px;
    background-color: var(--primary-color);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
}

.student-details h4 {
    margin: 0;
    font-size: 1rem;
}

.student-details {
    flex: 1;
    min-width: 0;
}

.student-details p {
    margin: 0;
    color: var(--gray-color);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    font-size: clamp(0.65rem, 1.5vw, 0.875rem);
}

.student-actions {
    display: flex;
    gap: 0.5rem;
    flex-shrink: 0;
}

.btn-icon {
    width: 36px;
    height: 36px;
    border: none;
    background-color: transparent;
    color: var(--gray-color);
    border-radius: var(--border-radius);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.btn-icon:hover {
    background-color: var(--light-gray);
    color: var(--primary-color);
}

.btn-icon.danger:hover {
    background-color: #FEE2E2;
    color: var(--danger-color);
}

/* Add student form */
.add-student-form {
    background-color: #F9FAFB;
    padding: 1.5rem;
    border-radius: var(--border-radius);
    border: 2px dashed var(--primary-color);
    margin-bottom: 2rem;
}

.form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
}

/* Grades section */
.grades-section {
    background-color: var(--white);
    padding: 2rem;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-sm);
}

/* Sections par discipline */
.grades-section-by-subject {
    background-color: var(--white);
    padding: 1.5rem;
    margin-bottom: 2rem;
    border-radius: var(--border-radius);
    border: 1px solid var(--light-gray);
}

.subject-title {
    color: var(--primary-color);
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.grades-section-by-subject .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid var(--light-gray);
}

/* Sections par discipline pour les fichiers */
.files-section-by-subject {
    background-color: var(--white);
    padding: 1.5rem;
    margin-bottom: 2rem;
    border-radius: var(--border-radius);
    border: 1px solid var(--light-gray);
}

.files-section-by-subject .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid var(--light-gray);
}

.grades-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.stat-box {
    background-color: var(--light-gray);
    padding: 1.5rem;
    border-radius: var(--border-radius);
    text-align: center;
}

.stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: var(--primary-color);
}

.stat-label {
    font-size: 0.875rem;
    color: var(--gray-color);
}

.grades-table {
    width: 100%;
    background-color: var(--white);
    border-radius: var(--border-radius);
    overflow: hidden;
}

.grades-table table {
    width: 100%;
    border-collapse: collapse;
}

.grades-table th {
    background-color: var(--light-gray);
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    color: var(--dark-color);
}

.grades-table td {
    padding: 1rem;
    border-bottom: 1px solid var(--light-gray);
}

.grades-table tr:hover {
    background-color: #F9FAFB;
}

.grade-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.875rem;
    font-weight: 600;
}

.grade-badge.excellent {
    background-color: #D1FAE5;
    color: #065F46;
}

.grade-badge.good {
    background-color: #DBEAFE;
    color: #1E40AF;
}

.grade-badge.average {
    background-color: #FEF3C7;
    color: #92400E;
}

.grade-badge.poor {
    background-color: #FEE2E2;
    color: #991B1B;
}

/* Files section */
.files-section {
    background-color: var(--white);
    padding: 2rem;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-sm);
}

.header-actions {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.btn-group {
    display: flex;
    gap: 0;
}

.btn-group .btn {
    border-radius: 0;
    border-right-width: 0;
}

.btn-group .btn:first-child {
    border-top-left-radius: var(--border-radius);
    border-bottom-left-radius: var(--border-radius);
}

.btn-group .btn:last-child {
    border-top-right-radius: var(--border-radius);
    border-bottom-right-radius: var(--border-radius);
    border-right-width: 1px;
}

.drop-zone {
    border: 2px dashed var(--primary-color);
    border-radius: var(--border-radius);
    padding: 3rem;
    text-align: center;
    background-color: #F9FAFB;
    margin-bottom: 1rem;
    transition: all 0.3s ease;
}

.drop-zone.active {
    background-color: #DBEAFE;
    border-color: #2563EB;
}

.drop-zone i {
    font-size: 3rem;
    color: var(--primary-color);
    margin-bottom: 1rem;
}

/* Breadcrumb */
.breadcrumb {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    font-size: 0.875rem;
}

.breadcrumb-item {
    color: var(--gray-color);
    text-decoration: none;
    transition: color 0.2s ease;
}

.breadcrumb-item:hover {
    color: var(--primary-color);
}

.breadcrumb-separator {
    color: var(--light-gray);
}

/* File grid */
.file-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.file-item {
    position: relative;
    background-color: var(--light-gray);
    border-radius: var(--border-radius);
    padding: 1rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
    min-height: 140px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.file-item:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-sm);
}

.file-item.folder {
    background-color: #F3F4F6;
}

.item-icon {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
}

.item-icon i {
    display: block;
}

.item-icon img.thumbnail {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: 4px;
}

.item-name {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--dark-color);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    width: 100%;
    margin-bottom: 0.25rem;
}

.item-info {
    font-size: 0.75rem;
    color: var(--gray-color);
}

.item-actions {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    display: flex;
    gap: 0.25rem;
    opacity: 0;
    transition: opacity 0.2s ease;
}

.file-item:hover .item-actions {
    opacity: 1;
}

.action-btn {
    width: 28px;
    height: 28px;
    border: none;
    background-color: var(--white);
    color: var(--gray-color);
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.875rem;
    transition: all 0.2s ease;
    text-decoration: none;
}

.action-btn:hover {
    background-color: var(--primary-color);
    color: white;
}

.action-btn.danger:hover {
    background-color: var(--danger-color);
    color: white;
}

/* Sanctions section */
.sanctions-section {
    background-color: var(--white);
    padding: 2rem;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-sm);
}

.display-mode-selector {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin-bottom: 1rem;
    padding: 1rem;
    background-color: var(--light-gray);
    border-radius: var(--border-radius);
    border: 1px solid var(--light-gray);
    width: 100%;
    max-width: none;
}

.display-mode-selector .form-label {
    margin: 0;
    font-size: 0.875rem;
    color: var(--gray-color);
    font-weight: 600;
}

.radio-group {
    display: flex !important;
    flex-direction: row !important;
    gap: 1.5rem;
    flex-wrap: nowrap !important;
    align-items: center;
    justify-content: flex-start;
}

.radio-option {
    display: flex !important;
    align-items: center;
    gap: 0.5rem;
    white-space: nowrap;
    flex-shrink: 0;
}

.radio-option input[type="radio"] {
    margin: 0;
    width: 16px;
    height: 16px;
    cursor: pointer;
}

.radio-option input[type="radio"]:disabled {
    cursor: not-allowed;
    opacity: 0.5;
}

.radio-option label {
    margin: 0;
    font-size: 0.825rem;
    cursor: pointer;
    user-select: none;
    line-height: 1.2;
}

.radio-option input[type="radio"]:disabled + label {
    color: var(--gray-color);
    cursor: not-allowed;
    opacity: 0.6;
}

.lock-warning {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background-color: #fff3cd;
    color: #856404;
    padding: 0.5rem;
    border-radius: var(--border-radius);
    font-size: 0.75rem;
    border: 1px solid #ffeeba;
}

.lock-warning i {
    color: #ffc107;
}

/* Modal de confirmation */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.modal-content {
    background-color: var(--white);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-lg);
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
}

.modal-header {
    padding: 1.5rem 1.5rem 0 1.5rem;
    border-bottom: 1px solid var(--light-gray);
}

.modal-header h3 {
    margin: 0 0 1rem 0;
    color: var(--dark-color);
    font-size: 1.25rem;
}

.modal-body {
    padding: 1.5rem;
}

.modal-body p {
    margin: 0;
    color: var(--gray-color);
    line-height: 1.5;
}

.modal-footer {
    padding: 0 1.5rem 1.5rem 1.5rem;
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    border-top: 1px solid var(--light-gray);
    margin-top: 1rem;
    padding-top: 1rem;
}

.sanctions-by-subject {
    margin-bottom: 2rem;
}

.sanctions-by-subject .subject-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--primary-color);
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid var(--primary-color);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.sanctions-table-container {
    overflow-x: auto;
    border-radius: var(--border-radius);
    border: 1px solid var(--light-gray);
}

.sanctions-table {
    width: 100%;
    border-collapse: collapse;
    background-color: var(--white);
    min-width: 600px;
}

.sanctions-table th {
    background-color: var(--light-gray);
    padding: 1rem;
    text-align: center;
    font-weight: 600;
    color: var(--dark-color);
    border-bottom: 2px solid var(--primary-color);
    position: sticky;
    top: 0;
    z-index: 1;
}

.sanctions-table th.student-column {
    text-align: left;
    min-width: 200px;
    max-width: 200px;
}

.sanctions-table th.sanction-column {
    min-width: 120px;
    font-size: 0.875rem;
}

.sanctions-table td {
    padding: 0.75rem;
    border-bottom: 1px solid var(--light-gray);
    vertical-align: middle;
}

.sanctions-table tr:hover {
    background-color: #F9FAFB;
}

.student-name {
    font-weight: 500;
    color: var(--dark-color);
    text-align: left;
}

.sanction-count {
    text-align: center;
}

.count-controls {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

.count-btn {
    width: 28px;
    height: 28px;
    border: 1px solid var(--light-gray);
    background-color: var(--white);
    color: var(--gray-color);
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    transition: all 0.2s ease;
}

.count-btn:hover {
    background-color: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
    transform: scale(1.1);
}

.count-btn.decrease:hover {
    background-color: var(--danger-color);
    border-color: var(--danger-color);
}

.count-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

.count-display {
    font-weight: 600;
    font-size: 1.125rem;
    min-width: 30px;
    text-align: center;
    color: var(--dark-color);
    padding: 0.25rem 0.5rem;
    border-radius: var(--border-radius);
    background-color: var(--light-gray);
}

.count-display.warning {
    background-color: #FEF3C7;
    color: #92400E;
}

.count-display.danger {
    background-color: #FEE2E2;
    color: #991B1B;
}

/* Empty states */
.empty-state {
    text-align: center;
    padding: 3rem;
    color: var(--gray-color);
}

.empty-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

.empty-state p {
    margin-bottom: 1rem;
}

/* Responsive */
@media (max-width: 768px) {
    .header-content {
        flex-direction: column;
        gap: 1rem;
    }

    .tabs {
        overflow-x: auto;
    }

    .tab-button {
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
    }
}

/* Styles pour les en-têtes d'évaluations */
.eval-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.5rem;
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 4px;
    transition: background-color 0.2s;
}

.eval-header:hover {
    background-color: rgba(79, 70, 229, 0.05);
}

.eval-column.selected .eval-header {
    background-color: rgba(79, 70, 229, 0.15);
}

.eval-title {
    flex: 1;
    font-weight: 600;
}

.eval-actions {
    display: flex;
    gap: 0.25rem;
    opacity: 0;
    transition: opacity 0.2s;
}

.eval-header:hover .eval-actions {
    opacity: 1;
}

.btn-icon {
    background: none;
    border: none;
    padding: 0.25rem;
    border-radius: 4px;
    cursor: pointer;
    color: var(--gray-color);
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
}

.btn-icon:hover {
    background-color: rgba(79, 70, 229, 0.2);
    color: var(--primary-color);
}

.edit-eval-btn:hover {
    background-color: rgba(239, 68, 68, 0.2);
    color: #ef4444;
}

.delete-eval-btn:hover {
    background-color: rgba(239, 68, 68, 0.2);
    color: #ef4444;
}

/* Ligne de moyennes */
.average-row {
    background-color: rgba(79, 70, 229, 0.05);
    border-top: 2px solid var(--primary-color);
}

.average-row .average-label {
    font-weight: 600;
    color: var(--primary-color);
}

.average-row .average-cell {
    font-weight: 600;
    background-color: rgba(79, 70, 229, 0.1);
}

.class-average {
    background-color: rgba(79, 70, 229, 0.2) !important;
    color: var(--primary-color);
}

/* Styles pour les TA dépliés */
.ta-column {
    background-color: rgba(156, 39, 176, 0.05);
}

.expanded-ta-item {
    background-color: rgba(156, 39, 176, 0.1);
    border-left: 3px solid #9C27B0;
}

.expanded-ta-item .eval-title {
    font-size: 0.875rem;
    font-style: italic;
}

.expand-ta-btn:hover,
.collapse-ta-btn:hover {
    background-color: rgba(156, 39, 176, 0.2);
    color: #9C27B0;
}

/* Styles pour le plan de classe */
.seating-container {
    display: flex;
    gap: 15px;
    height: calc(100vh - 300px);
    min-height: 600px;
}

.seating-toolbar {
    width: 160px;
    background: #f8f9fa;
    border-radius: 8px;
    padding: 12px;
    border: 1px solid #dee2e6;
    overflow-y: auto;
}

.toolbar-section {
    margin-bottom: 20px;
}

.toolbar-section h4 {
    margin-bottom: 10px;
    color: #495057;
    font-size: 0.9rem;
    font-weight: 600;
}

.tool-buttons {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
}

.tool-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
    padding: 10px 8px;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.75rem;
    text-align: center;
}

.tool-btn:hover {
    background: #e3f2fd;
    border-color: #007bff;
    transform: translateY(-1px);
}

.tool-btn i {
    color: #007bff;
    font-size: 1.3em;
}

.control-buttons {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.control-btn {
    padding: 8px 10px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.75rem;
    font-weight: 500;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 5px;
    justify-content: center;
}

.btn-reset {
    background: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
}

.btn-reset:hover {
    background: #ffeaa7;
    transform: translateY(-1px);
}

.btn-save {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.btn-save:hover {
    background: #c3e6cb;
    transform: translateY(-1px);
}

.btn-print {
    background: #e1ecf4;
    color: #0c5460;
    border: 1px solid #b8daff;
}

.btn-print:hover {
    background: #b8daff;
    transform: translateY(-1px);
}

.btn-load-master {
    background: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
}

.btn-load-master:hover {
    background: #ffeaa7;
    transform: translateY(-1px);
}

.seating-main-area {
    display: flex;
    flex: 1;
    gap: 20px;
}

.seating-workspace {
    flex: 1;
    background: white;
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    position: relative;
    min-height: 500px;
    overflow: hidden;
}

.students-sidebar {
    width: 200px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #dee2e6;
    display: flex;
    flex-direction: column;
}

.sidebar-header {
    padding: 12px;
    border-bottom: 1px solid #dee2e6;
    background: white;
    border-radius: 8px 8px 0 0;
}

.sidebar-header h4 {
    margin: 0 0 5px 0;
    color: #495057;
    font-size: 0.9rem;
    font-weight: 600;
}

.students-count {
    color: #6c757d;
    font-size: 0.875rem;
}

.students-labels-container {
    padding: 10px;
    flex: 1;
    overflow-y: auto;
    max-height: 400px;
}

.student-label {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 10px;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    margin-bottom: 6px;
    cursor: grab;
    transition: all 0.2s ease;
    user-select: none;
}

.student-label:hover {
    background: #e3f2fd;
    border-color: #007bff;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,123,255,0.2);
}

.student-label:active {
    cursor: grabbing;
}

.student-label i {
    color: #007bff;
    font-size: 0.8em;
}

.student-label span {
    font-size: 0.75rem;
    font-weight: 500;
    color: #495057;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Éléments du plan de classe */
.seating-element {
    position: absolute;
    background: white;
    border: 2px solid #dee2e6;
    border-radius: 8px;
    cursor: grab;
    user-select: none;
    transition: all 0.2s ease;
}

.seating-element:hover {
    border-color: #007bff;
    box-shadow: 0 4px 8px rgba(0,123,255,0.2);
}

.seating-element.dragging {
    opacity: 0.8;
    z-index: 1000;
    cursor: grabbing;
}

.desk-single {
    width: 100px;
    height: 80px;
    background: #e3f2fd;
    border-color: #007bff;
    position: absolute !important;
    padding: 8px;
}

.desk-double {
    width: 140px;
    height: 80px;
    background: #e8f5e8;
    border-color: #28a745;
    position: absolute !important;
    padding: 8px;
}

.teacher-desk {
    width: 140px;
    height: 80px;
    background: #fff3cd;
    border-color: #ffc107;
    position: absolute !important;
}

.desk-content {
    padding: 6px;
    height: 100%;
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    position: relative;
    box-sizing: border-box;
    min-width: 0;
}

.desk-content i {
    font-size: 1.2em;
    margin-bottom: 4px;
}

.desk-content span {
    font-size: 0.75rem;
    font-weight: 500;
}

.student-slots {
    display: flex;
    gap: 8px; /* Augmentation du gap entre les slots */
    margin-top: 4px;
    width: 100%;
    justify-content: center; /* Centrer les slots */
    flex: 1;
    align-items: center;
}

.student-slot {
    width: 100%;
    min-width: 25px; /* Largeur minimale légèrement augmentée pour les slots vides */
    height: 25px;
    background: rgba(255,255,255,0.9);
    border: 1px dashed #999;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.65rem;
    position: relative;
    margin-top: 2px;
    box-sizing: border-box;
    flex-shrink: 0; /* Empêche la réduction */
}

.student-slot.occupied {
    background: #4caf50 !important;
    border: 1px solid #388e3c !important;
    color: white !important;
}

.student-placed {
    font-size: 0.65rem;
    font-weight: 500;
    white-space: nowrap;
    overflow: visible; /* Permettre l'affichage complet */
    width: 100%;
    height: 100%;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white !important; /* Assurer que le texte est visible sur fond vert */
    background: transparent;
    border: none;
    border-radius: 4px;
    padding: 2px 16px 2px 4px; /* Plus de padding à droite pour le bouton */
    box-sizing: border-box;
    text-align: center;
}

.student-remove, .remove-student {
    position: absolute;
    top: -5px;
    right: -5px;
    width: 16px;
    height: 16px;
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 50%;
    font-size: 0.6rem;
    cursor: pointer;
    display: none;
    z-index: 10;
    line-height: 16px;
    text-align: center;
}

.student-placed:hover .student-remove,
.student-placed:hover .remove-student {
    display: block;
}

.element-delete {
    position: absolute;
    top: -8px;
    right: -8px;
    width: 20px;
    height: 20px;
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 50%;
    font-size: 0.7rem;
    cursor: pointer;
    display: none;
    z-index: 10;
}

.seating-element:hover .element-delete {
    display: block;
}

/* Styles pour l'onglet absences */
.attendance-mini-tabs {
    display: flex;
    margin-bottom: 20px;
    background: #f8f9fa;
    border-radius: 8px;
    padding: 4px;
}

.attendance-mini-tab {
    flex: 1;
    padding: 10px 16px;
    background: transparent;
    border: none;
    border-radius: 6px;
    color: #6c757d;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}

.attendance-mini-tab.active {
    background: white;
    color: #007bff;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.attendance-mini-tab:hover:not(.active) {
    background: rgba(0, 123, 255, 0.05);
    color: #495057;
}

.attendance-content {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.attendance-filters {
    display: grid;
    grid-template-columns: 1fr 1fr auto;
    gap: 15px;
    margin-bottom: 20px;
    align-items: end;
}

.attendance-table-container {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 8px;
}

.attendance-table {
    width: 100%;
    border-collapse: collapse;
    margin: 0;
}

.attendance-table th {
    background: #f8f9fa;
    padding: 12px;
    text-align: left;
    font-weight: 600;
    border-bottom: 2px solid #dee2e6;
    position: sticky;
    top: 0;
    z-index: 1;
}

.attendance-table td {
    padding: 12px;
    border-bottom: 1px solid #e9ecef;
}

.attendance-table tbody tr:hover {
    background: #f8f9fa;
}

.attendance-table tbody tr.absence-row {
    background-color: #ffebee !important;
}

.attendance-table tbody tr.absence-row:hover {
    background-color: #fce4ec !important;
}

.attendance-table tbody tr.late-row {
    background-color: #fff3e0 !important;
}

.attendance-table tbody tr.late-row:hover {
    background-color: #ffe0b2 !important;
}

.badge-absence {
    background: #dc3545;
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.75rem;
}

.badge-late {
    background: #fd7e14;
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.75rem;
}

/* Styles pour le plan de classe */
.seating-container {
    display: flex;
    gap: 20px;
    height: 600px;
}

.seating-toolbar {
    width: 250px;
    background: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    border: 1px solid #dee2e6;
    overflow-y: auto;
}

.seating-workspace {
    flex: 1;
    background: white;
    border: 2px solid #dee2e6;
    border-radius: 8px;
    position: relative;
    overflow: hidden;
    background-image: 
        radial-gradient(circle, #e9ecef 1px, transparent 1px);
    background-size: 20px 20px;
}

.toolbar-section {
    margin-bottom: 25px;
}

.toolbar-section h4 {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 15px;
    color: #495057;
    border-bottom: 1px solid #dee2e6;
    padding-bottom: 8px;
}

.tool-buttons {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 15px;
}

.tool-btn {
    padding: 10px;
    border: 1px solid #dee2e6;
    background: white;
    border-radius: 6px;
    cursor: pointer;
    text-align: center;
    font-size: 0.875rem;
    transition: all 0.2s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
}

.tool-btn:hover {
    background: #e9ecef;
    border-color: #007bff;
}

.tool-btn i {
    font-size: 1.2em;
    color: #007bff;
}

.control-buttons {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.control-btn {
    padding: 8px 12px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.875rem;
    font-weight: 500;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.btn-reset {
    background: #f8d7da;
    color: #721c24;
}

.btn-reset:hover {
    background: #f5c6cb;
}

.btn-save {
    background: #d4edda;
    color: #155724;
}

.btn-save:hover {
    background: #c3e6cb;
}

.students-list {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 10px;
    background: white;
}

/* Éléments déplaçables */
.draggable-element {
    position: absolute;
    cursor: move;
    user-select: none;
    transition: all 0.2s ease;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 500;
    font-size: 0.875rem;
}

.draggable-element:hover {
    transform: scale(1.05);
    z-index: 10;
}

.draggable-element.dragging {
    transform: rotate(5deg);
    z-index: 100;
    opacity: 0.8;
}

/* Types d'éléments */
.desk-single {
    min-width: 80px;
    max-width: 200px;
    width: 80px; /* Largeur par défaut */
    height: 60px;
    background: #e3f2fd;
    border: 2px solid #2196f3;
    color: #1976d2;
}

.desk-double {
    min-width: 70px;
    max-width: 300px;
    width: 70px; /* Largeur par défaut ajustée pour 2 slots de 25px */
    height: 60px;
    background: #f3e5f5;
    border: 2px solid #9c27b0;
    color: #7b1fa2;
}

.teacher-desk {
    width: 140px;
    height: 80px;
    background: #fff3e0;
    border: 2px solid #ff9800;
    color: #f57c00;
    font-weight: 600;
}

.student-label {
    width: 100px;
    height: 30px;
    background: #e8f5e8;
    border: 2px solid #4caf50;
    color: #2e7d32;
    font-size: 0.75rem;
    border-radius: 15px;
}

.student-label.placed {
    background: #c8e6c9;
    border-color: #388e3c;
}

/* Zone de drop */
.drop-zone {
    position: absolute;
    border: 2px dashed #007bff;
    background: rgba(0, 123, 255, 0.1);
    border-radius: 4px;
    display: none;
}

.drop-zone.active {
    display: block;
}

/* Styles d'impression */
@media print {
    @page {
        size: landscape;
        margin: 10mm;
    }
    
    /* Styles pour l'impression - permettre plusieurs pages */
    html, body {
        width: 100% !important;
        height: auto !important;
        margin: 0 !important;
        padding: 0 !important;
        overflow: visible !important;
        background: white !important;
    }
    
    /* Règles spécifiques pour l'impression du plan de classe */
    body.printing-seating-plan * {
        visibility: hidden !important;
    }
    
    /* Rendre visible seulement le workspace et son contenu pour le plan de classe */
    body.printing-seating-plan .seating-workspace,
    body.printing-seating-plan .seating-workspace *,
    body.printing-seating-plan #print-title,
    body.printing-seating-plan #print-title * {
        visibility: visible !important;
    }
    
    /* Masquer spécifiquement le message d'aide même s'il est dans le workspace */
    body.printing-seating-plan #seating-help,
    body.printing-seating-plan #seating-help * {
        visibility: hidden !important;
        display: none !important;
    }
    
    /* Positionner le workspace - décalé vers la droite pour le plan de classe */
    body.printing-seating-plan .seating-workspace {
        position: fixed !important;
        top: 0 !important;
        left: 15% !important;
        width: 80% !important;
        height: 100% !important;
        margin: 0 !important;
        padding: 50px 20px 20px 20px !important;
        border: none !important;
        background: white !important;
        background-image: none !important;
        box-shadow: none !important;
        overflow: visible !important;
        display: block !important;
        transform: none !important;
    }
    
    /* Titre d'impression */
    #print-title {
        position: absolute !important;
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        text-align: center !important;
        margin: 0 !important;
        padding: 0 0 10px 0 !important;
        z-index: 1000 !important;
    }
    
    #print-title h2 {
        color: #333 !important;
        font-size: 1.2rem !important;
        margin: 0 !important;
        font-family: Arial, sans-serif !important;
        font-weight: bold !important;
    }
    
    /* Éléments du plan de classe - préserver leur position absolue */
    .seating-element {
        position: absolute !important;
        border: 2px solid !important;
        border-radius: 8px !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2) !important;
    }
    
    /* Tables et slots */
    .student-slot {
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        border: 1px solid #999 !important;
        border-radius: 4px !important;
        background: rgba(255,255,255,0.9) !important;
    }
    
    .student-slot.occupied {
        background: #4caf50 !important;
        border-color: #388e3c !important;
    }
    
    /* Noms des étudiants */
    .student-placed {
        font-size: 0.75rem !important;
        font-weight: 600 !important;
        color: white !important;
        text-align: center !important;
        line-height: 1.2 !important;
    }
    
    /* Masquer les boutons de suppression */
    .remove-student {
        display: none !important;
    }
    
    /* Bureau du professeur */
    .teacher-desk {
        font-weight: 700 !important;
        text-align: center !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
    }
}

/* ===== STYLES POUR LES GROUPES ===== */
.groups-container {
    padding: 1rem;
}

.groups-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1rem;
}

.group-card {
    background: white;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
    padding: 1rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    transition: all 0.2s;
}

.group-card:hover {
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    transform: translateY(-1px);
}

.group-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.75rem;
}

.group-info h3 {
    margin: 0;
    font-size: 1.1rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.group-color-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid white;
    box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.1);
}

.group-actions {
    display: flex;
    gap: 0.25rem;
}

.group-actions button {
    padding: 0.25rem 0.5rem;
    border: none;
    background: transparent;
    color: #6b7280;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
}

.group-actions button:hover {
    background: #f3f4f6;
    color: #374151;
}

.group-description {
    color: #6b7280;
    font-size: 0.875rem;
    margin-bottom: 0.75rem;
}

.group-students {
    display: flex;
    flex-wrap: wrap;
    gap: 0.25rem;
}

.student-tag {
    background: #f3f4f6;
    color: #374151;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
}

.students-selection {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    padding: 0.5rem;
}

.students-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 0.5rem;
}

.student-checkbox {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.2s;
}

.student-checkbox:hover {
    background: #f3f4f6;
}

.student-checkbox input[type="checkbox"] {
    margin: 0;
}

.color-picker input[type="color"] {
    width: 100%;
    height: 40px;
    padding: 0;
    border: 1px solid #e5e7eb;
    border-radius: 4px;
    cursor: pointer;
}

.empty-groups {
    text-align: center;
    color: #9ca3af;
    padding: 2rem;
}

/* Ajustements spécifiques pour le modal de groupes */
#groupModal .modal-dialog {
    max-width: 1200px; /* Augmentation de 200% par rapport à la largeur standard (~600px) */
    width: 90%;
}

#groupModal .modal-content {
    width: 100%;
}

/* Élargir la zone de description */
#groupDescription {
    min-height: 100px;
    width: 100%;
}

/* Élargir la zone de sélection des élèves */
.students-selection {
    max-height: 400px; /* Augmenté pour plus de confort */
    overflow-y: auto;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    padding: 1rem; /* Augmenté le padding */
}

.students-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); /* Colonnes plus étroites pour plus d'éléments */
    gap: 0.75rem; /* Espacement légèrement augmenté */
}

.student-checkbox {
    padding: 0.75rem; /* Padding augmenté pour plus de confort */
}

/* Styles pour les aménagements */
.accommodations-section {
    padding: 1rem;
}

.student-accommodations-card {
    transition: box-shadow 0.2s ease;
}

.student-accommodations-card:hover {
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}

.accommodation-item {
    transition: all 0.2s ease;
}

.accommodation-item:hover {
    background-color: #f3f4f6 !important;
}

.radio-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.radio-option {
    display: flex;
    align-items: center;
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 0.25rem;
    transition: background-color 0.2s ease;
}

.radio-option:hover {
    background-color: #f9fafb;
}

.radio-option input[type="radio"] {
    margin-right: 0.5rem;
}

.checkbox-option {
    display: flex;
    align-items: center;
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 0.25rem;
    transition: background-color 0.2s ease;
}

.checkbox-option:hover {
    background-color: #f9fafb;
}

.checkbox-option input[type="checkbox"] {
    margin-right: 0.5rem;
}

.form-row {
    display: flex;
    gap: 0.5rem;
    align-items: start;
}

/* Student Report Styles */
.student-report-section {
    background-color: var(--white);
    padding: 1.5rem;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-sm);
}

.student-selector-container {
    margin-bottom: 2rem;
    padding: 1rem;
    background-color: #f8f9fa;
    border-radius: var(--border-radius);
}

.student-report-content {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.report-section {
    background-color: #f8f9fa;
    padding: 1.5rem;
    border-radius: var(--border-radius);
    border-left: 4px solid var(--primary-color);
}

.report-section-title {
    margin: 0 0 1rem 0;
    font-size: 1.1rem;
    color: var(--primary-color);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.report-info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.info-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.info-item label {
    font-weight: 600;
    color: #374151;
    font-size: 0.875rem;
}

.info-item span {
    color: #111827;
    font-size: 1rem;
}

.accommodations-list, .grades-list, .sanctions-list, .attendance-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.accommodation-item, .grade-item, .sanction-item, .attendance-item {
    padding: 0.75rem;
    background-color: var(--white);
    border-radius: var(--border-radius);
    border: 1px solid #e5e7eb;
    border-left: 3px solid #e5e7eb;
}

/* Sanctions */
.sanction-item.own-sanction {
    border-left-color: var(--primary-color);
    background-color: #f0f9ff;
}

.sanction-item.other-sanction {
    border-left-color: #f59e0b;
    background-color: #fefbf2;
}

.sanction-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.25rem;
}

.sanction-teacher {
    font-size: 0.75rem;
    color: #059669;
    font-weight: 600;
    margin-left: 1rem;
}

/* Absences */
.attendance-item.own-attendance {
    border-left-color: var(--primary-color);
    background-color: #f0f9ff;
}

.attendance-item.other-attendance {
    border-left-color: #f59e0b;
    background-color: #fefbf2;
}

.attendance-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.25rem;
}

.attendance-teacher {
    font-size: 0.75rem;
    color: #059669;
    font-weight: 600;
    margin-left: 1rem;
}

.accommodation-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    border-left: 3px solid #e5e7eb;
}

.accommodation-item.own-accommodation {
    border-left-color: var(--primary-color);
    background-color: #f0f9ff;
}

.accommodation-item.other-accommodation {
    border-left-color: #f59e0b;
    background-color: #fefbf2;
}

.accommodation-content {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.accommodation-teacher {
    font-size: 0.75rem;
    color: #059669;
    font-weight: 600;
    margin-left: 1.5rem;
}

/* Behavior Summary Table */
.behavior-summary {
    background: white;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid #e5e7eb;
}

.behavior-table {
    width: 100%;
    border-collapse: collapse;
}

.behavior-table th {
    background: #4f46e5;
    color: white;
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    font-size: 0.875rem;
}

.behavior-table td {
    padding: 0.875rem 1rem;
    border-bottom: 1px solid #f3f4f6;
    vertical-align: top;
}

.behavior-table tr:last-child td {
    border-bottom: none;
}

.behavior-table tr.own-data {
    background-color: #f0f9ff;
}

.behavior-table tr.other-data {
    background-color: #fefbf2;
}

.teacher-name {
    font-weight: 600;
    color: #374151;
}

.teacher-name.own {
    color: var(--primary-color);
}

.teacher-name.other {
    color: #f59e0b;
}

.sanctions-summary {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    align-items: center;
}

.sanction-badge {
    background: #fef3c7;
    color: #92400e;
    padding: 0.25rem 0.5rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.sanction-badge.own {
    background: #dbeafe;
    color: #1e40af;
}

.absences-summary {
    display: flex;
    flex-wrap: wrap;
    gap: 0.375rem;
    align-items: center;
}

.absence-badge {
    background: #fee2e2;
    color: #dc2626;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
}

.absence-badge.late {
    background: #fef3c7;
    color: #d97706;
}

.absence-badge.own {
    background: #dbeafe;
    color: #1e40af;
}

.summary-count {
    font-weight: 700;
    font-size: 1.1rem;
}

.summary-count.sanctions {
    color: #dc2626;
}

.summary-count.absences {
    color: #d97706;
}

.summary-count.own {
    color: var(--primary-color);
}

.behavior-empty {
    text-align: center;
    padding: 2rem;
    color: #6b7280;
    font-style: italic;
}

.teachers-summary {
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
}

.teachers-summary .teacher-name {
    font-size: 0.875rem;
    padding: 0.25rem 0;
}

/* Styles d'impression pour le rapport d'élève */
@media print {
    /* === IMPRESSION DU RAPPORT D'ÉLÈVE === */
    /* Masquer la navigation et l'interface pour le rapport */
    nav, .navbar, .header, .sidebar,
    .main-sidebar, .tabs, .tab-content,
    button:not(.debug-keep),
    .student-selector-container,
    .classes-header,
    .header-content,
    .header-title,
    .class-selector,
    .upload-progress,
    #classUploadProgress {
        display: none !important;
    }
    
    /* Afficher explicitement le contenu du rapport d'élève */
    body:not(.printing-seating-plan) #student-report-tab,
    body:not(.printing-seating-plan) #student-report-content,
    body:not(.printing-seating-plan) .student-report-section,
    body:not(.printing-seating-plan) .report-section,
    body:not(.printing-seating-plan) .print-header,
    body:not(.printing-seating-plan) .print-footer,
    body:not(.printing-seating-plan) #report-sanctions-summary,
    body:not(.printing-seating-plan) #report-attendance-summary,
    body:not(.printing-seating-plan) .behavior-summary,
    body:not(.printing-seating-plan) .behavior-table,
    body:not(.printing-seating-plan) .sanction-badge,
    body:not(.printing-seating-plan) .absence-badge,
    body:not(.printing-seating-plan) .teacher-name,
    body:not(.printing-seating-plan) #student-additional-info,
    body:not(.printing-seating-plan) .additional-info-container,
    body:not(.printing-seating-plan) .info-history-container,
    body:not(.printing-seating-plan) .info-history-item {
        display: block !important;
        visibility: visible !important;
    }
    
    /* Style de l'en-tête d'impression */
    .print-header {
        background: #f0f0f0 !important;
        border: 1px solid #333 !important;
        padding: 6px !important;
        margin: 0 0 8px 0 !important;
        text-align: center !important;
        page-break-after: avoid !important;
    }
    
    .print-header h1 {
        color: #000 !important;
        font-size: 16px !important;
        margin: 0 !important;
        line-height: 1.2 !important;
    }
    
    /* Styles de base pour l'impression */
    body {
        font-size: 11px !important;
        line-height: 1.3 !important;
        margin: 0 !important;
        padding: 10px !important;
        background: white !important;
        color: black !important;
    }
    
    /* Optimiser l'espace pour le contenu du rapport */
    #student-report-content {
        margin-top: 0 !important;
        padding-top: 0 !important;
    }
    
    /* Style simple pour les sections */
    .report-section {
        border: 1px solid #ccc !important;
        margin: 5px 0 !important;
        padding: 6px !important;
        page-break-inside: avoid !important;
    }
    
    .report-section-title {
        font-weight: bold !important;
        margin-bottom: 4px !important;
        border-bottom: 1px solid #ddd !important;
        padding-bottom: 2px !important;
        font-size: 12px !important;
    }
    
    .print-header .student-info {
        font-size: 11px !important;
        color: #666 !important;
        margin: 5px 0 !important;
    }
    
    /* Informations générales en colonnes */
    .report-info-grid {
        display: grid !important;
        grid-template-columns: repeat(3, 1fr) !important;
        gap: 4px !important;
        font-size: 9px !important;
    }
    
    .info-item {
        margin-bottom: 2px !important;
    }
    
    .info-item strong {
        font-weight: bold !important;
        color: #333 !important;
    }
    
    /* Tableaux compacts */
    .behavior-table {
        width: 100% !important;
        border-collapse: collapse !important;
        font-size: 8px !important;
        margin: 2px 0 !important;
        page-break-inside: avoid !important;
    }
    
    .behavior-table th {
        background: #f5f5f5 !important;
        color: #333 !important;
        font-weight: bold !important;
        padding: 4px !important;
        border: 1px solid #ccc !important;
        font-size: 9px !important;
    }
    
    .behavior-table td {
        padding: 3px 4px !important;
        border: 1px solid #ddd !important;
        vertical-align: top !important;
    }
    
    /* Badges et éléments visuels */
    .sanction-badge, .absence-badge {
        display: inline-block !important;
        padding: 1px 4px !important;
        margin: 1px !important;
        border: 1px solid #ccc !important;
        border-radius: 3px !important;
        font-size: 8px !important;
        background: #f9f9f9 !important;
        color: #333 !important;
    }
    
    .sanction-badge.own, .absence-badge.own {
        background: #e3f2fd !important;
        border-color: #1976d2 !important;
    }
    
    .teacher-name {
        font-size: 9px !important;
        font-weight: bold !important;
    }
    
    .teacher-name.own {
        color: #1976d2 !important;
    }
    
    .teacher-name.other {
        color: #f57c00 !important;
    }
    
    /* Optimisation espace */
    .accommodations-list, .grades-list, .sanctions-list, .attendance-list {
        gap: 3px !important;
    }
    
    .accommodation-item, .grade-item, .sanction-item, .attendance-item {
        padding: 4px !important;
        margin: 2px 0 !important;
        border: 1px solid #ddd !important;
        border-radius: 0 !important;
        font-size: 9px !important;
    }
    
    /* Informations supplémentaires */
    .info-history-item {
        border: 1px solid #ddd !important;
        padding: 4px !important;
        margin: 3px 0 !important;
        font-size: 9px !important;
    }
    
    .info-history-header {
        font-weight: bold !important;
        font-size: 8px !important;
        color: #666 !important;
    }
    
    /* Gestion optimisée des sauts de page */
    .student-report-content {
        page-break-inside: auto;
    }
    
    /* Éviter les coupures à l'intérieur des éléments importants */
    .behavior-table,
    .report-section,
    .info-history-item,
    .additional-info-container {
        page-break-inside: avoid !important;
    }
    
    /* Optimiser l'espace après les titres */
    .report-section-title {
        page-break-after: avoid !important;
    }
    
    /* Afficher les éléments vides avec un style discret */
    .behavior-empty {
        display: block !important;
        font-style: italic !important;
        color: #666 !important;
        font-size: 8px !important;
        text-align: center !important;
        padding: 4px !important;
    }
    
    /* Masquer les boutons dans les informations supplémentaires */
    .additional-info-container button,
    .additional-info-container .btn {
        display: none !important;
    }
    
    /* Convertir le textarea en texte pour l'impression */
    #student-additional-info {
        border: 1px solid #ddd !important;
        background: #f9f9f9 !important;
        resize: none !important;
        min-height: 30px !important;
        font-size: 9px !important;
        padding: 4px !important;
        width: 100% !important;
        overflow: visible !important;
    }
    
    /* Date d'impression - position optimisée */
    .print-footer {
        position: fixed;
        bottom: 5px;
        right: 10px;
        font-size: 7px;
        color: #666;
    }
    
    /* Configuration de page pour impression sur plusieurs pages */
    @page {
        size: A4 portrait;
        margin: 15mm 10mm 15mm 10mm;
    }
    
    /* Permettre la pagination normale */
    html, body {
        max-height: none !important;
        height: auto !important;
    }
    
    /* DEBUG: Forcer l'affichage de la section informations supplémentaires */
    body.debug-print .report-section,
    body.debug-print .additional-info-container,
    body.debug-print #student-additional-info {
        border: 2px solid red !important;
        background: yellow !important;
        display: block !important;
        visibility: visible !important;
        min-height: 40px !important;
    }
}

.grade-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-left: 3px solid #e5e7eb;
}

.grade-item.own-grade {
    border-left-color: var(--primary-color);
    background-color: #f0f9ff;
}

.grade-item.other-grade {
    border-left-color: #f59e0b;
    background-color: #fefbf2;
}

.grade-subject {
    color: #6b7280;
    font-size: 0.9em;
    margin-left: 0.5rem;
}

.grade-teacher {
    color: #059669;
    font-weight: 600;
}

/* Styles pour le tableau des notes */
.grades-table-container {
    overflow-x: auto;
    border-radius: var(--border-radius);
    border: 1px solid #e5e7eb;
}

.grades-table {
    width: 100%;
    border-collapse: collapse;
    background: var(--white);
}

.grades-table th {
    background-color: #f9fafb;
    padding: 0.75rem;
    text-align: left;
    font-weight: 600;
    color: #374151;
    border-bottom: 2px solid #e5e7eb;
}

.grades-table td {
    padding: 0.75rem;
    border-bottom: 1px solid #e5e7eb;
    vertical-align: top;
}

.grades-table tr.own-subject {
    background-color: #f0f9ff;
}

.grades-table tr.other-subject {
    background-color: #fefbf2;
}

.subject-name {
    min-width: 120px;
    font-size: 0.95em;
}

.teacher-name {
    min-width: 100px;
    color: #059669;
    font-size: 0.9em;
}

.evaluations-cell {
    width: 100%;
}

.evaluations-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.evaluation-item {
    background: var(--white);
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    padding: 0.5rem;
    min-width: 100px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
}

.evaluation-item:hover {
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    transform: translateY(-1px);
}

.evaluation-item.own-evaluation {
    border-left: 3px solid var(--primary-color);
}

.evaluation-item.other-evaluation {
    border-left: 3px solid #f59e0b;
}

.evaluation-name {
    font-size: 0.8em;
    font-weight: 600;
    color: #374151;
    margin-bottom: 0.25rem;
}

.evaluation-score {
    font-size: 1em;
    font-weight: bold;
    color: var(--primary-color);
    margin-bottom: 0.25rem;
}

.evaluation-date {
    font-size: 0.7em;
    color: #6b7280;
}

.additional-info-container {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.student-files-container {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.file-upload-area {
    display: flex;
    gap: 0.5rem;
    align-items: center;
    padding: 1rem;
    border: 2px dashed #d1d5db;
    border-radius: var(--border-radius);
    background-color: var(--white);
}

.files-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.file-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    background-color: var(--white);
    border-radius: var(--border-radius);
    border: 1px solid #e5e7eb;
}

.file-item .file-info {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.file-item .file-actions {
    display: flex;
    gap: 0.25rem;
}

.info-history-container {
    border-top: 1px solid #e5e7eb;
    padding-top: 1rem;
}

.info-history-title {
    font-size: 1rem;
    margin-bottom: 0.75rem;
    color: #374151;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.info-history-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    max-height: 300px;
    overflow-y: auto;
}

.info-history-item {
    padding: 0.75rem;
    background-color: var(--white);
    border-radius: var(--border-radius);
    border: 1px solid #e5e7eb;
    border-left: 3px solid var(--primary-color);
}

.info-history-item.own-info {
    border-left-color: var(--primary-color);
    background-color: #f0f9ff;
}

.info-history-item.other-info {
    border-left-color: #f59e0b;
    background-color: #fefbf2;
}

.info-history-item .info-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.info-history-item .info-date {
    font-size: 0.75rem;
    color: #6b7280;
    font-weight: 600;
}

.info-history-item .info-teacher {
    font-size: 0.75rem;
    color: #059669;
    font-weight: 600;
}

.info-history-item .info-content {
    color: #111827;
    white-space: pre-wrap;
    line-height: 1.4;
}

/* Styles pour les justifications côté enseignant */
.justifications-teacher-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    max-height: 600px;
    overflow-y: auto;
}

.justification-teacher-card {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 1rem;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    transition: all 0.2s ease;
}

.justification-teacher-card:hover {
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.justification-teacher-card[data-status="pending"] {
    border-left: 4px solid #f59e0b;
}

.justification-teacher-card[data-status="approved"] {
    border-left: 4px solid #10b981;
}

.justification-teacher-card[data-status="rejected"] {
    border-left: 4px solid #ef4444;
}

.justification-teacher-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
}

.student-info h4 {
    margin: 0;
    color: #111827;
    font-size: 1rem;
    font-weight: 600;
    display: inline-block;
}

.absence-date {
    color: #6b7280;
    font-size: 0.875rem;
    font-weight: 500;
    margin-left: 0.75rem;
}

.status-select {
    padding: 0.375rem 0.5rem;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    background-color: white;
    font-size: 0.75rem;
    color: #374151;
    cursor: pointer;
}

.status-select:disabled {
    background-color: #f9fafb;
    color: #6b7280;
    cursor: not-allowed;
}

.justification-teacher-details {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.5rem 1rem;
}

.detail-row {
    display: flex;
    align-items: flex-start;
    gap: 0.5rem;
    font-size: 0.875rem;
}

.detail-row strong {
    color: #374151;
    font-weight: 600;
    font-size: 0.8rem;
    min-width: 60px;
}

.detail-row:has(.teacher-response-input) {
    grid-column: 1 / -1;
}

.detail-row.meta {
    grid-column: 1 / -1;
    padding-top: 0.5rem;
    margin-top: 0.5rem;
    border-top: 1px solid #e5e7eb;
}

.period-tag-teacher {
    display: inline-block;
    background: #3b82f6;
    color: white;
    padding: 0.125rem 0.375rem;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: 600;
    margin-right: 0.25rem;
}

.file-link {
    color: #3b82f6;
    text-decoration: none;
    font-size: 0.875rem;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
}

.file-link:hover {
    text-decoration: underline;
}

.teacher-response-input {
    width: 100%;
    min-height: 40px;
    padding: 0.375rem 0.5rem;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    font-size: 0.8rem;
    font-family: inherit;
    resize: vertical;
}

.teacher-response-input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
}

.detail-row.meta {
    padding-top: 0.5rem;
    border-top: 1px solid #e5e7eb;
}

.text-muted {
    color: #6b7280;
}

/* Styles pour l'onglet enseignants */
.teachers-container {
    margin-top: 1rem;
}

.teachers-list {
    display: grid;
    gap: 1rem;
}

.teacher-card {
    background-color: var(--white);
    border: 1px solid var(--light-gray);
    border-radius: var(--border-radius);
    padding: 1.5rem;
    box-shadow: var(--shadow-sm);
    transition: box-shadow 0.3s ease;
}

.teacher-card:hover {
    box-shadow: var(--shadow-md);
}

.teacher-card.current-user {
    border-color: var(--primary-color);
    background-color: #f8f9ff;
}

.teacher-info {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.teacher-name {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.teacher-name i {
    color: var(--primary-color);
}

.teacher-email {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--text-secondary);
}

.teacher-email i {
    color: var(--text-muted);
}

.teacher-email a {
    color: var(--primary-color);
    text-decoration: none;
}

.teacher-email a:hover {
    text-decoration: underline;
}

.teacher-subjects {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--text-secondary);
}

.teacher-subjects i {
    color: var(--text-muted);
}

.badge {
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.badge-primary {
    background-color: var(--primary-color);
    color: var(--white);
}

/* Styles pour les indicateurs de notes collaborateurs */
.specialized-notes-indicator {
    background-color: #e3f2fd;
    color: #1976d2;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    font-weight: 500;
    margin-left: 0.5rem;
}

.readonly-indicator {
    background-color: #fff3e0;
    color: #f57c00;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.subject-title {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 0.5rem;
}

</style>
{% endblock %}

{% block content %}
<div class="manage-classes-container">
    <!-- En-tête -->
    <div class="classes-header">
        <div class="header-content">
            <div class="header-title">
                <h1><i class="fas fa-users"></i> Gestion des classes</h1>
            </div>
            <div class="class-selector">
                <label for="classSelect">Classe :</label>
                <select id="classSelect" onchange="changeClass(this.value)">
                    {% for group in class_groups %}
                        <option value="{{ group.name }}" {% if group.name == selected_class_group %}selected{% endif %}>
                            {% if group.get('has_class_master', false) %}👑 {% endif %}{{ group.name }}
                            {% if group.is_multi_subject %}
                                ({{ group.subjects|join(', ') }})
                            {% else %}
                                - {{ group.subjects[0] }}
                            {% endif %}
                        </option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs-container">
            <div class="tabs">
                <button class="tab-button active" onclick="showTab('students')">
                    <i class="fas fa-user-graduate"></i> Élèves
                </button>
                <button class="tab-button" onclick="showTab('student-report')">
                    <i class="fas fa-file-alt"></i> Rapport élève
                </button>
                <button class="tab-button" onclick="showTab('grades')">
                    <i class="fas fa-clipboard-check"></i> Notes
                </button>
                <button class="tab-button" onclick="showTab('files')">
                    <i class="fas fa-folder-open"></i> Fichiers
                </button>
                <button class="tab-button" onclick="showTab('sanctions')">
                    <i class="fas fa-exclamation-triangle"></i> Coches
                </button>
                <button class="tab-button" onclick="showTab('attendance')">
                    <i class="fas fa-calendar-check"></i> Absences
                </button>
                <button class="tab-button" onclick="showTab('seating')">
                    <i class="fas fa-th"></i> Plan de classe
                </button>
                <button class="tab-button" onclick="showTab('groups')">
                    <i class="fas fa-users"></i> Groupes
                </button>
                <button class="tab-button" onclick="showTab('accommodations')">
                    <i class="fas fa-universal-access"></i> Aménagements
                </button>
                {% if show_teachers_tab %}
                <button class="tab-button" onclick="showTab('teachers')">
                    <i class="fas fa-chalkboard-teacher"></i> Enseignants
                </button>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Contenu des onglets -->
    <!-- Onglet Élèves -->
    <div id="students-tab" class="tab-content active">
        <div class="students-section">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-user-graduate"></i> Liste des élèves
                </h2>
                <div class="header-actions">
                    {% if not is_mixed_group_class and can_manage_access_codes %}
                    <button class="btn btn-secondary" onclick="generateClassCode()">
                        <i class="fas fa-key"></i> Code d'accès pour élèves
                    </button>
                    {% endif %}
                    {% if not is_mixed_group_class %}
                    <button class="btn btn-primary" onclick="toggleAddStudentForm()">
                        <i class="fas fa-plus"></i> Ajouter un élève
                    </button>
                    {% else %}
                    <button class="btn btn-primary" onclick="toggleAddMixedGroupStudentForm()">
                        <i class="fas fa-plus"></i> Ajouter un élève
                    </button>
                    {% endif %}
                </div>
            </div>

            {% if not is_mixed_group_class %}
            {% if is_specialized_teacher %}
            <!-- Liste déroulante pour enseignants spécialisés -->
            <div id="addStudentForm" class="add-student-form" style="display: none;">
                <h3>Ajouter un élève de la classe du maître</h3>
                <form id="studentSelectForm">
                    <div class="form-group">
                        <label class="form-label">Sélectionner un élève</label>
                        <select class="form-control" id="masterStudentSelect" required>
                            <option value="">-- Choisir un élève --</option>
                            {% for student in available_students %}
                            <option value="{{ student.id }}">{{ student.full_name }}{% if student.email %} ({{ student.email }}){% endif %}</option>
                            {% endfor %}
                        </select>
                        {% if not available_students %}
                        <small style="color: var(--gray-color); font-size: 0.75rem;">Tous les élèves de la classe du maître sont déjà ajoutés</small>
                        {% endif %}
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary" {% if not available_students %}disabled{% endif %}>
                            <i class="fas fa-plus"></i> Ajouter l'élève
                        </button>
                        <button type="button" class="btn btn-outline" onclick="toggleAddStudentForm()">
                            Annuler
                        </button>
                    </div>
                </form>
            </div>
            {% else %}
            <!-- Formulaire d'ajout d'élève pour maîtres de classe -->
            <div id="addStudentForm" class="add-student-form" style="display: none;">
                <h3>Nouvel élève</h3>
                <form id="studentForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Prénom <span style="color: var(--danger-color);">*</span></label>
                            <input type="text" class="form-control" id="studentFirstName" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Nom de famille</label>
                            <input type="text" class="form-control" id="studentLastName">
                            <small style="color: var(--gray-color); font-size: 0.75rem;">Obligatoire uniquement si un élève a déjà ce prénom</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email élève (optionnel)</label>
                            <input type="email" class="form-control" id="studentEmail">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Email mère (optionnel)</label>
                            <input type="email" class="form-control" id="parentEmailMother" placeholder="exemple@mail.com">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email père (optionnel)</label>
                            <input type="email" class="form-control" id="parentEmailFather" placeholder="exemple@mail.com">
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Enregistrer
                        </button>
                        <button type="button" class="btn btn-outline" onclick="toggleAddStudentForm()">
                            Annuler
                        </button>
                    </div>
                </form>
            </div>
            {% endif %}
            {% endif %}

            <!-- Formulaire pour ajouter des élèves aux groupes mixtes -->
            {% if is_mixed_group_class %}
            <div id="addMixedGroupStudentForm" class="add-student-form" style="display: none;">
                <h3>Ajouter des élèves au groupe mixte</h3>
                <p class="form-description">Sélectionnez des élèves parmi les classes sources disponibles :</p>
                
                <div id="availableStudentsContainer">
                    <div class="loading-message">
                        <i class="fas fa-spinner fa-spin"></i> Chargement des élèves disponibles...
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-primary" onclick="addSelectedMixedGroupStudents()" id="addSelectedBtn" disabled>
                        <i class="fas fa-plus"></i> Ajouter les élèves sélectionnés
                    </button>
                    <button type="button" class="btn btn-outline" onclick="toggleAddMixedGroupStudentForm()">
                        Annuler
                    </button>
                </div>
            </div>
            {% endif %}

            <!-- Liste des élèves -->
            {% if students %}
            <div class="students-grid">
                {% for student in students %}
                <div class="student-card" id="student-{{ student.id }}">
                    <div class="student-info">
                        <div class="student-avatar">
                            {{ student.first_name[0] }}{{ student.last_name[0] if student.last_name else '' }}
                        </div>
                        <div class="student-details">
                            <h4>{{ student.full_name }}</h4>
                            {% if student.email %}
                            <p>{{ student.email }}</p>
                            {% endif %}
                        </div>
                    </div>
                    <div class="student-actions">
                        {% if not is_mixed_group_class %}
                            {% if can_edit_students %}
                            <button class="btn-icon" title="Modifier" onclick="editStudent({{ student.id }})">
                                <i class="fas fa-edit"></i>
                            </button>
                            {% endif %}
                            <button class="btn-icon danger" title="Supprimer" onclick="deleteStudent({{ student.id }}, '{{ student.full_name }}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        {% else %}
                            <button class="btn-icon danger" title="Supprimer du groupe mixte" onclick="deleteMixedGroupStudent({{ student.id }}, '{{ student.full_name }}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <i class="fas fa-user-graduate"></i>
                {% if is_mixed_group_class %}
                <p>Aucun élève dans ce groupe mixte</p>
                <p style="font-size: 0.875rem;">Les élèves doivent être ajoutés depuis la page de gestion des groupes mixtes</p>
                {% else %}
                <p>Aucun élève dans cette classe</p>
                <button class="btn btn-primary" onclick="toggleAddStudentForm()">
                    <i class="fas fa-plus"></i> Ajouter le premier élève
                </button>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Onglet Rapport élève -->
    <div id="student-report-tab" class="tab-content">
        <div class="student-report-section">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-file-alt"></i> Rapport d'élève
                </h2>
                <button id="print-report-btn" class="btn btn-secondary" onclick="printStudentReport()" style="display: none;">
                    <i class="fas fa-print"></i> Imprimer le rapport
                </button>
            </div>

            <!-- Sélection d'élève -->
            <div class="student-selector-container">
                <div class="form-group">
                    <label for="report-student-select">Sélectionner un élève :</label>
                    <select id="report-student-select" class="form-control" onchange="loadStudentReport()">
                        <option value="">-- Choisir un élève --</option>
                    </select>
                </div>
            </div>

            <!-- Rapport de l'élève -->
            <div id="student-report-content" class="student-report-content" style="display: none;">
                <!-- Informations générales -->
                <div class="report-section">
                    <h3 class="report-section-title">
                        <i class="fas fa-user"></i> Informations générales
                    </h3>
                    <div class="report-info-grid">
                        <div class="info-item">
                            <label>Prénom :</label>
                            <span id="report-first-name"></span>
                        </div>
                        <div class="info-item">
                            <label>Nom :</label>
                            <span id="report-last-name"></span>
                        </div>
                        <div class="info-item">
                            <label>Email élève :</label>
                            <span id="report-email"></span>
                        </div>
                        <div class="info-item">
                            <label>Email mère :</label>
                            <span id="report-parent-email-mother"></span>
                        </div>
                        <div class="info-item">
                            <label>Email père :</label>
                            <span id="report-parent-email-father"></span>
                        </div>
                        <div class="info-item">
                            <label>Groupes :</label>
                            <span id="report-groups"></span>
                        </div>
                    </div>
                </div>

                <!-- Aménagements -->
                <div class="report-section">
                    <h3 class="report-section-title">
                        <i class="fas fa-universal-access"></i> Aménagements
                    </h3>
                    <div id="report-accommodations" class="accommodations-list">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <!-- Notes -->
                <div class="report-section">
                    <h3 class="report-section-title">
                        <i class="fas fa-clipboard-check"></i> Notes
                    </h3>
                    <div id="report-grades" class="grades-list">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <!-- Coches/Sanctions -->
                <div class="report-section">
                    <h3 class="report-section-title">
                        <i class="fas fa-exclamation-triangle"></i> Coches
                    </h3>
                    <div id="report-sanctions-summary" class="behavior-summary">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <!-- Absences -->
                <div class="report-section">
                    <h3 class="report-section-title">
                        <i class="fas fa-calendar-check"></i> Absences
                    </h3>
                    <div id="report-attendance-summary" class="behavior-summary">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <!-- Informations supplémentaires -->
                <div class="report-section">
                    <h3 class="report-section-title">
                        <i class="fas fa-sticky-note"></i> Informations supplémentaires
                    </h3>
                    <div class="additional-info-container">
                        <textarea id="student-additional-info" class="form-control" rows="4" placeholder="Ajouter des informations sur cet élève..."></textarea>
                        <button class="btn btn-primary mt-2" onclick="saveAdditionalInfo()">
                            <i class="fas fa-save"></i> Enregistrer
                        </button>
                    </div>
                    
                    <!-- Historique des informations -->
                    <div class="info-history-container mt-3">
                        <h4 class="info-history-title">
                            <i class="fas fa-history"></i> Historique des informations
                        </h4>
                        <div id="student-info-history" class="info-history-list">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Fichiers associés -->
                <div class="report-section">
                    <h3 class="report-section-title">
                        <i class="fas fa-folder-open"></i> Fichiers associés
                    </h3>
                    <div class="student-files-container">
                        <div class="file-upload-area">
                            <input type="file" id="student-file-input" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                            <button class="btn btn-secondary" onclick="uploadStudentFile()">
                                <i class="fas fa-upload"></i> Ajouter un fichier
                            </button>
                        </div>
                        <div id="student-files-list" class="files-list">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Onglet Notes -->
    <div id="grades-tab" class="tab-content">
        <div class="grades-section">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-clipboard-check"></i> Gestion des notes
                </h2>
            </div>

            <!-- Statistiques -->
            <div class="grades-stats">
                <div class="stat-box">
                    <div class="stat-value">{{ students|length }}</div>
                    <div class="stat-label">Élèves</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value">{{ recent_grades|length }}</div>
                    <div class="stat-label">Évaluations</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value">-</div>
                    <div class="stat-label">Moyenne classe</div>
                </div>
            </div>

            <!-- Sections par discipline -->
            {% if grades_by_subject %}
                {% for subject, subject_data in grades_by_subject.items() %}
                <div class="grades-section-by-subject" data-subject="{{ subject }}">
                    <div class="section-header">
                        <h3 class="subject-title">
                            <i class="fas fa-book"></i> {{ subject }}
                            {% if subject_data.get('has_specialized_grades', false) %}
                                <span class="specialized-notes-indicator">
                                    <i class="fas fa-eye"></i> Inclus notes collaborateurs
                                </span>
                            {% endif %}
                        </h3>
                        {% if subject_data.get('is_editable', true) %}
                            <button class="btn btn-primary btn-sm" onclick="showNewEvaluationModal('{{ subject_data.classroom.id }}')">
                                <i class="fas fa-plus"></i> Nouvelle évaluation
                            </button>
                        {% else %}
                            <span class="readonly-indicator">
                                <i class="fas fa-lock"></i> Lecture seule
                            </span>
                        {% endif %}
                    </div>
                    
                    <div id="evaluationsContainer-{{ subject_data.classroom.id }}" class="evaluations-container">
                        <!-- Les évaluations seront chargées dynamiquement pour cette matière -->
                    </div>
                    
                    <!-- État vide pour cette matière -->
                    <div class="empty-state" id="evaluationsEmptyState-{{ subject_data.classroom.id }}" style="display: none;">
                        <i class="fas fa-clipboard-check"></i>
                        <p>Aucune évaluation créée pour {{ subject }}</p>
                        {% if subject_data.get('is_editable', true) %}
                        <button class="btn btn-primary" onclick="showNewEvaluationModal('{{ subject_data.classroom.id }}')">
                            <i class="fas fa-plus"></i> Créer une première évaluation
                        </button>
                        {% else %}
                        <p class="text-muted"><i class="fas fa-lock"></i> Discipline en lecture seule</p>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <!-- État vide général -->
                <div class="empty-state" id="evaluationsEmptyState" style="display: none;">
                    <i class="fas fa-clipboard-check"></i>
                    <p>Aucune évaluation créée</p>
                    <button class="btn btn-primary" onclick="showNewEvaluationModal()">
                        <i class="fas fa-plus"></i> Créer une première évaluation
                    </button>
                </div>
            {% endif %}
            
            <!-- Histogramme des notes -->
            <div id="gradeHistogram" style="display: none; margin-top: 2rem;">
                <h3>Analyse de l'évaluation sélectionnée</h3>
                <div class="histogram-container">
                    <canvas id="histogramChart" width="400" height="200"></canvas>
                </div>
                <div class="evaluation-stats">
                    <div class="stat-item">
                        <span class="stat-label">Moyenne :</span>
                        <span class="stat-value" id="selectedEvalAverage">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Note la plus haute :</span>
                        <span class="stat-value" id="selectedEvalMax">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Note la plus basse :</span>
                        <span class="stat-value" id="selectedEvalMin">-</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Onglet Fichiers -->
    <div id="files-tab" class="tab-content">
        <div class="files-section">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-folder-open"></i> Fichiers par discipline
                </h2>
            </div>

            <!-- Sections par discipline -->
            {% if grades_by_subject %}
                {% for subject, subject_data in grades_by_subject.items() %}
                {% if subject_data.get('is_editable', true) %}
                <div class="files-section-by-subject" data-subject="{{ subject }}" data-classroom-id="{{ subject_data.classroom.id }}">
                    <div class="section-header">
                        <h3 class="subject-title">
                            <i class="fas fa-book"></i> {{ subject }}
                        </h3>
                        <div class="header-actions">
                            <button class="btn btn-primary btn-sm" onclick="showNewClassFolderModal('{{ subject_data.classroom.id }}')">
                                <i class="fas fa-folder-plus"></i> Nouveau dossier
                            </button>
                            <div class="btn-group">
                                <button class="btn btn-success btn-sm" onclick="document.getElementById('classFileInput-{{ subject_data.classroom.id }}').click()">
                                    <i class="fas fa-file-upload"></i> Fichiers
                                </button>
                                <button class="btn btn-info btn-sm" onclick="document.getElementById('classFolderInput-{{ subject_data.classroom.id }}').click()">
                                    <i class="fas fa-folder-upload"></i> Dossier
                                </button>
                            </div>
                            <input type="file" id="classFileInput-{{ subject_data.classroom.id }}" multiple accept=".pdf,.png,.jpg,.jpeg" style="display: none;" onchange="handleClassFileSelect(event, '{{ subject_data.classroom.id }}')">
                            <input type="file" id="classFolderInput-{{ subject_data.classroom.id }}" webkitdirectory directory multiple style="display: none;" onchange="handleClassFolderSelect(event, '{{ subject_data.classroom.id }}')">
                        </div>
                    </div>

                    <!-- Zone de drop pour cette discipline -->
                    <div class="drop-zone" id="classDropZone-{{ subject_data.classroom.id }}" data-classroom-id="{{ subject_data.classroom.id }}">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p>Glissez vos fichiers ou dossiers ici pour {{ subject }}</p>
                        <p style="font-size: 0.875rem; color: var(--gray-color);">
                            PDF, PNG, JPG • Max 80 MB • Les dossiers seront importés avec leur structure
                        </p>
                    </div>

                    <!-- Navigation fil d'ariane pour cette discipline -->
                    <div class="breadcrumb" id="classBreadcrumb-{{ subject_data.classroom.id }}" style="display: none;">
                        <a href="javascript:void(0)" class="breadcrumb-item" onclick="navigateToClassRoot('{{ subject_data.classroom.id }}')">
                            <i class="fas fa-home"></i> Racine
                        </a>
                        <!-- Les éléments du breadcrumb seront ajoutés dynamiquement -->
                    </div>

                    <!-- Grille des fichiers pour cette discipline -->
                    <div class="file-grid" id="classFileGrid-{{ subject_data.classroom.id }}">
                        <!-- Les fichiers seront chargés dynamiquement -->
                    </div>

                    <!-- État vide pour cette discipline -->
                    <div class="empty-state" id="classEmptyState-{{ subject_data.classroom.id }}" style="display: none;">
                        <i class="fas fa-folder-open"></i>
                        <p>Aucun fichier pour {{ subject }}</p>
                        <p style="font-size: 0.875rem;">Créez un dossier ou uploadez des fichiers pour commencer</p>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            {% else %}
                <!-- Section générale si pas de disciplines multiples -->
                <div class="files-section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="fas fa-folder-open"></i> Fichiers de la classe
                        </h2>
                        <div class="header-actions">
                            <button class="btn btn-primary" onclick="showNewClassFolderModal()">
                                <i class="fas fa-folder-plus"></i> Nouveau dossier
                            </button>
                            <div class="btn-group">
                                <button class="btn btn-success" onclick="document.getElementById('classFileInput').click()">
                                    <i class="fas fa-file-upload"></i> Fichiers
                                </button>
                                <button class="btn btn-info" onclick="document.getElementById('classFolderInput').click()">
                                    <i class="fas fa-folder-upload"></i> Dossier
                                </button>
                            </div>
                            <input type="file" id="classFileInput" multiple accept=".pdf,.png,.jpg,.jpeg" style="display: none;" onchange="handleClassFileSelect(event)">
                            <input type="file" id="classFolderInput" webkitdirectory directory multiple style="display: none;" onchange="handleClassFolderSelect(event)">
                        </div>
                    </div>

                    <!-- Zone de drop -->
                    <div class="drop-zone" id="classDropZone">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p>Glissez vos fichiers ou dossiers ici</p>
                        <p style="font-size: 0.875rem; color: var(--gray-color);">
                            PDF, PNG, JPG • Max 80 MB • Les dossiers seront importés avec leur structure
                        </p>
                    </div>

                    <!-- Navigation fil d'ariane -->
                    <div class="breadcrumb" id="classBreadcrumb" style="display: none;">
                        <a href="javascript:void(0)" class="breadcrumb-item" onclick="navigateToClassRoot()">
                            <i class="fas fa-home"></i> Racine
                        </a>
                        <!-- Les éléments du breadcrumb seront ajoutés dynamiquement -->
                    </div>

                    <!-- Grille des fichiers -->
                    <div class="file-grid" id="classFileGrid">
                        <!-- Les fichiers seront chargés dynamiquement -->
                    </div>

                    <!-- État vide -->
                    <div class="empty-state" id="classEmptyState" style="display: none;">
                        <i class="fas fa-folder-open"></i>
                        <p>Ce dossier est vide</p>
                        <p style="font-size: 0.875rem;">Créez un dossier ou uploadez des fichiers pour commencer</p>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Onglet Sanctions -->
    <div id="sanctions-tab" class="tab-content">
        <div class="sanctions-section">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-exclamation-triangle"></i> Suivi des coches
                </h2>
                <div class="header-actions">
                    <button class="btn btn-danger" onclick="resetAllSanctions()">
                        <i class="fas fa-undo"></i> Réinitialiser toutes les coches
                    </button>
                </div>
            </div>
            
            <div class="display-mode-selector">
                        <label class="form-label">Mode d'affichage :</label>
                        <div class="radio-group">
                            <div class="radio-option">
                                {% set first_classroom = selected_group.classrooms[0] %}
                                {% set has_preferences = first_classroom.id in classroom_preferences %}
                                <input type="radio" id="mode-unified" name="sanctionDisplayMode" value="unified" 
                                       {% if has_preferences and classroom_preferences[first_classroom.id].display_mode == 'unified' %}checked{% endif %}
                                       {% if has_preferences and not classroom_preferences[first_classroom.id].can_change_mode() %}disabled{% endif %}
                                       onclick="handleModeChange(this, '{{ first_classroom.id }}')">
                                <label for="mode-unified">Tableau unifié (toutes disciplines)</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="mode-separated" name="sanctionDisplayMode" value="separated"
                                       {% if has_preferences and classroom_preferences[first_classroom.id].display_mode == 'separated' %}checked{% endif %}
                                       {% if has_preferences and not classroom_preferences[first_classroom.id].can_change_mode() %}disabled{% endif %}
                                       onclick="handleModeChange(this, '{{ first_classroom.id }}')">
                                <label for="mode-separated">Tableaux séparés par discipline</label>
                            </div>
                            {% if has_preferences and classroom_preferences[first_classroom.id].is_class_master() %}
                            <div class="radio-option">
                                <input type="radio" id="mode-centralized" name="sanctionDisplayMode" value="centralized"
                                       {% if classroom_preferences[first_classroom.id].display_mode == 'centralized' %}checked{% endif %}
                                       onclick="handleModeChange(this, '{{ first_classroom.id }}')">
                                <label for="mode-centralized">Coches centralisées (maître de classe)</label>
                            </div>
                            {% endif %}
                        </div>
                        {% if has_preferences and not classroom_preferences[first_classroom.id].can_change_mode() %}
                        <div class="lock-warning">
                            <i class="fas fa-lock"></i> 
                            Mode verrouillé par {{ classroom_preferences[first_classroom.id].locked_by_user.username if classroom_preferences[first_classroom.id].locked_by_user else 'le maître de classe' }}
                        </div>
                        {% endif %}
                    </div>

            {% if imported_sanctions and students %}
            {% set first_classroom = selected_group.classrooms[0] %}
            {% set current_mode = classroom_preferences[first_classroom.id].display_mode if first_classroom.id in classroom_preferences else 'unified' %}
            
            {% if current_mode == 'unified' or current_mode == 'centralized' %}
            <!-- Mode unifié ou centralisé : un seul tableau -->
            <div id="sanctions-unified" class="sanctions-display-mode">
                <div class="sanctions-table-container">
                    <table class="sanctions-table">
                        <thead>
                            <tr>
                                <th class="student-column">Élève</th>
                                {% for sanction in imported_sanctions %}
                                <th class="sanction-column">{{ sanction.name }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for student in students %}
                            <tr>
                                <td class="student-name">{{ student.full_name }}</td>
                                {% for sanction in imported_sanctions %}
                                <td class="sanction-count">
                                    <div class="count-controls">
                                        <button class="count-btn decrease" onclick="updateCount({{ student.id }}, {{ sanction.id }}, -1)">
                                            <i class="fas fa-minus"></i>
                                        </button>
                                        <span class="count-display" data-student="{{ student.id }}" data-sanction="{{ sanction.id }}">
                                            {{ sanctions_data[student.id][sanction.id] }}
                                        </span>
                                        <button class="count-btn increase" onclick="updateCount({{ student.id }}, {{ sanction.id }}, 1)">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            {% elif current_mode == 'separated' %}
            <!-- Mode séparé : un tableau par discipline -->
            <div id="sanctions-separated" class="sanctions-display-mode">
                {% for classroom in selected_group.classrooms %}
                <div class="sanctions-by-subject">
                    <h3 class="subject-title">
                        <i class="fas fa-book"></i> {{ classroom.subject }}
                    </h3>
                    <div class="sanctions-table-container">
                        <table class="sanctions-table">
                            <thead>
                                <tr>
                                    <th class="student-column">Élève</th>
                                    {% for sanction in imported_sanctions %}
                                    <th class="sanction-column">{{ sanction.name }}</th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for student in students %}
                                <tr>
                                    <td class="student-name">{{ student.full_name }}</td>
                                    {% for sanction in imported_sanctions %}
                                    <td class="sanction-count">
                                        <div class="count-controls">
                                            <button class="count-btn decrease" onclick="updateCount({{ student.id }}, {{ sanction.id }}, -1, {{ classroom.id }})">
                                                <i class="fas fa-minus"></i>
                                            </button>
                                            <span class="count-display" data-student="{{ student.id }}" data-sanction="{{ sanction.id }}" data-classroom="{{ classroom.id }}">
                                                {{ sanctions_data[student.id][sanction.id] }}
                                            </span>
                                            <button class="count-btn increase" onclick="updateCount({{ student.id }}, {{ sanction.id }}, 1, {{ classroom.id }})">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                    </td>
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            {% elif not imported_sanctions %}
            <div class="empty-state">
                <i class="fas fa-exclamation-triangle"></i>
                <p>Aucun modèle de sanction importé dans cette classe</p>
                <p style="font-size: 0.875rem;">Allez dans <a href="{{ url_for('sanctions.index') }}">Gestion des sanctions</a> pour créer et importer des modèles</p>
            </div>
            {% elif not students %}
            <div class="empty-state">
                <i class="fas fa-user-graduate"></i>
                <p>Aucun élève dans cette classe</p>
                <p style="font-size: 0.875rem;">Ajoutez des élèves dans l'onglet "Élèves" pour commencer le suivi des sanctions</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Onglet Absences -->
    <div id="attendance-tab" class="tab-content">
        <div class="attendance-section">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-calendar-check"></i> Suivi des absences
                </h2>
            </div>

            <!-- Sous-onglets -->
            <div class="attendance-mini-tabs">
                <button class="attendance-mini-tab active" onclick="showAttendanceTab('class-absences')">
                    <i class="fas fa-user-times"></i> Absences
                </button>
                <button class="attendance-mini-tab" onclick="showAttendanceTab('class-late')">
                    <i class="fas fa-clock"></i> Retards
                </button>
                <button class="attendance-mini-tab" onclick="showAttendanceTab('class-justified')">
                    <i class="fas fa-check-circle"></i> Absences justifiées
                </button>
            </div>

            <!-- Contenu des sous-onglets -->
            <!-- Absences -->
            <div id="class-absences" class="attendance-content">
                <div class="attendance-filters">
                    <div class="form-group">
                        <label class="form-label">Date de début</label>
                        <input type="date" class="form-control" id="class-start-date-absences">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date de fin</label>
                        <input type="date" class="form-control" id="class-end-date-absences">
                    </div>
                    <button class="btn btn-primary" onclick="loadClassAbsences()">
                        <i class="fas fa-search"></i> Filtrer
                    </button>
                </div>

                <div class="attendance-table-container">
                    <div class="loading-spinner" id="class-loading-absences" style="text-align: center; padding: 40px;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Chargement...</span>
                        </div>
                    </div>
                    <table class="attendance-table" id="class-absences-table" style="display: none;">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Élève</th>
                                <th>Période(s)</th>
                                <th>Horaires</th>
                                <th>Commentaire</th>
                            </tr>
                        </thead>
                        <tbody id="class-absences-tbody"></tbody>
                    </table>
                    <div class="no-data" id="class-no-absences" style="display: none; text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-inbox fa-3x mb-3"></i>
                        <p>Aucune absence trouvée pour cette classe.</p>
                    </div>
                </div>
            </div>

            <!-- Retards -->
            <div id="class-late" class="attendance-content" style="display: none;">
                <div class="attendance-filters">
                    <div class="form-group">
                        <label class="form-label">Date de début</label>
                        <input type="date" class="form-control" id="class-start-date-late">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date de fin</label>
                        <input type="date" class="form-control" id="class-end-date-late">
                    </div>
                    <button class="btn btn-primary" onclick="loadClassLateArrivals()">
                        <i class="fas fa-search"></i> Filtrer
                    </button>
                </div>

                <div class="attendance-table-container">
                    <div class="loading-spinner" id="class-loading-late" style="text-align: center; padding: 40px;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Chargement...</span>
                        </div>
                    </div>
                    <table class="attendance-table" id="class-late-table" style="display: none;">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Élève</th>
                                <th>Période(s)</th>
                                <th>Horaires</th>
                                <th>Minutes de retard</th>
                                <th>Commentaire</th>
                            </tr>
                        </thead>
                        <tbody id="class-late-tbody"></tbody>
                    </table>
                    <div class="no-data" id="class-no-late" style="display: none; text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-inbox fa-3x mb-3"></i>
                        <p>Aucun retard trouvé pour cette classe.</p>
                    </div>
                </div>
            </div>

            <!-- Absences justifiées -->
            <div id="class-justified" class="attendance-content" style="display: none;">
                {% if justifications %}
                    <div class="justifications-teacher-list">
                        {% for justification in justifications %}
                            <div class="justification-teacher-card" data-status="{{ justification.status }}">
                                <div class="justification-teacher-header">
                                    <div class="student-info">
                                        <h4>{{ justification.student.first_name }} {{ justification.student.last_name }}</h4>
                                        <span class="absence-date">{{ justification.absence_date.strftime('%d/%m/%Y') }}</span>
                                    </div>
                                    <div class="justification-actions">
                                        <select class="status-select" 
                                                onchange="updateJustificationStatus({{ justification.id }}, this.value)"
                                                {% if justification.status != 'pending' %}disabled{% endif %}>
                                            <option value="pending" {% if justification.status == 'pending' %}selected{% endif %}>En attente</option>
                                            <option value="approved" {% if justification.status == 'approved' %}selected{% endif %}>Approuver</option>
                                            <option value="rejected" {% if justification.status == 'rejected' %}selected{% endif %}>Refuser</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="justification-teacher-details">
                                    <div class="detail-row">
                                        <strong>Périodes:</strong>
                                        <div>
                                            {% set periods = justification.get_periods_list() %}
                                            {% if periods %}
                                                {% for period in periods %}
                                                    <span class="period-tag-teacher">P{{ period.period }}</span>
                                                {% endfor %}
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <div class="detail-row">
                                        <strong>Motif:</strong>
                                        <span>
                                            {% if justification.reason_type == 'maladie' %}
                                                Maladie/Accident
                                            {% elif justification.reason_type == 'medecin' %}
                                                Rendez-vous médecin
                                            {% elif justification.reason_type == 'transport' %}
                                                Problème transport
                                            {% elif justification.reason_type == 'conge_joker' %}
                                                Congé joker
                                            {% elif justification.reason_type == 'dispense' %}
                                                Dispense - {{ justification.dispense_subject }}
                                            {% elif justification.reason_type == 'autre' %}
                                                {{ justification.other_reason_text[:50] }}{% if justification.other_reason_text|length > 50 %}...{% endif %}
                                            {% endif %}
                                        </span>
                                    </div>
                                    
                                    <div class="detail-row">
                                        <strong>Parent:</strong>
                                        <span>{{ justification.parent.full_name }}</span>
                                    </div>
                                    
                                    {% if justification.justification_file %}
                                    <div class="detail-row">
                                        <strong>Fichier:</strong>
                                        <a href="/uploads/justifications/{{ justification.justification_file }}" 
                                           target="_blank" class="file-link">
                                            <i class="fas fa-paperclip"></i> Voir
                                        </a>
                                    </div>
                                    {% endif %}
                                    
                                    <div class="detail-row">
                                        <strong>Note:</strong>
                                        <textarea class="teacher-response-input" 
                                                  placeholder="Réponse ou note pour le parent..."
                                                  rows="2"
                                                  onchange="updateTeacherResponse({{ justification.id }}, this.value)">{{ justification.teacher_response or '' }}</textarea>
                                    </div>
                                    
                                    <div class="detail-row meta">
                                        <small class="text-muted">
                                            Soumis le {{ justification.created_at.strftime('%d/%m %H:%M') }}
                                            {% if justification.processed_at %}
                                                • Traité le {{ justification.processed_at.strftime('%d/%m %H:%M') }}
                                            {% endif %}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div style="text-align: center; padding: 60px 20px; background: #f8f9fa; border-radius: 8px; color: #666;">
                        <i class="fas fa-file-medical" style="font-size: 3em; margin-bottom: 20px; color: #007bff;"></i>
                        <h3>Aucune justification d'absence</h3>
                        <p>Les parents peuvent maintenant justifier les absences via leur portail dédié.</p>
                        <p style="color: #999;">Les justifications apparaîtront ici pour validation.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Onglet Plan de classe -->
    <div id="seating-tab" class="tab-content">
        <div class="seating-section">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-th"></i> Plan de classe
                </h2>
                <div class="header-info">
                    <span id="seating-class-name" class="text-muted">{{ selected_classroom.name if selected_classroom else 'Aucune classe sélectionnée' }}</span>
                </div>
            </div>

            <div class="seating-container">
                <!-- Barre d'outils -->
                <div class="seating-toolbar">
                    <!-- Ajouter des éléments -->
                    <div class="toolbar-section">
                        <h4><i class="fas fa-plus"></i> Ajouter</h4>
                        <div class="tool-buttons">
                            <div class="tool-btn" onclick="addElement('desk-single')">
                                <i class="fas fa-square"></i>
                                <span>Simple</span>
                            </div>
                            <div class="tool-btn" onclick="addElement('desk-double')">
                                <i class="fas fa-th-large"></i>
                                <span>Double</span>
                            </div>
                        </div>
                        <div class="tool-btn" onclick="addElement('teacher-desk')" style="margin-top: 8px;">
                            <i class="fas fa-chalkboard-teacher"></i>
                            <span>Bureau prof</span>
                        </div>
                    </div>

                    <!-- Contrôles -->
                    <div class="toolbar-section">
                        <h4><i class="fas fa-cogs"></i> Actions</h4>
                        <div class="control-buttons">
                            <button class="control-btn btn-reset" onclick="resetStudentsPlacement()">
                                <i class="fas fa-undo"></i>
                                Réinitialiser élèves
                            </button>
                            <button class="control-btn btn-save" onclick="saveSeatingPlan()">
                                <i class="fas fa-save"></i>
                                Enregistrer plan
                            </button>
                            <button class="control-btn btn-print" onclick="printSeatingPlan()">
                                <i class="fas fa-print"></i>
                                Imprimer
                            </button>
                            <button id="load-master-plan-btn" class="control-btn btn-load-master" onclick="loadMasterSeatingPlan()" style="display: none;">
                                <i class="fas fa-download"></i>
                                Charger plan du maître
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Zone de travail avec panneau latéral -->
                <div class="seating-main-area">
                    <!-- Zone de travail -->
                    <div class="seating-workspace" id="seating-workspace">
                        <!-- Les éléments du plan seront ajoutés ici -->
                        
                        <!-- Message d'aide initial -->
                        <div id="seating-help" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #6c757d; pointer-events: none;">
                            <i class="fas fa-mouse fa-3x" style="margin-bottom: 20px; opacity: 0.3;"></i>
                            <h3 style="margin-bottom: 10px;">Créez votre plan de classe</h3>
                            <p>Utilisez les outils de gauche pour ajouter des tables et un bureau.<br>
                            Déplacez ensuite les étiquettes des élèves depuis le panneau de droite.</p>
                        </div>
                    </div>

                    <!-- Panneau latéral des élèves -->
                    <div class="students-sidebar">
                        <div class="sidebar-header">
                            <h4><i class="fas fa-users"></i> Élèves de la classe</h4>
                            <div class="students-count">
                                <span id="sidebar-students-count">{{ students|length if students else 0 }}</span> élèves
                            </div>
                        </div>
                        <div class="students-labels-container" id="students-labels-container">
                            <!-- Les étiquettes d'élèves seront ajoutées ici dynamiquement -->
                            {% if students %}
                                {% for student in students %}
                                    <div class="student-label" draggable="true" data-student-id="{{ student.id }}">
                                        <i class="fas fa-user"></i>
                                        <span>{{ student.full_name }}</span>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <p style="color: #666; font-style: italic; text-align: center; padding: 20px;">
                                    Aucun élève dans cette classe.
                                </p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Onglet Groupes -->
    <div id="groups-tab" class="tab-content">
        <div class="groups-section">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-users"></i> Gestion des groupes
                </h2>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="showCreateGroupModal()">
                        <i class="fas fa-plus"></i> Créer un groupe
                    </button>
                </div>
            </div>

            <div class="groups-container">
                <div class="groups-list" id="groupsList">
                    <!-- Les groupes seront chargés ici -->
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-users fa-2x mb-2"></i>
                        <p>Aucun groupe créé pour cette classe</p>
                        <p class="small">Cliquez sur "Créer un groupe" pour commencer</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de création/édition de groupe -->
<div class="modal" id="groupModal">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="groupModalTitle">Créer un groupe</h4>
                <button type="button" class="close" onclick="closeGroupModal()">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="groupForm">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="form-group">
                                <label for="groupName" class="form-label">Nom du groupe *</label>
                                <input type="text" id="groupName" class="form-control" required 
                                       placeholder="Ex: Groupe A, Avancés, Débutants...">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="groupColor" class="form-label">Couleur</label>
                                <div class="color-picker">
                                    <input type="color" id="groupColor" class="form-control" value="#4F46E5">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="groupDescription" class="form-label">Description (optionnel)</label>
                        <textarea id="groupDescription" class="form-control" rows="2" 
                                  placeholder="Description du groupe ou objectifs..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Sélectionner les élèves</label>
                        <div class="students-selection">
                            <div class="students-grid" id="studentsGrid">
                                <!-- Les élèves seront chargés ici -->
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeGroupModal()">Annuler</button>
                <button type="button" class="btn btn-primary" onclick="saveGroup()">
                    <i class="fas fa-save"></i> Enregistrer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Onglet Aménagements -->
<div id="accommodations-tab" class="tab-content">
    <div class="accommodations-section">
        <div class="section-header">
            <h2 class="section-title">
                <i class="fas fa-universal-access"></i> Gestion des aménagements
            </h2>
        </div>

        <!-- Liste des élèves avec leurs aménagements -->
        <div class="accommodations-container">
            <div class="students-accommodations-list" id="studentsAccommodationsList">
                <!-- Les élèves avec leurs aménagements seront chargés ici -->
                <div class="text-center text-muted py-4">
                    <i class="fas fa-universal-access fa-2x mb-2"></i>
                    <p>Aucun aménagement défini pour cette classe</p>
                    <p class="small">Les aménagements se gèrent individuellement pour chaque élève</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour ajouter/modifier un aménagement -->
<div id="accommodationModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3 id="accommodationModalTitle">Ajouter un aménagement</h3>
            <button type="button" class="modal-close" onclick="closeAccommodationModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <!-- Sélection de l'élève -->
            <div class="form-group">
                <label class="form-label">Élève</label>
                <select id="accommodationStudentSelect" class="form-control">
                    <option value="">-- Sélectionner un élève --</option>
                </select>
            </div>

            <!-- Type d'aménagement -->
            <div class="form-group">
                <label class="form-label">Type d'aménagement</label>
                <div class="radio-group">
                    <label class="radio-option">
                        <input type="radio" name="accommodationType" value="template" checked onchange="toggleAccommodationType()">
                        <span>Choisir dans la liste prédéfinie</span>
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="accommodationType" value="custom" onchange="toggleAccommodationType()">
                        <span>Créer un aménagement personnalisé</span>
                    </label>
                </div>
            </div>

            <!-- Aménagement prédéfini -->
            <div id="templateAccommodationDiv" class="form-group">
                <label class="form-label">Aménagement prédéfini</label>
                <select id="accommodationTemplateSelect" class="form-control" onchange="updateTemplatePreview()">
                    <option value="">-- Sélectionner un aménagement --</option>
                </select>
                <div id="templatePreview" style="display: none; margin-top: 10px; padding: 10px; background-color: #f8f9fa; border-radius: 4px;">
                    <div id="templatePreviewContent"></div>
                </div>
            </div>

            <!-- Aménagement personnalisé -->
            <div id="customAccommodationDiv" class="form-group" style="display: none;">
                <div class="form-row">
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label">Nom de l'aménagement</label>
                        <input type="text" id="customAccommodationName" class="form-control" placeholder="Ex: Calculatrice autorisée">
                    </div>
                    <div class="form-group" style="flex: 0 0 80px; margin-left: 10px;">
                        <label class="form-label">Emoji</label>
                        <select id="customAccommodationEmoji" class="form-control text-center">
                            <option value="⏰">⏰ Temps</option>
                            <option value="⏱️">⏱️ Chrono</option>
                            <option value="⏳">⏳ Sablier</option>
                            <option value="💻">💻 Ordinateur</option>
                            <option value="📱">📱 Tablette</option>
                            <option value="🖨️">🖨️ Imprimante</option>
                            <option value="📖">📖 Lecture</option>
                            <option value="📝">📝 Écriture</option>
                            <option value="📋">📋 Support</option>
                            <option value="💬">💬 Oral</option>
                            <option value="🗣️">🗣️ Parole</option>
                            <option value="👂">👂 Écoute</option>
                            <option value="👀">👀 Visuel</option>
                            <option value="🔍">🔍 Agrandissement</option>
                            <option value="🔎">🔎 Loupe</option>
                            <option value="🏠">🏠 Isolement</option>
                            <option value="🪑">🪑 Position</option>
                            <option value="🔇">🔇 Silence</option>
                            <option value="🔢">🔢 Calculs</option>
                            <option value="🧮">🧮 Calculatrice</option>
                            <option value="📐">📐 Géométrie</option>
                            <option value="📏">📏 Règle</option>
                            <option value="✏️">✏️ Crayon</option>
                            <option value="🖊️">🖊️ Stylo</option>
                            <option value="📎">📎 Aide-mémoire</option>
                            <option value="🎯">🎯 Objectif</option>
                            <option value="⭐">⭐ Motivation</option>
                            <option value="🔄">🔄 Répétition</option>
                            <option value="📚">📚 Documentation</option>
                            <option value="🎧">🎧 Audio</option>
                            <option value="🔊">🔊 Amplification</option>
                            <option value="🎨">🎨 Créatif</option>
                            <option value="🖼️">🖼️ Images</option>
                            <option value="📊">📊 Graphiques</option>
                            <option value="🗂️">🗂️ Organisation</option>
                            <option value="⚡">⚡ Rapidité</option>
                            <option value="🔧">🔧 Outil</option>
                            <option value="🛠️">🛠️ Adaptation</option>
                            <option value="🎪">🎪 Ludique</option>
                            <option value="🎮">🎮 Interactif</option>
                            <option value="📌">📌 Repérage</option>
                            <option value="🏷️">🏷️ Étiquettes</option>
                            <option value="🔆">🔆 Éclairage</option>
                            <option value="🌈">🌈 Couleurs</option>
                            <option value="📋">📋 Check-list</option>
                            <option value="⚙️">⚙️ Configuration</option>
                            <option value="🔑">🔑 Accès</option>
                            <option value="🎓">🎓 Apprentissage</option>
                            <option value="📑">📑 Fiche</option>
                            <option value="🎭">🎭 Expression</option>
                            <option value="🌟">🌟 Excellence</option>
                            <option value="💡">💡 Idée</option>
                            <option value="🎹">🎹 Musical</option>
                            <option value="🎵">🎵 Rythme</option>
                            <option value="🎪">🎪 Animation</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="customAccommodationDescription" class="form-control" rows="2" placeholder="Description détaillée de l'aménagement"></textarea>
                </div>
                <div class="form-group">
                    <label class="checkbox-option">
                        <input type="checkbox" id="customIsTimeExtension" onchange="toggleTimeMultiplier()">
                        <span>Cet aménagement concerne une extension de temps</span>
                    </label>
                </div>
                <div id="timeMultiplierDiv" class="form-group" style="display: none;">
                    <label class="form-label">Multiplicateur de temps</label>
                    <select id="customTimeMultiplier" class="form-control">
                        <option value="1.25">+25% (1/4 de temps en plus)</option>
                        <option value="1.33">+33% (1/3 de temps en plus)</option>
                        <option value="1.5">+50% (1/2 de temps en plus)</option>
                        <option value="1.75">+75% (3/4 de temps en plus)</option>
                        <option value="2">+100% (temps doublé)</option>
                    </select>
                </div>
            </div>

            <!-- Notes spécifiques -->
            <div class="form-group">
                <label class="form-label">Notes spécifiques pour cet élève (optionnel)</label>
                <textarea id="accommodationNotes" class="form-control" rows="2" placeholder="Notes particulières ou adaptations spécifiques..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-outline" onclick="closeAccommodationModal()">Annuler</button>
            <button type="button" class="btn btn-primary" onclick="saveAccommodation()">
                <i class="fas fa-save"></i> Enregistrer
            </button>
        </div>
    </div>
</div>

<!-- Onglet Enseignants -->
{% if show_teachers_tab %}
<div id="teachers-tab" class="tab-content">
    <div class="teachers-section">
        <div class="section-header">
            <h2 class="section-title">
                <i class="fas fa-chalkboard-teacher"></i> Enseignants de la classe
            </h2>
        </div>

        <div class="teachers-container">
            {% if class_teachers %}
                <div class="teachers-list">
                    {% for teacher in class_teachers %}
                    <div class="teacher-card {% if teacher.is_current_user %}current-user{% endif %}">
                        <div class="teacher-info">
                            <div class="teacher-name">
                                <i class="fas fa-user"></i>
                                {{ teacher.full_name }}
                                {% if teacher.is_class_master %}
                                    <span class="badge badge-primary">👑 Maître de classe</span>
                                {% endif %}
                            </div>
                            <div class="teacher-email">
                                <i class="fas fa-envelope"></i>
                                <a href="mailto:{{ teacher.email }}">{{ teacher.email }}</a>
                            </div>
                            <div class="teacher-subjects">
                                <i class="fas fa-book"></i>
                                <strong>Disciplines :</strong> {{ teacher.subjects|join(', ') }}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center text-muted py-4">
                    <i class="fas fa-chalkboard-teacher fa-2x mb-2"></i>
                    <p>Aucun enseignant trouvé pour cette classe</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}

<!-- Modal de partage de fichiers avec les élèves -->
<div id="shareFileModal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h3 id="shareFileModalTitle">Partager un fichier avec des élèves</h3>
            <button type="button" class="modal-close" onclick="closeShareFileModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="file-to-share-info" style="background-color: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="background-color: #667eea; color: white; padding: 0.5rem; border-radius: 8px;">
                        <i class="fas fa-file-pdf"></i>
                    </div>
                    <div>
                        <h4 id="shareFileName" style="margin: 0; color: #2d3748;"></h4>
                        <p style="margin: 0; color: #718096; font-size: 0.875rem;">Fichier à partager</p>
                    </div>
                </div>
            </div>

            <form id="shareFileForm">
                <input type="hidden" id="shareFileId" value="">
                
                <!-- Sélection des élèves -->
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-users"></i> Sélectionner les élèves
                    </label>
                    <div class="students-selection-grid" id="studentsSelectionGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 0.5rem; max-height: 300px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; padding: 1rem;">
                        <!-- Les élèves seront chargés ici -->
                    </div>
                    <div style="margin-top: 0.5rem; font-size: 0.875rem; color: #718096;">
                        <span id="selectedStudentsCount">0</span> élève(s) sélectionné(s)
                    </div>
                </div>

                <!-- Message optionnel -->
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-comment"></i> Message pour les élèves (optionnel)
                    </label>
                    <textarea id="shareMessage" class="form-control" rows="3" 
                              placeholder="Ajoutez un message personnalisé pour expliquer pourquoi vous partagez ce fichier (ex: 'Document pour rattraper le cours du 15/01')"></textarea>
                    <div style="font-size: 0.75rem; color: #718096; margin-top: 0.25rem;">
                        Ce message apparaîtra avec le fichier sur la plateforme élève
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-outline" onclick="closeShareFileModal()">Annuler</button>
            <button type="button" class="btn btn-primary" onclick="submitFileShare()" id="shareFileSubmitBtn">
                <i class="fas fa-share"></i> Partager le fichier
            </button>
        </div>
    </div>
</div>

<script>
// ===== SYSTÈME DE PLAN DE CLASSE =====

// Variables globales pour le plan de classe
let seatingWorkspace = null;
let elementCounter = 0;
let isDragging = false;
let currentDragElement = null;
let dragOffset = { x: 0, y: 0 };
let currentStudents = [];
let magnetRadius = 100; // Distance pour l'aimantation en pixels (augmenté pour plus de facilité)

// Initialisation du plan de classe
function initializeSeatingPlan() {
    seatingWorkspace = document.getElementById('seating-workspace');
    
    if (!seatingWorkspace) {
        console.error('seatingWorkspace element not found!');
        return;
    }
    
    console.log('Initializing seating plan, workspace found:', seatingWorkspace);
    
    // Réinitialiser les variables
    elementCounter = 0;
    isDragging = false;
    currentDragElement = null;
    
    // Ajouter les event listeners pour le drag and drop
    setupSeatingEventListeners();
    
    // Charger les étudiants de la classe sélectionnée
    loadStudentsForSeating();
    
    // Mettre à jour les compteurs
    updateSeatingStats();
}

// Obtenir l'ID de la classe sélectionnée
function getSelectedClassroomId() {
    const classSelect = document.getElementById('classSelect');
    return classSelect ? classSelect.value : null;
}

// Vérifier si le bouton de chargement du plan du maître doit être affiché
function checkMasterPlanButton() {
    const selectedClass = getSelectedClassroomId();
    if (!selectedClass) return;
    
    fetch(`/planning/check-master-plan-available/${selectedClass}`)
    .then(response => response.json())
    .then(data => {
        const button = document.getElementById('load-master-plan-btn');
        if (data.show_button) {
            button.style.display = 'block';
        } else {
            button.style.display = 'none';
        }
    })
    .catch(error => {
        console.error('Erreur lors de la vérification du plan du maître:', error);
        document.getElementById('load-master-plan-btn').style.display = 'none';
    });
}

// Charger les étudiants pour le plan de classe
function loadStudentsForSeating() {
    const studentsCountSpan = document.getElementById('sidebar-students-count');
    
    console.log('Loading students for seating...');
    
    // Vérifier si le bouton de chargement du plan du maître doit être affiché
    checkMasterPlanButton();
    
    // Compter les étudiants déjà affichés
    const studentLabels = document.querySelectorAll('#students-labels-container .student-label');
    currentStudents = [];
    
    studentLabels.forEach(label => {
        const studentId = label.dataset.studentId;
        const studentName = label.querySelector('span').textContent;
        currentStudents.push({ id: studentId, name: studentName });
    });
    
    if (studentsCountSpan) {
        studentsCountSpan.textContent = currentStudents.length;
    }
    
    console.log('Total students found:', currentStudents.length);
    updateSeatingStats();
}

// Configuration des event listeners pour le drag and drop
function setupSeatingEventListeners() {
    if (!seatingWorkspace) {
        console.error('seatingWorkspace not found in setupSeatingEventListeners');
        return;
    }
    
    // Event listeners pour l'espace de travail
    seatingWorkspace.addEventListener('dragover', handleWorkspaceDragOver);
    seatingWorkspace.addEventListener('drop', handleWorkspaceDrop);
    
    // Event listeners globaux pour le drag des tables
    document.addEventListener('mouseup', handleMouseUp);
    document.addEventListener('mousemove', handleMouseMove);
    
    // Support tactile pour les tablettes
    document.addEventListener('touchmove', handleTouchMove, {passive: false});
    document.addEventListener('touchend', handleTouchEnd);
    
    // Event listener pour empêcher la sélection de texte pendant le drag
    document.addEventListener('selectstart', function(e) {
        if (isDragging) {
            e.preventDefault();
        }
    });
}

// Ajouter un élément (table ou bureau)
function addElement(elementType) {
    // S'assurer que seatingWorkspace est initialisé
    if (!seatingWorkspace) {
        seatingWorkspace = document.getElementById('seating-workspace');
        if (!seatingWorkspace) {
            console.error('seatingWorkspace element not found');
            return;
        }
    }
    
    elementCounter++;
    
    const element = document.createElement('div');
    element.id = `element-${elementCounter}`;
    element.className = 'seating-element';
    element.dataset.type = elementType;
    
    // S'assurer que l'élément est en position absolute
    element.style.position = 'absolute';
    
    // Position par défaut au centre avec un petit décalage
    const centerX = Math.max(50, seatingWorkspace.offsetWidth / 2 + (elementCounter * 20) - 50);
    const centerY = Math.max(50, seatingWorkspace.offsetHeight / 2 + (elementCounter * 20) - 50);
    
    element.style.left = centerX + 'px';
    element.style.top = centerY + 'px';
    
    console.log('Creating element at position:', centerX, centerY);
    
    // Définir le contenu selon le type
    switch(elementType) {
        case 'desk-single':
            element.classList.add('desk-single');
            element.innerHTML = `
                <div class="desk-content">
                    <div class="student-slot" data-capacity="1" title="Déposez un élève ici"></div>
                </div>
                <button class="element-delete" onclick="deleteElement('${element.id}')">
                    <i class="fas fa-times"></i>
                </button>
            `;
            break;
            
        case 'desk-double':
            element.classList.add('desk-double');
            element.innerHTML = `
                <div class="desk-content">
                    <div class="student-slots">
                        <div class="student-slot" data-capacity="1" title="Déposez un élève ici"></div>
                        <div class="student-slot" data-capacity="1" title="Déposez un élève ici"></div>
                    </div>
                </div>
                <button class="element-delete" onclick="deleteElement('${element.id}')">
                    <i class="fas fa-times"></i>
                </button>
            `;
            break;
            
        case 'teacher-desk':
            element.classList.add('teacher-desk');
            element.innerHTML = `
                <div class="desk-content">
                    <i class="fas fa-chalkboard-teacher"></i>
                    <span>Bureau enseignant</span>
                </div>
                <button class="element-delete" onclick="deleteElement('${element.id}')">
                    <i class="fas fa-times"></i>
                </button>
            `;
            break;
    }
    
    // Système de drag-and-drop simplifié directement sur l'élément
    let offsetX = 0;
    let offsetY = 0;
    let isDraggingElement = false;
    
    element.onmousedown = function(e) {
        if (e.target.classList.contains('element-delete') || e.target.closest('.element-delete')) {
            return;
        }
        
        e.preventDefault();
        isDraggingElement = true;
        
        const rect = element.getBoundingClientRect();
        offsetX = e.clientX - rect.left;
        offsetY = e.clientY - rect.top;
        
        element.style.cursor = 'grabbing';
        element.style.zIndex = '1000';
        
        function moveElement(e) {
            if (!isDraggingElement) return;
            
            const workspaceRect = seatingWorkspace.getBoundingClientRect();
            let newX = e.clientX - workspaceRect.left - offsetX;
            let newY = e.clientY - workspaceRect.top - offsetY;
            
            // Contraindre aux limites
            newX = Math.max(0, Math.min(newX, seatingWorkspace.offsetWidth - element.offsetWidth));
            newY = Math.max(0, Math.min(newY, seatingWorkspace.offsetHeight - element.offsetHeight));
            
            element.style.left = newX + 'px';
            element.style.top = newY + 'px';
        }
        
        function stopDragging() {
            isDraggingElement = false;
            element.style.cursor = 'grab';
            element.style.zIndex = '';
            document.removeEventListener('mousemove', moveElement);
            document.removeEventListener('mouseup', stopDragging);
        }
        
        document.addEventListener('mousemove', moveElement);
        document.addEventListener('mouseup', stopDragging);
    };
    
    seatingWorkspace.appendChild(element);
    
    // Ajuster la largeur pour les tables doubles vides dès la création
    if (elementType === 'desk-double') {
        setTimeout(() => adjustDeskWidth(element), 10);
    }
    
    // Masquer le message d'aide dès qu'il y a des éléments
    updateHelpVisibility();
    
    updateSeatingStats();
}

// Supprimer un élément
function deleteElement(elementId) {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    // Libérer les étudiants placés sur cet élément
    const studentSlots = element.querySelectorAll('.student-slot .student-placed');
    studentSlots.forEach(studentPlaced => {
        const studentId = studentPlaced.dataset.studentId;
        const studentName = studentPlaced.textContent;
        
        // Remettre l'étiquette dans la liste des étudiants
        const studentsContainer = document.getElementById('students-labels-container');
        const studentLabel = document.createElement('div');
        studentLabel.className = 'student-label';
        studentLabel.draggable = true;
        studentLabel.dataset.studentId = studentId;
        studentLabel.innerHTML = `
            <i class="fas fa-user"></i>
            <span>${studentName}</span>
        `;
        studentsContainer.appendChild(studentLabel);
    });
    
    // Supprimer l'élément
    element.remove();
    
    // Mettre à jour la visibilité du message d'aide
    updateHelpVisibility();
    
    updateSeatingStats();
}

// Fonction pour gérer la visibilité du message d'aide
function updateHelpVisibility() {
    const helpMessage = document.getElementById('seating-help');
    const elements = seatingWorkspace.querySelectorAll('.seating-element');
    
    if (helpMessage) {
        if (elements.length > 0) {
            helpMessage.style.display = 'none';
        } else {
            helpMessage.style.display = 'block';
        }
    }
}

// Gestion du mousedown sur les éléments
function handleElementMouseDown(e) {
    if (e.target.classList.contains('element-delete') || e.target.closest('.element-delete')) {
        return; // Ne pas déclencher le drag pour le bouton de suppression
    }
    
    // Ignorer si ce n'est pas un clic gauche
    if (e.button !== 0) return;
    
    e.preventDefault();
    e.stopPropagation();
    
    isDragging = true;
    currentDragElement = e.currentTarget;
    
    // Obtenir la position actuelle de l'élément et de la souris
    const elementRect = currentDragElement.getBoundingClientRect();
    const workspaceRect = seatingWorkspace.getBoundingClientRect();
    
    // Calculer l'offset de la souris par rapport à l'élément
    dragOffset.x = e.clientX - elementRect.left;
    dragOffset.y = e.clientY - elementRect.top;
    
    currentDragElement.style.zIndex = '1000';
    currentDragElement.classList.add('dragging');
    
    // Changer le curseur de tout le document
    document.body.style.cursor = 'grabbing';
    
    console.log('Start dragging element:', currentDragElement.id);
    console.log('Mouse position:', e.clientX, e.clientY);
    console.log('Element position:', elementRect.left, elementRect.top);
    console.log('Drag offset:', dragOffset.x, dragOffset.y);
}

// Gestion tactile du début de drag
function handleElementTouchStart(e) {
    if (e.target.classList.contains('element-delete') || e.target.closest('.element-delete')) {
        return; // Ne pas déclencher le drag pour le bouton de suppression
    }
    
    e.preventDefault();
    e.stopPropagation();
    
    const touch = e.touches[0];
    
    isDragging = true;
    currentDragElement = e.currentTarget;
    
    // Obtenir la position actuelle de l'élément et du touch
    const elementRect = currentDragElement.getBoundingClientRect();
    const workspaceRect = seatingWorkspace.getBoundingClientRect();
    
    // Calculer l'offset du touch par rapport à l'élément
    dragOffset.x = touch.clientX - elementRect.left;
    dragOffset.y = touch.clientY - elementRect.top;
    
    currentDragElement.style.zIndex = '1000';
    currentDragElement.classList.add('dragging');
    
    // Changer le curseur de tout le document
    document.body.style.cursor = 'grabbing';
    
    console.log('Start touch dragging element:', currentDragElement.id);
    console.log('Touch position:', touch.clientX, touch.clientY);
    console.log('Element position:', elementRect.left, elementRect.top);
    console.log('Touch drag offset:', dragOffset.x, dragOffset.y);
}

// Gestion du mousemove
function handleMouseMove(e) {
    if (!isDragging || !currentDragElement) return;
    
    e.preventDefault();
    
    const workspaceRect = seatingWorkspace.getBoundingClientRect();
    
    // Calculer la nouvelle position relative au workspace
    let newX = e.clientX - workspaceRect.left - dragOffset.x;
    let newY = e.clientY - workspaceRect.top - dragOffset.y;
    
    // Contraindre aux limites de l'espace de travail
    newX = Math.max(0, Math.min(newX, seatingWorkspace.offsetWidth - currentDragElement.offsetWidth));
    newY = Math.max(0, Math.min(newY, seatingWorkspace.offsetHeight - currentDragElement.offsetHeight));
    
    currentDragElement.style.left = newX + 'px';
    currentDragElement.style.top = newY + 'px';
    
    console.log('Moving to:', newX, newY);
}

// Gestion du mouseup
function handleMouseUp(e) {
    if (isDragging && currentDragElement) {
        console.log('Stop dragging element:', currentDragElement.id);
        currentDragElement.style.zIndex = '';
        currentDragElement.classList.remove('dragging');
    }
    
    // Restaurer le curseur
    document.body.style.cursor = '';
    
    isDragging = false;
    currentDragElement = null;
}

// Gestion tactile pour tablettes
function handleTouchMove(e) {
    if (!isDragging || !currentDragElement) return;
    
    e.preventDefault();
    
    const touch = e.touches[0];
    const workspaceRect = seatingWorkspace.getBoundingClientRect();
    
    // Calculer la nouvelle position relative au workspace
    let newX = touch.clientX - workspaceRect.left - dragOffset.x;
    let newY = touch.clientY - workspaceRect.top - dragOffset.y;
    
    // Contraindre aux limites de l'espace de travail
    newX = Math.max(0, Math.min(newX, seatingWorkspace.offsetWidth - currentDragElement.offsetWidth));
    newY = Math.max(0, Math.min(newY, seatingWorkspace.offsetHeight - currentDragElement.offsetHeight));
    
    currentDragElement.style.left = newX + 'px';
    currentDragElement.style.top = newY + 'px';
    
    console.log('Touch moving to:', newX, newY);
}

function handleTouchEnd(e) {
    if (isDragging && currentDragElement) {
        console.log('Stop touch dragging element:', currentDragElement.id);
        currentDragElement.style.zIndex = '';
        currentDragElement.classList.remove('dragging');
    }
    
    // Restaurer le curseur
    document.body.style.cursor = '';
    
    isDragging = false;
    currentDragElement = null;
}

// Gestion du dragover sur l'espace de travail
function handleWorkspaceDragOver(e) {
    e.preventDefault();
}

// Gestion du drop sur l'espace de travail
function handleWorkspaceDrop(e) {
    e.preventDefault();
    
    // Trouver l'élément étudiant en cours de drag
    const draggedStudentId = e.dataTransfer.getData('studentId');
    if (!draggedStudentId) return;
    
    const draggedElement = document.querySelector(`.student-label[data-student-id="${draggedStudentId}"]`) || 
                           document.querySelector(`.student-label[data-studentid="${draggedStudentId}"]`);
    if (!draggedElement) return;
    
    // Restaurer l'opacité
    draggedElement.style.opacity = '';
    
    // Trouver la table la plus proche
    const workspaceRect = seatingWorkspace.getBoundingClientRect();
    const dropX = e.clientX - workspaceRect.left;
    const dropY = e.clientY - workspaceRect.top;
    
    console.log('Drop position:', dropX, dropY);
    
    const closestDesk = findClosestDesk(dropX, dropY);
    
    if (closestDesk) {
        console.log('Found closest desk:', closestDesk.id);
        // Passer la position X absolue du drop
        placeStudentOnDesk(draggedElement, closestDesk, e.clientX);
    } else {
        console.log('No desk found within magnetism radius');
    }
}

// Trouver la table la plus proche dans le rayon d'aimantation
function findClosestDesk(x, y) {
    const desks = seatingWorkspace.querySelectorAll('.seating-element');
    let closestDesk = null;
    let minDistance = magnetRadius;
    
    desks.forEach(desk => {
        if (desk.dataset.type === 'teacher-desk') return; // Exclure le bureau enseignant
        
        const rect = desk.getBoundingClientRect();
        const workspaceRect = seatingWorkspace.getBoundingClientRect();
        
        const deskCenterX = rect.left - workspaceRect.left + rect.width / 2;
        const deskCenterY = rect.top - workspaceRect.top + rect.height / 2;
        
        const distance = Math.sqrt(Math.pow(x - deskCenterX, 2) + Math.pow(y - deskCenterY, 2));
        
        if (distance < minDistance) {
            // Vérifier s'il y a de la place
            const availableSlot = desk.querySelector('.student-slot:not(.occupied)');
            if (availableSlot) {
                minDistance = distance;
                closestDesk = desk;
            }
        }
    });
    
    return closestDesk;
}

// Ajuster la largeur d'une table et de ses slots en fonction du contenu
function adjustDeskWidth(desk) {
    const allSlots = desk.querySelectorAll('.student-slot');
    const occupiedSlots = desk.querySelectorAll('.student-slot.occupied .student-placed');
    
    // Si aucun étudiant, revenir à la largeur de base
    if (occupiedSlots.length === 0) {
        if (desk.classList.contains('desk-single')) {
            desk.style.width = '80px';
            // Remettre le slot à sa largeur par défaut
            allSlots.forEach(slot => {
                slot.style.width = '';
            });
        } else {
            // Pour les tables doubles vides, calculer la largeur pour 2 slots de 25px
            const emptySlotWidth = 25;
            const gapWidth = 8; // Nouveau gap plus large
            const tablePadding = 16;
            const minTableWidth = (emptySlotWidth * 2) + gapWidth + tablePadding;
            desk.style.width = Math.max(120, minTableWidth) + 'px';
            
            // Définir explicitement la largeur des slots vides
            allSlots.forEach(slot => {
                slot.style.width = emptySlotWidth + 'px';
            });
        }
        return;
    }
    
    if (desk.classList.contains('desk-double')) {
        // Pour les tables doubles, ajuster chaque slot individuellement
        const slots = desk.querySelectorAll('.student-slot');
        let totalCalculatedWidth = 0;
        
        slots.forEach(slot => {
            if (slot.classList.contains('occupied')) {
                const studentPlaced = slot.querySelector('.student-placed');
                if (studentPlaced) {
                    const name = studentPlaced.textContent || '';
                    const cleanName = name.replace('×', '').trim();
                    
                    // Mesurer la largeur du texte
                    const tempElement = document.createElement('span');
                    tempElement.style.visibility = 'hidden';
                    tempElement.style.position = 'absolute';
                    tempElement.style.fontSize = '0.65rem';
                    tempElement.style.fontWeight = '500';
                    tempElement.style.fontFamily = window.getComputedStyle(studentPlaced).fontFamily;
                    tempElement.textContent = cleanName;
                    
                    document.body.appendChild(tempElement);
                    const textWidth = tempElement.offsetWidth;
                    document.body.removeChild(tempElement);
                    
                    // Calculer la largeur optimale pour ce slot
                    const slotPadding = 24; // Padding + bouton suppression
                    const slotWidth = Math.max(35, textWidth + slotPadding);
                    slot.style.width = slotWidth + 'px';
                    totalCalculatedWidth += slotWidth;
                }
            } else {
                // Slot vide, largeur minimale
                slot.style.width = '25px';
                totalCalculatedWidth += 25;
            }
        });
        
        // Ajouter le gap entre les slots + padding de la table
        const gapWidth = 8; // CSS gap (correspondant au CSS gap: 8px)
        const tablePadding = 16; // Padding de la table
        const tableWidth = Math.max(120, totalCalculatedWidth + gapWidth + tablePadding);
        const maxWidth = 300; // Limite pour les tables doubles
        desk.style.width = Math.min(tableWidth, maxWidth) + 'px';
        
    } else {
        // Pour les tables simples
        const slot = allSlots[0];
        if (slot && slot.classList.contains('occupied')) {
            const studentPlaced = slot.querySelector('.student-placed');
            if (studentPlaced) {
                const name = studentPlaced.textContent || '';
                const cleanName = name.replace('×', '').trim();
                
                // Mesurer la largeur du texte
                const tempElement = document.createElement('span');
                tempElement.style.visibility = 'hidden';
                tempElement.style.position = 'absolute';
                tempElement.style.fontSize = '0.65rem';
                tempElement.style.fontWeight = '500';
                tempElement.style.fontFamily = window.getComputedStyle(studentPlaced).fontFamily;
                tempElement.textContent = cleanName;
                
                document.body.appendChild(tempElement);
                const textWidth = tempElement.offsetWidth;
                document.body.removeChild(tempElement);
                
                // Calculer les largeurs optimales
                const slotPadding = 24; // Padding + bouton suppression
                const slotWidth = Math.max(35, textWidth + slotPadding);
                slot.style.width = slotWidth + 'px';
                
                const tableWidth = Math.max(60, slotWidth + 16); // + padding de la table
                const maxWidth = 200; // Limite pour les tables simples
                desk.style.width = Math.min(tableWidth, maxWidth) + 'px';
            }
        }
    }
}

// Placer un étudiant sur une table
function placeStudentOnDesk(studentLabel, desk, dropX = null) {
    let targetSlot = null;
    
    // Si c'est une table double et qu'on a une position de drop
    if (desk.classList.contains('desk-double') && dropX !== null) {
        const slots = desk.querySelectorAll('.student-slot');
        const deskRect = desk.getBoundingClientRect();
        const deskMiddle = deskRect.left + deskRect.width / 2;
        
        // Déterminer quel slot utiliser selon la position du drop
        if (dropX < deskMiddle) {
            // Côté gauche
            targetSlot = slots[0];
        } else {
            // Côté droit
            targetSlot = slots[1];
        }
        
        // Si le slot choisi est occupé, essayer l'autre
        if (targetSlot && targetSlot.classList.contains('occupied')) {
            targetSlot = slots[0] === targetSlot ? slots[1] : slots[0];
        }
        
        // Vérifier si le slot alternatif est disponible
        if (targetSlot && targetSlot.classList.contains('occupied')) {
            targetSlot = null;
        }
    } else {
        // Pour les tables simples ou si pas de position, prendre le premier slot disponible
        targetSlot = desk.querySelector('.student-slot:not(.occupied)');
    }
    
    if (!targetSlot) {
        console.log('No available slot on this desk');
        return;
    }
    
    const studentId = studentLabel.dataset.studentId || studentLabel.dataset.studentid;
    const studentName = studentLabel.querySelector('span').textContent;
    
    console.log('Placing student:', studentName, 'on desk:', desk.id);
    
    // Créer l'élément étudiant placé
    const studentPlaced = document.createElement('div');
    studentPlaced.className = 'student-placed';
    studentPlaced.dataset.studentId = studentId;
    studentPlaced.textContent = studentName;
    
    // Ajouter un bouton pour retirer l'étudiant
    const removeBtn = document.createElement('button');
    removeBtn.className = 'student-remove';
    removeBtn.innerHTML = '<i class="fas fa-times"></i>';
    removeBtn.onclick = () => removeStudentFromDesk(studentId);
    
    studentPlaced.appendChild(removeBtn);
    
    // Marquer le slot comme occupé
    targetSlot.classList.add('occupied');
    targetSlot.innerHTML = ''; // Vider le slot
    targetSlot.appendChild(studentPlaced);
    
    // Supprimer l'étiquette de la liste
    studentLabel.remove();
    
    // Ajuster la largeur de la table en fonction du contenu (avec petit délai pour le rendu)
    setTimeout(() => adjustDeskWidth(desk), 10);
    
    // Mettre à jour le compteur
    const studentsCountSpan = document.getElementById('sidebar-students-count');
    if (studentsCountSpan) {
        const remainingCount = document.getElementById('students-labels-container').querySelectorAll('.student-label').length;
        studentsCountSpan.textContent = remainingCount;
    }
    
    updateSeatingStats();
}

// Retirer un étudiant d'une table
function removeStudentFromDesk(studentId) {
    const studentPlaced = seatingWorkspace.querySelector(`.student-placed[data-student-id="${studentId}"]`) ||
                         seatingWorkspace.querySelector(`.student-placed[data-studentid="${studentId}"]`);
    if (!studentPlaced) return;
    
    const studentName = studentPlaced.textContent;
    const slot = studentPlaced.parentElement;
    
    // Retirer de la table
    slot.classList.remove('occupied');
    studentPlaced.remove();
    
    // Ajuster la largeur de la table après suppression (avec petit délai pour le rendu)
    const desk = slot.closest('.seating-element');
    if (desk) {
        setTimeout(() => adjustDeskWidth(desk), 10);
    }
    
    // Remettre dans la liste des étudiants
    const studentsContainer = document.getElementById('students-labels-container');
    const studentLabel = document.createElement('div');
    studentLabel.className = 'student-label';
    studentLabel.draggable = true;
    studentLabel.dataset.studentId = studentId;
    studentLabel.innerHTML = `
        <i class="fas fa-user"></i>
        <span>${studentName}</span>
    `;
    
    studentsContainer.appendChild(studentLabel);
    
    // Mettre à jour le compteur
    const studentsCountSpan = document.getElementById('sidebar-students-count');
    if (studentsCountSpan) {
        const currentCount = studentsContainer.querySelectorAll('.student-label').length;
        studentsCountSpan.textContent = currentCount;
    }
    
    updateSeatingStats();
}

// Réinitialiser le placement des étudiants
function resetStudentsPlacement() {
    const placedStudents = seatingWorkspace.querySelectorAll('.student-placed');
    placedStudents.forEach(studentPlaced => {
        const studentId = studentPlaced.dataset.studentId;
        removeStudentFromDesk(studentId);
    });
}

// Sauvegarder le plan de classe
function saveSeatingPlan() {
    // S'assurer que seatingWorkspace est initialisé
    if (!seatingWorkspace) {
        seatingWorkspace = document.getElementById('seating-workspace');
        if (!seatingWorkspace) {
            showNotification('error', 'Espace de travail non trouvé');
            return;
        }
    }
    
    const classSelect = document.getElementById('classSelect');
    const selectedClassId = classSelect ? classSelect.value : null;
    
    if (!selectedClassId) {
        showNotification('error', 'Veuillez sélectionner une classe');
        return;
    }
    
    // Collecter les données du plan
    const planData = {
        classroom_id: selectedClassId,
        elements: [],
        students_placement: []
    };
    
    // Récupérer les éléments (tables et bureau)
    const elements = seatingWorkspace.querySelectorAll('.seating-element');
    elements.forEach(element => {
        const rect = element.getBoundingClientRect();
        const workspaceRect = seatingWorkspace.getBoundingClientRect();
        
        planData.elements.push({
            id: element.id,
            type: element.dataset.type,
            x: element.offsetLeft,
            y: element.offsetTop
        });
    });
    
    // Récupérer le placement des étudiants
    const placedStudents = seatingWorkspace.querySelectorAll('.student-placed');
    placedStudents.forEach(studentPlaced => {
        const studentId = studentPlaced.dataset.studentId;
        const studentName = studentPlaced.textContent.trim();
        const desk = studentPlaced.closest('.seating-element');
        const slot = studentPlaced.parentElement;
        const slotIndex = Array.from(desk.querySelectorAll('.student-slot')).indexOf(slot);
        
        planData.students_placement.push({
            student_id: studentId,
            student_name: studentName,
            element_id: desk.id,
            slot_index: slotIndex
        });
    });
    
    // Envoyer au serveur
    fetch('/planning/save-seating-plan', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            classroom_id: selectedClassId,
            plan_data: planData,
            name: 'Plan par défaut'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('success', 'Plan de classe sauvegardé avec succès !');
        } else {
            showNotification('error', 'Erreur lors de la sauvegarde : ' + data.message);
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        showNotification('error', 'Erreur de connexion lors de la sauvegarde');
    });
}

// Créer un élément table simple
function createSingleDesk(customId = null) {
    if (!customId) {
        elementCounter++;
        customId = `element-${elementCounter}`;
    }
    const element = document.createElement('div');
    element.id = customId;
    element.className = 'seating-element desk-single';
    element.dataset.type = 'desk-single';
    element.style.position = 'absolute';
    
    element.innerHTML = `
        <div class="desk-content">
            <div class="student-slot" data-capacity="1" title="Déposez un élève ici"></div>
        </div>
        <button class="element-delete" onclick="deleteElement('${customId}')">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    return element;
}

// Créer un élément table double
function createDoubleDesk(customId = null) {
    if (!customId) {
        elementCounter++;
        customId = `element-${elementCounter}`;
    }
    const element = document.createElement('div');
    element.id = customId;
    element.className = 'seating-element desk-double';
    element.dataset.type = 'desk-double';
    element.style.position = 'absolute';
    
    element.innerHTML = `
        <div class="desk-content">
            <div class="student-slots">
                <div class="student-slot" data-capacity="1" title="Déposez un élève ici"></div>
                <div class="student-slot" data-capacity="1" title="Déposez un élève ici"></div>
            </div>
        </div>
        <button class="element-delete" onclick="deleteElement('${customId}')">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    // Ajuster la largeur pour les tables doubles vides dès la création
    setTimeout(() => adjustDeskWidth(element), 10);
    
    return element;
}

// Créer un bureau enseignant
function createTeacherDesk(customId = null) {
    if (!customId) {
        elementCounter++;
        customId = `element-${elementCounter}`;
    }
    const element = document.createElement('div');
    element.id = customId;
    element.className = 'seating-element teacher-desk';
    element.dataset.type = 'teacher-desk';
    element.style.position = 'absolute';
    
    element.innerHTML = `
        <div class="desk-content">
            <i class="fas fa-chalkboard-teacher"></i>
            <span>Bureau enseignant</span>
        </div>
        <button class="element-delete" onclick="deleteElement('${customId}')">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    return element;
}

// Configurer le drag-and-drop pour un élément
function setupElementDragging(element) {
    let offsetX = 0;
    let offsetY = 0;
    let isDraggingElement = false;
    
    element.onmousedown = function(e) {
        if (e.target.classList.contains('element-delete') || e.target.closest('.element-delete')) {
            return;
        }
        
        e.preventDefault();
        isDraggingElement = true;
        
        const rect = element.getBoundingClientRect();
        offsetX = e.clientX - rect.left;
        offsetY = e.clientY - rect.top;
        
        element.style.cursor = 'grabbing';
        element.style.zIndex = '1000';
        
        function moveElement(e) {
            if (!isDraggingElement) return;
            
            const workspaceRect = seatingWorkspace.getBoundingClientRect();
            let newX = e.clientX - workspaceRect.left - offsetX;
            let newY = e.clientY - workspaceRect.top - offsetY;
            
            // Contraindre aux limites
            newX = Math.max(0, Math.min(newX, seatingWorkspace.offsetWidth - element.offsetWidth));
            newY = Math.max(0, Math.min(newY, seatingWorkspace.offsetHeight - element.offsetHeight));
            
            element.style.left = newX + 'px';
            element.style.top = newY + 'px';
        }
        
        function stopDragging() {
            isDraggingElement = false;
            element.style.cursor = 'grab';
            element.style.zIndex = '';
            document.removeEventListener('mousemove', moveElement);
            document.removeEventListener('mouseup', stopDragging);
        }
        
        document.addEventListener('mousemove', moveElement);
        document.addEventListener('mouseup', stopDragging);
    };
    
    // Support tactile pour tablettes
    element.ontouchstart = function(e) {
        if (e.target.classList.contains('element-delete') || e.target.closest('.element-delete')) {
            return;
        }
        
        e.preventDefault();
        e.stopPropagation();
        isDraggingElement = true;
        
        const touch = e.touches[0];
        const rect = element.getBoundingClientRect();
        offsetX = touch.clientX - rect.left;
        offsetY = touch.clientY - rect.top;
        
        element.style.cursor = 'grabbing';
        element.style.zIndex = '1000';
        
        function moveTouchElement(e) {
            if (!isDraggingElement) return;
            
            e.preventDefault();
            const touch = e.touches[0];
            const workspaceRect = seatingWorkspace.getBoundingClientRect();
            let newX = touch.clientX - workspaceRect.left - offsetX;
            let newY = touch.clientY - workspaceRect.top - offsetY;
            
            // Contraindre aux limites
            newX = Math.max(0, Math.min(newX, seatingWorkspace.offsetWidth - element.offsetWidth));
            newY = Math.max(0, Math.min(newY, seatingWorkspace.offsetHeight - element.offsetHeight));
            
            element.style.left = newX + 'px';
            element.style.top = newY + 'px';
        }
        
        function stopTouchDragging() {
            isDraggingElement = false;
            element.style.cursor = 'grab';
            element.style.zIndex = '';
            document.removeEventListener('touchmove', moveTouchElement);
            document.removeEventListener('touchend', stopTouchDragging);
        }
        
        document.addEventListener('touchmove', moveTouchElement, {passive: false});
        document.addEventListener('touchend', stopTouchDragging);
    };
}

// Charger un plan de classe depuis le serveur
function loadSeatingPlan(classroomId) {
    if (!classroomId) {
        return;
    }
    
    // S'assurer que seatingWorkspace est initialisé
    if (!seatingWorkspace) {
        seatingWorkspace = document.getElementById('seating-workspace');
        if (!seatingWorkspace) {
            console.log('Seating workspace not found, unable to load plan');
            return;
        }
    }
    
    fetch(`/planning/load-seating-plan/${classroomId}`)
    .then(response => response.json())
    .then(data => {
        if (data.success && data.plan_data) {
            // Effacer le plan actuel
            clearSeatingWorkspace();
            
            // Recréer les éléments
            const planData = data.plan_data;
            
            // Restaurer les éléments (tables et bureau)
            if (planData.elements) {
                planData.elements.forEach(elementData => {
                    let element;
                    if (elementData.type === 'desk-single') {
                        element = createSingleDesk(elementData.id);
                    } else if (elementData.type === 'desk-double') {
                        element = createDoubleDesk(elementData.id);
                    } else if (elementData.type === 'teacher-desk') {
                        element = createTeacherDesk(elementData.id);
                    }
                    
                    if (element) {
                        element.style.left = elementData.x + 'px';
                        element.style.top = elementData.y + 'px';
                        seatingWorkspace.appendChild(element);
                        setupElementDragging(element);
                    }
                });
            }
            
            // Restaurer le placement des étudiants
            if (planData.students_placement) {
                planData.students_placement.forEach(placement => {
                    const element = document.getElementById(placement.element_id);
                    const studentLabel = document.querySelector(`[data-student-id="${placement.student_id}"]`);
                    
                    if (element && studentLabel) {
                        const slots = element.querySelectorAll('.student-slot');
                        const targetSlot = slots[placement.slot_index];
                        
                        if (targetSlot && !targetSlot.querySelector('.student-placed')) {
                            placeStudentInSlot(studentLabel, targetSlot);
                        }
                    }
                });
            }
            
            showNotification('success', 'Plan de classe chargé avec succès !');
            
            // Mettre à jour la visibilité du message d'aide
            updateHelpVisibility();
        } else if (data.success && !data.plan_data) {
            // Pas de plan sauvegardé, c'est normal
            console.log('Aucun plan sauvegardé pour cette classe');
            
            // Afficher le message d'aide s'il n'y a pas de plan
            updateHelpVisibility();
        } else {
            showNotification('error', 'Erreur lors du chargement : ' + data.message);
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        showNotification('error', 'Erreur de connexion lors du chargement');
    });
}

// Charger le plan de classe du maître de classe
function loadMasterSeatingPlan() {
    const selectedClass = getSelectedClassroomId();
    if (!selectedClass) {
        showNotification('error', 'Aucune classe sélectionnée');
        return;
    }
    
    // Confirmer l'action avec l'utilisateur
    if (!confirm('Voulez-vous remplacer votre plan actuel par celui du maître de classe ? Cette action est irréversible.')) {
        return;
    }
    
    // Récupérer la liste des élèves actuels pour faire la correspondance
    const currentStudents = {};
    document.querySelectorAll('#students-labels-container .student-label').forEach(label => {
        const studentId = label.dataset.studentId;
        const studentName = label.querySelector('span').textContent.trim();
        currentStudents[studentName] = studentId;
    });
    
    fetch(`/planning/load-master-seating-plan/${selectedClass}`)
    .then(response => response.json())
    .then(data => {
        if (data.success && data.plan_data) {
            // Effacer le plan actuel
            clearSeatingWorkspace();
            
            // Recréer les éléments du plan du maître
            const planData = data.plan_data;
            
            // Restaurer les éléments (tables et bureau)
            if (planData.elements) {
                planData.elements.forEach(elementData => {
                    let element;
                    if (elementData.type === 'desk-single') {
                        element = createSingleDesk(elementData.id);
                    } else if (elementData.type === 'desk-double') {
                        element = createDoubleDesk(elementData.id);
                    } else if (elementData.type === 'teacher-desk') {
                        element = createTeacherDesk(elementData.id);
                    }
                    
                    if (element) {
                        element.style.left = elementData.x + 'px';
                        element.style.top = elementData.y + 'px';
                        seatingWorkspace.appendChild(element);
                        setupElementDragging(element);
                    }
                });
            }
            
            // Restaurer le placement des étudiants (seulement ceux qui existent dans notre classe)
            if (planData.students_placement) {
                planData.students_placement.forEach(placement => {
                    const element = document.getElementById(placement.element_id);
                    const studentLabel = document.querySelector(`[data-student-id="${placement.student_id}"]`);
                    
                    // Ne placer que les élèves qui existent dans notre classe actuelle
                    if (element && studentLabel) {
                        const slots = element.querySelectorAll('.student-slot');
                        const targetSlot = slots[placement.slot_index] || slots[0]; // Fallback au premier slot
                        
                        if (targetSlot && !targetSlot.querySelector('.student-placed')) {
                            const studentPlaced = studentLabel.cloneNode(true);
                            studentPlaced.classList.add('student-placed');
                            studentPlaced.classList.remove('student-label');
                            studentPlaced.draggable = false;
                            
                            targetSlot.appendChild(studentPlaced);
                            targetSlot.classList.add('occupied');
                            studentLabel.style.display = 'none';
                            
                            // Ajuster la largeur de la table
                            setTimeout(() => adjustDeskWidth(element), 10);
                        }
                    } else if (element && !studentLabel) {
                        // Log pour debug : élève du plan du maître non trouvé dans notre classe
                        console.log(`Élève ${placement.student_id} du plan du maître non trouvé dans la classe actuelle`);
                    }
                });
            }
            
            // Maintenant sauvegarder ce plan adapté pour que ça fonctionne aussi sur lesson_view
            setTimeout(() => {
                console.log('DEBUG: Auto-saving adapted seating plan...');
                saveSeatingPlan();
            }, 500);
            
            // Afficher le message d'aide s'il n'y a pas de plan
            updateHelpVisibility();
            
            showNotification('success', 'Plan du maître de classe chargé avec succès');
            
            // Le bouton reste visible pour permettre de recharger le plan si nécessaire
        } else {
            showNotification('error', data.message || 'Erreur lors du chargement du plan du maître');
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        showNotification('error', 'Erreur de connexion lors du chargement');
    });
}

// Effacer l'espace de travail
function clearSeatingWorkspace() {
    // S'assurer que seatingWorkspace est initialisé
    if (!seatingWorkspace) {
        seatingWorkspace = document.getElementById('seating-workspace');
        if (!seatingWorkspace) {
            console.log('Seating workspace not found, unable to clear');
            return;
        }
    }
    
    // Supprimer tous les éléments du workspace
    const elements = seatingWorkspace.querySelectorAll('.seating-element');
    elements.forEach(element => element.remove());
    
    // Remettre tous les étudiants dans la barre latérale
    const placedStudents = document.querySelectorAll('.student-placed');
    placedStudents.forEach(student => {
        student.classList.remove('student-placed');
        student.classList.add('student-label');
        student.style.display = 'block';
        
        // Remettre dans la barre latérale
        const studentsSidebar = document.querySelector('.students-sidebar .students-list');
        if (studentsSidebar) {
            studentsSidebar.appendChild(student);
        }
    });
    
    // Mettre à jour la visibilité du message d'aide
    updateHelpVisibility();
}

// Fonction utilitaire pour placer un étudiant dans un slot spécifique
function placeStudentInSlot(studentLabel, slot) {
    if (!slot || slot.querySelector('.student-placed')) {
        return false;
    }
    
    // Cacher le label original dans la barre latérale
    studentLabel.style.display = 'none';
    
    // Créer une copie dans la table
    const studentPlaced = studentLabel.cloneNode(true);
    studentPlaced.classList.remove('student-label');
    studentPlaced.classList.add('student-placed');
    studentPlaced.style.display = 'block';
    studentPlaced.style.opacity = '1';
    
    // Ajouter un bouton de suppression
    const removeBtn = document.createElement('span');
    removeBtn.classList.add('remove-student');
    removeBtn.innerHTML = '×';
    removeBtn.onclick = function(e) {
        e.stopPropagation();
        removeStudentFromDesk(studentPlaced.dataset.studentId);
    };
    studentPlaced.appendChild(removeBtn);
    
    // Marquer le slot comme occupé
    slot.classList.add('occupied');
    slot.appendChild(studentPlaced);
    
    // Ajuster la largeur de la table (avec petit délai pour le rendu)
    const desk = slot.closest('.seating-element');
    if (desk) {
        setTimeout(() => adjustDeskWidth(desk), 10);
    }
    
    return true;
}

// Mettre à jour les statistiques (simplifiée)
function updateSeatingStats() {
    // Cette fonction peut être étendue plus tard si nécessaire
    console.log('Seating plan updated');
}

// Event listeners pour les étiquettes d'étudiants
document.addEventListener('dragstart', function(e) {
    if (e.target.classList.contains('student-label')) {
        e.target.style.opacity = '0.5';
        // Stocker l'ID de l'étudiant dans dataTransfer (vérifier les deux cas)
        const studentId = e.target.dataset.studentId || e.target.dataset.studentid;
        e.dataTransfer.setData('studentId', studentId);
        e.dataTransfer.effectAllowed = 'move';
        console.log('Start dragging student:', studentId);
    }
});

document.addEventListener('dragend', function(e) {
    if (e.target.classList.contains('student-label')) {
        e.target.style.opacity = '';
    }
});

// Support tactile pour les étudiants sur tablettes
let touchDraggedStudent = null;
let studentTouchStartPos = null;
let isDraggingStudent = false;

document.addEventListener('touchstart', function(e) {
    if (e.target.classList.contains('student-label')) {
        e.preventDefault();
        touchDraggedStudent = e.target;
        isDraggingStudent = false; // Pas encore en cours de drag
        
        const touch = e.touches[0];
        studentTouchStartPos = {
            x: touch.clientX,
            y: touch.clientY,
            startTime: Date.now()
        };
        
        console.log('Touch start on student:', touchDraggedStudent.dataset.studentId);
    }
});

document.addEventListener('touchmove', function(e) {
    if (!touchDraggedStudent) return;
    
    const touch = e.touches[0];
    const deltaX = Math.abs(touch.clientX - studentTouchStartPos.x);
    const deltaY = Math.abs(touch.clientY - studentTouchStartPos.y);
    
    // Commencer le drag si on bouge de plus de 10px
    if (!isDraggingStudent && (deltaX > 10 || deltaY > 10)) {
        isDraggingStudent = true;
        touchDraggedStudent.style.opacity = '0.5';
        touchDraggedStudent.style.pointerEvents = 'none'; // Éviter les conflits
        console.log('Start touch dragging student:', touchDraggedStudent.dataset.studentId);
    }
    
    if (isDraggingStudent) {
        e.preventDefault();
        // Créer un feedback visuel de drag si nécessaire
    }
});

document.addEventListener('touchend', function(e) {
    if (!touchDraggedStudent) return;
    
    const touch = e.changedTouches[0];
    const elementUnderTouch = document.elementFromPoint(touch.clientX, touch.clientY);
    
    if (isDraggingStudent && elementUnderTouch) {
        // Trouver le bureau le plus proche
        const desk = elementUnderTouch.closest('.seating-element');
        if (desk) {
            console.log('Touch drop student on desk:', desk.id);
            // Utiliser la même logique que le drop souris
            const studentId = touchDraggedStudent.dataset.studentId || touchDraggedStudent.dataset.studentid;
            if (studentId) {
                placeStudentOnDesk(touchDraggedStudent, desk, touch.clientX);
            }
        }
    }
    
    // Nettoyage
    if (touchDraggedStudent) {
        touchDraggedStudent.style.opacity = '';
        touchDraggedStudent.style.pointerEvents = '';
        touchDraggedStudent = null;
        isDraggingStudent = false;
        studentTouchStartPos = null;
        console.log('End touch drag student');
    }
});

// Ajouter des event listeners pour le drag over sur les tables
document.addEventListener('dragover', function(e) {
    if (e.target.closest('.seating-element')) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        
        const desk = e.target.closest('.seating-element');
        desk.style.boxShadow = '0 0 10px rgba(0, 123, 255, 0.5)';
        
        // Pour les tables doubles, mettre en évidence le slot qui sera utilisé
        if (desk.classList.contains('desk-double')) {
            const slots = desk.querySelectorAll('.student-slot');
            const deskRect = desk.getBoundingClientRect();
            const deskMiddle = deskRect.left + deskRect.width / 2;
            
            // Réinitialiser les styles
            slots.forEach(slot => {
                if (!slot.classList.contains('occupied')) {
                    slot.style.background = 'rgba(255,255,255,0.9)';
                    slot.style.borderColor = '#999';
                }
            });
            
            // Mettre en évidence le slot approprié
            if (e.clientX < deskMiddle) {
                if (!slots[0].classList.contains('occupied')) {
                    slots[0].style.background = 'rgba(0, 123, 255, 0.2)';
                    slots[0].style.borderColor = '#007bff';
                    slots[0].style.borderWidth = '2px';
                }
            } else {
                if (!slots[1].classList.contains('occupied')) {
                    slots[1].style.background = 'rgba(0, 123, 255, 0.2)';
                    slots[1].style.borderColor = '#007bff';
                    slots[1].style.borderWidth = '2px';
                }
            }
        }
    }
});

document.addEventListener('dragleave', function(e) {
    if (e.target.closest('.seating-element')) {
        const desk = e.target.closest('.seating-element');
        desk.style.boxShadow = '';
        
        // Réinitialiser les styles des slots
        const slots = desk.querySelectorAll('.student-slot');
        slots.forEach(slot => {
            if (!slot.classList.contains('occupied')) {
                slot.style.background = 'rgba(255,255,255,0.9)';
                slot.style.borderColor = '#999';
                slot.style.borderWidth = '1px';
            }
        });
    }
});

// Gérer le drop directement sur les tables
document.addEventListener('drop', function(e) {
    if (e.target.closest('.seating-element')) {
        e.preventDefault();
        e.stopPropagation();
        
        const desk = e.target.closest('.seating-element');
        desk.style.boxShadow = '';
        
        const draggedStudentId = e.dataTransfer.getData('studentId');
        if (!draggedStudentId) return;
        
        const draggedElement = document.querySelector(`.student-label[data-student-id="${draggedStudentId}"]`) || 
                               document.querySelector(`.student-label[data-studentid="${draggedStudentId}"]`);
        if (!draggedElement) return;
        
        console.log('Drop on desk:', desk.id);
        // Passer la position X du drop pour les tables doubles
        placeStudentOnDesk(draggedElement, desk, e.clientX);
    }
});

// Initialiser le plan de classe quand on change d'onglet
document.addEventListener('DOMContentLoaded', function() {
    // Observer les changements d'onglets
    const tabButtons = document.querySelectorAll('.tab-button');
    tabButtons.forEach(button => {
        button.addEventListener('click', function() {
            if (this.dataset.tab === 'seating') {
                setTimeout(() => {
                    initializeSeatingPlan();
                    // Recharger les étudiants au cas où la classe aurait changé
                    loadStudentsForSeating();
                }, 300); // Délai plus long pour s'assurer que l'onglet est affiché
            }
        });
    });

    // Charger les étudiants immédiatement si on démarre sur l'onglet seating
    if (window.location.hash === '#seating') {
        setTimeout(() => {
            initializeSeatingPlan();
            loadStudentsForSeating();
        }, 500);
    }
    
    // Observer les changements de classe pour recharger les étudiants
    const classSelect = document.getElementById('classSelect');
    if (classSelect) {
        classSelect.addEventListener('change', function() {
            // Si on est sur l'onglet plan de classe, recharger les étudiants et le plan
            const seatingTab = document.getElementById('seating-tab');
            if (seatingTab && seatingTab.classList.contains('active')) {
                loadStudentsForSeating();
                // Attendre un délai pour s'assurer que l'espace de travail est prêt
                setTimeout(() => {
                    initializeSeatingPlan();
                    loadSeatingPlan(this.value);
                }, 200);
            }
        });
    }
});

// Fonction pour imprimer le plan de classe
function printSeatingPlan() {
    // Vérifier s'il y a des éléments dans le plan
    const seatingWorkspace = document.getElementById('seating-workspace');
    if (!seatingWorkspace) {
        showNotification('error', 'Espace de travail non trouvé');
        return;
    }
    
    const elements = seatingWorkspace.querySelectorAll('.seating-element');
    if (elements.length === 0) {
        showNotification('warning', 'Aucun élément à imprimer. Veuillez d\'abord créer votre plan de classe.');
        return;
    }
    
    // Obtenir le nom de la classe sélectionnée pour le titre
    const classSelector = document.getElementById('classroomSelector');
    const selectedClassroom = classSelector ? classSelector.options[classSelector.selectedIndex]?.text : 'Classe';
    
    // Créer un titre temporaire pour l'impression
    const printTitle = document.createElement('div');
    printTitle.innerHTML = `<h2>Plan de classe - ${selectedClassroom}</h2>`;
    printTitle.id = 'print-title';
    printTitle.style.position = 'absolute';
    printTitle.style.top = '0px';
    printTitle.style.left = '0px';
    printTitle.style.width = '100%';
    printTitle.style.textAlign = 'center';
    printTitle.style.zIndex = '1000';
    printTitle.style.backgroundColor = 'white';
    
    // Ajouter le titre au workspace
    seatingWorkspace.appendChild(printTitle);
    
    // Ajuster temporairement le padding du workspace pour faire de la place au titre
    const originalPadding = seatingWorkspace.style.paddingTop;
    seatingWorkspace.style.paddingTop = '40px';
    
    try {
        // Lancer l'impression
        window.print();
    } catch (error) {
        console.error('Erreur lors de l\'impression:', error);
        showNotification('error', 'Erreur lors de l\'impression');
    } finally {
        // Nettoyer après impression
        setTimeout(() => {
            // Supprimer le titre temporaire
            const titleElement = document.getElementById('print-title');
            if (titleElement) {
                titleElement.remove();
            }
            
            // Restaurer le padding original
            seatingWorkspace.style.paddingTop = originalPadding;
        }, 500);
    }
}

// ===== SYSTÈME D'AMÉNAGEMENTS =====

// Variables globales pour les aménagements
let accommodationTemplates = [];
let currentStudentsAccommodations = [];

// Charger les aménagements lors du changement de classe
function loadAccommodations() {
    const classroomId = document.getElementById('classSelect').value;
    if (!classroomId) {
        document.getElementById('studentsAccommodationsList').innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-universal-access fa-2x mb-2"></i>
                <p>Sélectionnez une classe pour voir les aménagements</p>
            </div>
        `;
        return;
    }

    // Charger les modèles d'aménagements et les aménagements des élèves
    Promise.all([
        fetch('/planning/get-accommodation-templates').then(r => r.json()),
        fetch(`/planning/get-student-accommodations/${classroomId}`).then(r => r.json())
    ]).then(([templatesResult, studentsResult]) => {
        if (templatesResult.success) {
            accommodationTemplates = templatesResult.templates;
        }
        
        if (studentsResult.success) {
            currentStudentsAccommodations = studentsResult.students;
            displayStudentsAccommodations();
        }
    }).catch(error => {
        console.error('Erreur lors du chargement des aménagements:', error);
    });
}

// Afficher la liste des élèves avec leurs aménagements
function displayStudentsAccommodations() {
    const container = document.getElementById('studentsAccommodationsList');
    
    if (currentStudentsAccommodations.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-universal-access fa-2x mb-2"></i>
                <p>Aucun élève dans cette classe</p>
            </div>
        `;
        return;
    }

    let html = '';
    for (const student of currentStudentsAccommodations) {
        html += `
            <div class="student-accommodations-card" style="border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem;">
                <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 0.5rem;">
                    <h4 style="margin: 0; color: #374151;">${student.full_name}</h4>
                    <button class="btn btn-sm btn-primary" onclick="showAddAccommodationModal(${student.id})" style="margin-left: auto;">
                        <i class="fas fa-plus"></i> Ajouter
                    </button>
                </div>
                <div class="accommodations-list">
                    ${student.accommodations.length > 0 ? student.accommodations.map(acc => `
                        <div class="accommodation-item" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background-color: #f8f9fa; border-radius: 0.25rem; margin-bottom: 0.5rem;">
                            <span style="font-size: 1.2rem;">${acc.emoji}</span>
                            <div style="flex: 1;">
                                <strong>${acc.name}</strong>
                                ${acc.description ? `<div style="font-size: 0.875rem; color: #6b7280;">${acc.description}</div>` : ''}
                                ${acc.is_time_extension ? `<div style="font-size: 0.75rem; color: #059669; font-weight: 600;">⏰ +${Math.round((acc.time_multiplier - 1) * 100)}% de temps</div>` : ''}
                                ${acc.notes ? `<div style="font-size: 0.75rem; color: #7c3aed; font-style: italic;">📝 ${acc.notes}</div>` : ''}
                            </div>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteAccommodation(${acc.id})" title="Supprimer">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `).join('') : '<p style="color: #6b7280; font-style: italic; margin: 0;">Aucun aménagement</p>'}
                </div>
            </div>
        `;
    }

    container.innerHTML = html;
}

// Afficher le modal pour ajouter un aménagement
function showAddAccommodationModal(studentId = null) {
    const modal = document.getElementById('accommodationModal');
    const studentSelect = document.getElementById('accommodationStudentSelect');
    const templateSelect = document.getElementById('accommodationTemplateSelect');
    
    // Remplir la liste des élèves
    studentSelect.innerHTML = '<option value="">-- Sélectionner un élève --</option>';
    for (const student of currentStudentsAccommodations) {
        const selected = studentId && student.id === studentId ? 'selected' : '';
        studentSelect.innerHTML += `<option value="${student.id}" ${selected}>${student.full_name}</option>`;
    }
    
    // Remplir la liste des modèles d'aménagements
    templateSelect.innerHTML = '<option value="">-- Sélectionner un aménagement --</option>';
    let currentCategory = '';
    for (const template of accommodationTemplates) {
        if (template.category !== currentCategory) {
            if (currentCategory !== '') templateSelect.innerHTML += '</optgroup>';
            currentCategory = template.category;
            templateSelect.innerHTML += `<optgroup label="${template.category}">`;
        }
        templateSelect.innerHTML += `<option value="${template.id}">${template.emoji} ${template.name}</option>`;
    }
    if (currentCategory !== '') templateSelect.innerHTML += '</optgroup>';
    
    // Réinitialiser le formulaire
    document.querySelector('input[name="accommodationType"][value="template"]').checked = true;
    toggleAccommodationType();
    document.getElementById('accommodationNotes').value = '';
    
    modal.style.display = 'flex';
}

// Fermer le modal d'aménagement
function closeAccommodationModal() {
    document.getElementById('accommodationModal').style.display = 'none';
}

// Basculer entre aménagement prédéfini et personnalisé
function toggleAccommodationType() {
    const isTemplate = document.querySelector('input[name="accommodationType"]:checked').value === 'template';
    document.getElementById('templateAccommodationDiv').style.display = isTemplate ? 'block' : 'none';
    document.getElementById('customAccommodationDiv').style.display = isTemplate ? 'none' : 'block';
}

// Afficher l'aperçu du modèle sélectionné
function updateTemplatePreview() {
    const templateId = document.getElementById('accommodationTemplateSelect').value;
    const preview = document.getElementById('templatePreview');
    const content = document.getElementById('templatePreviewContent');
    
    if (!templateId) {
        preview.style.display = 'none';
        return;
    }
    
    const template = accommodationTemplates.find(t => t.id == templateId);
    if (template) {
        content.innerHTML = `
            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                <span style="font-size: 1.5rem;">${template.emoji}</span>
                <strong>${template.name}</strong>
            </div>
            ${template.description ? `<p style="margin: 0.5rem 0; color: #6b7280;">${template.description}</p>` : ''}
            ${template.is_time_extension ? `<div style="font-size: 0.875rem; color: #059669; font-weight: 600;">⏰ Extension de temps: +${Math.round((template.time_multiplier - 1) * 100)}%</div>` : ''}
        `;
        preview.style.display = 'block';
    }
}

// Basculer l'affichage du multiplicateur de temps
function toggleTimeMultiplier() {
    const isTimeExtension = document.getElementById('customIsTimeExtension').checked;
    document.getElementById('timeMultiplierDiv').style.display = isTimeExtension ? 'block' : 'none';
}

// Sauvegarder un aménagement
async function saveAccommodation() {
    const studentId = document.getElementById('accommodationStudentSelect').value;
    const accommodationType = document.querySelector('input[name="accommodationType"]:checked').value;
    const notes = document.getElementById('accommodationNotes').value;
    
    if (!studentId) {
        alert('Veuillez sélectionner un élève');
        return;
    }
    
    const data = {
        student_id: parseInt(studentId),
        accommodation_type: accommodationType,
        notes: notes
    };
    
    if (accommodationType === 'template') {
        const templateId = document.getElementById('accommodationTemplateSelect').value;
        if (!templateId) {
            alert('Veuillez sélectionner un aménagement prédéfini');
            return;
        }
        data.template_id = parseInt(templateId);
    } else {
        const name = document.getElementById('customAccommodationName').value.trim();
        const description = document.getElementById('customAccommodationDescription').value.trim();
        const emoji = document.getElementById('customAccommodationEmoji').value.trim() || '🔧';
        const isTimeExtension = document.getElementById('customIsTimeExtension').checked;
        const timeMultiplier = document.getElementById('customTimeMultiplier').value;
        
        if (!name) {
            alert('Veuillez entrer un nom pour l\'aménagement personnalisé');
            return;
        }
        
        data.custom_name = name;
        data.custom_description = description;
        data.custom_emoji = emoji;
        data.custom_is_time_extension = isTimeExtension;
        if (isTimeExtension && timeMultiplier) {
            data.custom_time_multiplier = timeMultiplier;
        }
    }
    
    try {
        const response = await fetch('/planning/add-student-accommodation', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            closeAccommodationModal();
            loadAccommodations(); // Recharger la liste
            showNotification('success', result.message);
        } else {
            alert('Erreur: ' + result.message);
        }
    } catch (error) {
        console.error('Erreur:', error);
        alert('Erreur lors de la sauvegarde');
    }
}

// Supprimer un aménagement
async function deleteAccommodation(accommodationId) {
    if (!confirm('Êtes-vous sûr de vouloir supprimer cet aménagement ?')) {
        return;
    }
    
    try {
        const response = await fetch(`/planning/delete-student-accommodation/${accommodationId}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
            loadAccommodations(); // Recharger la liste
            showNotification('success', result.message);
        } else {
            alert('Erreur: ' + result.message);
        }
    } catch (error) {
        console.error('Erreur:', error);
        alert('Erreur lors de la suppression');
    }
}

</script>

<!-- Modal nouveau dossier pour les fichiers de classe -->
<div class="modal" id="newClassFolderModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-folder-plus"></i> Nouveau dossier</h3>
            <button class="modal-close" onclick="closeModal('newClassFolderModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="newClassFolderForm" onsubmit="createClassFolder(event)">
                <div class="form-group">
                    <label class="form-label">Nom du dossier</label>
                    <input type="text" id="classFolderName" class="form-control" required
                           placeholder="Ex: Exercices">
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-outline" onclick="closeModal('newClassFolderModal')">
                Annuler
            </button>
            <button type="submit" form="newClassFolderForm" class="btn btn-primary">
                <i class="fas fa-check"></i> Créer
            </button>
        </div>
    </div>
</div>

<!-- Modal d'aperçu pour les fichiers de classe -->
<div class="modal" id="classPreviewModal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h3 id="classPreviewTitle">Aperçu</h3>
            <button class="modal-close" onclick="closeModal('classPreviewModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div id="classPreviewContent" class="preview-content"></div>
        </div>
    </div>
</div>

<!-- Modal de renommage pour les fichiers de classe -->
<div class="modal" id="classRenameModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-edit"></i> Renommer</h3>
            <button class="modal-close" onclick="closeModal('classRenameModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="classRenameForm" onsubmit="saveClassRename(event)">
                <input type="hidden" id="classRenameType">
                <input type="hidden" id="classRenameId">
                <div class="form-group">
                    <label class="form-label">Nouveau nom</label>
                    <input type="text" id="classRenameName" class="form-control" required>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-outline" onclick="closeModal('classRenameModal')">
                Annuler
            </button>
            <button type="submit" form="classRenameForm" class="btn btn-primary">
                <i class="fas fa-check"></i> Renommer
            </button>
        </div>
    </div>
</div>

<!-- Indicateur de progression pour les fichiers de classe -->
<div class="upload-progress" id="classUploadProgress">
    <div class="progress-header">
        <span>Upload en cours...</span>
        <span id="classProgressPercent">0%</span>
    </div>
    <div class="progress-bar">
        <div class="progress-fill" id="classProgressFill"></div>
    </div>
    <div class="progress-info" id="classProgressInfo"></div>
</div>

<!-- Modal nouvelle évaluation -->
<div class="modal" id="newEvaluationModal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h3><i class="fas fa-clipboard-check"></i> Nouvelle évaluation</h3>
            <button class="modal-close" onclick="closeModal('newEvaluationModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="newEvaluationForm" onsubmit="createEvaluation(event)">
                <!-- Étape 1: Informations de base -->
                <div class="eval-step" id="evalStep1">
                    <h4>Informations de l'évaluation</h4>
                    
                    <div class="form-group">
                        <label class="form-label">Titre de l'évaluation <span style="color: var(--danger-color);">*</span></label>
                        <input type="text" id="evalTitle" class="form-control" required placeholder="Ex: Test de mathématiques chapitre 3">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Date de l'évaluation</label>
                        <input type="date" id="evalDate" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Note maximale</label>
                        <input type="number" id="evalMaxPoints" class="form-control" min="1" step="0.5" value="20" required>
                        <small class="form-text">Les notes seront saisies directement selon cette échelle</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Note minimale</label>
                        <input type="number" id="evalMinPoints" class="form-control" min="0" step="0.5" value="0" required>
                        <small class="form-text">Note la plus basse possible</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Type d'évaluation <span style="color: var(--danger-color);">*</span></label>
                        <div class="radio-group">
                            <label class="radio-item">
                                <input type="radio" name="evalType" value="significatif" checked onchange="handleEvalTypeChange()">
                                <span class="radio-custom"></span>
                                <span class="radio-label">
                                    <strong>Test significatif</strong><br>
                                    <small>Compte pour 1 note directement</small>
                                </span>
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="evalType" value="ta" onchange="handleEvalTypeChange()">
                                <span class="radio-custom"></span>
                                <span class="radio-label">
                                    <strong>Élément de test assimilé (TA)</strong><br>
                                    <small>Sera groupé avec d'autres éléments TA pour former 1 note</small>
                                </span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Configuration TA (masqué par défaut) -->
                    <div class="form-group" id="taConfigGroup" style="display: none;">
                        <label class="form-label">Configuration du test assimilé</label>
                        <div class="radio-group">
                            <label class="radio-item">
                                <input type="radio" name="taMode" value="new" checked onchange="handleTAModeChange()">
                                <span class="radio-custom"></span>
                                <span class="radio-label">Créer un nouveau groupe TA</span>
                            </label>
                            <label class="radio-item" id="existingTAOption" style="display: none;">
                                <input type="radio" name="taMode" value="existing" onchange="handleTAModeChange()">
                                <span class="radio-custom"></span>
                                <span class="radio-label">Ajouter à un groupe TA existant</span>
                            </label>
                        </div>
                        
                        <div id="newTAGroup" class="form-group">
                            <label class="form-label">Nom du groupe TA</label>
                            <input type="text" id="taGroupName" class="form-control" placeholder="Ex: TA1 - Algèbre">
                        </div>
                        
                        <div id="existingTAGroup" class="form-group" style="display: none;">
                            <label class="form-label">Groupe TA existant</label>
                            <select id="taGroupSelect" class="form-control">
                                <!-- Sera rempli dynamiquement -->
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-primary" onclick="nextEvalStep()">
                            Suivant : Saisir les notes <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Étape 2: Saisie des notes -->
                <div class="eval-step" id="evalStep2" style="display: none;">
                    <h4>Saisie des notes</h4>
                    <p>Entrez les notes pour chaque élève (laissez vide si absent)</p>
                    
                    <div class="grades-input-container" id="gradesInputContainer">
                        <!-- Sera rempli dynamiquement avec la liste des élèves -->
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-outline" onclick="prevEvalStep()">
                            <i class="fas fa-arrow-left"></i> Retour
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> Créer l'évaluation
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
/* Styles pour les modals */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1000;
}

.modal.show {
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background-color: var(--white);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-lg);
    width: 90%;
    max-width: 500px;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.modal-content.modal-large {
    max-width: 900px;
}

.modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--light-gray);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
    font-size: 1.25rem;
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: var(--gray-color);
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    transition: all 0.2s ease;
}

.modal-close:hover {
    background-color: var(--light-gray);
    color: var(--dark-color);
}

.modal-body {
    padding: 1.5rem;
    overflow-y: auto;
    flex: 1;
}

.modal-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid var(--light-gray);
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
}

.preview-content {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 400px;
}

.preview-content iframe {
    width: 100%;
    height: 600px;
    border: none;
}

.preview-content img {
    max-width: 100%;
    max-height: 600px;
    object-fit: contain;
}

/* Upload progress */
.upload-progress {
    position: fixed;
    bottom: -100px;
    right: 20px;
    background-color: var(--white);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-lg);
    padding: 1rem;
    min-width: 300px;
    transition: bottom 0.3s ease;
    z-index: 1001;
}

.upload-progress.show {
    bottom: 20px;
}

.progress-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
}

.progress-bar {
    height: 4px;
    background-color: var(--light-gray);
    border-radius: 2px;
    overflow: hidden;
    margin-bottom: 0.5rem;
}

.progress-fill {
    height: 100%;
    background-color: var(--primary-color);
    transition: width 0.3s ease;
}

.progress-info {
    font-size: 0.75rem;
    color: var(--gray-color);
}

/* Styles pour les évaluations */
.radio-group {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.radio-item {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    padding: 1rem;
    border: 2px solid var(--light-gray);
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: all 0.2s ease;
}

.radio-item:hover {
    border-color: var(--primary-color);
    background-color: #F9FAFB;
}

.radio-item input[type="radio"] {
    display: none;
}

.radio-custom {
    width: 20px;
    height: 20px;
    border: 2px solid var(--light-gray);
    border-radius: 50%;
    position: relative;
    margin-top: 2px;
    transition: all 0.2s ease;
}

.radio-item input[type="radio"]:checked + .radio-custom {
    border-color: var(--primary-color);
    background-color: var(--primary-color);
}

.radio-item input[type="radio"]:checked + .radio-custom::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 6px;
    height: 6px;
    background-color: white;
    border-radius: 50%;
    transform: translate(-50%, -50%);
}

.radio-label {
    flex: 1;
}

.radio-label strong {
    display: block;
    margin-bottom: 0.25rem;
}

.radio-label small {
    color: var(--gray-color);
    font-size: 0.875rem;
}

.eval-step h4 {
    margin-bottom: 1.5rem;
    color: var(--primary-color);
}

.grades-input-container {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid var(--light-gray);
    border-radius: var(--border-radius);
    padding: 1rem;
}

.grade-input-row {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.75rem;
    border-bottom: 1px solid var(--light-gray);
}

.grade-input-row:last-child {
    border-bottom: none;
}

.student-name {
    flex: 1;
    font-weight: 500;
}

.grade-input {
    width: 100px;
    padding: 0.5rem;
    border: 1px solid var(--light-gray);
    border-radius: var(--border-radius);
    text-align: center;
}

.grade-input:focus {
    border-color: var(--primary-color);
    outline: none;
    box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.1);
}

/* Tableau des évaluations */
.evaluations-table {
    width: 100%;
    border-collapse: collapse;
    background-color: var(--white);
    border-radius: var(--border-radius);
    overflow: hidden;
    box-shadow: var(--shadow-sm);
}

.evaluations-table th,
.evaluations-table td {
    padding: 0.75rem;
    text-align: center;
    border-bottom: 1px solid var(--light-gray);
}

.evaluations-table th {
    background-color: var(--light-gray);
    font-weight: 600;
    color: var(--dark-color);
    position: sticky;
    top: 0;
    z-index: 1;
}

.evaluations-table th.student-column {
    text-align: left;
    min-width: 150px;
}

.evaluations-table th.eval-column {
    min-width: 80px;
    cursor: pointer;
    transition: background-color 0.2s ease;
}

.evaluations-table th.eval-column:hover {
    background-color: var(--primary-color);
    color: white;
}

.evaluations-table th.eval-column.selected {
    background-color: var(--primary-color);
    color: white;
}

.evaluations-table th.average-column {
    background-color: var(--primary-color);
    color: white;
    min-width: 100px;
}

.evaluations-table tr:hover {
    background-color: #F9FAFB;
}

.grade-cell {
    font-weight: 500;
}

.grade-cell.excellent { color: #059669; }
.grade-cell.good { color: #2563EB; }
.grade-cell.average { color: #F59E0B; }
.grade-cell.poor { color: #DC2626; }
.grade-cell.absent { color: var(--gray-color); font-style: italic; }

.average-cell {
    font-weight: 600;
    color: var(--primary-color);
}

/* Histogramme */
.histogram-container {
    margin: 1rem 0;
    text-align: center;
}

.evaluation-stats {
    display: flex;
    justify-content: space-around;
    gap: 2rem;
    margin-top: 1rem;
}

.stat-item {
    text-align: center;
}

.stat-label {
    display: block;
    font-size: 0.875rem;
    color: var(--gray-color);
    margin-bottom: 0.25rem;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--primary-color);
}

/* Styles pour le formulaire d'ajout d'élèves aux groupes mixtes */
.available-students-list {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 16px;
    background: var(--bg-color);
}

.source-group {
    margin-bottom: 24px;
}

.source-group:last-child {
    margin-bottom: 0;
}

.source-title {
    color: var(--text-color);
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 2px solid var(--primary-color);
}

.students-checkboxes {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 8px;
}

.student-checkbox {
    display: flex;
    align-items: center;
    padding: 8px 12px;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.student-checkbox:hover {
    background: var(--primary-light);
    border-color: var(--primary-color);
}

.student-checkbox input[type="checkbox"] {
    margin-right: 8px;
    transform: scale(1.1);
}

.student-name {
    font-weight: 500;
    color: var(--text-color);
}

.loading-message {
    text-align: center;
    padding: 32px;
    color: var(--gray-color);
    font-style: italic;
}
</style>

<script>
// Variables globales
let editingStudentId = null;
const canEditStudents = {{ can_edit_students|tojson }};
const isSpecializedTeacher = {{ is_specialized_teacher|tojson }};
const availableStudents = {{ available_students|tojson }};
const isMixedGroupClass = {{ is_mixed_group_class|tojson }};

// Gestion des onglets
function showTab(tabName) {
    // Masquer tous les contenus
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });

    // Désactiver tous les boutons
    document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active');
    });

    // Afficher le contenu sélectionné
    document.getElementById(tabName + '-tab').classList.add('active');

    // Activer le bouton correspondant
    const targetButton = document.querySelector(`[onclick="showTab('${tabName}')"]`);
    if (targetButton) {
        targetButton.classList.add('active');
    }
    
    // Charger les fichiers si on est sur l'onglet fichiers
    if (tabName === 'files') {
        loadAllClassFiles();
        // Initialiser le drag & drop pour chaque discipline éditable
        const classrooms = {{ classrooms_json | tojson }};
        const editableClassrooms = classrooms.filter(classroom => classroom.is_editable === true);
        editableClassrooms.forEach(classroom => {
            initClassDragAndDrop(classroom.id);
        });
        // Initialiser le drag & drop général aussi (pour compatibilité)
        initClassDragAndDrop();
    }
    
    // Charger les groupes si on est sur l'onglet groupes
    if (tabName === 'groups') {
        loadGroups();
    }
    
    // Charger les aménagements si on est sur l'onglet aménagements
    if (tabName === 'accommodations') {
        loadAccommodations();
    }
    
    // Charger la liste des élèves si on est sur l'onglet rapport élève
    if (tabName === 'student-report') {
        loadStudentsForReport();
    }
    
    // Charger le plan de classe si on est sur l'onglet plan de classe
    if (tabName === 'seating') {
        // Attendre un délai pour s'assurer que l'onglet est visible
        setTimeout(() => {
            initializeSeatingPlan(); // S'assurer que l'espace de travail est initialisé
            const classSelect = document.getElementById('classSelect');
            if (classSelect && classSelect.value) {
                loadSeatingPlan(classSelect.value);
            }
        }, 300);
    }
    
    // Charger les évaluations si on est sur l'onglet notes
    if (tabName === 'grades') {
        loadEvaluations();
    }
    
    // Initialiser l'onglet absences si on est sur l'onglet absences
    if (tabName === 'attendance') {
        initializeClassAbsencesTab();
    }
}

// Changer de classe
function changeClass(classGroupName) {
    // Mémoriser l'onglet actuel
    const activeTab = document.querySelector('.tab-button.active');
    let currentTab = 'students'; // onglet par défaut
    
    if (activeTab) {
        // Extraire le nom de l'onglet depuis l'onclick
        const onclickAttr = activeTab.getAttribute('onclick');
        if (onclickAttr) {
            const match = onclickAttr.match(/showTab\('([^']+)'\)/);
            if (match) {
                currentTab = match[1];
            }
        }
    }
    
    window.location.href = `{{ url_for('planning.manage_classes') }}?classroom=${encodeURIComponent(classGroupName)}&tab=${currentTab}`;
}

// Afficher/masquer le formulaire d'ajout d'élève
function toggleAddStudentForm() {
    // Empêcher l'ajout d'élèves pour les classes mixtes
    if (isMixedGroupClass) {
        showAlert('info', 'Les élèves des groupes mixtes sont gérés depuis la page des groupes mixtes.');
        return;
    }
    
    const form = document.getElementById('addStudentForm');
    form.style.display = form.style.display === 'none' ? 'block' : 'none';

    // Réinitialiser le formulaire si on le cache
    if (form.style.display === 'none') {
        resetStudentForm();
    }
}

// Réinitialiser le formulaire
function resetStudentForm() {
    if (isSpecializedTeacher) {
        // Réinitialiser le formulaire de sélection pour enseignants spécialisés
        const selectForm = document.getElementById('studentSelectForm');
        if (selectForm) {
            selectForm.reset();
        }
    } else {
        // Réinitialiser le formulaire classique pour maîtres de classe
        const studentForm = document.getElementById('studentForm');
        if (studentForm) {
            studentForm.reset();
            editingStudentId = null;
            document.querySelector('#addStudentForm h3').textContent = 'Nouvel élève';
            document.querySelector('#studentForm button[type="submit"]').innerHTML = '<i class="fas fa-save"></i> Enregistrer';
        }
    }
}

// Gestion du formulaire d'ajout/modification d'élève (pour maîtres de classe)
const studentForm = document.getElementById('studentForm');
if (studentForm) {
    studentForm.addEventListener('submit', async function(e) {
    e.preventDefault();

    const submitButton = e.target.querySelector('button[type="submit"]');
    const originalText = submitButton.innerHTML;

    // Désactiver le bouton et afficher un loader
    submitButton.disabled = true;
    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enregistrement...';

    const data = {
        classroom_id: "{{ primary_classroom.id }}",
        first_name: document.getElementById('studentFirstName').value,
        last_name: document.getElementById('studentLastName').value,
        email: document.getElementById('studentEmail').value,
        parent_email_mother: document.getElementById('parentEmailMother').value,
        parent_email_father: document.getElementById('parentEmailFather').value
    };

    try {
        let url, method;

        if (editingStudentId) {
            // Mode modification
            data.student_id = editingStudentId;
            url = '{{ url_for("planning.update_student") }}';
            method = 'PUT';
        } else {
            // Mode ajout
            url = '{{ url_for("planning.add_student") }}';
            method = 'POST';
        }

        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.success) {
            showNotification('success', result.message);

            if (editingStudentId) {
                // En mode modification, mettre à jour la carte de l'élève
                updateStudentCard(result.student);
                toggleAddStudentForm();
            } else {
                // En mode ajout, ajouter la nouvelle carte
                addStudentCard(result.student);
                // Réinitialiser le formulaire mais le garder ouvert
                document.getElementById('studentForm').reset();
                document.getElementById('studentFirstName').focus();
            }
        } else {
            showNotification('error', result.message || 'Erreur lors de l\'enregistrement');
        }
    } catch (error) {
        console.error('Erreur:', error);
        showNotification('error', 'Erreur lors de la communication avec le serveur');
    } finally {
        submitButton.disabled = false;
        submitButton.innerHTML = originalText;
    }
    });
}

// Gestion du formulaire de sélection d'élève pour enseignants spécialisés
if (isSpecializedTeacher) {
    const selectForm = document.getElementById('studentSelectForm');
    if (selectForm) {
        selectForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            const submitButton = e.target.querySelector('button[type="submit"]');
            const originalText = submitButton.innerHTML;

            // Désactiver le bouton et afficher un loader
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ajout...';

            const masterStudentId = document.getElementById('masterStudentSelect').value;

            if (!masterStudentId) {
                showNotification('error', 'Veuillez sélectionner un élève');
                submitButton.disabled = false;
                submitButton.innerHTML = originalText;
                return;
            }

            const data = {
                classroom_id: "{{ primary_classroom.id }}",
                master_student_id: parseInt(masterStudentId)
            };

            try {
                const response = await fetch('{{ url_for("planning.add_student_from_master") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    // Ajouter l'élève à la grille
                    addStudentCard(result.student);
                    
                    // Réinitialiser et fermer le formulaire
                    document.getElementById('masterStudentSelect').value = '';
                    toggleAddStudentForm();
                    
                    // Supprimer l'élève de la liste déroulante
                    const option = document.querySelector(`#masterStudentSelect option[value="${masterStudentId}"]`);
                    if (option) {
                        option.remove();
                    }
                    
                    // Vérifier s'il reste des élèves disponibles
                    const allOptions = document.querySelectorAll('#masterStudentSelect option');
                    const remainingOptions = Array.from(allOptions).filter(option => option.value !== '');
                    if (remainingOptions.length === 0) {
                        const select = document.getElementById('masterStudentSelect');
                        select.innerHTML = '<option value="">-- Aucun élève disponible --</option>';
                        submitButton.disabled = true;
                        submitButton.innerHTML = '<i class="fas fa-plus"></i> Ajouter l\'élève';
                        
                        // Ajouter le message informatif
                        const helpText = document.createElement('small');
                        helpText.style.color = 'var(--gray-color)';
                        helpText.style.fontSize = '0.75rem';
                        helpText.textContent = 'Tous les élèves de la classe du maître sont déjà ajoutés';
                        select.parentNode.appendChild(helpText);
                    }
                    
                    showNotification('success', result.message);
                } else {
                    showNotification('error', result.message || 'Erreur lors de l\'ajout');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showNotification('error', 'Erreur lors de la communication avec le serveur');
            } finally {
                const allOptionsFinally = document.querySelectorAll('#masterStudentSelect option');
                const remainingOptionsFinally = Array.from(allOptionsFinally).filter(option => option.value !== '');
                if (remainingOptionsFinally.length > 0) {
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalText;
                }
            }
        });
    }
}

// Ajouter un élève au container des labels pour le plan de classe
function addStudentToSeatingLabels(student) {
    const studentsContainer = document.getElementById('students-labels-container');
    if (!studentsContainer) return;
    
    // Vérifier si l'étudiant n'existe pas déjà
    const existingLabel = studentsContainer.querySelector(`.student-label[data-student-id="${student.id}"]`);
    if (existingLabel) return;
    
    // Supprimer le message "Aucun élève" s'il existe
    const emptyMessage = studentsContainer.querySelector('p[style*="italic"]');
    if (emptyMessage) {
        emptyMessage.remove();
    }
    
    // Créer le label de l'étudiant
    const studentLabel = document.createElement('div');
    studentLabel.className = 'student-label';
    studentLabel.draggable = true;
    studentLabel.dataset.studentId = student.id;
    studentLabel.innerHTML = `
        <i class="fas fa-user"></i>
        <span>${student.full_name}</span>
    `;
    
    studentsContainer.appendChild(studentLabel);
    
    // Mettre à jour le compteur
    const studentsCountSpan = document.getElementById('sidebar-students-count');
    if (studentsCountSpan) {
        const currentCount = parseInt(studentsCountSpan.textContent) || 0;
        studentsCountSpan.textContent = currentCount + 1;
    }
    
    // Recharger les étudiants pour le plan de classe si on est sur cet onglet
    const seatingTab = document.getElementById('seating-tab');
    if (seatingTab && seatingTab.classList.contains('active')) {
        loadStudentsForSeating();
    }
}

// Supprimer un élève du container des labels pour le plan de classe
function removeStudentFromSeatingLabels(studentId) {
    const studentsContainer = document.getElementById('students-labels-container');
    if (!studentsContainer) return;
    
    // Trouver et supprimer le label de l'étudiant
    const studentLabel = studentsContainer.querySelector(`.student-label[data-student-id="${studentId}"]`);
    if (studentLabel) {
        studentLabel.remove();
    }
    
    // Mettre à jour le compteur
    const studentsCountSpan = document.getElementById('sidebar-students-count');
    if (studentsCountSpan) {
        const currentCount = parseInt(studentsCountSpan.textContent) || 0;
        studentsCountSpan.textContent = Math.max(0, currentCount - 1);
    }
    
    // Vérifier s'il ne reste plus d'élèves et ajouter le message "Aucun élève" si nécessaire
    const remainingLabels = studentsContainer.querySelectorAll('.student-label');
    if (remainingLabels.length === 0) {
        const emptyMessage = document.createElement('p');
        emptyMessage.style.cssText = 'color: #666; font-style: italic; text-align: center; padding: 20px;';
        emptyMessage.textContent = 'Aucun élève dans cette classe pour le moment.';
        studentsContainer.appendChild(emptyMessage);
    }
    
    // Recharger les étudiants pour le plan de classe si on est sur cet onglet
    const seatingTab = document.getElementById('seating-tab');
    if (seatingTab && seatingTab.classList.contains('active')) {
        loadStudentsForSeating();
    }
}

// Ajouter une carte d'élève au DOM
function addStudentCard(student) {
    const studentsGrid = document.querySelector('.students-grid');

    // Si c'est le premier élève, remplacer l'état vide
    const emptyState = document.querySelector('.students-section .empty-state');
    if (emptyState) {
        emptyState.remove();
        // Créer la grille si elle n'existe pas
        if (!studentsGrid) {
            const newGrid = document.createElement('div');
            newGrid.className = 'students-grid';
            document.querySelector('.students-section').appendChild(newGrid);
        }
    }

    const studentCard = document.createElement('div');
    studentCard.className = 'student-card';
    studentCard.id = `student-${student.id}`;
    // Animation d'apparition
    studentCard.style.animation = 'slideIn 0.3s ease';

    studentCard.innerHTML = `
        <div class="student-info">
            <div class="student-avatar">
                ${student.initials}
            </div>
            <div class="student-details">
                <h4>${student.full_name}</h4>
                ${student.email ? `<p>${student.email}</p>` : ''}
            </div>
        </div>
        <div class="student-actions">
            ${canEditStudents ? `<button class="btn-icon" title="Modifier" onclick="editStudent(${student.id})">
                <i class="fas fa-edit"></i>
            </button>` : ''}
            <button class="btn-icon danger" title="Supprimer" onclick="deleteStudent(${student.id}, '${student.full_name}')">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;

    // Recréer une grille fraîche pour éviter les problèmes CSS
    const studentsSection = document.querySelector('.students-section');
    
    // Sauvegarder les élèves existants avant de supprimer la grille
    const oldGrid = document.querySelector('.students-grid');
    let existingStudents = [];
    
    if (oldGrid) {
        existingStudents = Array.from(oldGrid.querySelectorAll('.student-card'));
        oldGrid.remove();
    }
    
    // Créer une nouvelle grille
    const grid = document.createElement('div');
    grid.className = 'students-grid';
    grid.id = 'studentsGrid';
    
    // L'ajouter à la section
    studentsSection.appendChild(grid);
    
    // Remettre tous les élèves existants dans la nouvelle grille
    existingStudents.forEach(studentElement => {
        grid.appendChild(studentElement);
    });
    
    if (grid) {
        grid.appendChild(studentCard);
    }
    
    // Ajouter l'étudiant au container des labels pour le plan de classe
    addStudentToSeatingLabels(student);
}

// Mettre à jour une carte d'élève existante
function updateStudentCard(student) {
    const card = document.getElementById(`student-${student.id}`);
    if (card) {
        const avatar = card.querySelector('.student-avatar');
        avatar.textContent = student.initials;

        const details = card.querySelector('.student-details');
        details.innerHTML = `
            <h4>${student.full_name}</h4>
            ${student.email ? `<p>${student.email}</p>` : ''}
        `;

        // Mettre à jour le bouton de suppression avec le nouveau nom
        const deleteBtn = card.querySelector('.btn-icon.danger');
        deleteBtn.setAttribute('onclick', `deleteStudent(${student.id}, '${student.full_name}')`);

        // Animation de mise à jour
        card.style.animation = 'pulse 0.5s ease';
    }
}

// Modifier un élève
async function editStudent(studentId) {
    // Empêcher l'édition d'élèves pour les classes mixtes
    if (isMixedGroupClass) {
        showAlert('info', 'Les élèves des groupes mixtes sont gérés depuis la page des groupes mixtes.');
        return;
    }
    
    try {
        const response = await fetch(`{{ url_for("planning.get_student", student_id=0) }}`.replace('0', studentId), {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });

        const result = await response.json();

        if (result.success) {
            // Remplir le formulaire avec les données de l'élève
            document.getElementById('studentFirstName').value = result.student.first_name;
            document.getElementById('studentLastName').value = result.student.last_name;
            document.getElementById('studentEmail').value = result.student.email || '';
            document.getElementById('parentEmailMother').value = result.student.parent_email_mother || '';
            document.getElementById('parentEmailFather').value = result.student.parent_email_father || '';

            // Mettre à jour le titre et le bouton
            document.querySelector('#addStudentForm h3').textContent = 'Modifier l\'élève';
            document.querySelector('#studentForm button[type="submit"]').innerHTML = '<i class="fas fa-save"></i> Modifier';

            // Stocker l'ID de l'élève en cours de modification
            editingStudentId = studentId;

            // Afficher le formulaire
            document.getElementById('addStudentForm').style.display = 'block';

            // Focus sur le premier champ
            document.getElementById('studentFirstName').focus();
        } else {
            showNotification('error', result.message || 'Erreur lors du chargement des données');
        }
    } catch (error) {
        console.error('Erreur:', error);
        showNotification('error', 'Erreur lors de la communication avec le serveur');
    }
}

// Supprimer un élève
async function deleteStudent(studentId, studentName) {
    // Empêcher la suppression d'élèves pour les classes mixtes
    if (isMixedGroupClass) {
        showAlert('info', 'Les élèves des groupes mixtes sont gérés depuis la page des groupes mixtes.');
        return;
    }
    
    if (!confirm(`Êtes-vous sûr de vouloir supprimer ${studentName} ?\n\nCette action supprimera également toutes les notes de cet élève.`)) {
        return;
    }

    try {
        const response = await fetch(`{{ url_for("planning.delete_student", student_id=0) }}`.replace('0', studentId), {
            method: 'DELETE',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });

        const result = await response.json();

        if (result.success) {
            showNotification('success', result.message);

            // Si c'est un enseignant spécialisé et qu'on a l'info de l'élève original, le remettre dans la liste
            if (isSpecializedTeacher && result.original_student) {
                const originalStudent = result.original_student;
                const select = document.getElementById('masterStudentSelect');
                if (select) {
                    // Vérifier d'abord s'il n'y a que l'option "aucun élève disponible"
                    const noStudentsOption = select.querySelector('option[value=""]');
                    if (noStudentsOption && noStudentsOption.textContent.includes('Aucun élève disponible')) {
                        // Réinitialiser la liste
                        select.innerHTML = '<option value="">-- Choisir un élève --</option>';
                        
                        // Réactiver le bouton d'ajout s'il existe
                        const addButton = document.querySelector('#studentSelectForm button[type="submit"]');
                        if (addButton) {
                            addButton.disabled = false;
                            addButton.innerHTML = '<i class="fas fa-plus"></i> Ajouter l\'élève';
                        }
                        
                        // Supprimer le message d'information s'il existe
                        const helpText = document.querySelector('#masterStudentSelect ~ small');
                        if (helpText) {
                            helpText.remove();
                        }
                    }
                    
                    // Créer une nouvelle option avec l'ID original
                    const newOption = document.createElement('option');
                    newOption.value = originalStudent.id;
                    newOption.textContent = originalStudent.email ? 
                        `${originalStudent.full_name} (${originalStudent.email})` : 
                        originalStudent.full_name;
                    select.appendChild(newOption);
                }
            }

            // Supprimer la carte de l'élève avec une animation
            const studentCard = document.getElementById(`student-${studentId}`);
            if (studentCard) {
                studentCard.style.transition = 'all 0.3s ease';
                studentCard.style.opacity = '0';
                studentCard.style.transform = 'scale(0.9)';

                setTimeout(() => {
                    studentCard.remove();
                    
                    // Supprimer l'élève du container des labels pour le plan de classe
                    removeStudentFromSeatingLabels(studentId);

                    // Vérifier s'il reste des élèves
                    const remainingStudents = document.querySelectorAll('.student-card').length;
                    if (remainingStudents === 0) {
                        // Afficher l'état vide
                        const studentsSection_local = document.querySelector('.students-section');
                        const emptyState = document.createElement('div');
                        emptyState.className = 'empty-state';
                        if (isMixedGroupClass) {
                            emptyState.innerHTML = `
                                <i class="fas fa-user-graduate"></i>
                                <p>Aucun élève dans ce groupe mixte</p>
                                <p style="font-size: 0.875rem;">Les élèves doivent être ajoutés depuis la page de gestion des groupes mixtes</p>
                            `;
                        } else {
                            emptyState.innerHTML = `
                                <i class="fas fa-user-graduate"></i>
                                <p>Aucun élève dans cette classe</p>
                                <button class="btn btn-primary" onclick="toggleAddStudentForm()">
                                    <i class="fas fa-plus"></i> Ajouter le premier élève
                                </button>
                            `;
                        }
                        studentsSection_local.appendChild(emptyState);
                    }
                }, 300);
            }
        } else {
            showNotification('error', result.message || 'Erreur lors de la suppression');
        }
    } catch (error) {
        console.error('Erreur:', error);
        showNotification('error', 'Erreur lors de la communication avec le serveur');
    }
}

// Supprimer un élève d'un groupe mixte
async function deleteMixedGroupStudent(studentId, studentName) {
    if (!confirm(`Êtes-vous sûr de vouloir supprimer ${studentName} du groupe mixte ?\n\nL'élève restera dans sa classe d'origine.`)) {
        return;
    }

    try {
        const response = await fetch('/planning/api/delete-mixed-group-student', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                classroom: '{{ selected_class_group }}',
                student_id: studentId
            })
        });

        const result = await response.json();

        if (result.success) {
            showNotification('success', result.message);

            // Supprimer visuellement la carte de l'élève avec animation
            const studentCard = document.getElementById(`student-${studentId}`);
            if (studentCard) {
                studentCard.style.transition = 'all 0.3s ease';
                studentCard.style.opacity = '0';
                studentCard.style.transform = 'scale(0.9)';

                setTimeout(() => {
                    studentCard.remove();
                    
                    // Supprimer l'élève du container des labels pour le plan de classe
                    removeStudentFromSeatingLabels(studentId);

                    // Vérifier s'il reste des élèves
                    const remainingStudents = document.querySelectorAll('.student-card').length;
                    if (remainingStudents === 0) {
                        // Afficher l'état vide pour groupe mixte
                        const studentsSection_local = document.querySelector('.students-section');
                        const emptyState = document.createElement('div');
                        emptyState.className = 'empty-state';
                        emptyState.innerHTML = `
                            <i class="fas fa-user-graduate"></i>
                            <p>Aucun élève dans ce groupe mixte</p>
                            <button class="btn btn-primary" onclick="toggleAddMixedGroupStudentForm()">
                                <i class="fas fa-plus"></i> Ajouter des élèves
                            </button>
                        `;
                        studentsSection_local.appendChild(emptyState);
                    }
                }, 300);
            }
        } else {
            showNotification('error', result.message || 'Erreur lors de la suppression');
        }
    } catch (error) {
        console.error('Erreur:', error);
        showNotification('error', 'Erreur lors de la communication avec le serveur');
    }
}

// Fonction pour générer un code d'accès pour toute la classe
async function generateClassCode() {
    const classroomId = "{{ primary_classroom.id }}";
    
    try {
        const response = await fetch(`{{ url_for("planning.generate_class_code", classroom_id=0) }}`.replace('0', classroomId), {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });

        const result = await response.json();

        if (result.success) {
            // Afficher le modal avec le code
            showClassCodeModal(result.code, result.classroom_name);
        } else {
            showNotification('error', result.message || 'Erreur lors de la génération du code');
        }
    } catch (error) {
        console.error('Erreur:', error);
        showNotification('error', 'Erreur lors de la communication avec le serveur');
    }
}

// Fonction pour afficher le modal avec le code de classe
function showClassCodeModal(code, classroomName) {
    // Créer le modal
    const modal = document.createElement('div');
    modal.className = 'modal show';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>Code d'accès classe généré</h3>
                <button class="modal-close" onclick="this.closest('.modal').remove()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" style="text-align: center;">
                <p style="margin-bottom: 1rem;">Code d'accès pour la classe <strong>${classroomName}</strong> :</p>
                <div style="background: #f3f4f6; padding: 1.5rem; border-radius: 8px; margin: 1.5rem 0;">
                    <h2 style="margin: 0; font-size: 2rem; letter-spacing: 0.5rem; color: #667eea;">${code}</h2>
                </div>
                <p style="color: #6b7280; font-size: 0.875rem;">
                    Ce code est valide pendant 30 jours.<br>
                    Tous les élèves de la classe peuvent utiliser ce code pour créer leur compte.<br>
                    Ils doivent utiliser l'email que vous avez enregistré pour eux.
                </p>
                <div style="margin-top: 1.5rem;">
                    <button class="btn btn-secondary" onclick="copyToClipboard('${code}', this)">
                        <i class="fas fa-copy"></i> Copier le code
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

// Fonction pour copier dans le presse-papier
function copyToClipboard(text, button) {
    navigator.clipboard.writeText(text).then(() => {
        const originalHTML = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check"></i> Copié !';
        button.style.backgroundColor = '#10b981';
        setTimeout(() => {
            button.innerHTML = originalHTML;
            button.style.backgroundColor = '';
        }, 2000);
    }).catch(() => {
        showNotification('error', 'Impossible de copier le code');
    });
}

// Fonction pour afficher les notifications
function showNotification(type, message) {
    // Créer le conteneur de notifications s'il n'existe pas
    let container = document.querySelector('.notifications-container');
    if (!container) {
        container = document.createElement('div');
        container.className = 'notifications-container';
        container.style.cssText = 'position: fixed; top: 80px; right: 20px; z-index: 1000;';
        document.body.appendChild(container);
    }

    // Créer la notification
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.style.cssText = `
        background-color: ${type === 'success' ? '#D1FAE5' : '#FEE2E2'};
        color: ${type === 'success' ? '#065F46' : '#991B1B'};
        padding: 1rem 1.5rem;
        border-radius: 0.5rem;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        animation: slideInNotification 0.3s ease;
        max-width: 400px;
    `;

    const icon = document.createElement('i');
    icon.className = `fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}`;

    const text = document.createElement('span');
    text.textContent = message;

    notification.appendChild(icon);
    notification.appendChild(text);
    container.appendChild(notification);

    // Supprimer la notification après 5 secondes
    setTimeout(() => {
        notification.style.animation = 'slideOutNotification 0.3s ease';
        setTimeout(() => notification.remove(), 300);
    }, 5000);
}

// Ajouter les animations CSS
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from {
            transform: translateY(-20px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    @keyframes pulse {
        0% {
            transform: scale(1);
        }
        50% {
            transform: scale(1.05);
        }
        100% {
            transform: scale(1);
        }
    }

    @keyframes slideInNotification {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @keyframes slideOutNotification {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
`;
document.head.appendChild(style);

// Fonctions pour la gestion des sanctions

// Variable pour suivre le mode actuel dynamiquement
let currentDisplayMode = '{{ classroom_preferences[selected_group.classrooms[0].id].display_mode if selected_group.classrooms[0].id in classroom_preferences else "unified" }}';

// Gérer le clic sur un bouton radio de mode
function handleModeChange(radioElement, classroomId) {
    const newMode = radioElement.value;
    
    console.log('handleModeChange:', 'current=' + currentDisplayMode, 'new=' + newMode);
    
    // Si c'est le même mode, ne rien faire
    if (currentDisplayMode === newMode) {
        console.log('Même mode, aucun changement nécessaire');
        return;
    }
    
    // Empêcher le changement visuel immédiat et remettre l'ancien mode
    resetRadioToCurrentMode();
    
    // Demander la mise à jour avec confirmation
    updateSanctionDisplayMode(newMode, classroomId, false);
}

// Mettre à jour le mode d'affichage des coches
async function updateSanctionDisplayMode(displayMode, classroomId, confirmed = false) {
    try {
        const response = await fetch('{{ url_for("planning.update_sanction_display_preferences") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                display_mode: displayMode,
                classroom_id: classroomId,
                confirmed: confirmed
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Mettre à jour le mode actuel
            currentDisplayMode = result.new_mode || displayMode;
            console.log('Mode mis à jour avec succès:', currentDisplayMode);
            
            // Masquer tous les modes d'affichage
            document.querySelectorAll('.sanctions-display-mode').forEach(mode => {
                mode.style.display = 'none';
            });
            
            // Afficher le mode sélectionné
            const selectedMode = document.getElementById(`sanctions-${displayMode}`);
            if (selectedMode) {
                selectedMode.style.display = 'block';
            }
            
            showNotification('success', result.message);
            
            // Recharger la page pour refléter tous les changements en restant sur l'onglet Coches
            if (result.new_mode) {
                setTimeout(() => {
                    window.location.href = window.location.pathname + window.location.search + '#sanctions-tab';
                    window.location.reload();
                }, 1500);
            }
        } else if (result.requires_confirmation) {
            // Maintenir le bouton radio sélectionné pendant la confirmation
            document.getElementById(`mode-${displayMode}`).checked = true;
            console.log('Confirmation requise pour passer de', currentDisplayMode, 'vers', displayMode);
            
            // Afficher la fenêtre de confirmation
            showConfirmationModal(
                'Confirmation requise',
                result.message,
                () => {
                    // L'utilisateur a confirmé, relancer avec confirmation
                    console.log('Utilisateur a confirmé le changement vers:', displayMode);
                    updateSanctionDisplayMode(displayMode, classroomId, true);
                },
                () => {
                    // L'utilisateur a annulé, remettre l'ancien bouton radio
                    console.log('Utilisateur a annulé, retour au mode:', currentDisplayMode);
                    resetRadioToCurrentMode();
                }
            );
        } else {
            showNotification('error', result.message || 'Erreur lors de la mise à jour');
            resetRadioToCurrentMode();
        }
    } catch (error) {
        console.error('Erreur:', error);
        showNotification('error', 'Erreur lors de la communication avec le serveur');
        resetRadioToCurrentMode();
    }
}

function resetRadioToCurrentMode() {
    // Remettre le bon bouton radio sélectionné
    console.log('resetRadioToCurrentMode:', currentDisplayMode);
    
    // Décocher tous les boutons radio
    document.querySelectorAll('input[name="sanctionDisplayMode"]').forEach(radio => {
        radio.checked = false;
    });
    
    // Cocher le bon bouton
    const correctRadio = document.getElementById(`mode-${currentDisplayMode}`);
    if (correctRadio) {
        correctRadio.checked = true;
    }
}

function showConfirmationModal(title, message, onConfirm, onCancel) {
    // Créer la modal de confirmation
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>${title}</h3>
            </div>
            <div class="modal-body">
                <p>${message}</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeConfirmationModal(false)">Annuler</button>
                <button class="btn btn-danger" onclick="closeConfirmationModal(true)">Confirmer</button>
            </div>
        </div>
    `;
    
    // Stocker les callbacks
    modal.onConfirm = onConfirm;
    modal.onCancel = onCancel;
    
    document.body.appendChild(modal);
}

function closeConfirmationModal(confirmed) {
    const modal = document.querySelector('.modal-overlay');
    if (modal) {
        if (confirmed && modal.onConfirm) {
            modal.onConfirm();
        } else if (!confirmed && modal.onCancel) {
            modal.onCancel();
        }
        document.body.removeChild(modal);
    }
}

async function updateCount(studentId, sanctionId, delta, classroomId = null) {
    // Sélectionner l'élément selon le mode (avec ou sans classroom_id)
    let selector = `[data-student="${studentId}"][data-sanction="${sanctionId}"]`;
    if (classroomId) {
        selector += `[data-classroom="${classroomId}"]`;
    }
    
    const countElement = document.querySelector(selector);
    if (!countElement) {
        console.error('Element not found with selector:', selector);
        return;
    }
    
    const currentCount = parseInt(countElement.textContent);
    const newCount = Math.max(0, currentCount + delta); // Ne pas aller en dessous de 0
    
    try {
        const response = await fetch('{{ url_for("planning.update_sanction_count") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                student_id: studentId,
                template_id: sanctionId,
                count: newCount
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            countElement.textContent = result.new_count;
            
            // Mettre à jour les classes CSS selon le nombre
            countElement.className = 'count-display';
            if (result.new_count >= 6) {
                countElement.classList.add('danger');
            } else if (result.new_count >= 3) {
                countElement.classList.add('warning');
            }
            
            // Animation de mise à jour
            countElement.style.transform = 'scale(1.2)';
            setTimeout(() => {
                countElement.style.transform = 'scale(1)';
            }, 200);
        } else {
            showNotification('error', result.message || 'Erreur lors de la mise à jour');
        }
    } catch (error) {
        console.error('Erreur:', error);
        showNotification('error', 'Erreur lors de la communication avec le serveur');
    }
}

async function resetAllSanctions() {
    if (!confirm('Êtes-vous sûr de vouloir remettre toutes les coches à zéro pour cette classe ?\n\nCette action est irréversible.')) {
        return;
    }
    
    try {
        const response = await fetch('{{ url_for("planning.reset_all_sanctions") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                classroom_id: {{ primary_classroom.id }}
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification('success', result.message);
            
            // Mettre à jour tous les compteurs à 0 visuellement
            document.querySelectorAll('.count-display').forEach(element => {
                element.textContent = '0';
                element.className = 'count-display'; // Enlever les classes warning/danger
                
                // Animation de réinitialisation
                element.style.backgroundColor = '#D1FAE5';
                element.style.color = '#065F46';
                setTimeout(() => {
                    element.style.backgroundColor = '';
                    element.style.color = '';
                }, 1000);
            });
        } else {
            showNotification('error', result.message || 'Erreur lors de la réinitialisation');
        }
    } catch (error) {
        console.error('Erreur:', error);
        showNotification('error', 'Erreur lors de la communication avec le serveur');
    }
}

// Focus sur le champ prénom au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    const firstNameField = document.getElementById('studentFirstName');
    if (firstNameField && document.getElementById('addStudentForm').style.display !== 'none') {
        firstNameField.focus();
    }
    
    // Appliquer les classes CSS aux compteurs selon leur valeur au chargement
    document.querySelectorAll('.count-display').forEach(element => {
        const count = parseInt(element.textContent);
        if (count >= 6) {
            element.classList.add('danger');
        } else if (count >= 3) {
            element.classList.add('warning');
        }
    });
    
    // Initialiser le gestionnaire de fichiers de classe
    initClassFileManager();
});

// Variables pour la gestion des fichiers de classe
let currentClassFolder = null; // Pour compatibilité
let currentClassFolderByClass = {}; // Chemin actuel par classe
let classFolderPath = [];
let classUploadQueue = [];
let isClassUploading = false;
let allClassFiles = []; // Pour compatibilité
let allClassFilesByClass = {}; // Fichiers par classe

// Variables pour la gestion des évaluations par discipline
let evaluationsByClassroom = {}; // Stockage des évaluations par ID de classe
let selectedEvaluationId = null;
let existingTAGroupsByClassroom = {}; // Stockage des groupes TA par ID de classe
let expandedTAGroups = new Set(); // Stocker les groupes TA dépliés

// Initialiser le gestionnaire de fichiers de classe
function initClassFileManager() {
    // Initialiser le drag & drop
    initClassDragAndDrop();
}

// Charger les fichiers pour toutes les disciplines éditables
async function loadAllClassFiles() {
    const classrooms = {{ classrooms_json | tojson }};
    
    // Filtrer seulement les disciplines éditables
    const editableClassrooms = classrooms.filter(classroom => classroom.is_editable === true);
    
    for (let classroom of editableClassrooms) {
        await loadClassFiles('', classroom.id);
    }
}

// Charger les fichiers d'une classe spécifique
async function loadClassFiles(folderPath = '', classroomId = null) {
    if (!classroomId) {
        classroomId = "{{ primary_classroom.id }}";
    }
    currentClassFolder = folderPath; // Pour compatibilité
    currentClassFolderByClass[classroomId] = folderPath; // Spécifique à la classe
    
    try {
        const url = `/api/class-files/list/${classroomId}`;
            
        const response = await fetch(url);
        const result = await response.json();
        
        console.log('Réponse API:', result);
        
        if (result.success) {
            allClassFiles = result.files || []; // Pour compatibilité
            allClassFilesByClass[classroomId] = result.files || []; // Spécifique à la classe
            renderClassFiles(folderPath, classroomId);
            updateClassBreadcrumb(folderPath, classroomId);
        } else {
            console.error('Erreur API:', result.message);
            showNotification('error', result.message || 'Erreur lors du chargement des fichiers');
        }
    } catch (error) {
        console.error('Erreur lors du chargement des fichiers:', error);
        showNotification('error', 'Erreur lors du chargement des fichiers');
    }
}

// Afficher les fichiers et dossiers
function renderClassFiles(currentPath, classroomId = null) {
    // Utiliser les conteneurs spécifiques à la classe ou les généraux
    const fileGridId = classroomId ? `classFileGrid-${classroomId}` : 'classFileGrid';
    const emptyStateId = classroomId ? `classEmptyState-${classroomId}` : 'classEmptyState';
    
    const fileGrid = document.getElementById(fileGridId);
    const emptyState = document.getElementById(emptyStateId);
    
    console.log('Rendu des fichiers pour le chemin:', currentPath, 'classe:', classroomId);
    
    // Utiliser les fichiers spécifiques à la classe
    const classFiles = classroomId ? (allClassFilesByClass[classroomId] || []) : allClassFiles;
    
    // Filtrer les fichiers selon le chemin actuel
    let filesToShow = [];
    let foldersToShow = new Set();
    
    if (currentPath === '') {
        // À la racine - montrer les fichiers racine et les dossiers de premier niveau
        classFiles.forEach(file => {
            if (!file.folder_path || file.folder_path.trim() === '') {
                filesToShow.push(file);
            } else {
                // Extraire le premier niveau de dossier
                const firstFolder = file.folder_path.split('/')[0];
                foldersToShow.add(firstFolder);
            }
        });
    } else {
        // Dans un dossier - montrer les fichiers de ce dossier et les sous-dossiers
        classFiles.forEach(file => {
            if (file.folder_path && file.folder_path.startsWith(currentPath)) {
                const relativePath = file.folder_path.substring(currentPath.length);
                if (relativePath.startsWith('/')) {
                    const remainingPath = relativePath.substring(1);
                    if (remainingPath === '') {
                        // Fichier directement dans ce dossier
                        filesToShow.push(file);
                    } else {
                        // Sous-dossier
                        const nextFolder = remainingPath.split('/')[0];
                        foldersToShow.add(nextFolder);
                    }
                } else if (relativePath === '') {
                    // Fichier directement dans ce dossier
                    filesToShow.push(file);
                }
            }
        });
    }
    
    console.log('Fichiers à afficher:', filesToShow);
    console.log('Dossiers à afficher:', Array.from(foldersToShow));
    
    if (filesToShow.length === 0 && foldersToShow.size === 0) {
        fileGrid.style.display = 'none';
        emptyState.style.display = 'block';
        return;
    }
    
    fileGrid.style.display = 'grid';
    emptyState.style.display = 'none';
    
    let html = '';
    
    // Afficher les dossiers
    foldersToShow.forEach(folderName => {
        const folderPath = currentPath ? `${currentPath}/${folderName}` : folderName;
        const filesInFolder = classFiles.filter(f => 
            f.folder_path && f.folder_path.startsWith(folderPath)
        );
        
        html += `
            <div class="file-item folder" data-folder-path="${folderPath}" data-type="folder" ondblclick="openClassFolder('${folderPath}', ${classroomId})">
                <div class="item-icon" style="color: #F59E0B;">
                    <i class="fas fa-folder"></i>
                </div>
                <div class="item-name" title="${folderName}">${folderName}</div>
                <div class="item-info">${filesInFolder.length} fichier(s)</div>
                <div class="item-actions">
                    <button class="action-btn" onclick="openClassFolder('${folderPath}', ${classroomId})" title="Ouvrir">
                        <i class="fas fa-folder-open"></i>
                    </button>
                    <button class="action-btn danger" onclick="deleteClassFolder('${folderPath}', ${classroomId})" title="Supprimer">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
    });
    
    // Afficher les fichiers
    filesToShow.forEach(file => {
        const icon = getFileIcon(file.file_type);
        const iconColor = getFileIconColor(file.file_type);
        
        html += `
            <div class="file-item file" data-id="${file.id}" data-type="file" ondblclick="previewClassFile(${file.id}, '${file.file_type}')">
                <div class="item-icon">
                    ${file.thumbnail 
                        ? `<img src="/api/class-files/preview/${file.id}?thumbnail=1" alt="${file.original_filename}" class="thumbnail">`
                        : `<i class="${icon}" style="color: ${iconColor};"></i>`
                    }
                </div>
                <div class="item-name" title="${file.original_filename}">${file.original_filename}</div>
                <div class="item-info">${formatFileSize(file.file_size)}</div>
                <div class="item-actions">
                    <button class="action-btn" onclick="previewClassFile(${file.id}, '${file.file_type}')" title="Aperçu">
                        <i class="fas fa-eye"></i>
                    </button>
                    <a href="/api/class-files/download/${file.id}" class="action-btn" title="Télécharger">
                        <i class="fas fa-download"></i>
                    </a>
                    <button class="action-btn" onclick="shareFileWithStudents(${file.id}, '${file.original_filename}')" title="Partager avec des élèves" style="color: #10B981;">
                        <i class="fas fa-share"></i>
                    </button>
                    <button class="action-btn" onclick="renameClassItem('file', ${file.id}, '${file.original_filename}', ${classroomId})" title="Renommer">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="action-btn danger" onclick="deleteClassFile(${file.id}, ${classroomId})" title="Supprimer">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
    });
    
    fileGrid.innerHTML = html;
}

// Mettre à jour le fil d'ariane
function updateClassBreadcrumb(currentPath, classroomId = null) {
    // Utiliser le breadcrumb spécifique à la classe ou le général
    const breadcrumbId = classroomId ? `classBreadcrumb-${classroomId}` : 'classBreadcrumb';
    const breadcrumbEl = document.getElementById(breadcrumbId);
    
    if (!currentPath || currentPath === '') {
        breadcrumbEl.style.display = 'none';
        return;
    }
    
    breadcrumbEl.style.display = 'flex';
    
    let html = `
        <a href="javascript:void(0)" class="breadcrumb-item" onclick="navigateToClassRoot(${classroomId})">
            <i class="fas fa-home"></i> Racine
        </a>
    `;
    
    const pathParts = currentPath.split('/').filter(part => part.trim() !== '');
    let cumulativePath = '';
    
    pathParts.forEach((part, index) => {
        cumulativePath += (index === 0 ? '' : '/') + part;
        html += `<span class="breadcrumb-separator">/</span>`;
        html += `<a href="javascript:void(0)" class="breadcrumb-item" onclick="openClassFolder('${cumulativePath}', ${classroomId})">${part}</a>`;
    });
    
    breadcrumbEl.innerHTML = html;
}

// Navigation - adaptée pour fonctionner par discipline
function navigateToClassRoot(classroomId = null) {
    loadClassFiles('', classroomId);
}

function openClassFolder(folderPath, classroomId = null) {
    loadClassFiles(folderPath, classroomId);
}

// Drag & Drop
function initClassDragAndDrop() {
    const dropZone = document.getElementById('classDropZone');
    const fileGrid = document.getElementById('classFileGrid');
    
    if (!dropZone) return;
    
    // Prévenir le comportement par défaut
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
        fileGrid.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    // Afficher la zone de drop
    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => dropZone.classList.add('active'));
        fileGrid.addEventListener(eventName, () => dropZone.classList.add('active'));
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => dropZone.classList.remove('active'));
        fileGrid.addEventListener(eventName, () => dropZone.classList.remove('active'));
    });
    
    // Gérer le drop
    dropZone.addEventListener('drop', handleClassDrop);
    fileGrid.addEventListener('drop', handleClassDrop);
}

// Gérer le drop de fichiers
async function handleClassDrop(e) {
    const dt = e.dataTransfer;
    const items = dt.items;
    
    if (items && items.length > 0) {
        const entries = [];
        
        for (let i = 0; i < items.length; i++) {
            const item = items[i];
            if (item.kind === 'file') {
                const entry = item.webkitGetAsEntry ? item.webkitGetAsEntry() : item.getAsEntry();
                if (entry) {
                    entries.push(entry);
                }
            }
        }
        
        if (entries.length > 0) {
            await handleClassFileSystemEntries(entries);
        }
    } else if (dt.files.length > 0) {
        handleClassFiles(dt.files);
    }
}

// Gérer les entrées du système de fichiers
async function handleClassFileSystemEntries(entries) {
    showNotification('info', 'Analyse de la structure en cours...');
    
    const fileStructure = {
        folders: new Set(),
        files: []
    };
    
    for (const entry of entries) {
        await traverseClassFileSystem(entry, '', fileStructure);
    }
    
    // Créer les dossiers
    if (fileStructure.folders.size > 0) {
        await createClassFolderStructure(Array.from(fileStructure.folders));
    }
    
    // Uploader les fichiers
    if (fileStructure.files.length > 0) {
        await uploadClassFilesWithStructure(fileStructure.files);
    }
}

// Parcourir récursivement le système de fichiers
async function traverseClassFileSystem(entry, path, fileStructure) {
    if (entry.isFile) {
        const file = await new Promise((resolve) => entry.file(resolve));
        
        // Vérifier le type de fichier
        if (validateClassFile(file)) {
            fileStructure.files.push({
                file: file,
                path: path,
                relativePath: path + file.name
            });
        }
    } else if (entry.isDirectory) {
        const folderPath = path + entry.name + '/';
        fileStructure.folders.add(folderPath);
        
        const dirReader = entry.createReader();
        let entries = [];
        
        const readEntries = async () => {
            const results = await new Promise((resolve) => dirReader.readEntries(resolve));
            if (results.length > 0) {
                entries = entries.concat(results);
                await readEntries();
            }
        };
        
        await readEntries();
        
        for (const childEntry of entries) {
            await traverseClassFileSystem(childEntry, folderPath, fileStructure);
        }
    }
}

// Créer la structure de dossiers dans la classe
async function createClassFolderStructure(folderPaths) {
    const classroomId = "{{ primary_classroom.id }}";
    folderPaths.sort((a, b) => a.split('/').length - b.split('/').length);
    
    try {
        const response = await fetch('/api/class-files/create-folder-structure', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                classroom_id: classroomId,
                folders: folderPaths,
                parent_id: currentClassFolder
            })
        });
        
        const result = await response.json();
        
        if (!result.success) {
            showNotification('error', 'Erreur lors de la création des dossiers');
            return false;
        }
        
        return true;
    } catch (error) {
        console.error('Erreur:', error);
        showNotification('error', 'Erreur lors de la création de la structure');
        return false;
    }
}

// Uploader les fichiers avec leur structure
async function uploadClassFilesWithStructure(filesData) {
    const totalFiles = filesData.length;
    let uploadedCount = 0;
    
    showClassUploadProgress();
    
    for (const fileData of filesData) {
        const formData = new FormData();
        formData.append('file', fileData.file);
        formData.append('classroom_id', "{{ primary_classroom.id }}");
        formData.append('folder_path', fileData.path);
        
        if (currentClassFolder) {
            formData.append('parent_folder_id', currentClassFolder);
        }
        
        try {
            const xhr = new XMLHttpRequest();
            
            xhr.upload.addEventListener('progress', (e) => {
                if (e.lengthComputable) {
                    const fileProgress = (e.loaded / e.total) * 100;
                    const totalProgress = ((uploadedCount + fileProgress / 100) / totalFiles) * 100;
                    updateClassUploadProgress(totalProgress, `${fileData.file.name} (${uploadedCount + 1}/${totalFiles})`);
                }
            });
            
            await new Promise((resolve, reject) => {
                xhr.onload = () => {
                    if (xhr.status === 200) {
                        uploadedCount++;
                        resolve(JSON.parse(xhr.responseText));
                    } else {
                        reject(new Error(`Upload failed: ${xhr.status}`));
                    }
                };
                xhr.onerror = reject;
                
                xhr.open('POST', '/api/class-files/upload');
                xhr.send(formData);
            });
            
        } catch (error) {
            console.error(`Erreur lors de l'upload de ${fileData.file.name}:`, error);
        }
    }
    
    hideClassUploadProgress();
    showNotification('success', `${uploadedCount} fichier(s) uploadé(s) avec succès`);
    
    // Recharger les fichiers
    loadClassFiles(currentClassFolder);
}

// Gérer la sélection de fichiers
function handleClassFileSelect(e, classroomId = null) {
    const files = e.target.files;
    handleClassFiles(files, classroomId);
}

// Gérer la sélection de dossiers entiers
function handleClassFolderSelect(e, classroomId = null) {
    const files = e.target.files;
    console.log('Upload de dossier détecté:', files.length, 'fichiers');
    
    if (files.length === 0) {
        showNotification('error', 'Aucun fichier sélectionné');
        return;
    }
    
    // Organiser les fichiers par structure de dossiers
    const fileStructure = organizeFolderStructure(files);
    
    // Traiter l'upload avec la structure
    handleClassFolderUpload(fileStructure, classroomId);
}

// Organiser la structure des dossiers à partir des fichiers sélectionnés
function organizeFolderStructure(files) {
    const structure = {
        folders: new Set(),
        files: []
    };
    
    Array.from(files).forEach(file => {
        // Valider le fichier
        if (!validateClassFile(file)) {
            return;
        }
        
        // Extraire le chemin relatif
        const relativePath = file.webkitRelativePath || file.name;
        const pathParts = relativePath.split('/');
        
        // Ajouter les dossiers intermédiaires
        let currentPath = '';
        for (let i = 0; i < pathParts.length - 1; i++) {
            currentPath += (i === 0 ? '' : '/') + pathParts[i];
            structure.folders.add(currentPath + '/');
        }
        
        // Ajouter le fichier avec son chemin
        const folderPath = pathParts.slice(0, -1).join('/');
        structure.files.push({
            file: file,
            path: folderPath ? folderPath + '/' : '',
            relativePath: relativePath
        });
    });
    
    return structure;
}

// Gérer l'upload de dossiers avec structure
async function handleClassFolderUpload(fileStructure, classroomId = null) {
    if (!classroomId) {
        classroomId = "{{ primary_classroom.id }}";
    }
    
    showNotification('info', `Préparation de l'upload de ${fileStructure.files.length} fichier(s) dans ${fileStructure.folders.size} dossier(s)...`);
    
    try {
        // Créer d'abord la structure de dossiers
        if (fileStructure.folders.size > 0) {
            await createClassFolderStructure(Array.from(fileStructure.folders), classroomId);
        }
        
        // Puis uploader tous les fichiers
        if (fileStructure.files.length > 0) {
            await uploadClassFilesWithStructure(fileStructure.files, classroomId);
        }
        
        showNotification('success', 'Dossier uploadé avec succès!');
    } catch (error) {
        console.error('Erreur lors de l\'upload du dossier:', error);
        showNotification('error', 'Erreur lors de l\'upload du dossier');
    }
}

// Traiter les fichiers sélectionnés
function handleClassFiles(files, classroomId = null) {
    const validFiles = [];
    
    [...files].forEach(file => {
        if (validateClassFile(file)) {
            validFiles.push(file);
        }
    });
    
    if (validFiles.length > 0) {
        uploadClassFiles(validFiles, classroomId);
    }
}

// Valider un fichier
function validateClassFile(file) {
    const allowedTypes = ['application/pdf', 'image/png', 'image/jpeg', 'image/jpg'];
    const maxSize = 80 * 1024 * 1024; // 80 MB
    
    if (!allowedTypes.includes(file.type)) {
        showNotification('error', `Type de fichier non autorisé: ${file.name}`);
        return false;
    }
    
    if (file.size > maxSize) {
        showNotification('error', `Fichier trop volumineux: ${file.name} (max 80 MB)`);
        return false;
    }
    
    return true;
}

// Uploader des fichiers
async function uploadClassFiles(files, classroomId = null) {
    if (!classroomId) {
        classroomId = "{{ primary_classroom.id }}";
    }
    
    showClassUploadProgress();
    
    let uploadedCount = 0;
    const totalFiles = files.length;
    
    for (const file of files) {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('classroom_id', classroomId);
        
        if (currentClassFolder) {
            formData.append('folder_id', currentClassFolder);
        }
        
        try {
            const xhr = new XMLHttpRequest();
            
            xhr.upload.addEventListener('progress', (e) => {
                if (e.lengthComputable) {
                    const fileProgress = (e.loaded / e.total) * 100;
                    const totalProgress = ((uploadedCount + fileProgress / 100) / totalFiles) * 100;
                    updateClassUploadProgress(totalProgress, `${file.name} (${uploadedCount + 1}/${totalFiles})`);
                }
            });
            
            const response = await new Promise((resolve, reject) => {
                xhr.onload = () => {
                    if (xhr.status === 200) {
                        resolve(JSON.parse(xhr.responseText));
                    } else {
                        reject(new Error(`Upload failed: ${xhr.status}`));
                    }
                };
                xhr.onerror = reject;
                
                xhr.open('POST', '/api/class-files/upload');
                xhr.send(formData);
            });
            
            if (response.success) {
                uploadedCount++;
            } else {
                showNotification('error', response.message || `Erreur lors de l'upload de ${file.name}`);
            }
        } catch (error) {
            console.error('Erreur upload:', error);
            showNotification('error', `Erreur lors de l'upload de ${file.name}`);
        }
    }
    
    hideClassUploadProgress();
    
    if (uploadedCount > 0) {
        showNotification('success', `${uploadedCount} fichier(s) uploadé(s) avec succès`);
        loadClassFiles(currentClassFolder, classroomId);
    }
}

// Progress upload
function showClassUploadProgress() {
    const progress = document.getElementById('classUploadProgress');
    progress.classList.add('show');
}

function hideClassUploadProgress() {
    const progress = document.getElementById('classUploadProgress');
    progress.classList.remove('show');
    
    document.getElementById('classProgressFill').style.width = '0%';
    document.getElementById('classProgressPercent').textContent = '0%';
    document.getElementById('classProgressInfo').textContent = '';
}

function updateClassUploadProgress(percent, filename) {
    document.getElementById('classProgressFill').style.width = percent + '%';
    document.getElementById('classProgressPercent').textContent = Math.round(percent) + '%';
    document.getElementById('classProgressInfo').textContent = filename;
}

// Modals - adaptées pour fonctionner par discipline
function showNewClassFolderModal(classroomId = null) {
    window.currentFolderClassroomId = classroomId;
    document.getElementById('newClassFolderModal').classList.add('show');
    document.getElementById('classFolderName').focus();
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('show');
    
    // Si c'est le modal d'évaluation, remettre le formulaire en mode création
    if (modalId === 'newEvaluationModal') {
        resetEvaluationForm();
    }
}

// Créer un dossier
async function createClassFolder(e) {
    e.preventDefault();
    
    const name = document.getElementById('classFolderName').value;
    const classroomId = window.currentFolderClassroomId || "{{ primary_classroom.id }}";
    const folderPath = currentClassFolderByClass[classroomId] || '';
    
    console.log('Création dossier:', { name, classroomId, folderPath });
    
    try {
        const response = await fetch('/api/class-files/create-folder', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: name,
                classroom_id: classroomId,
                parent_id: folderPath // L'API attend parent_id même si non utilisé
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Créer un fichier .keep pour que le dossier soit visible
            await createKeepFile(name, folderPath, classroomId);
            
            showNotification('success', 'Dossier créé avec succès');
            closeModal('newClassFolderModal');
            document.getElementById('classFolderName').value = '';
            loadClassFiles(folderPath, classroomId);
        } else {
            showNotification('error', result.message || 'Erreur lors de la création du dossier');
        }
    } catch (error) {
        console.error('Erreur:', error);
        showNotification('error', 'Erreur lors de la création du dossier');
    }
}

// Créer un fichier .keep pour rendre un dossier vide visible
async function createKeepFile(folderName, parentPath, classroomId) {
    try {
        // Créer un petit fichier texte .keep
        const keepContent = `Ce fichier maintient le dossier "${folderName}" visible.\nVous pouvez le supprimer une fois que vous ajoutez d'autres fichiers.`;
        const blob = new Blob([keepContent], { type: 'text/plain' });
        const keepFile = new File([blob], '.keep', { type: 'text/plain' });
        
        // Déterminer le chemin complet du nouveau dossier
        const newFolderPath = parentPath ? `${parentPath}/${folderName}` : folderName;
        
        // Uploader le fichier .keep dans le nouveau dossier
        const formData = new FormData();
        formData.append('file', keepFile);
        formData.append('classroom_id', classroomId);
        formData.append('folder_path', newFolderPath);
        
        const response = await fetch('/api/class-files/upload', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        console.log('Fichier .keep créé:', result.success);
        
    } catch (error) {
        console.error('Erreur lors de la création du fichier .keep:', error);
        // Ne pas bloquer la création du dossier si ça échoue
    }
}

// Aperçu fichier
function previewClassFile(fileId, fileType) {
    const modal = document.getElementById('classPreviewModal');
    const content = document.getElementById('classPreviewContent');
    const title = document.getElementById('classPreviewTitle');
    
    title.textContent = 'Aperçu';
    
    if (fileType === 'pdf') {
        content.innerHTML = `<iframe src="/api/class-files/preview/${fileId}"></iframe>`;
    } else {
        content.innerHTML = `<img src="/api/class-files/preview/${fileId}" alt="Aperçu">`;
    }
    
    modal.classList.add('show');
}

// Renommer
function renameClassItem(type, id, currentName, classroomId = null) {
    const modal = document.getElementById('classRenameModal');
    document.getElementById('classRenameType').value = type;
    document.getElementById('classRenameId').value = id;
    document.getElementById('classRenameName').value = currentName;
    window.currentRenameClassroomId = classroomId;
    
    modal.classList.add('show');
    document.getElementById('classRenameName').focus();
    document.getElementById('classRenameName').select();
}

async function saveClassRename(e) {
    e.preventDefault();
    
    const type = document.getElementById('classRenameType').value;
    const id = document.getElementById('classRenameId').value;
    const name = document.getElementById('classRenameName').value;
    
    try {
        const response = await fetch('/api/class-files/rename', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                type: type,
                id: id,
                name: name
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification('success', 'Renommage effectué avec succès');
            closeModal('classRenameModal');
            loadClassFiles(currentClassFolder, window.currentRenameClassroomId);
        } else {
            showNotification('error', result.message || 'Erreur lors du renommage');
        }
    } catch (error) {
        console.error('Erreur:', error);
        showNotification('error', 'Erreur lors du renommage');
    }
}

// Suppression
async function deleteClassFile(fileId, classroomId = null) {
    if (!confirm('Êtes-vous sûr de vouloir supprimer ce fichier ?')) return;
    
    try {
        const response = await fetch(`/api/class-files/delete/${fileId}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification('success', 'Fichier supprimé avec succès');
            // Recharger les fichiers
            loadClassFiles(currentClassFolder, classroomId);
        } else {
            showNotification('error', result.message || 'Erreur lors de la suppression');
        }
    } catch (error) {
        console.error('Erreur:', error);
        showNotification('error', 'Erreur lors de la suppression');
    }
}

async function deleteClassFolder(folderPath, classroomId = null) {
    if (!confirm(`Êtes-vous sûr de vouloir supprimer le dossier "${folderPath}" et tout son contenu ?`)) return;
    
    try {
        const response = await fetch('/api/class-files/delete-folder-by-path', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                classroom_id: classroomId || "{{ primary_classroom.id }}",
                folder_path: folderPath
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification('success', `Dossier "${folderPath}" supprimé avec succès`);
            // Recharger les fichiers
            loadClassFiles(currentClassFolder, classroomId);
        } else {
            showNotification('error', result.message || 'Erreur lors de la suppression');
        }
    } catch (error) {
        console.error('Erreur:', error);
        showNotification('error', 'Erreur lors de la suppression');
    }
}

// Helpers
function getFileIcon(fileType) {
    switch(fileType) {
        case 'pdf': return 'fas fa-file-pdf';
        case 'png':
        case 'jpg':
        case 'jpeg': return 'fas fa-file-image';
        default: return 'fas fa-file';
    }
}

function getFileIconColor(fileType) {
    switch(fileType) {
        case 'pdf': return '#DC2626';
        case 'png':
        case 'jpg':
        case 'jpeg': return '#059669';
        default: return '#6B7280';
    }
}

function formatFileSize(bytes) {
    if (!bytes) return '0 B';
    
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// ==================== FONCTIONS ÉVALUATIONS ====================

// Charger les évaluations pour toutes les disciplines
async function loadEvaluations() {
    const classrooms = {{ classrooms_json | tojson }};
    
    for (let classroom of classrooms) {
        await loadEvaluationsForClassroom(classroom.id, classroom.subject);
    }
}

// Charger les évaluations pour une discipline spécifique
async function loadEvaluationsForClassroom(classroomId, subject) {
    try {
        const response = await fetch(`/api/evaluations/classroom/${classroomId}`);
        const result = await response.json();
        
        if (result.success) {
            const evaluations = result.evaluations || [];
            const existingTAGroups = result.ta_groups || [];
            
            // Stocker les évaluations par classe
            evaluationsByClassroom[classroomId] = evaluations;
            existingTAGroupsByClassroom[classroomId] = existingTAGroups;
            
            renderEvaluationsTableForSubject(classroomId, subject, evaluations, existingTAGroups);
        } else {
            console.error(`Erreur API évaluations pour ${subject}:`, result.message);
        }
    } catch (error) {
        console.error(`Erreur lors du chargement des évaluations pour ${subject}:`, error);
    }
}

// Rendre le tableau des évaluations pour une discipline spécifique
function renderEvaluationsTableForSubject(classroomId, subject, evaluations, existingTAGroups) {
    const container = document.getElementById(`evaluationsContainer-${classroomId}`);
    const emptyState = document.getElementById(`evaluationsEmptyState-${classroomId}`);
    
    if (!evaluations || evaluations.length === 0) {
        container.innerHTML = '';
        emptyState.style.display = 'block';
        return;
    }
    
    emptyState.style.display = 'none';
    
    // Vérifier les permissions pour cette discipline
    const classrooms = {{ classrooms_json | tojson }};
    const currentClassroom = classrooms.find(c => c.id == classroomId);
    const isEditable = currentClassroom ? currentClassroom.is_editable === true : false;
    
    const students = {{ students_json|tojson|safe }};
    
    // Organiser les évaluations par type et calcul des moyennes TA
    const processedEvaluations = processEvaluations(evaluations);
    
    let html = `
        <table class="evaluations-table">
            <thead>
                <tr>
                    <th class="student-column">Élève</th>
    `;
    
    // En-têtes des colonnes d'évaluations (copié de la fonction originale)
    processedEvaluations.forEach(eval => {
        const isTA = eval.type === 'ta';
        const isExpandedTA = eval.isExpandedTA;
        const isGroupedTA = isTA && !isExpandedTA;
        
        let title;
        if (isExpandedTA) {
            title = eval.title;
        } else if (isTA) {
            title = `TA: ${eval.ta_group_name}`;
        } else {
            title = eval.title;
        }
        
        const isExpanded = isGroupedTA && expandedTAGroups.has(eval.ta_group_name);
        
        html += `
            <th class="eval-column ${isTA || isExpandedTA ? 'ta-column' : ''} ${isExpandedTA ? 'expanded-ta-item' : ''}" data-eval-id="${eval.id}">
                <div class="eval-header" onclick="selectEvaluation('${eval.id}')">
                    <span class="eval-title">${title}</span>
                    <div class="eval-actions">
                        ${isGroupedTA ? `<button class="btn-icon expand-ta-btn" onclick="event.stopPropagation(); toggleTAExpansion('${eval.ta_group_name}')" title="${isExpanded ? 'Regrouper les tests TA' : 'Voir les tests individuels'}">
                            <i class="fas fa-${isExpanded ? 'compress' : 'expand'}-alt"></i>
                        </button>` : ''}
                        ${isEditable ? `<button class="btn-icon edit-eval-btn" onclick="event.stopPropagation(); editEvaluation('${eval.id}', '${classroomId}')" title="Modifier l'évaluation">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon delete-eval-btn" onclick="event.stopPropagation(); deleteEvaluation('${eval.id}', '${classroomId}')" title="Supprimer l'évaluation">
                            <i class="fas fa-trash"></i>
                        </button>` : ''}
                    </div>
                </div>
            </th>
        `;
    });
    
    html += `
                    <th class="average-column">Moyenne</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    // Lignes des élèves
    students.forEach(student => {
        html += `<tr><td class="student-name">${student.full_name}</td>`;
        
        // Notes pour chaque évaluation
        processedEvaluations.forEach(eval => {
            const grade = getStudentGradeForEvaluation(student.id, eval);
            const gradeDisplay = formatGradeDisplay(grade, eval.max_points);
            html += `<td class="grade-cell ${getGradeClass(grade, eval.max_points)}">${gradeDisplay}</td>`;
        });
        
        // Moyenne générale de l'élève
        const studentAverage = calculateStudentAverage(student.id, processedEvaluations);
        html += `<td class="average-cell">${studentAverage.toFixed(1)}</td>`;
        
        html += '</tr>';
    });
    
    html += `
            </tbody>
        </table>
    `;
    
    container.innerHTML = html;
}

// Afficher le modal de nouvelle évaluation
function showNewEvaluationModal(classroomId = null) {
    // Si pas de classroomId spécifié, utiliser la classe primaire
    if (!classroomId) {
        classroomId = "{{ primary_classroom.id }}";
    }
    
    // Vérifier les permissions pour cette discipline
    const classrooms = {{ classrooms_json | tojson }};
    const currentClassroom = classrooms.find(c => c.id == classroomId);
    const isEditable = currentClassroom ? currentClassroom.is_editable === true : false;
    
    if (!isEditable) {
        showNotification('error', 'Vous ne pouvez pas créer d\'évaluations pour cette discipline (lecture seule).');
        return;
    }
    
    // Stocker l'ID de la classe pour l'utiliser lors de la création
    window.currentEvaluationClassroomId = classroomId;
    document.getElementById('newEvaluationModal').classList.add('show');
    
    // Initialiser la date à aujourd'hui
    document.getElementById('evalDate').value = new Date().toISOString().split('T')[0];
    
    // Réinitialiser le formulaire
    document.getElementById('evalStep1').style.display = 'block';
    document.getElementById('evalStep2').style.display = 'none';
    
    // Gérer l'activation des champs note maximale et minimale
    const maxPointsInput = document.getElementById('evalMaxPoints');
    const maxPointsHelpText = document.querySelector('#evalMaxPoints + small');
    const minPointsInput = document.getElementById('evalMinPoints');
    const minPointsHelpText = document.querySelector('#evalMinPoints + small');
    
    // Récupérer les évaluations pour cette classe spécifique
    const classroomEvaluations = evaluationsByClassroom[classroomId] || [];
    
    if (!classroomEvaluations || classroomEvaluations.length === 0) {
        // Aucune évaluation existante : permettre la modification
        maxPointsInput.removeAttribute('readonly');
        maxPointsInput.style.backgroundColor = '';
        maxPointsHelpText.textContent = 'Cette note maximale sera utilisée pour toutes les évaluations de cette classe';
        maxPointsHelpText.style.color = '#6B7280';
        
        minPointsInput.removeAttribute('readonly');
        minPointsInput.style.backgroundColor = '';
        minPointsHelpText.textContent = 'Cette note minimale sera utilisée pour toutes les évaluations de cette classe';
        minPointsHelpText.style.color = '#6B7280';
    } else {
        // Des évaluations existent : verrouiller sur les valeurs existantes
        const existingMaxPoints = classroomEvaluations[0].max_points;
        const existingMinPoints = classroomEvaluations[0].min_points || 0;
        
        maxPointsInput.value = existingMaxPoints;
        maxPointsInput.setAttribute('readonly', 'readonly');
        maxPointsInput.style.backgroundColor = '#F9FAFB';
        maxPointsHelpText.textContent = `Les notes seront saisies sur ${existingMaxPoints} (cohérence avec les tests existants)`;
        maxPointsHelpText.style.color = '#9CA3AF';
        
        minPointsInput.value = existingMinPoints;
        minPointsInput.setAttribute('readonly', 'readonly');
        minPointsInput.style.backgroundColor = '#F9FAFB';
        minPointsHelpText.textContent = `Note minimale: ${existingMinPoints} (cohérence avec les tests existants)`;
        minPointsHelpText.style.color = '#9CA3AF';
    }
    
    // Charger les groupes TA existants
    loadExistingTAGroups();
}

// Charger les groupes TA existants
function loadExistingTAGroups() {
    const select = document.getElementById('taGroupSelect');
    const existingOption = document.getElementById('existingTAOption');
    
    select.innerHTML = '';
    
    // Utiliser les groupes TA de la classe actuelle
    const classroomId = window.currentEvaluationClassroomId || "{{ primary_classroom.id }}";
    const currentTAGroups = existingTAGroupsByClassroom[classroomId] || [];
    
    if (currentTAGroups.length > 0) {
        existingOption.style.display = 'block';
        currentTAGroups.forEach(group => {
            const option = document.createElement('option');
            option.value = group;
            option.textContent = group;
            select.appendChild(option);
        });
    } else {
        existingOption.style.display = 'none';
    }
}

// Gérer le changement de type d'évaluation
function handleEvalTypeChange() {
    const taConfig = document.getElementById('taConfigGroup');
    const evalType = document.querySelector('input[name="evalType"]:checked').value;
    
    if (evalType === 'ta') {
        taConfig.style.display = 'block';
    } else {
        taConfig.style.display = 'none';
    }
}

// Gérer le changement de mode TA
function handleTAModeChange() {
    const newTAGroup = document.getElementById('newTAGroup');
    const existingTAGroup = document.getElementById('existingTAGroup');
    const taMode = document.querySelector('input[name="taMode"]:checked').value;
    
    if (taMode === 'new') {
        newTAGroup.style.display = 'block';
        existingTAGroup.style.display = 'none';
    } else {
        newTAGroup.style.display = 'none';
        existingTAGroup.style.display = 'block';
    }
}

// Passer à l'étape suivante
function nextEvalStep() {
    // Valider l'étape 1
    const title = document.getElementById('evalTitle').value.trim();
    const date = document.getElementById('evalDate').value;
    const evalType = document.querySelector('input[name="evalType"]:checked').value;
    
    if (!title || !date) {
        showNotification('error', 'Veuillez remplir tous les champs obligatoires');
        return;
    }
    
    // Valider la configuration TA si nécessaire
    if (evalType === 'ta') {
        const taMode = document.querySelector('input[name="taMode"]:checked').value;
        if (taMode === 'new') {
            const taGroupName = document.getElementById('taGroupName').value.trim();
            if (!taGroupName) {
                showNotification('error', 'Veuillez entrer un nom pour le groupe TA');
                return;
            }
        }
    }
    
    // Générer les champs de saisie des notes
    generateGradeInputs();
    
    // Passer à l'étape 2
    document.getElementById('evalStep1').style.display = 'none';
    document.getElementById('evalStep2').style.display = 'block';
}

// Revenir à l'étape précédente
function prevEvalStep() {
    document.getElementById('evalStep1').style.display = 'block';
    document.getElementById('evalStep2').style.display = 'none';
}

// Générer les champs de saisie des notes
function generateGradeInputs() {
    const container = document.getElementById('gradesInputContainer');
    const maxPoints = document.getElementById('evalMaxPoints').value;
    const minPoints = document.getElementById('evalMinPoints').value;
    
    let html = '';
    
    // Récupérer les élèves de la classe
    const students = {{ students_json|tojson|safe }};
    
    students.forEach(student => {
        html += `
            <div class="grade-input-row">
                <div class="student-name">${student.full_name}</div>
                <input type="number" 
                       class="grade-input" 
                       data-student-id="${student.id}"
                       min="${minPoints}" 
                       max="${maxPoints}" 
                       step="0.5" 
                       placeholder="${minPoints} - ${maxPoints}">
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Créer l'évaluation
async function createEvaluation(event) {
    event.preventDefault();
    
    // Utiliser l'ID de classe stocké dans le modal, ou celui par défaut
    const classroomId = window.currentEvaluationClassroomId || "{{ primary_classroom.id }}";
    
    // Récupérer les données du formulaire
    const title = document.getElementById('evalTitle').value.trim();
    const date = document.getElementById('evalDate').value;
    const maxPoints = parseFloat(document.getElementById('evalMaxPoints').value);
    const minPoints = parseFloat(document.getElementById('evalMinPoints').value);
    const evalType = document.querySelector('input[name="evalType"]:checked').value;
    
    let taGroupName = null;
    if (evalType === 'ta') {
        const taMode = document.querySelector('input[name="taMode"]:checked').value;
        if (taMode === 'new') {
            taGroupName = document.getElementById('taGroupName').value.trim();
        } else {
            taGroupName = document.getElementById('taGroupSelect').value;
        }
    }
    
    // Récupérer les notes (directement sur 20)
    const grades = [];
    const gradeInputs = document.querySelectorAll('.grade-input');
    gradeInputs.forEach(input => {
        const studentId = input.dataset.studentId;
        const note = input.value ? parseFloat(input.value) : null;
        
        grades.push({
            student_id: parseInt(studentId),
            points: note  // Les notes sont directement stockées comme points
        });
    });
    
    const evaluationData = {
        classroom_id: classroomId,
        title: title,
        date: date,
        max_points: maxPoints,
        min_points: minPoints,
        type: evalType,
        ta_group_name: taGroupName,
        grades: grades
    };
    
    try {
        const response = await fetch('/api/evaluations/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(evaluationData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification('success', 'Évaluation créée avec succès');
            closeModal('newEvaluationModal');
            
            // Recharger seulement la classe concernée
            const classroomId = window.currentEvaluationClassroomId || "{{ primary_classroom.id }}";
            const classrooms = {{ classrooms_json | tojson }};
            const classroom = classrooms.find(c => c.id == classroomId);
            if (classroom) {
                loadEvaluationsForClassroom(classroomId, classroom.subject);
            }
        } else {
            showNotification('error', result.message || 'Erreur lors de la création');
        }
    } catch (error) {
        console.error('Erreur:', error);
        showNotification('error', 'Erreur lors de la création de l\'évaluation');
    }
}


// Traiter les évaluations (grouper les TA)
function processEvaluations(rawEvaluations) {
    const processed = [];
    const taGroups = {};
    
    rawEvaluations.forEach(eval => {
        if (eval.type === 'significatif') {
            processed.push(eval);
        } else if (eval.type === 'ta') {
            if (!taGroups[eval.ta_group_name]) {
                taGroups[eval.ta_group_name] = {
                    id: `ta_${eval.ta_group_name}`,
                    title: eval.ta_group_name,
                    type: 'ta',
                    ta_group_name: eval.ta_group_name,
                    max_points: eval.max_points,
                    evaluations: []
                };
            }
            taGroups[eval.ta_group_name].evaluations.push(eval);
        }
    });
    
    // Ajouter les groupes TA traités ou les évaluations individuelles si dépliés
    Object.values(taGroups).forEach(taGroup => {
        if (expandedTAGroups.has(taGroup.ta_group_name)) {
            // Si le groupe est déplié, ajouter les évaluations individuelles
            taGroup.evaluations.forEach(eval => {
                processed.push({
                    ...eval,
                    isExpandedTA: true,
                    parentTAGroup: taGroup.ta_group_name
                });
            });
        } else {
            // Sinon, ajouter le groupe TA regroupé
            processed.push(taGroup);
        }
    });
    
    return processed;
}

// Obtenir la note d'un élève pour une évaluation
function getStudentGradeForEvaluation(studentId, evaluation) {
    if (evaluation.isExpandedTA) {
        // Pour les évaluations TA individuelles dépliées
        const grade = evaluation.grades?.find(g => g.student_id === studentId);
        if (!grade || grade.points === null) return null;
        return grade.points;
    } else if (evaluation.type === 'ta') {
        // Pour les TA groupés, calculer la moyenne des évaluations du groupe
        const taGrades = [];
        evaluation.evaluations.forEach(eval => {
            const grade = eval.grades?.find(g => g.student_id === studentId);
            if (grade && grade.points !== null) {
                taGrades.push(grade.points);
            }
        });
        
        if (taGrades.length === 0) return null;
        return taGrades.reduce((sum, grade) => sum + grade, 0) / taGrades.length;
    } else {
        // Pour les évaluations significatives
        const grade = evaluation.grades?.find(g => g.student_id === studentId);
        if (!grade || grade.points === null) return null;
        return grade.points;
    }
}

// Formater l'affichage d'une note
function formatGradeDisplay(grade, maxPoints) {
    if (grade === null) return 'Abs.';
    return grade.toFixed(1);
}

// Obtenir la classe CSS selon la note
function getGradeClass(grade, maxPoints) {
    if (grade === null) return 'absent';
    const percentage = (grade / maxPoints) * 100;
    
    if (percentage >= 80) return 'excellent';
    if (percentage >= 60) return 'good';
    if (percentage >= 40) return 'average';
    return 'poor';
}

// Calculer la moyenne générale d'un élève
function calculateStudentAverage(studentId, processedEvaluations) {
    const grades = [];
    
    // Ne compter que les évaluations significatives et les groupes TA (pas les éléments individuels)
    processedEvaluations.forEach(eval => {
        if (!eval.isExpandedTA) { // Exclure les évaluations TA individuelles dépliées
            const grade = getStudentGradeForEvaluation(studentId, eval);
            if (grade !== null) {
                grades.push(grade);
            }
        }
    });
    
    if (grades.length === 0) return 0;
    return grades.reduce((sum, grade) => sum + grade, 0) / grades.length;
}

// Calculer la moyenne d'un test pour tous les élèves
function calculateTestAverage(evaluation, students) {
    const grades = [];
    
    students.forEach(student => {
        const grade = getStudentGradeForEvaluation(student.id, evaluation);
        if (grade !== null) {
            grades.push(grade);
        }
    });
    
    if (grades.length === 0) return null;
    return grades.reduce((sum, grade) => sum + grade, 0) / grades.length;
}

// Calculer la moyenne générale de la classe
function calculateClassAverage(processedEvaluations, students) {
    const studentAverages = [];
    
    students.forEach(student => {
        const average = calculateStudentAverage(student.id, processedEvaluations);
        if (average > 0) {
            studentAverages.push(average);
        }
    });
    
    if (studentAverages.length === 0) return null;
    return studentAverages.reduce((sum, avg) => sum + avg, 0) / studentAverages.length;
}

// Sélectionner une évaluation pour afficher l'histogramme
function selectEvaluation(evalId) {
    console.log('Selecting evaluation:', evalId);
    selectedEvaluationId = evalId;
    
    // Mettre à jour l'apparence des colonnes
    document.querySelectorAll('.eval-column').forEach(col => {
        col.classList.remove('selected');
    });
    const columnElement = document.querySelector(`[data-eval-id="${evalId}"]`);
    if (columnElement) {
        columnElement.classList.add('selected');
    }
    
    // Afficher l'histogramme
    showEvaluationHistogram(evalId);
}

// Afficher l'histogramme d'une évaluation
function showEvaluationHistogram(evalId) {
    console.log('Showing histogram for evaluation:', evalId);
    const evaluation = findEvaluationById(evalId);
    console.log('Found evaluation:', evaluation);
    
    if (!evaluation) {
        console.log('No evaluation found');
        return;
    }
    
    const students = {{ students_json|tojson|safe }};
    const grades = [];
    
    students.forEach(student => {
        const grade = getStudentGradeForEvaluation(student.id, evaluation);
        if (grade !== null) {
            grades.push(grade);
        }
    });
    
    console.log('Grades for histogram:', grades);
    
    if (grades.length === 0) {
        console.log('No grades found');
        document.getElementById('gradeHistogram').style.display = 'none';
        return;
    }
    
    // Calculer les statistiques
    const average = grades.reduce((sum, grade) => sum + grade, 0) / grades.length;
    const max = Math.max(...grades);
    const min = Math.min(...grades);
    
    // Mettre à jour les statistiques
    document.getElementById('selectedEvalAverage').textContent = average.toFixed(1);
    document.getElementById('selectedEvalMax').textContent = max.toFixed(1);
    document.getElementById('selectedEvalMin').textContent = min.toFixed(1);
    
    // Dessiner l'histogramme
    drawHistogram(grades, evaluation.max_points);
    
    document.getElementById('gradeHistogram').style.display = 'block';
}

// Trouver une évaluation par ID dans toutes les classes
function findEvaluationById(evalId) {
    // Parcourir toutes les classes pour trouver l'évaluation
    const numericEvalId = parseInt(evalId);
    for (const [classroomId, evaluations] of Object.entries(evaluationsByClassroom)) {
        const processedEvaluations = processEvaluations(evaluations);
        const evaluation = processedEvaluations.find(eval => eval.id === numericEvalId);
        if (evaluation) {
            return evaluation;
        }
    }
    return null;
}

// Dessiner l'histogramme simple (sans Chart.js)
function drawHistogram(grades, maxPoints) {
    const canvas = document.getElementById('histogramChart');
    const ctx = canvas.getContext('2d');
    
    // Effacer le canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Déterminer la précision d'arrondi selon la note maximale
    let roundingPrecision;
    if (maxPoints >= 10) {
        roundingPrecision = 0.5; // Arrondi à 0.5 si note maximale >= 10
    } else {
        roundingPrecision = 0.25; // Arrondi à 0.25 si note maximale < 10
    }
    
    // Compter chaque note exacte (arrondie)
    const noteCounts = {};
    
    grades.forEach(grade => {
        // Arrondir la note selon la précision
        const roundedGrade = Math.round(grade / roundingPrecision) * roundingPrecision;
        const key = roundedGrade.toFixed(2);
        noteCounts[key] = (noteCounts[key] || 0) + 1;
    });
    
    // Convertir en tableau ordonné
    const sortedNotes = Object.keys(noteCounts)
        .map(key => parseFloat(key))
        .sort((a, b) => a - b);
    
    if (sortedNotes.length === 0) return;
    
    // Dessiner l'histogramme
    const barWidth = Math.min(canvas.width / sortedNotes.length, 60); // Largeur maximale de 60px
    const maxCount = Math.max(...Object.values(noteCounts));
    const startX = (canvas.width - (barWidth * sortedNotes.length)) / 2; // Centrer les barres
    
    ctx.fillStyle = '#4F46E5';
    
    sortedNotes.forEach((note, index) => {
        const count = noteCounts[note.toFixed(2)];
        const barHeight = (count / maxCount) * (canvas.height - 60);
        const x = startX + (index * barWidth);
        const y = canvas.height - barHeight - 30;
        
        // Dessiner la barre
        ctx.fillRect(x + 2, y, barWidth - 4, barHeight);
        
        // Labels
        ctx.fillStyle = '#374151';
        ctx.font = '11px Arial';
        ctx.textAlign = 'center';
        
        // Afficher la note (absolue)
        const noteLabel = note % 1 === 0 ? note.toString() : note.toFixed(1);
        ctx.fillText(noteLabel, x + barWidth / 2, canvas.height - 10);
        
        // Afficher le nombre d'élèves
        ctx.fillText(count.toString(), x + barWidth / 2, y - 5);
        
        ctx.fillStyle = '#4F46E5';
    });
}

// Éditer une évaluation existante
async function editEvaluation(evalId, classroomId = null) {
    // Vérifier les permissions pour cette discipline
    if (classroomId) {
        const classrooms = {{ classrooms_json | tojson }};
        const currentClassroom = classrooms.find(c => c.id == classroomId);
        const isEditable = currentClassroom ? currentClassroom.is_editable === true : false;
        
        if (!isEditable) {
            showNotification('error', 'Vous ne pouvez pas modifier les évaluations de cette discipline (lecture seule).');
            return;
        }
    }
    
    // Trouver l'évaluation dans la liste
    let evaluation;
    let currentClassroomId = classroomId;
    
    if (classroomId) {
        // Rechercher dans les évaluations de la classe spécifique
        const classroomEvaluations = evaluationsByClassroom[classroomId] || [];
        evaluation = classroomEvaluations.find(eval => eval.id === parseInt(evalId));
    } else {
        // Fallback : rechercher dans toutes les classes
        for (const [cId, evals] of Object.entries(evaluationsByClassroom)) {
            evaluation = evals.find(eval => eval.id === parseInt(evalId));
            if (evaluation) {
                currentClassroomId = cId;
                break;
            }
        }
    }
    if (!evaluation) {
        showNotification('error', 'Évaluation introuvable');
        return;
    }
    
    // Stocker l'ID de classe pour l'utiliser lors de la mise à jour
    window.currentEvaluationClassroomId = currentClassroomId;
    
    // Pré-remplir le formulaire avec les données existantes
    document.getElementById('evalTitle').value = evaluation.title;
    document.getElementById('evalDate').value = evaluation.date;
    document.getElementById('evalMaxPoints').value = evaluation.max_points;
    document.getElementById('evalMinPoints').value = evaluation.min_points || 0;
    
    // Sélectionner le type d'évaluation
    const typeRadio = document.querySelector(`input[name="evalType"][value="${evaluation.type}"]`);
    if (typeRadio) {
        typeRadio.checked = true;
        handleEvalTypeChange();
    }
    
    // Si c'est un TA, configurer le groupe
    if (evaluation.type === 'ta' && evaluation.ta_group_name) {
        const existingTARadio = document.querySelector('input[name="taMode"][value="existing"]');
        if (existingTARadio) {
            existingTARadio.checked = true;
            handleTAModeChange();
            document.getElementById('taGroupSelect').value = evaluation.ta_group_name;
        }
    }
    
    // Passer à l'étape 2 directement
    nextEvalStep();
    
    // Pré-remplir les notes
    const students = {{ students_json|tojson|safe }};
    students.forEach(student => {
        const gradeInput = document.querySelector(`input[data-student-id="${student.id}"]`);
        if (gradeInput) {
            const gradeData = evaluation.grades?.find(g => g.student_id === student.id);
            if (gradeData && gradeData.points !== null) {
                gradeInput.value = gradeData.points;
            }
        }
    });
    
    // Modifier le formulaire pour la mise à jour au lieu de la création
    const form = document.getElementById('newEvaluationForm');
    form.onsubmit = (event) => updateEvaluation(event, evalId);
    
    // Changer le titre du modal
    document.querySelector('#newEvaluationModal .modal-header h3').innerHTML = 
        '<i class="fas fa-edit"></i> Modifier l\'évaluation';
    
    // Afficher le modal
    document.getElementById('newEvaluationModal').classList.add('show');
}

// Mettre à jour une évaluation existante
async function updateEvaluation(event, evalId) {
    event.preventDefault();
    
    // Récupérer les données du formulaire (même logique que createEvaluation)
    const title = document.getElementById('evalTitle').value.trim();
    const date = document.getElementById('evalDate').value;
    const evalType = document.querySelector('input[name="evalType"]:checked').value;
    
    let taGroupName = null;
    if (evalType === 'ta') {
        const taMode = document.querySelector('input[name="taMode"]:checked').value;
        if (taMode === 'new') {
            taGroupName = document.getElementById('taGroupName').value.trim();
        } else {
            taGroupName = document.getElementById('taGroupSelect').value;
        }
    }
    
    // Récupérer les notes
    const grades = [];
    const gradeInputs = document.querySelectorAll('.grade-input');
    gradeInputs.forEach(input => {
        const studentId = input.dataset.studentId;
        const note = input.value ? parseFloat(input.value) : null;
        
        grades.push({
            student_id: parseInt(studentId),
            points: note
        });
    });
    
    const evaluationData = {
        title: title,
        date: date,
        max_points: parseFloat(document.getElementById('evalMaxPoints').value),
        min_points: parseFloat(document.getElementById('evalMinPoints').value),
        type: evalType,
        ta_group_name: taGroupName,
        grades: grades
    };
    
    try {
        const response = await fetch(`/api/evaluations/${evalId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(evaluationData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification('success', 'Évaluation modifiée avec succès');
            closeModal('newEvaluationModal');
            
            // Recharger seulement la classe concernée
            const classroomId = window.currentEvaluationClassroomId || "{{ primary_classroom.id }}";
            const classrooms = {{ classrooms_json | tojson }};
            const classroom = classrooms.find(c => c.id == classroomId);
            if (classroom) {
                loadEvaluationsForClassroom(classroomId, classroom.subject);
            }
            
            // Remettre le formulaire en mode création
            resetEvaluationForm();
        } else {
            showNotification('error', result.message || 'Erreur lors de la modification');
        }
    } catch (error) {
        console.error('Erreur:', error);
        showNotification('error', 'Erreur lors de la modification de l\'évaluation');
    }
}

// Remettre le formulaire en mode création
function resetEvaluationForm() {
    const form = document.getElementById('newEvaluationForm');
    form.onsubmit = createEvaluation;
    
    // Remettre le titre original
    document.querySelector('#newEvaluationModal .modal-header h3').innerHTML = 
        '<i class="fas fa-clipboard-check"></i> Nouvelle évaluation';
        
    // Réinitialiser le formulaire
    form.reset();
    document.getElementById('evalStep1').style.display = 'block';
    document.getElementById('evalStep2').style.display = 'none';
}

// Supprimer une évaluation
async function deleteEvaluation(evalId, classroomId = null) {
    // Vérifier les permissions pour cette discipline
    if (classroomId) {
        const classrooms = {{ classrooms_json | tojson }};
        const currentClassroom = classrooms.find(c => c.id == classroomId);
        const isEditable = currentClassroom ? currentClassroom.is_editable === true : false;
        
        if (!isEditable) {
            showNotification('error', 'Vous ne pouvez pas supprimer les évaluations de cette discipline (lecture seule).');
            return;
        }
    }
    
    // Trouver l'évaluation pour afficher son nom
    let evaluation;
    let currentClassroomId = classroomId;
    
    if (classroomId) {
        // Rechercher dans les évaluations de la classe spécifique
        const classroomEvaluations = evaluationsByClassroom[classroomId] || [];
        evaluation = classroomEvaluations.find(eval => eval.id === parseInt(evalId));
    } else {
        // Fallback : rechercher dans toutes les classes
        for (const [cId, evals] of Object.entries(evaluationsByClassroom)) {
            evaluation = evals.find(eval => eval.id === parseInt(evalId));
            if (evaluation) {
                currentClassroomId = cId;
                break;
            }
        }
    }
    if (!evaluation) {
        showNotification('error', 'Évaluation introuvable');
        return;
    }
    
    // Demander confirmation
    const confirmMessage = `Êtes-vous sûr de vouloir supprimer l'évaluation "${evaluation.title}" ?\n\nCette action est irréversible et supprimera toutes les notes associées.`;
    if (!confirm(confirmMessage)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/evaluations/${evalId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification('success', 'Évaluation supprimée avec succès');
            
            // Recharger seulement la classe concernée
            if (currentClassroomId) {
                const classrooms = {{ classrooms_json | tojson }};
                const classroom = classrooms.find(c => c.id == currentClassroomId);
                if (classroom) {
                    loadEvaluationsForClassroom(currentClassroomId, classroom.subject);
                }
            } else {
                loadEvaluations(); // Fallback : recharger tout
            }
            
            // Masquer l'histogramme si l'évaluation supprimée était sélectionnée
            if (selectedEvaluationId === evalId) {
                document.getElementById('gradeHistogram').style.display = 'none';
                selectedEvaluationId = null;
            }
        } else {
            showNotification('error', result.message || 'Erreur lors de la suppression');
        }
    } catch (error) {
        console.error('Erreur:', error);
        showNotification('error', 'Erreur lors de la suppression de l\'évaluation');
    }
}

// Basculer l'expansion d'un groupe TA
function toggleTAExpansion(taGroupName) {
    if (expandedTAGroups.has(taGroupName)) {
        // Replier : retirer du set
        expandedTAGroups.delete(taGroupName);
    } else {
        // Déplier : ajouter au set
        expandedTAGroups.add(taGroupName);
    }
    
    // Recharger tous les tableaux pour refléter les changements
    loadEvaluations();
}


// === GESTION DE L'ONGLET ABSENCES ===

// Gérer les sous-onglets de l'onglet Absences
function showAttendanceTab(tabName) {
    // Masquer tous les contenus
    document.querySelectorAll('.attendance-content').forEach(content => {
        content.style.display = 'none';
    });
    
    // Désactiver tous les boutons
    document.querySelectorAll('.attendance-mini-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Afficher le contenu sélectionné
    document.getElementById(tabName).style.display = 'block';
    
    // Activer le bouton correspondant
    event.target.classList.add('active');
    
    // Charger les données initiales si nécessaire
    if (tabName === 'class-absences') {
        initializeClassAbsencesTab();
    } else if (tabName === 'class-late') {
        initializeClassLateTab();
    }
}

// Initialiser l'onglet Absences
function initializeClassAbsencesTab() {
    // Définir les dates par défaut (année scolaire)
    const today = new Date();
    const currentYear = today.getFullYear();
    const currentMonth = today.getMonth();
    let startYear = currentMonth < 7 ? currentYear - 1 : currentYear;
    let endYear = startYear + 1;
    
    document.getElementById('class-start-date-absences').value = `${startYear}-09-01`;
    document.getElementById('class-end-date-absences').value = `${endYear}-07-31`;
    
    loadClassAbsences();
}

// Initialiser l'onglet Retards
function initializeClassLateTab() {
    // Définir les dates par défaut (année scolaire)
    const today = new Date();
    const currentYear = today.getFullYear();
    const currentMonth = today.getMonth();
    let startYear = currentMonth < 7 ? currentYear - 1 : currentYear;
    let endYear = startYear + 1;
    
    document.getElementById('class-start-date-late').value = `${startYear}-09-01`;
    document.getElementById('class-end-date-late').value = `${endYear}-07-31`;
    
    loadClassLateArrivals();
}

// Charger les absences pour la classe sélectionnée
function loadClassAbsences() {
    const selectedClassroomId = document.getElementById('classSelect').value;
    if (!selectedClassroomId) return;
    
    showClassLoading('absences');
    
    const params = new URLSearchParams({
        start_date: document.getElementById('class-start-date-absences').value,
        end_date: document.getElementById('class-end-date-absences').value,
        classroom_id: selectedClassroomId
    });
    
    fetch(`{{ url_for('attendance.get_absences') }}?${params}`)
        .then(response => response.json())
        .then(data => {
            hideClassLoading('absences');
            
            if (data.success) {
                displayClassAbsences(data.absences);
            } else {
                showNotification('error', 'Erreur lors du chargement des absences: ' + data.message);
            }
        })
        .catch(error => {
            hideClassLoading('absences');
            showNotification('error', 'Erreur de connexion: ' + error.message);
        });
}

// Charger les retards pour la classe sélectionnée
function loadClassLateArrivals() {
    const selectedClassroomId = document.getElementById('classSelect').value;
    if (!selectedClassroomId) return;
    
    showClassLoading('late');
    
    const params = new URLSearchParams({
        start_date: document.getElementById('class-start-date-late').value,
        end_date: document.getElementById('class-end-date-late').value,
        classroom_id: selectedClassroomId
    });
    
    fetch(`{{ url_for('attendance.get_late_arrivals') }}?${params}`)
        .then(response => response.json())
        .then(data => {
            hideClassLoading('late');
            
            if (data.success) {
                displayClassLateArrivals(data.late_arrivals);
            } else {
                showNotification('error', 'Erreur lors du chargement des retards: ' + data.message);
            }
        })
        .catch(error => {
            hideClassLoading('late');
            showNotification('error', 'Erreur de connexion: ' + error.message);
        });
}

// Afficher le spinner de chargement
function showClassLoading(type) {
    document.getElementById(`class-loading-${type}`).style.display = 'block';
    document.getElementById(`class-${type}-table`).style.display = 'none';
    document.getElementById(`class-no-${type}`).style.display = 'none';
}

// Masquer le spinner de chargement
function hideClassLoading(type) {
    document.getElementById(`class-loading-${type}`).style.display = 'none';
}

// Afficher les absences dans le tableau
function displayClassAbsences(absences) {
    const tbody = document.getElementById('class-absences-tbody');
    const table = document.getElementById('class-absences-table');
    const noData = document.getElementById('class-no-absences');
    
    tbody.innerHTML = '';
    
    if (absences.length === 0) {
        table.style.display = 'none';
        noData.style.display = 'block';
        return;
    }
    
    absences.forEach(absence => {
        const row = tbody.insertRow();
        row.className = 'absence-row'; // Ajouter la classe pour le fond rouge clair
        row.innerHTML = `
            <td>${absence.date}</td>
            <td>${absence.student_name}</td>
            <td>${absence.periods}</td>
            <td>${absence.time_range}</td>
            <td>${absence.comment || '-'}</td>
        `;
    });
    
    table.style.display = 'table';
    noData.style.display = 'none';
}

// Afficher les retards dans le tableau
function displayClassLateArrivals(lateArrivals) {
    const tbody = document.getElementById('class-late-tbody');
    const table = document.getElementById('class-late-table');
    const noData = document.getElementById('class-no-late');
    
    tbody.innerHTML = '';
    
    if (lateArrivals.length === 0) {
        table.style.display = 'none';
        noData.style.display = 'block';
        return;
    }
    
    lateArrivals.forEach(late => {
        const row = tbody.insertRow();
        row.className = 'late-row'; // Ajouter la classe pour le fond jaune clair
        row.innerHTML = `
            <td>${late.date}</td>
            <td>${late.student_name}</td>
            <td>${late.periods}</td>
            <td>${late.time_range}</td>
            <td><span class="badge-late">${late.late_minutes} min</span></td>
            <td>${late.comment || '-'}</td>
        `;
    });
    
    table.style.display = 'table';
    noData.style.display = 'none';
}

// ===== GESTION DES GROUPES =====

let currentEditingGroupId = null;

// Charger les groupes de la classe
function loadGroups() {
    const classroomId = document.getElementById('classSelect').value;
    if (!classroomId) return;

    fetch(`/planning/get-groups/${classroomId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayGroups(data.groups);
            } else {
                console.error('Erreur lors du chargement des groupes:', data.message);
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
        });
}

// Afficher les groupes
function displayGroups(groups) {
    const groupsList = document.getElementById('groupsList');
    
    if (groups.length === 0) {
        groupsList.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-users fa-2x mb-2"></i>
                <p>Aucun groupe créé pour cette classe</p>
                <p class="small">Cliquez sur "Créer un groupe" pour commencer</p>
            </div>
        `;
        return;
    }

    groupsList.innerHTML = groups.map(group => `
        <div class="group-card">
            <div class="group-header">
                <div class="group-info">
                    <h3>
                        <span class="group-color-indicator" style="background-color: ${group.color}"></span>
                        ${group.name}
                    </h3>
                </div>
                <div class="group-actions">
                    <button onclick="editGroup(${group.id})" title="Modifier">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="deleteGroup(${group.id})" title="Supprimer">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            ${group.description ? `<div class="group-description">${group.description}</div>` : ''}
            <div class="group-students">
                ${group.students.map(student => `
                    <span class="student-tag">${student.first_name} ${student.last_name || ''}</span>
                `).join('')}
            </div>
            <div class="mt-2 small text-muted">
                ${group.students.length} élève(s)
            </div>
        </div>
    `).join('');
}

// Afficher le modal de création de groupe
function showCreateGroupModal() {
    currentEditingGroupId = null;
    document.getElementById('groupModalTitle').textContent = 'Créer un groupe';
    document.getElementById('groupName').value = '';
    document.getElementById('groupDescription').value = '';
    document.getElementById('groupColor').value = '#4F46E5';
    
    loadStudentsForSelection();
    document.getElementById('groupModal').classList.add('show');
}

// Éditer un groupe
function editGroup(groupId) {
    currentEditingGroupId = groupId;
    document.getElementById('groupModalTitle').textContent = 'Modifier le groupe';
    
    const classroomId = document.getElementById('classSelect').value;
    fetch(`/planning/get-group/${groupId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const group = data.group;
                document.getElementById('groupName').value = group.name;
                document.getElementById('groupDescription').value = group.description || '';
                document.getElementById('groupColor').value = group.color;
                
                loadStudentsForSelection(group.student_ids);
                document.getElementById('groupModal').classList.add('show');
            }
        })
        .catch(error => console.error('Erreur:', error));
}

// Charger les élèves pour la sélection
function loadStudentsForSelection(selectedStudentIds = []) {
    const studentsGrid = document.getElementById('studentsGrid');
    
    const students = {{ students_json|tojson|safe }};
    studentsGrid.innerHTML = students.map(student => `
        <label class="student-checkbox">
            <input type="checkbox" value="${student.id}" ${selectedStudentIds.includes(student.id) ? 'checked' : ''}>
            <span>${student.first_name} ${student.last_name || ''}</span>
        </label>
    `).join('');
}

// Sauvegarder le groupe
function saveGroup() {
    const name = document.getElementById('groupName').value.trim();
    const description = document.getElementById('groupDescription').value.trim();
    const color = document.getElementById('groupColor').value;
    const classroomId = document.getElementById('classSelect').value;
    
    if (!name) {
        alert('Le nom du groupe est obligatoire');
        return;
    }

    const selectedStudents = Array.from(document.querySelectorAll('#studentsGrid input[type="checkbox"]:checked'))
        .map(checkbox => parseInt(checkbox.value));

    const groupData = {
        name: name,
        description: description,
        color: color,
        classroom_id: classroomId,
        student_ids: selectedStudents
    };

    const url = currentEditingGroupId 
        ? `/planning/update-group/${currentEditingGroupId}`
        : '/planning/create-group';

    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(groupData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeGroupModal();
            loadGroups();
            showNotification('success', data.message);
        } else {
            alert('Erreur: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        alert('Erreur lors de la sauvegarde');
    });
}

// Supprimer un groupe
function deleteGroup(groupId) {
    if (!confirm('Êtes-vous sûr de vouloir supprimer ce groupe ?')) {
        return;
    }

    fetch(`/planning/delete-group/${groupId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadGroups();
            showNotification('success', 'Groupe supprimé avec succès');
        } else {
            alert('Erreur: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        alert('Erreur lors de la suppression');
    });
}

// Fermer le modal de groupe
function closeGroupModal() {
    document.getElementById('groupModal').classList.remove('show');
    currentEditingGroupId = null;
}

// ===== SYSTÈME DE RAPPORT ÉLÈVE =====

let currentSelectedStudentId = null;

// Fonction helper pour récupérer l'ID de la classe actuelle
function getCurrentClassroomId() {
    return "{{ primary_classroom.id }}";
}

// Charger la liste des élèves pour le sélecteur de rapport
function loadStudentsForReport() {
    const select = document.getElementById('report-student-select');
    select.innerHTML = '<option value="">-- Choisir un élève --</option>';
    
    // Utiliser les élèves déjà disponibles dans le template (qui gèrent correctement les classes mixtes)
    const students = {{ students_json|tojson|safe }};
    
    students.forEach(student => {
        const option = document.createElement('option');
        option.value = student.id;
        option.textContent = `${student.first_name} ${student.last_name}`;
        select.appendChild(option);
    });
}

// Charger le rapport complet d'un élève
function loadStudentReport() {
    const studentId = document.getElementById('report-student-select').value;
    const reportContent = document.getElementById('student-report-content');
    const printBtn = document.getElementById('print-report-btn');
    
    if (!studentId) {
        reportContent.style.display = 'none';
        printBtn.style.display = 'none';
        return;
    }
    
    currentSelectedStudentId = studentId;
    reportContent.style.display = 'block';
    printBtn.style.display = 'inline-block';
    
    // Charger toutes les données de l'élève
    loadStudentInfo(studentId);
    loadStudentAccommodations(studentId);
    loadStudentGrades(studentId);
    loadStudentBehaviorSummary(studentId);
    loadStudentAdditionalInfo(studentId);
    loadStudentInfoHistory(studentId);
    loadStudentFiles(studentId);
}

// Charger les informations de base de l'élève
function loadStudentInfo(studentId) {
    fetch(`/planning/student/${studentId}`)
        .then(response => response.json())
        .then(data => {
            const student = data.student;
            document.getElementById('report-first-name').textContent = student.first_name || '-';
            document.getElementById('report-last-name').textContent = student.last_name || '-';
            document.getElementById('report-email').textContent = student.email || '-';
            document.getElementById('report-parent-email-mother').textContent = student.parent_email_mother || '-';
            document.getElementById('report-parent-email-father').textContent = student.parent_email_father || '-';
            
            // Charger les groupes de l'élève
            const groups = data.groups || [];
            const groupsText = groups.length > 0 ? groups.map(g => g.name).join(', ') : 'Aucun groupe';
            document.getElementById('report-groups').textContent = groupsText;
        })
        .catch(error => {
            console.error('Erreur lors du chargement des infos élève:', error);
        });
}

// Charger les aménagements de l'élève
function loadStudentAccommodations(studentId) {
    fetch(`/planning/student/${studentId}/accommodations`)
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('report-accommodations');
            
            if (data.accommodations.length === 0) {
                container.innerHTML = '<p class="text-muted">Aucun aménagement</p>';
                return;
            }
            
            container.innerHTML = data.accommodations.map(acc => `
                <div class="accommodation-item ${acc.is_own ? 'own-accommodation' : 'other-accommodation'}">
                    <div class="accommodation-content">
                        <span class="accommodation-emoji">${acc.emoji}</span>
                        <span class="accommodation-name">${acc.name}</span>
                        ${acc.time_multiplier ? `<span class="time-multiplier">(x${acc.time_multiplier})</span>` : ''}
                    </div>
                    ${acc.teacher_name ? `<div class="accommodation-teacher">
                        <i class="fas fa-user"></i> ${acc.teacher_name}
                    </div>` : ''}
                </div>
            `).join('');
        })
        .catch(error => {
            console.error('Erreur lors du chargement des aménagements:', error);
        });
}

// Charger les notes de l'élève
function loadStudentGrades(studentId) {
    fetch(`/planning/student/${studentId}/grades`)
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('report-grades');
            
            if (!data.subjects_table || data.subjects_table.length === 0) {
                container.innerHTML = '<p class="text-muted">Aucune note enregistrée</p>';
                return;
            }
            
            // Créer le tableau des notes par discipline
            let tableHTML = `
                <div class="grades-table-container">
                    <table class="grades-table">
                        <thead>
                            <tr>
                                <th>Discipline</th>
                                <th>Enseignant</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.subjects_table.forEach(subject => {
                const isOwnSubject = subject.evaluations.some(eval => eval.is_own);
                const rowClass = isOwnSubject ? 'own-subject' : 'other-subject';
                
                tableHTML += `
                    <tr class="${rowClass}">
                        <td class="subject-name">
                            <strong>${subject.subject}</strong>
                        </td>
                        <td class="teacher-name">
                            <i class="fas fa-user"></i> ${subject.teacher_name}
                        </td>
                        <td class="evaluations-cell">
                            <div class="evaluations-grid">
                                ${subject.evaluations.map(eval => `
                                    <div class="evaluation-item ${eval.is_own ? 'own-evaluation' : 'other-evaluation'}" 
                                         title="${eval.evaluation_name} - ${eval.date}">
                                        <div class="evaluation-name">${eval.evaluation_name}</div>
                                        <div class="evaluation-score">${eval.score}/${eval.max_score}</div>
                                        <div class="evaluation-date">${eval.date}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = tableHTML;
        })
        .catch(error => {
            console.error('Erreur lors du chargement des notes:', error);
        });
}

// Charger le résumé compact du comportement (sanctions + absences séparés)
function loadStudentBehaviorSummary(studentId) {
    fetch(`/planning/student/${studentId}/behavior-summary`)
        .then(response => response.json())
        .then(data => {
            // Traiter les sanctions
            const sanctionsContainer = document.getElementById('report-sanctions-summary');
            
            if (!data.sanctions || data.sanctions.length === 0) {
                sanctionsContainer.innerHTML = '<div class="behavior-empty">Aucune coche enregistrée</div>';
            } else {
                // Construire le tableau des sanctions
                let sanctionsTableHTML = `
                    <table class="behavior-table">
                        <thead>
                            <tr>
                                <th style="width: 30%;">Enseignant</th>
                                <th style="width: 20%;">Total</th>
                                <th style="width: 50%;">Détails</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                data.sanctions.forEach(teacher => {
                    const rowClass = teacher.is_own ? 'own-data' : 'other-data';
                    const teacherClass = teacher.is_own ? 'own' : 'other';
                    
                    // Sanctions/coches
                    let sanctionsHTML = `
                        <div class="sanctions-summary">
                            ${teacher.sanctions_details.map(sanction => `
                                <span class="sanction-badge ${teacher.is_own ? 'own' : ''}">
                                    ${sanction.emoji} ${sanction.name} (${sanction.count})
                                </span>
                            `).join('')}
                        </div>
                    `;
                    
                    sanctionsTableHTML += `
                        <tr class="${rowClass}">
                            <td>
                                <div class="teacher-name ${teacherClass}">
                                    <i class="fas fa-user"></i> ${teacher.teacher_name}
                                    ${teacher.is_own ? ' <small>(vous)</small>' : ''}
                                </div>
                            </td>
                            <td>
                                <span class="summary-count sanctions ${teacher.is_own ? 'own' : ''}">
                                    ${teacher.sanctions_count}
                                </span>
                            </td>
                            <td>${sanctionsHTML}</td>
                        </tr>
                    `;
                });
                
                sanctionsTableHTML += `
                        </tbody>
                    </table>
                `;
                
                sanctionsContainer.innerHTML = sanctionsTableHTML;
            }
            
            // Traiter les absences (organisées par date)
            const attendanceContainer = document.getElementById('report-attendance-summary');
            
            if (!data.attendance || data.attendance.length === 0) {
                attendanceContainer.innerHTML = '<div class="behavior-empty">Aucune absence enregistrée</div>';
            } else {
                // Construire le tableau des absences par date
                let attendanceTableHTML = `
                    <table class="behavior-table">
                        <thead>
                            <tr>
                                <th style="width: 20%;">Date</th>
                                <th style="width: 50%;">Détails</th>
                                <th style="width: 30%;">Enseignant(s)</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                data.attendance.forEach(dayEntry => {
                    // Construire les détails des périodes pour ce jour
                    let periodsHTML = `
                        <div class="absences-summary">
                            ${dayEntry.periods_details.map(period => `
                                <span class="absence-badge ${period.status} ${period.is_own ? 'own' : ''}">
                                    ${period.period_range} - ${period.status_text}
                                </span>
                            `).join('')}
                        </div>
                    `;
                    
                    // Construire la liste des enseignants impliqués
                    let teachersHTML = `
                        <div class="teachers-summary">
                            ${dayEntry.periods_details.map(period => `
                                <div class="teacher-name ${period.is_own ? 'own' : 'other'}">
                                    <i class="fas fa-user"></i> ${period.teacher_name}
                                    ${period.is_own ? ' <small>(vous)</small>' : ''}
                                    <small>(${period.period_range})</small>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    
                    attendanceTableHTML += `
                        <tr>
                            <td>
                                <strong>${dayEntry.date}</strong>
                                <br><small class="text-muted">${dayEntry.total_absences} période(s)</small>
                            </td>
                            <td>${periodsHTML}</td>
                            <td>${teachersHTML}</td>
                        </tr>
                    `;
                });
                
                attendanceTableHTML += `
                        </tbody>
                    </table>
                `;
                
                attendanceContainer.innerHTML = attendanceTableHTML;
            }
        })
        .catch(error => {
            console.error('Erreur lors du chargement du résumé comportement:', error);
            const sanctionsContainer = document.getElementById('report-sanctions-summary');
            const attendanceContainer = document.getElementById('report-attendance-summary');
            sanctionsContainer.innerHTML = '<div class="behavior-empty">Erreur lors du chargement des sanctions</div>';
            attendanceContainer.innerHTML = '<div class="behavior-empty">Erreur lors du chargement des absences</div>';
        });
}

// Charger les informations supplémentaires de l'élève
function loadStudentAdditionalInfo(studentId) {
    // Charger les informations supplémentaires existantes pour l'élève
    fetch(`/planning/student/${studentId}/additional-info`)
        .then(response => response.json())
        .then(data => {
            const textarea = document.getElementById('student-additional-info');
            if (data.success && data.additional_info) {
                textarea.value = data.additional_info;
            } else {
                textarea.value = '';
            }
        })
        .catch(error => {
            console.error('Erreur lors du chargement des informations supplémentaires:', error);
            document.getElementById('student-additional-info').value = '';
        });
}

// Charger l'historique des informations de l'élève
function loadStudentInfoHistory(studentId) {
    fetch(`/planning/student/${studentId}/info-history`)
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('student-info-history');
            
            if (data.history.length === 0) {
                container.innerHTML = '<p class="text-muted">Aucune information enregistrée</p>';
                return;
            }
            
            container.innerHTML = data.history.map(info => `
                <div class="info-history-item ${info.is_own ? 'own-info' : 'other-info'}">
                    <div class="info-header">
                        <div class="info-date">
                            <i class="fas fa-calendar"></i> ${info.created_at}
                        </div>
                        ${info.teacher_name ? `<div class="info-teacher">
                            <i class="fas fa-user"></i> ${info.teacher_name}
                        </div>` : ''}
                    </div>
                    <div class="info-content">${info.content}</div>
                </div>
            `).join('');
        })
        .catch(error => {
            console.error('Erreur lors du chargement de l\'historique:', error);
        });
}

// Sauvegarder les informations supplémentaires
function saveAdditionalInfo() {
    if (!currentSelectedStudentId) return;
    
    const additionalInfo = document.getElementById('student-additional-info').value.trim();
    
    if (!additionalInfo) {
        alert('Veuillez saisir des informations avant d\'enregistrer');
        return;
    }
    
    fetch(`/planning/student/${currentSelectedStudentId}/additional-info`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            additional_info: additionalInfo
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('success', 'Informations sauvegardées');
            // Vider le textarea et recharger l'historique
            document.getElementById('student-additional-info').value = '';
            loadStudentInfoHistory(currentSelectedStudentId);
        } else {
            alert('Erreur: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        alert('Erreur lors de la sauvegarde');
    });
}

// Charger les fichiers de l'élève
function loadStudentFiles(studentId) {
    fetch(`/planning/student/${studentId}/files`)
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('student-files-list');
            
            if (data.files.length === 0) {
                container.innerHTML = '<p class="text-muted">Aucun fichier associé</p>';
                return;
            }
            
            container.innerHTML = data.files.map(file => `
                <div class="file-item">
                    <div class="file-info">
                        <i class="fas fa-file"></i>
                        <div>
                            <span>${file.original_name}</span>
                            <br><small class="text-muted">
                                <i class="fas fa-calendar"></i> Ajouté le ${file.upload_date}
                            </small>
                        </div>
                    </div>
                    <div class="file-actions">
                        <button class="btn btn-sm btn-primary" onclick="downloadStudentFile('${file.id}')">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteStudentFile('${file.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        })
        .catch(error => {
            console.error('Erreur lors du chargement des fichiers:', error);
        });
}

// Upload de fichier pour l'élève
function uploadStudentFile() {
    if (!currentSelectedStudentId) return;
    
    const fileInput = document.getElementById('student-file-input');
    const files = fileInput.files;
    
    if (files.length === 0) {
        alert('Veuillez sélectionner au moins un fichier');
        return;
    }
    
    const formData = new FormData();
    for (let i = 0; i < files.length; i++) {
        formData.append('files', files[i]);
    }
    formData.append('student_id', currentSelectedStudentId);
    
    fetch('/planning/student/upload-file', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('success', 'Fichier(s) uploadé(s) avec succès');
            // Recharger immédiatement la liste des fichiers
            loadStudentFiles(currentSelectedStudentId);
            fileInput.value = '';
        } else {
            alert('Erreur: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        alert('Erreur lors de l\'upload');
    });
}

// Télécharger un fichier d'élève
function downloadStudentFile(fileId) {
    window.open(`/planning/student/file/${fileId}/download`, '_blank');
}

// Supprimer un fichier d'élève
function deleteStudentFile(fileId) {
    if (!confirm('Êtes-vous sûr de vouloir supprimer ce fichier ?')) return;
    
    fetch(`/planning/student/file/${fileId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('success', 'Fichier supprimé');
            loadStudentFiles(currentSelectedStudentId);
        } else {
            alert('Erreur: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        alert('Erreur lors de la suppression');
    });
}

// Activer l'onglet correct au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    // Récupérer l'onglet sélectionné depuis le backend
    const selectedTab = '{{ selected_tab }}';
    
    // Si l'onglet n'est pas le défaut (students), l'activer
    if (selectedTab && selectedTab !== 'students') {
        // Simuler un clic sur le bon bouton d'onglet
        const tabButton = document.querySelector(`[onclick="showTab('${selectedTab}')"]`);
        if (tabButton) {
            // Désactiver tous les onglets
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Activer l'onglet voulu
            tabButton.classList.add('active');
            const tabContent = document.getElementById(selectedTab + '-tab');
            if (tabContent) {
                tabContent.classList.add('active');
                
                // Déclencher les actions spécifiques à l'onglet
                if (selectedTab === 'files') {
                    loadAllClassFiles();
                    // Initialiser le drag & drop pour chaque discipline éditable
                    const classrooms = {{ classrooms_json | tojson }};
                    const editableClassrooms = classrooms.filter(classroom => classroom.is_editable === true);
                    editableClassrooms.forEach(classroom => {
                        initClassDragAndDrop(classroom.id);
                    });
                    initClassDragAndDrop();
                } else if (selectedTab === 'groups') {
                    loadGroups();
                } else if (selectedTab === 'accommodations') {
                    loadAccommodations();
                } else if (selectedTab === 'student-report') {
                    loadStudentsForReport();
                } else if (selectedTab === 'seating') {
                    initializeSeatingPlan();
                }
            }
        }
    }
});

// Fonctions pour gérer les justifications d'absence
function updateJustificationStatus(justificationId, status) {
    fetch('/planning/update-justification-status', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            justification_id: justificationId,
            status: status
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Mettre à jour l'apparence de la card
            const card = document.querySelector(`.justification-teacher-card[data-status]`);
            if (card && card.querySelector(`select[onchange*="${justificationId}"]`)) {
                card.setAttribute('data-status', status);
                
                // Désactiver le select si le statut n'est plus pending
                if (status !== 'pending') {
                    card.querySelector('.status-select').disabled = true;
                }
            }
            
            showNotification('Statut mis à jour avec succès', 'success');
        } else {
            showNotification('Erreur lors de la mise à jour: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        showNotification('Erreur lors de la mise à jour du statut', 'error');
    });
}

function updateTeacherResponse(justificationId, response) {
    fetch('/planning/update-teacher-response', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            justification_id: justificationId,
            teacher_response: response
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Note sauvegardée', 'success');
        } else {
            showNotification('Erreur lors de la sauvegarde: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        showNotification('Erreur lors de la sauvegarde de la note', 'error');
    });
}

function showNotification(message, type) {
    // Créer ou réutiliser un élément de notification
    let notification = document.getElementById('notification');
    if (!notification) {
        notification = document.createElement('div');
        notification.id = 'notification';
        document.body.appendChild(notification);
    }
    
    notification.className = `notification notification-${type}`;
    notification.textContent = message;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 24px;
        border-radius: 6px;
        color: white;
        font-weight: 500;
        z-index: 1000;
        opacity: 0;
        transform: translateX(100%);
        transition: all 0.3s ease;
    `;
    
    if (type === 'success') {
        notification.style.backgroundColor = '#10b981';
    } else if (type === 'error') {
        notification.style.backgroundColor = '#ef4444';
    }
    
    // Animation d'entrée
    setTimeout(() => {
        notification.style.opacity = '1';
        notification.style.transform = 'translateX(0)';
    }, 10);
    
    // Animation de sortie
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
    }, 3000);
}

// Note: La fonction showTab est déjà définie plus haut, on va la modifier directement

// ===== FONCTIONS DE PARTAGE DE FICHIERS =====

// Ouvrir le modal de partage de fichiers
function shareFileWithStudents(fileId, fileName) {
    // Récupérer les données du fichier
    document.getElementById('shareFileId').value = fileId;
    document.getElementById('shareFileName').textContent = fileName;
    
    // Charger la liste des élèves
    loadStudentsForFileSharing();
    
    // Afficher le modal
    document.getElementById('shareFileModal').style.display = 'flex';
}

// Charger les élèves pour le partage de fichiers
async function loadStudentsForFileSharing() {
    const classroomId = "{{ primary_classroom.id }}";
    const studentsGrid = document.getElementById('studentsSelectionGrid');
    
    console.log('Chargement des élèves pour la classe ID:', classroomId);
    
    try {
        const response = await fetch(`/api/class-files/students/list/${classroomId}`);
        console.log('Réponse status:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        console.log('Résultat:', result);
        
        if (result.success) {
            const students = result.students;
            
            if (students.length === 0) {
                studentsGrid.innerHTML = '<p style="text-align: center; color: #718096; grid-column: 1/-1;">Aucun élève dans cette classe</p>';
                return;
            }
            
            // Ajouter le bouton "Sélectionner tout" en haut
            let html = `
                <div style="grid-column: 1/-1; margin-bottom: 1rem; border-bottom: 1px solid #e2e8f0; padding-bottom: 0.75rem;">
                    <label class="student-checkbox-option" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background-color: #f7fafc; border: 2px solid #cbd5e0; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        <input type="checkbox" id="selectAllStudents" onchange="toggleSelectAllStudents()">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 32px; height: 32px; background-color: #4a5568; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-users" style="font-size: 0.875rem;"></i>
                            </div>
                            <div style="color: #2d3748;">Sélectionner tous les élèves</div>
                        </div>
                    </label>
                </div>
            `;
            
            students.forEach(student => {
                html += `
                    <label class="student-checkbox-option" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; border: 1px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                        <input type="checkbox" name="selectedStudents" value="${student.id}" onchange="updateSelectedStudentsCount()">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 32px; height: 32px; background-color: #667eea; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.875rem;">
                                ${student.first_name ? student.first_name.charAt(0).toUpperCase() : ''}${student.last_name ? student.last_name.charAt(0).toUpperCase() : ''}
                            </div>
                            <div>
                                <div style="font-weight: 500; color: #2d3748;">${student.first_name} ${student.last_name}</div>
                                <div style="font-size: 0.75rem; color: #718096;">${student.email || 'Pas d\'email'}</div>
                            </div>
                        </div>
                    </label>
                `;
            });
            
            studentsGrid.innerHTML = html;
            updateSelectedStudentsCount();
            
            // Ajouter les styles CSS pour les checkboxes
            if (!document.getElementById('student-checkbox-styles')) {
                const style = document.createElement('style');
                style.id = 'student-checkbox-styles';
                style.textContent = `
                    .student-checkbox-option:hover {
                        background-color: #f7fafc;
                        border-color: #cbd5e0;
                    }
                    .student-checkbox-option input[type="checkbox"]:checked + div {
                        color: #667eea;
                    }
                    .student-checkbox-option:has(input:checked) {
                        background-color: #eef2ff;
                        border-color: #667eea;
                    }
                `;
                document.head.appendChild(style);
            }
        } else {
            console.error('Erreur API:', result.message);
            studentsGrid.innerHTML = `<p style="text-align: center; color: #ef4444; grid-column: 1/-1;">Erreur: ${result.message || 'Impossible de charger les élèves'}</p>`;
        }
    } catch (error) {
        console.error('Erreur lors du chargement des élèves:', error);
        studentsGrid.innerHTML = `<p style="text-align: center; color: #ef4444; grid-column: 1/-1;">Erreur réseau: ${error.message}</p>`;
    }
}

// Fonction pour sélectionner/désélectionner tous les élèves
function toggleSelectAllStudents() {
    const selectAllCheckbox = document.getElementById('selectAllStudents');
    const studentCheckboxes = document.querySelectorAll('input[name="selectedStudents"]');
    
    studentCheckboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
    });
    
    updateSelectedStudentsCount();
}

// Mettre à jour le compteur d'élèves sélectionnés
function updateSelectedStudentsCount() {
    const checkboxes = document.querySelectorAll('input[name="selectedStudents"]:checked');
    const allCheckboxes = document.querySelectorAll('input[name="selectedStudents"]');
    const count = checkboxes.length;
    
    document.getElementById('selectedStudentsCount').textContent = count;
    
    // Mettre à jour la case "sélectionner tout"
    const selectAllCheckbox = document.getElementById('selectAllStudents');
    if (selectAllCheckbox) {
        if (count === 0) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
        } else if (count === allCheckboxes.length) {
            selectAllCheckbox.checked = true;
            selectAllCheckbox.indeterminate = false;
        } else {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = true;
        }
    }
    
    // Activer/désactiver le bouton de partage
    const submitBtn = document.getElementById('shareFileSubmitBtn');
    if (count > 0) {
        submitBtn.disabled = false;
        submitBtn.style.opacity = '1';
    } else {
        submitBtn.disabled = true;
        submitBtn.style.opacity = '0.6';
    }
}

// Soumettre le partage de fichier
async function submitFileShare() {
    const fileId = document.getElementById('shareFileId').value;
    const message = document.getElementById('shareMessage').value.trim();
    const selectedStudents = Array.from(document.querySelectorAll('input[name="selectedStudents"]:checked')).map(cb => cb.value);
    
    if (selectedStudents.length === 0) {
        showNotification('Veuillez sélectionner au moins un élève', 'error');
        return;
    }
    
    // Désactiver le bouton pendant l'envoi
    const submitBtn = document.getElementById('shareFileSubmitBtn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Partage en cours...';
    
    try {
        const response = await fetch('/api/class-files/share', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                file_id: parseInt(fileId),
                student_ids: selectedStudents.map(id => parseInt(id)),
                message: message || null
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification(`Fichier partagé avec ${selectedStudents.length} élève(s)`, 'success');
            closeShareFileModal();
        } else {
            showNotification(result.message || 'Erreur lors du partage', 'error');
        }
    } catch (error) {
        console.error('Erreur lors du partage:', error);
        showNotification('Erreur lors du partage du fichier', 'error');
    } finally {
        // Réactiver le bouton
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-share"></i> Partager le fichier';
    }
}

// Fermer le modal de partage de fichiers
function closeShareFileModal() {
    document.getElementById('shareFileModal').style.display = 'none';
    
    // Réinitialiser le formulaire
    document.getElementById('shareFileId').value = '';
    document.getElementById('shareFileName').textContent = '';
    document.getElementById('shareMessage').value = '';
    
    // Décocher tous les élèves
    document.querySelectorAll('input[name="selectedStudents"]').forEach(cb => cb.checked = false);
    updateSelectedStudentsCount();
}

// Gérer l'onglet actif au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    // Si l'URL contient un hash pour l'onglet sanctions, l'activer
    if (window.location.hash === '#sanctions-tab') {
        showTab('sanctions');
    }
});

// ===== FONCTIONS POUR GROUPES MIXTES =====

// Basculer l'affichage du formulaire d'ajout d'élève pour groupes mixtes
function toggleAddMixedGroupStudentForm() {
    const form = document.getElementById('addMixedGroupStudentForm');
    const isVisible = form.style.display === 'block';
    
    if (isVisible) {
        form.style.display = 'none';
    } else {
        form.style.display = 'block';
        loadAvailableMixedGroupStudents();
    }
}

// Charger les élèves disponibles pour le groupe mixte
async function loadAvailableMixedGroupStudents() {
    const container = document.getElementById('availableStudentsContainer');
    const addBtn = document.getElementById('addSelectedBtn');
    
    try {
        // Afficher le loader
        container.innerHTML = '<div class="loading-message"><i class="fas fa-spinner fa-spin"></i> Chargement des élèves disponibles...</div>';
        addBtn.disabled = true;
        
        // Récupérer les élèves disponibles depuis l'API
        const response = await fetch(`/planning/api/mixed-group-available-students?classroom={{ selected_class_group|urlencode }}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (result.success && result.students) {
            displayAvailableStudents(result.students);
        } else {
            container.innerHTML = '<div class="alert alert-info">Aucun élève disponible à ajouter.</div>';
        }
    } catch (error) {
        console.error('Erreur lors du chargement des élèves:', error);
        container.innerHTML = '<div class="alert alert-danger">Erreur lors du chargement des élèves disponibles.</div>';
    }
}

// Afficher la liste des élèves disponibles
function displayAvailableStudents(students) {
    const container = document.getElementById('availableStudentsContainer');
    const addBtn = document.getElementById('addSelectedBtn');
    
    if (students.length === 0) {
        container.innerHTML = '<div class="alert alert-info">Tous les élèves des classes sources sont déjà dans le groupe mixte.</div>';
        return;
    }
    
    let html = '<div class="available-students-list">';
    
    // Regrouper par classe source
    const studentsBySource = {};
    students.forEach(student => {
        const source = student.source_class_name || 'Classe inconnue';
        if (!studentsBySource[source]) {
            studentsBySource[source] = [];
        }
        studentsBySource[source].push(student);
    });
    
    // Afficher par classe source
    Object.keys(studentsBySource).forEach(sourceName => {
        html += `<div class="source-group">`;
        html += `<h4 class="source-title">${sourceName}</h4>`;
        html += `<div class="students-checkboxes">`;
        
        studentsBySource[sourceName].forEach(student => {
            html += `
                <label class="student-checkbox">
                    <input type="checkbox" value="${student.id}" onchange="updateAddSelectedButton()">
                    <span class="checkmark"></span>
                    <span class="student-name">${student.full_name}</span>
                </label>
            `;
        });
        
        html += `</div></div>`;
    });
    
    html += '</div>';
    container.innerHTML = html;
    
    // Activer le bouton d'ajout
    addBtn.disabled = false;
}

// Mettre à jour l'état du bouton d'ajout
function updateAddSelectedButton() {
    const checkboxes = document.querySelectorAll('#availableStudentsContainer input[type="checkbox"]:checked');
    const addBtn = document.getElementById('addSelectedBtn');
    
    if (checkboxes.length > 0) {
        addBtn.disabled = false;
        addBtn.innerHTML = `<i class="fas fa-plus"></i> Ajouter ${checkboxes.length} élève(s) sélectionné(s)`;
    } else {
        addBtn.disabled = true;
        addBtn.innerHTML = '<i class="fas fa-plus"></i> Ajouter les élèves sélectionnés';
    }
}

// Ajouter les élèves sélectionnés au groupe mixte
async function addSelectedMixedGroupStudents() {
    const checkboxes = document.querySelectorAll('#availableStudentsContainer input[type="checkbox"]:checked');
    const studentIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
    
    if (studentIds.length === 0) {
        showAlert('warning', 'Veuillez sélectionner au moins un élève.');
        return;
    }
    
    const addBtn = document.getElementById('addSelectedBtn');
    const originalText = addBtn.innerHTML;
    
    try {
        // Désactiver le bouton et afficher le loader
        addBtn.disabled = true;
        addBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ajout en cours...';
        
        const response = await fetch('/planning/api/add-mixed-group-students', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                classroom: '{{ selected_class_group }}',
                student_ids: studentIds
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification(`${studentIds.length} élève(s) ajouté(s) avec succès!`, 'success');
            toggleAddMixedGroupStudentForm();
            
            // Recharger la page pour voir les nouveaux élèves
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showNotification(result.message || 'Erreur lors de l\'ajout des élèves', 'error');
        }
    } catch (error) {
        console.error('Erreur lors de l\'ajout des élèves:', error);
        showNotification('Erreur lors de l\'ajout des élèves', 'error');
    } finally {
        // Restaurer le bouton
        addBtn.disabled = false;
        addBtn.innerHTML = originalText;
    }
}

// Fonction d'impression du rapport d'élève
function printStudentReport() {
    const studentId = currentSelectedStudentId;
    if (!studentId) {
        alert('Aucun élève sélectionné');
        return;
    }
    
    // Vérifier que le contenu est visible
    const reportContent = document.getElementById('student-report-content');
    if (!reportContent || reportContent.style.display === 'none') {
        alert('Le rapport doit être ouvert avant l\'impression');
        return;
    }
    
    // Récupérer les informations de l'élève pour l'en-tête
    const firstName = document.getElementById('report-first-name').textContent;
    const lastName = document.getElementById('report-last-name').textContent;
    const studentName = `${firstName} ${lastName}`.trim();
    
    if (studentName === '' || studentName === ' ') {
        alert('Informations de l\'élève non chargées. Veuillez attendre le chargement complet.');
        return;
    }
    
    // Debug : vérifier les éléments visibles et les données
    console.log('=== DEBUG IMPRESSION ===');
    console.log('Student name:', studentName);
    console.log('Report content visible:', reportContent.style.display);
    console.log('Report sections count:', document.querySelectorAll('.report-section').length);
    
    // Vérifier le contenu des sections de données
    const sanctionsContainer = document.getElementById('report-sanctions-summary');
    const attendanceContainer = document.getElementById('report-attendance-summary');
    const additionalInfo = document.getElementById('student-additional-info');
    
    console.log('Sanctions container exists:', !!sanctionsContainer);
    console.log('Sanctions content:', sanctionsContainer ? sanctionsContainer.innerHTML : 'N/A');
    console.log('Attendance container exists:', !!attendanceContainer);
    console.log('Attendance content:', attendanceContainer ? attendanceContainer.innerHTML : 'N/A');
    console.log('Additional info value:', additionalInfo ? additionalInfo.value : 'N/A');
    console.log('Additional info visible:', additionalInfo ? getComputedStyle(additionalInfo).display !== 'none' : false);
    
    // Vérifier la section des informations supplémentaires
    let additionalInfoSection = null;
    try {
        const additionalInfoContainer = document.querySelector('.additional-info-container');
        additionalInfoSection = additionalInfoContainer ? additionalInfoContainer.closest('.report-section') : null;
        console.log('Additional info section exists:', !!additionalInfoSection);
        console.log('Additional info section visible:', additionalInfoSection ? getComputedStyle(additionalInfoSection).display !== 'none' : false);
    } catch (e) {
        console.log('Error finding additional info section:', e);
    }
    
    // Compter les tableaux et badges
    console.log('Behavior tables count:', document.querySelectorAll('.behavior-table').length);
    console.log('Sanction badges count:', document.querySelectorAll('.sanction-badge').length);
    console.log('Absence badges count:', document.querySelectorAll('.absence-badge').length);
    
    // Marquer le body pour l'impression du rapport (pas du plan de classe)
    document.body.classList.remove('printing-seating-plan');
    document.body.classList.add('printing-mode');
    
    // FORCE: S'assurer que la section informations supplémentaires est visible
    if (additionalInfoSection) {
        additionalInfoSection.style.display = 'block';
        additionalInfoSection.style.visibility = 'visible';
        additionalInfoSection.style.pageBreakInside = 'auto';
        console.log('FORCE: Section informations supplémentaires forcée visible');
    }
    
    // FORCE: S'assurer que le textarea est visible
    if (additionalInfo) {
        additionalInfo.style.display = 'block';
        additionalInfo.style.visibility = 'visible';
        additionalInfo.style.minHeight = '40px';
        console.log('FORCE: Textarea informations supplémentaires forcé visible');
    }
    
    // FORCE: S'assurer que le conteneur est visible
    const additionalContainer = document.querySelector('.additional-info-container');
    if (additionalContainer) {
        additionalContainer.style.display = 'block';
        additionalContainer.style.visibility = 'visible';
        console.log('FORCE: Conteneur informations supplémentaires forcé visible');
    }
    
    // Créer l'en-tête d'impression
    createPrintHeader(studentName);
    
    // Ajouter le pied de page avec la date
    createPrintFooter();
    
    // Debug : vérifier que l'en-tête a été créé
    console.log('Print header created:', !!document.querySelector('.print-header'));
    
    // Attendre un peu pour que les styles s'appliquent puis lancer l'impression
    setTimeout(() => {
        window.print();
        
        // Nettoyer après impression
        setTimeout(() => {
            removePrintElements();
            document.body.classList.remove('printing-mode');
        }, 1000);
    }, 100);
}

// Créer l'en-tête pour l'impression
function createPrintHeader(studentName) {
    // Supprimer l'ancien en-tête s'il existe
    const existingHeader = document.querySelector('.print-header');
    if (existingHeader) {
        existingHeader.remove();
    }
    
    // Créer le nouvel en-tête
    const header = document.createElement('div');
    header.className = 'print-header';
    header.innerHTML = `
        <h1>Rapport d'élève</h1>
        <div class="student-info">
            <strong>Élève :</strong> ${studentName}<br>
            <strong>Date :</strong> ${new Date().toLocaleDateString('fr-FR')}
        </div>
    `;
    
    // Insérer avant le contenu du rapport
    const reportContent = document.getElementById('student-report-content');
    reportContent.insertBefore(header, reportContent.firstChild);
}

// Créer le pied de page pour l'impression
function createPrintFooter() {
    // Supprimer l'ancien pied de page s'il existe
    const existingFooter = document.querySelector('.print-footer');
    if (existingFooter) {
        existingFooter.remove();
    }
    
    // Créer le nouveau pied de page
    const footer = document.createElement('div');
    footer.className = 'print-footer';
    footer.innerHTML = `Imprimé le ${new Date().toLocaleDateString('fr-FR')} à ${new Date().toLocaleTimeString('fr-FR')}`;
    
    // Ajouter au body
    document.body.appendChild(footer);
}

// Nettoyer les éléments d'impression
function removePrintElements() {
    const printHeader = document.querySelector('.print-header');
    const printFooter = document.querySelector('.print-footer');
    
    if (printHeader) {
        printHeader.remove();
    }
    if (printFooter) {
        printFooter.remove();
    }
}


// Fonction de debug pour les informations supplémentaires
function debugAdditionalInfo() {
    console.log('=== DEBUG INFORMATIONS SUPPLÉMENTAIRES ===');
    
    const textarea = document.getElementById('student-additional-info');
    const container = document.querySelector('.additional-info-container');
    const section = container ? container.closest('.report-section') : null;
    
    console.log('Textarea exists:', !!textarea);
    console.log('Textarea value:', textarea ? textarea.value : 'N/A');
    console.log('Container exists:', !!container);
    console.log('Section exists:', !!section);
    
    if (textarea) {
        textarea.value = 'TEST DEBUG: Informations supplémentaires visibles!';
        textarea.style.border = '3px solid red';
        textarea.style.background = 'yellow';
        textarea.style.minHeight = '50px';
        console.log('Textarea modifié pour test');
    }
    
    if (container) {
        container.style.border = '3px solid blue';
        container.style.background = 'lightblue';
        console.log('Container modifié pour test');
    }
    
    if (section) {
        section.style.border = '3px solid green';
        section.style.background = 'lightgreen';
        console.log('Section modifiée pour test');
    }
    
    alert('Debug appliqué! Testez maintenant l\'impression.');
}

// Test rapide - à exécuter dans la console
// debugAdditionalInfo(); printStudentReport();

</script>
{% endblock %}
