{% extends "base.html" %}

{% block title %}Tableau de bord - ProfCalendar{% endblock %}

{% block extra_css %}
<style>
.dashboard-container {
    max-width: 1200px;
    margin: 0 auto;
}

.welcome-section {
    background: linear-gradient(135deg, var(--primary-color) 0%, #6366F1 100%);
    color: white;
    padding: 3rem;
    border-radius: 1rem;
    margin-bottom: 2rem;
    box-shadow: var(--shadow-lg);
}

.welcome-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.welcome-text h1 {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
}

.welcome-text p {
    font-size: 1.25rem;
    opacity: 0.9;
}

.today-date {
    text-align: right;
}

.today-date .date {
    font-size: 2rem;
    font-weight: 700;
}

.today-date .day {
    font-size: 1.125rem;
    opacity: 0.9;
}


.quick-actions {
    background-color: var(--white);
    padding: 2rem;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-sm);
    margin-bottom: 2rem;
}

.quick-actions h2 {
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.action-buttons-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.action-button {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    padding: 1.5rem;
    border: 2px solid var(--light-gray);
    border-radius: var(--border-radius);
    text-decoration: none;
    color: var(--dark-color);
    transition: all 0.3s ease;
    text-align: center;
}

.action-button:hover {
    border-color: var(--primary-color);
    transform: translateY(-2px);
    box-shadow: var(--shadow-sm);
}

.action-button i {
    font-size: 2rem;
    color: var(--primary-color);
}

.action-button span {
    font-weight: 500;
}

.action-button.current-lesson {
    background-color: #FEF3C7;
    border-color: var(--warning-color);
}

.action-button.current-lesson i {
    color: var(--warning-color);
}

.recent-activity {
    background-color: var(--white);
    padding: 2rem;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-sm);
}

.recent-activity h2 {
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.activity-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.activity-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background-color: var(--light-gray);
    border-radius: var(--border-radius);
}

.activity-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.125rem;
}

.activity-icon.planning {
    background-color: #E0E7FF;
    color: var(--primary-color);
}

.activity-details {
    flex: 1;
}

.activity-title {
    font-weight: 500;
    margin-bottom: 0.25rem;
}

.activity-time {
    font-size: 0.875rem;
    color: var(--gray-color);
}

.empty-state {
    text-align: center;
    padding: 3rem;
    color: var(--gray-color);
}

.empty-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

@media (max-width: 768px) {
    .welcome-content {
        flex-direction: column;
        text-align: center;
        gap: 2rem;
    }

    .today-date {
        text-align: center;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Section de bienvenue -->
    <div class="welcome-section">
        <div class="welcome-content">
            <div class="welcome-text">
                <h1>Bonjour, {{ current_user.username }} !</h1>
                <p>Bienvenue dans votre espace de planification</p>
            </div>
            <div class="today-date">
                <div class="date">{{ today.day }}</div>
                <div class="day">
                    {% if today %}
                        {% set months = {
                            1: 'Janvier', 2: 'Février', 3: 'Mars', 4: 'Avril',
                            5: 'Mai', 6: 'Juin', 7: 'Juillet', 8: 'Août',
                            9: 'Septembre', 10: 'Octobre', 11: 'Novembre', 12: 'Décembre'
                        } %}
                        {{ months[today.month] }} {{ today.year }}
                    {% else %}
                        Date non disponible
                    {% endif %}
                </div>
            </div>
        </div>
    </div>


    <!-- Actions rapides -->
   <!-- Remplacez la section "Actions rapides" dans templates/planning/dashboard.html par cette version mise à jour -->

<!-- Actions rapides -->
<div class="quick-actions">
    <h2><i class="fas fa-bolt"></i> Actions rapides</h2>
    <div class="action-buttons-grid">
        {% if current_lesson %}
        <a href="{{ url_for('planning.lesson_view') }}" class="action-button" style="background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%); border-color: var(--warning-color);">
            <i class="fas fa-graduation-cap" style="color: var(--warning-color);"></i>
            <span>Cours actuel</span>
            <small style="font-size: 0.75rem; color: var(--gray-color); margin-top: 0.25rem;">
                {{ current_lesson.classroom.name }} - P{{ current_lesson.period_number }}
            </small>
        </a>
        {% elif next_lesson %}
        <a href="{{ url_for('planning.lesson_view') }}" class="action-button" style="background: linear-gradient(135deg, #EEF2FF 0%, #E0E7FF 100%); border-color: var(--primary-color);">
            <i class="fas fa-clock" style="color: var(--primary-color);"></i>
            <span>Prochain cours</span>
            <small style="font-size: 0.75rem; color: var(--gray-color); margin-top: 0.25rem;">
                {{ next_lesson.classroom.name }} - {{ next_lesson.start_time.strftime('%H:%M') }}
            </small>
        </a>
        {% else %}
        <a href="{{ url_for('planning.lesson_view') }}" class="action-button" style="background: linear-gradient(135deg, #EEF2FF 0%, #E0E7FF 100%); border-color: var(--primary-color);">
            <i class="fas fa-calendar-alt" style="color: var(--primary-color);"></i>
            <span>Prochain cours</span>
        </a>
        {% endif %}

        <a href="{{ url_for('planning.calendar_view') }}" class="action-button" style="background: linear-gradient(135deg, #ECFDF5 0%, #D1FAE5 100%); border-color: var(--success-color);">
            <i class="fas fa-calendar" style="color: var(--success-color);"></i>
            <span>Voir le calendrier</span>
        </a>

        <a href="{{ url_for('schedule.view_schedule') }}" class="action-button" style="background: linear-gradient(135deg, #F0F9FF 0%, #DBEAFE 100%); border-color: var(--secondary-color);">
            <i class="fas fa-edit" style="color: var(--secondary-color);"></i>
            <span>Modifier l'horaire type</span>
        </a>

        {% set is_premium = current_user.has_premium_access() if current_user.has_premium_access is defined else false %}

        {% if is_premium %}
        <a href="{{ url_for('file_manager.index') }}" class="action-button" style="background: linear-gradient(135deg, #EEF2FF 0%, #E0E7FF 100%); border-color: var(--primary-color);">
            <i class="fas fa-folder-open" style="color: var(--primary-color);"></i>
            <span>Gestionnaire de fichiers</span>
        </a>
        {% else %}
        <a href="{{ url_for('subscription.pricing') }}" class="action-button" style="background: linear-gradient(135deg, #F3F4F6 0%, #E5E7EB 100%); border-color: #D1D5DB; opacity: 0.75;">
            <i class="fas fa-folder-open" style="color: #9CA3AF;"></i>
            <span style="color: #6B7280;">Gestionnaire de fichiers</span>
            <small style="font-size: 0.7rem; color: #F59E0B; font-weight: 600;"><i class="fas fa-lock"></i> Accès premium</small>
        </a>
        {% endif %}

        {% if is_premium %}
        <a href="{{ url_for('sanctions.index') }}" class="action-button" style="background: linear-gradient(135deg, #FEF2F2 0%, #FECACA 100%); border-color: var(--danger-color);">
            <i class="fas fa-exclamation-triangle" style="color: var(--danger-color);"></i>
            <span>Gestion des sanctions</span>
        </a>
        {% else %}
        <a href="{{ url_for('subscription.pricing') }}" class="action-button" style="background: linear-gradient(135deg, #F3F4F6 0%, #E5E7EB 100%); border-color: #D1D5DB; opacity: 0.75;">
            <i class="fas fa-exclamation-triangle" style="color: #9CA3AF;"></i>
            <span style="color: #6B7280;">Gestion des sanctions</span>
            <small style="font-size: 0.7rem; color: #F59E0B; font-weight: 600;"><i class="fas fa-lock"></i> Accès premium</small>
        </a>
        {% endif %}

        {% if is_premium %}
        <a href="{{ url_for('attendance.index') }}" class="action-button" style="background: linear-gradient(135deg, #ECFDF5 0%, #D1FAE5 100%); border-color: var(--success-color);">
            <i class="fas fa-calendar-check" style="color: var(--success-color);"></i>
            <span>Suivi des absences</span>
        </a>
        {% else %}
        <a href="{{ url_for('subscription.pricing') }}" class="action-button" style="background: linear-gradient(135deg, #F3F4F6 0%, #E5E7EB 100%); border-color: #D1D5DB; opacity: 0.75;">
            <i class="fas fa-calendar-check" style="color: #9CA3AF;"></i>
            <span style="color: #6B7280;">Suivi des absences</span>
            <small style="font-size: 0.7rem; color: #F59E0B; font-weight: 600;"><i class="fas fa-lock"></i> Accès premium</small>
        </a>
        {% endif %}

        <a href="{{ url_for('setup.initial_setup') }}" class="action-button" style="background: linear-gradient(135deg, #F8FAFC 0%, #E2E8F0 100%); border-color: var(--gray-color);">
            <i class="fas fa-cog" style="color: var(--gray-color);"></i>
            <span>Paramètres</span>
        </a>

        {% if is_premium %}
        <a href="{{ url_for('planning.manage_classes') }}" class="action-button" style="background: linear-gradient(135deg, #F0F9FF 0%, #DBEAFE 100%); border-color: var(--secondary-color);">
            <i class="fas fa-users" style="color: var(--secondary-color);"></i>
            <span>Gérer les classes</span>
        </a>
        {% else %}
        <a href="{{ url_for('subscription.pricing') }}" class="action-button" style="background: linear-gradient(135deg, #F3F4F6 0%, #E5E7EB 100%); border-color: #D1D5DB; opacity: 0.75;">
            <i class="fas fa-users" style="color: #9CA3AF;"></i>
            <span style="color: #6B7280;">Gérer les classes</span>
            <small style="font-size: 0.7rem; color: #F59E0B; font-weight: 600;"><i class="fas fa-lock"></i> Accès premium</small>
        </a>
        {% endif %}

        <a href="{{ url_for('setup.manage_classrooms') }}?from_dashboard=1" class="action-button" style="background: linear-gradient(135deg, #ECFDF5 0%, #D1FAE5 100%); border-color: var(--success-color);">
            <i class="fas fa-chalkboard-teacher" style="color: var(--success-color);"></i>
            <span>Configuration des classes</span>
        </a>

        {% if is_premium %}
        <a href="{{ url_for('collaboration.index') }}" class="action-button" style="background: linear-gradient(135deg, #EEF2FF 0%, #E0E7FF 100%); border-color: var(--primary-color);">
            <i class="fas fa-handshake" style="color: var(--primary-color);"></i>
            <span>Collaboration</span>
        </a>
        {% else %}
        <a href="{{ url_for('subscription.pricing') }}" class="action-button" style="background: linear-gradient(135deg, #F3F4F6 0%, #E5E7EB 100%); border-color: #D1D5DB; opacity: 0.75;">
            <i class="fas fa-handshake" style="color: #9CA3AF;"></i>
            <span style="color: #6B7280;">Collaboration</span>
            <small style="font-size: 0.7rem; color: #F59E0B; font-weight: 600;"><i class="fas fa-lock"></i> Accès premium</small>
        </a>
        {% endif %}

        {% if is_premium %}
        <a href="{{ url_for('planning.decoupage') }}" class="action-button" style="background: linear-gradient(135deg, #EEF2FF 0%, #E0E7FF 100%); border-color: var(--primary-color);">
            <i class="fas fa-cut" style="color: var(--primary-color);"></i>
            <span>Création de découpage</span>
        </a>
        {% else %}
        <a href="{{ url_for('subscription.pricing') }}" class="action-button" style="background: linear-gradient(135deg, #F3F4F6 0%, #E5E7EB 100%); border-color: #D1D5DB; opacity: 0.75;">
            <i class="fas fa-cut" style="color: #9CA3AF;"></i>
            <span style="color: #6B7280;">Création de découpage</span>
            <small style="font-size: 0.7rem; color: #F59E0B; font-weight: 600;"><i class="fas fa-lock"></i> Accès premium</small>
        </a>
        {% endif %}

        <a href="{{ url_for('year_end.step1') }}" class="action-button" style="background: linear-gradient(135deg, #FDF4FF 0%, #FAE8FF 100%); border-color: #A855F7;">
            <i class="fas fa-graduation-cap" style="color: #A855F7;"></i>
            <span>Nouvelle année</span>
        </a>

    </div>
</div>

    <!-- Section des mémos -->
    <div class="memos-section" style="background-color: var(--white); padding: 2rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); margin-bottom: 2rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2><i class="fas fa-sticky-note" style="color: #F59E0B;"></i> Mes mémos</h2>
            <div style="display: flex; gap: 1rem; align-items: center;">
                <button onclick="openMemoCreationModal()" class="action-button" style="background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%); border: none; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem;">
                    <i class="fas fa-plus"></i>
                    <span>Nouveau mémo</span>
                </button>
                <select id="classFilter" onchange="filterMemos()" style="padding: 0.5rem; border: 1px solid #D1D5DB; border-radius: 0.375rem;">
                    <option value="all">Toutes les classes</option>
                    {% for classroom in user_classrooms %}
                    <option value="classroom-{{ classroom.id }}">{{ classroom.name }}</option>
                    {% endfor %}
                    {% for group in user_mixed_groups %}
                    <option value="mixed-{{ group.id }}">{{ group.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        {% if today_memos or week_memos %}

        <!-- Mémos d'aujourd'hui -->
        {% if today_memos %}
        <div class="memos-today" style="margin-bottom: 2rem;">
            <h3 style="color: #DC2626; margin-bottom: 1rem; font-size: 1.1rem;">
                <i class="fas fa-calendar-day"></i> Aujourd'hui ({{ today_memos|length }})
            </h3>
            <div class="memos-list" style="display: flex; flex-direction: column; gap: 0.75rem;">
                {% for memo in today_memos %}
                <div class="memo-card {{ 'classroom-' + memo.classroom_id|string if memo.classroom_id else 'mixed-' + memo.mixed_group_id|string }}"
                     style="border-left: 4px solid #F59E0B; background-color: #FFFBEB; padding: 1rem; border-radius: 0.375rem;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <span style="background: #F59E0B; color: white; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600;">
                                    {{ memo.get_display_name() }}
                                </span>
                                {% if memo.target_period %}
                                <span style="color: #92400E; font-size: 0.875rem;">Période {{ memo.target_period }}</span>
                                {% endif %}
                            </div>
                            <p style="margin: 0; color: #78350F;">{{ memo.content }}</p>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="editMemo({{ memo.id }}, '{{ memo.content|replace("'", "\\'") }}', {{ memo.classroom_id or 'null' }}, {{ memo.mixed_group_id or 'null' }}, '{{ memo.target_date.strftime('%Y-%m-%d') if memo.target_date else '' }}', {{ memo.target_period or 'null' }})"
                                    style="background: none; border: none; color: #3B82F6; cursor: pointer; padding: 0.25rem 0.5rem;"
                                    title="Modifier">
                                <i class="fas fa-edit" style="font-size: 1.25rem;"></i>
                            </button>
                            <button onclick="completeMemo({{ memo.id }})"
                                    style="background: none; border: none; color: #059669; cursor: pointer; padding: 0.25rem 0.5rem;"
                                    title="Marquer comme fait">
                                <i class="fas fa-check-circle" style="font-size: 1.25rem;"></i>
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Mémos de la semaine -->
        {% if week_memos %}
        <div class="memos-week">
            <h3 style="color: #3B82F6; margin-bottom: 1rem; font-size: 1.1rem;">
                <i class="fas fa-calendar-week"></i> Prochains mémos ({{ week_memos|length }})
            </h3>
            <div class="memos-list" style="display: flex; flex-direction: column; gap: 0.75rem;">
                {% for memo in week_memos %}
                <div class="memo-card {{ 'classroom-' + memo.classroom_id|string if memo.classroom_id else 'mixed-' + memo.mixed_group_id|string }}"
                     style="border-left: 4px solid #3B82F6; background-color: #EFF6FF; padding: 1rem; border-radius: 0.375rem;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <span style="background: #3B82F6; color: white; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600;">
                                    {{ memo.get_display_name() }}
                                </span>
                                <span style="color: #1E40AF; font-size: 0.875rem;">
                                    {% set days = {
                                        0: 'Lundi', 1: 'Mardi', 2: 'Mercredi', 3: 'Jeudi', 4: 'Vendredi'
                                    } %}
                                    {{ days[memo.target_date.weekday()] }} {{ memo.target_date.strftime('%d/%m') }}
                                    {% if memo.target_period %}• P{{ memo.target_period }}{% endif %}
                                </span>
                            </div>
                            <p style="margin: 0; color: #1E3A8A;">{{ memo.content }}</p>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="editMemo({{ memo.id }}, '{{ memo.content|replace("'", "\\'") }}', {{ memo.classroom_id or 'null' }}, {{ memo.mixed_group_id or 'null' }}, '{{ memo.target_date.strftime('%Y-%m-%d') if memo.target_date else '' }}', {{ memo.target_period or 'null' }})"
                                    style="background: none; border: none; color: #3B82F6; cursor: pointer; padding: 0.25rem 0.5rem;"
                                    title="Modifier">
                                <i class="fas fa-edit" style="font-size: 1.25rem;"></i>
                            </button>
                            <button onclick="completeMemo({{ memo.id }})"
                                    style="background: none; border: none; color: #059669; cursor: pointer; padding: 0.25rem 0.5rem;"
                                    title="Marquer comme fait">
                                <i class="fas fa-check-circle" style="font-size: 1.25rem;"></i>
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        {% else %}
        <!-- Message si aucun mémo -->
        <p style="color: #6B7280; text-align: center; padding: 2rem;">
            <i class="fas fa-inbox" style="font-size: 2rem; display: block; margin-bottom: 1rem; opacity: 0.5;"></i>
            Aucun mémo pour le moment. Créez-en un pour ne rien oublier !
        </p>
        {% endif %}
    </div>

    <!-- Modal de création/édition de mémo -->
    <div id="memoModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 2rem; border-radius: 0.5rem; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 id="memoModalTitle" style="margin: 0;">
                    <i class="fas fa-sticky-note" style="color: #F59E0B;"></i> Nouveau mémo
                </h2>
                <button onclick="closeMemoModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6B7280;">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="memoForm" style="display: flex; flex-direction: column; gap: 1rem;">
                <input type="hidden" id="memoId" value="">

                <!-- Sélection de la classe -->
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">
                        Classe / Groupe
                    </label>
                    <select id="memoClassSelect" required style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 0.375rem; font-size: 1rem;">
                        <option value="">-- Sélectionner une classe --</option>
                        {% for classroom in user_classrooms %}
                        <option value="classroom-{{ classroom.id }}">{{ classroom.name }}</option>
                        {% endfor %}
                        {% for group in user_mixed_groups %}
                        <option value="mixed-{{ group.id }}">{{ group.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Type de date -->
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">
                        Rappel pour
                    </label>
                    <select id="memoDateType" onchange="handleMemoDateTypeChange()" required style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 0.375rem; font-size: 1rem;">
                        <option value="">-- Choisir --</option>
                        <option value="next_lesson">Prochain cours</option>
                        <option value="custom">Date personnalisée</option>
                        <option value="no_date">Sans date</option>
                    </select>
                </div>

                <!-- Date personnalisée -->
                <div id="memoCustomDateDiv" style="display: none;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">
                        Date
                    </label>
                    <input type="date" id="memoCustomDate" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 0.375rem; font-size: 1rem;">
                </div>

                <!-- Contenu -->
                <div id="memoContentDiv" style="display: none;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">
                        Contenu du mémo
                    </label>
                    <textarea id="memoContent" required rows="4" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 0.375rem; font-size: 1rem; resize: vertical;" placeholder="Notez votre mémo ici..."></textarea>
                </div>

                <!-- Boutons -->
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1rem;">
                    <button type="button" onclick="closeMemoModal()" style="padding: 0.75rem 1.5rem; border: 1px solid #D1D5DB; border-radius: 0.375rem; background: white; color: #374151; cursor: pointer; font-size: 1rem;">
                        Annuler
                    </button>
                    <button type="submit" style="padding: 0.75rem 1.5rem; border: none; border-radius: 0.375rem; background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%); color: white; cursor: pointer; font-size: 1rem; font-weight: 600;">
                        <i class="fas fa-save"></i> Enregistrer
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
    function filterMemos() {
        const filter = document.getElementById('classFilter').value;
        const memoCards = document.querySelectorAll('.memo-card');

        memoCards.forEach(card => {
            if (filter === 'all') {
                card.style.display = 'flex';
            } else {
                if (card.classList.contains(filter)) {
                    card.style.display = 'flex';
                } else {
                    card.style.display = 'none';
                }
            }
        });
    }

    async function completeMemo(memoId) {
        try {
            const response = await fetch(`/planning/update_lesson_memo/${memoId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ is_completed: true })
            });

            const data = await response.json();
            if (data.success) {
                // Recharger la page pour mettre à jour l'affichage
                location.reload();
            } else {
                alert('Erreur lors de la mise à jour du mémo');
            }
        } catch (error) {
            console.error('Erreur:', error);
            alert('Erreur lors de la communication avec le serveur');
        }
    }

    // Fonctions pour le modal de création/édition
    function openMemoCreationModal() {
        document.getElementById('memoModalTitle').innerHTML = '<i class="fas fa-sticky-note" style="color: #F59E0B;"></i> Nouveau mémo';
        document.getElementById('memoId').value = '';
        document.getElementById('memoForm').reset();
        document.getElementById('memoCustomDateDiv').style.display = 'none';
        document.getElementById('memoContentDiv').style.display = 'none';
        document.getElementById('memoModal').style.display = 'flex';
    }

    function closeMemoModal() {
        document.getElementById('memoModal').style.display = 'none';
        document.getElementById('memoForm').reset();
    }

    function handleMemoDateTypeChange() {
        const dateType = document.getElementById('memoDateType').value;
        const customDateDiv = document.getElementById('memoCustomDateDiv');
        const contentDiv = document.getElementById('memoContentDiv');

        if (!dateType) {
            customDateDiv.style.display = 'none';
            contentDiv.style.display = 'none';
            return;
        }

        // Afficher le champ de date personnalisée si nécessaire
        if (dateType === 'custom') {
            customDateDiv.style.display = 'block';
        } else {
            customDateDiv.style.display = 'none';
        }

        // Toujours afficher le champ de contenu une fois qu'un type de date est sélectionné
        contentDiv.style.display = 'block';
    }

    function editMemo(id, content, classroomId, mixedGroupId, targetDate, targetPeriod) {
        document.getElementById('memoModalTitle').innerHTML = '<i class="fas fa-edit" style="color: #3B82F6;"></i> Modifier le mémo';
        document.getElementById('memoId').value = id;
        document.getElementById('memoContent').value = content;

        // Sélectionner la classe
        const classSelect = document.getElementById('memoClassSelect');
        if (classroomId) {
            classSelect.value = `classroom-${classroomId}`;
        } else if (mixedGroupId) {
            classSelect.value = `mixed-${mixedGroupId}`;
        }

        // Définir le type de date
        if (targetDate) {
            document.getElementById('memoDateType').value = 'custom';
            document.getElementById('memoCustomDate').value = targetDate;
            document.getElementById('memoCustomDateDiv').style.display = 'block';
        } else {
            document.getElementById('memoDateType').value = 'no_date';
        }

        document.getElementById('memoContentDiv').style.display = 'block';
        document.getElementById('memoModal').style.display = 'flex';
    }

    async function deleteMemo(memoId) {
        if (!confirm('Êtes-vous sûr de vouloir supprimer ce mémo ?')) {
            return;
        }

        try {
            const response = await fetch(`/planning/delete_lesson_memo/${memoId}`, {
                method: 'DELETE'
            });

            const data = await response.json();
            if (data.success) {
                location.reload();
            } else {
                alert('Erreur lors de la suppression du mémo');
            }
        } catch (error) {
            console.error('Erreur:', error);
            alert('Erreur lors de la communication avec le serveur');
        }
    }

    // Gestion de la soumission du formulaire
    document.addEventListener('DOMContentLoaded', function() {
        const memoForm = document.getElementById('memoForm');
        if (memoForm) {
            memoForm.addEventListener('submit', async function(e) {
                e.preventDefault();

                const memoId = document.getElementById('memoId').value;
                const classValue = document.getElementById('memoClassSelect').value;
                const dateType = document.getElementById('memoDateType').value;
                const content = document.getElementById('memoContent').value.trim();

                if (!classValue || !dateType || !content) {
                    alert('Veuillez remplir tous les champs obligatoires');
                    return;
                }

                // Parser classroom_id et mixed_group_id
                let classroomId = null;
                let mixedGroupId = null;
                if (classValue.startsWith('classroom-')) {
                    classroomId = parseInt(classValue.replace('classroom-', ''));
                } else if (classValue.startsWith('mixed-')) {
                    mixedGroupId = parseInt(classValue.replace('mixed-', ''));
                }

                let targetDate = null;
                if (dateType === 'custom') {
                    targetDate = document.getElementById('memoCustomDate').value;
                    if (!targetDate) {
                        alert('Veuillez sélectionner une date');
                        return;
                    }
                }

                const payload = {
                    classroom_id: classroomId,
                    mixed_group_id: mixedGroupId,
                    date_type: dateType,
                    target_date: targetDate,
                    content: content
                };

                try {
                    let response;
                    if (memoId) {
                        // Modification
                        response = await fetch(`/planning/update_lesson_memo/${memoId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(payload)
                        });
                    } else {
                        // Création
                        response = await fetch('/planning/create_lesson_memo', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(payload)
                        });
                    }

                    const data = await response.json();
                    if (data.success) {
                        closeMemoModal();
                        location.reload();
                    } else {
                        alert(data.error || 'Erreur lors de l\'enregistrement du mémo');
                    }
                } catch (error) {
                    console.error('Erreur:', error);
                    alert('Erreur lors de la communication avec le serveur');
                }
            });
        }
    });

    async function deleteArchiveReport(fileId, btn) {
        if (!confirm('Supprimer ce rapport archivé ? Cette action est irréversible.')) return;
        try {
            const resp = await fetch(`/file_manager/delete-file/${fileId}`, {
                method: 'DELETE',
                headers: { 'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || '' }
            });
            const data = await resp.json();
            if (data.success) {
                const card = btn.closest('[style*="border: 2px solid #A855F7"]');
                if (card) card.remove();
            } else {
                alert(data.message || 'Erreur lors de la suppression');
            }
        } catch (e) {
            console.error(e);
            alert('Erreur lors de la suppression');
        }
    }
    </script>

    <!-- Section des invitations reçues -->
    {% if received_invitations %}
    <div class="recent-activity" style="margin-bottom: 2rem;">
        <h2><i class="fas fa-envelope-open" style="color: #10B981;"></i> Demandes d'invitation ({{ received_invitations|length }})</h2>
        <p style="color: var(--gray-color); margin-bottom: 1.5rem; font-size: 0.9rem;">
            Des enseignants souhaitent rejoindre vos classes en tant qu'enseignants spécialisés.
        </p>
        
        <div class="invitations-list" style="display: flex; flex-direction: column; gap: 1rem;">
            {% for invitation in received_invitations %}
            <div class="invitation-card" style="border: 2px solid #10B981; border-radius: var(--border-radius); padding: 1.5rem; background-color: #F0FDF4;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div style="flex: 1;">
                        <h3 style="margin: 0 0 0.5rem 0; color: #065F46; font-size: 1.1rem;">
                            <i class="fas fa-user-graduate"></i> {{ invitation.requesting_teacher.username }}
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <strong>Veut rejoindre:</strong> {{ invitation.target_classroom.name if invitation.target_classroom else 'Classe inconnue' }}
                            </div>
                            <div>
                                <strong>Email:</strong> {{ invitation.requesting_teacher.email }}
                            </div>
                            <div>
                                <strong>Reçu le:</strong> {{ invitation.created_at.strftime('%d/%m/%Y à %H:%M') }}
                            </div>
                        </div>
                        
                        <!-- Affichage des disciplines proposées -->
                        <div style="background-color: white; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                            <strong>Disciplines proposées :</strong>
                            {% if invitation.disciplines %}
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 0.75rem; margin-top: 0.5rem;">
                                    {% for discipline in invitation.disciplines %}
                                    <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 0.375rem; background-color: #f9fafb;">
                                        <div style="width: 20px; height: 20px; border-radius: 0.25rem; background-color: {{ discipline.proposed_color }}; border: 1px solid #d1d5db;"></div>
                                        <div>
                                            <div style="font-weight: 600; font-size: 0.9rem;">{{ discipline.proposed_class_name }}</div>
                                            <div style="font-size: 0.8rem; color: #6b7280;">{{ discipline.proposed_subject }}</div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <!-- Rétrocompatibilité pour les anciennes invitations -->
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem;">
                                    <div style="width: 20px; height: 20px; border-radius: 0.25rem; background-color: {{ invitation.proposed_color }}; border: 1px solid #d1d5db;"></div>
                                    <div>
                                        <div style="font-weight: 600;">{{ invitation.proposed_class_name }}</div>
                                        <div style="font-size: 0.875rem; color: #6b7280;">{{ invitation.proposed_subject }}</div>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                        {% if invitation.message %}
                        <div style="background-color: white; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                            <strong>Message:</strong> <em>"{{ invitation.message }}"</em>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <div style="border-top: 1px solid #BBF7D0; margin-top: 1rem; padding-top: 1rem;">
                    <form method="POST" action="{{ url_for('setup.respond_to_invitation', invitation_id=invitation.id) }}" style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                        <textarea name="response_message" placeholder="Message de réponse (optionnel)" 
                                 style="flex: 1; min-width: 200px; padding: 0.5rem; border: 1px solid #BBF7D0; border-radius: 0.375rem; resize: vertical;" 
                                 rows="2"></textarea>
                        <div style="display: flex; gap: 0.5rem;">
                            <button type="submit" name="action" value="accept" 
                                   class="btn btn-success" 
                                   style="background-color: #059669; border-color: #059669; padding: 0.5rem 1rem;">
                                <i class="fas fa-check"></i> Accepter
                            </button>
                            <button type="submit" name="action" value="reject" 
                                   class="btn btn-danger" 
                                   style="background-color: #DC2626; border-color: #DC2626; padding: 0.5rem 1rem;"
                                   onclick="return confirm('Êtes-vous sûr de vouloir rejeter cette demande ?');">
                                <i class="fas fa-times"></i> Rejeter
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Rapports de fin d'année archivés -->
    {% if backup_reports %}
    <div class="recent-activity" style="margin-bottom: 2rem;">
        <h2><i class="fas fa-archive" style="color: #A855F7;"></i> Rapports archivés ({{ backup_reports|length }})</h2>
        <p style="color: var(--gray-color); margin-bottom: 1rem; font-size: 0.9rem;">
            Des classes partagées ont été supprimées — vos rapports sont disponibles ici.
        </p>
        <div style="display: flex; flex-direction: column; gap: 1rem;">
            {% for report in backup_reports %}
            <div style="border: 2px solid #A855F7; border-radius: var(--border-radius); padding: 1.25rem; background-color: #FDF4FF;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.75rem;">
                    <div style="flex: 1; min-width: 200px;">
                        <div style="font-weight: 600; color: #6B21A8; margin-bottom: 0.25rem;">
                            <i class="fas fa-file-pdf" style="color: #A855F7;"></i>
                            {{ report.original_filename }}
                        </div>
                        <div style="font-size: 0.85rem; color: #7C3AED;">
                            {{ report.uploaded_at.strftime('%d/%m/%Y à %H:%M') }} · {{ report.format_size() }}
                        </div>
                        {% if report.description %}
                        <div style="font-size: 0.85rem; color: #6B21A8; margin-top: 0.25rem;">
                            {{ report.description }}
                        </div>
                        {% endif %}
                    </div>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <a href="{{ url_for('file_manager.download_file', file_id=report.id) }}"
                           style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem;
                                  background: #A855F7; color: white; border-radius: 8px; text-decoration: none;
                                  font-size: 0.9rem; font-weight: 500; white-space: nowrap;">
                            <i class="fas fa-download"></i> Télécharger
                        </a>
                        <button onclick="deleteArchiveReport({{ report.id }}, this)"
                                style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem;
                                       background: #EF4444; color: white; border-radius: 8px; border: none; cursor: pointer;
                                       font-size: 0.9rem; font-weight: 500; white-space: nowrap;">
                            <i class="fas fa-trash"></i> Supprimer
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        <div style="margin-top: 1rem; text-align: center;">
            <a href="{{ url_for('file_manager.index') }}" style="color: #A855F7; text-decoration: none; font-weight: 500;">
                Voir dans le gestionnaire de fichiers →
            </a>
        </div>
    </div>
    {% endif %}

    <!-- Activité récente -->
    <div class="recent-activity">
        <h2><i class="fas fa-history"></i> Activité récente</h2>

        {% if week_plannings_count > 0 %}
        <div class="activity-list">
            <div class="activity-item">
                <div class="activity-icon planning">
                    <i class="fas fa-calendar-plus"></i>
                </div>
                <div class="activity-details">
                    <div class="activity-title">{{ week_plannings_count }} planifications cette semaine</div>
                    <div class="activity-time">Continuez votre excellent travail de planification !</div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="empty-state">
            <i class="fas fa-calendar-times"></i>
            <p>Aucune planification cette semaine</p>
            <p>Commencez à planifier vos cours dès maintenant !</p>
            <a href="{{ url_for('planning.calendar_view') }}" class="btn btn-primary" style="margin-top: 1rem;">
                <i class="fas fa-calendar-plus"></i> Planifier mes cours
            </a>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
