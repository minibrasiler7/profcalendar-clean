{% extends "base.html" %}

{% block title %}Horaire type - TeacherPlanner{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/calendar.css') }}">
<style>
.schedule-container {
    max-width: 1200px;
    margin: 0 auto;
}

.schedule-header {
    background-color: var(--white);
    border-radius: var(--border-radius);
    padding: 2rem;
    box-shadow: var(--shadow-sm);
    margin-bottom: 2rem;
}

.schedule-title {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
}

.schedule-title h1 {
    margin: 0;
}

.schedule-title i {
    font-size: 2rem;
    color: var(--primary-color);
}

.schedule-grid {
    background-color: var(--white);
    border-radius: var(--border-radius);
    padding: 1rem;
    box-shadow: var(--shadow-sm);
    overflow-x: auto;
}

.schedule-table {
    width: 100%;
    border-collapse: collapse;
    min-width: 800px;
}

.schedule-table th,
.schedule-table td {
    padding: 0.75rem;
    text-align: center;
    border: 1px solid var(--light-gray);
}

.schedule-table th {
    background-color: var(--light-gray);
    font-weight: 600;
    color: var(--dark-color);
}

.schedule-table tr:hover td {
    background-color: #F8FAFC;
}

.schedule-slot {
    position: relative;
    min-height: 60px;
    padding: 0.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
    border-radius: 0.25rem;
    margin: 0.25rem;
}

.schedule-slot:hover {
    background-color: var(--light-gray);
    transform: scale(1.02);
}

.schedule-slot.has-class {
    border-radius: 0.5rem;
    color: white;
    font-weight: 500;
    box-shadow: var(--shadow-sm);
}

.schedule-slot.has-class:hover {
    transform: scale(1.05);
    box-shadow: var(--shadow-md);
}

.class-name {
    font-size: 0.875rem;
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.class-subject {
    font-size: 0.75rem;
    opacity: 0.9;
}

.empty-slot {
    color: var(--gray-color);
    font-style: italic;
    font-size: 0.75rem;
}

.period-header {
    writing-mode: vertical-rl;
    text-orientation: mixed;
    background-color: var(--secondary-color);
    color: white;
    font-weight: 600;
    font-size: 0.875rem;
    min-width: 80px;
}

.class-selector {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background-color: var(--white);
    border: 1px solid var(--light-gray);
    border-radius: 0.5rem;
    box-shadow: var(--shadow-lg);
    z-index: 1000;
    max-height: 200px;
    overflow-y: auto;
    display: none;
}

.class-options-container {
    max-height: 150px;
    overflow-y: auto;
}

.class-option {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    border-radius: 0.25rem;
    cursor: pointer;
    transition: background-color 0.2s ease;
    margin-bottom: 0.25rem;
}

.class-option:hover {
    background-color: var(--light-gray);
}

.class-color-dot {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    flex-shrink: 0;
    box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.1);
}

.class-option-info {
    flex: 1;
    min-width: 0;
}

.class-option-name {
    font-weight: 600;
    font-size: 0.875rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.class-option-subject {
    font-size: 0.75rem;
    color: var(--gray-color);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.remove-option {
    padding: 0.75rem;
    border-radius: 0.25rem;
    cursor: pointer;
    transition: background-color 0.2s ease;
    color: var(--danger-color);
    border-top: 1px solid var(--light-gray);
    text-align: center;
    font-size: 0.875rem;
    flex-shrink: 0;
}

.remove-option:hover {
    background-color: #FEF2F2;
}

/* Scrollbar personnalisée pour le sélecteur */
.class-options-container::-webkit-scrollbar {
    width: 8px;
}

.class-options-container::-webkit-scrollbar-track {
    background: var(--light-gray);
    border-radius: 4px;
}

.class-options-container::-webkit-scrollbar-thumb {
    background: #CBD5E1;
    border-radius: 4px;
}

.class-options-container::-webkit-scrollbar-thumb:hover {
    background: #94A3B8;
}

.legend {
    display: flex;
    gap: 2rem;
    margin-top: 1rem;
    flex-wrap: wrap;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
}

.legend-color {
    width: 20px;
    height: 20px;
    border-radius: 0.25rem;
}

.action-buttons {
    margin-top: 2rem;
    display: flex;
    justify-content: center;
    gap: 1rem;
}

.save-status {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 1rem;
    background-color: var(--success-color);
    color: white;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-md);
    z-index: 1000;
    opacity: 0;
    transform: translateX(100%);
    transition: all 0.3s ease;
}

.save-status.show {
    opacity: 1;
    transform: translateX(0);
}

/* Styles pour la fusion des périodes */
.connection-row {
    height: 20px;
}

.connection-spacer {
    background-color: var(--light-gray);
    border: none;
}

.connection-cell {
    text-align: center;
    vertical-align: middle;
    padding: 0;
    border-left: 1px solid #ddd;
    position: relative;
}

.period-connector {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 30px;
    height: 20px;
    background-color: var(--primary-color);
    color: white;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.8rem;
}

.period-connector:hover {
    background-color: var(--primary-dark);
    transform: scale(1.1);
}

.period-connector.break-mode {
    background-color: #dc3545;
}

.period-connector.break-mode i:before {
    content: "\f127"; /* fa-unlink */
}

/* Styles pour les périodes fusionnées */
.schedule-slot.merged-start {
    border-bottom: 2px dashed rgba(255, 255, 255, 0.5);
}

.schedule-slot.merged-middle {
    border-top: none;
    border-bottom: 2px dashed rgba(255, 255, 255, 0.5);
    opacity: 0.8;
}

.schedule-slot.merged-end {
    border-top: none;
}

.schedule-slot.merged-middle .class-name,
.schedule-slot.merged-middle .class-subject,
.schedule-slot.merged-middle .empty-slot {
    display: none;
}

.schedule-slot.merged-start .merged-duration {
    position: absolute;
    top: 2px;
    right: 4px;
    background: rgba(0, 0, 0, 0.2);
    color: white;
    font-size: 0.7rem;
    padding: 1px 4px;
    border-radius: 3px;
}
</style>
{% endblock %}

{% block content %}
<div class="schedule-container">
    <div class="schedule-header">
        <div class="schedule-title">
            <i class="fas fa-calendar-week"></i>
            <div>
                <h1>Horaire type</h1>
                <p>Consultez et modifiez votre emploi du temps hebdomadaire</p>
            </div>
        </div>
    </div>

    <div class="schedule-grid">
        <table class="schedule-table">
            <thead>
                <tr>
                    <th style="width: 80px;">Période</th>
                    {% for day in days %}
                    <th>{{ day }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for period in periods %}
                <tr>
                    <td class="period-header">
                        <div>P{{ period.number }}</div>
                        <div style="font-size: 0.7rem; margin-top: 0.25rem;">
                            {{ period.start.strftime('%H:%M') }}<br>
                            {{ period.end.strftime('%H:%M') }}
                        </div>
                    </td>
                    {% for day_index in range(5) %}
                    {% set slot_key = day_index ~ '_' ~ period.number %}
                    {% set schedule = schedule_grid.get(slot_key) %}
                    <td>
                        {% set merged_class = "" %}
                        {% if schedule %}
                            {% if schedule.has_merged_next %}
                                {% set merged_class = "merged-start" %}
                            {% elif schedule.merged_with_previous %}
                                {% set merged_class = "merged-end" %}
                                {% set prev_slot_key = day_index ~ '_' ~ (period.number - 1) %}
                                {% set prev_schedule = schedule_grid.get(prev_slot_key) %}
                                {% if prev_schedule and prev_schedule.has_merged_next %}
                                    {% set merged_class = "merged-middle" %}
                                {% endif %}
                            {% endif %}
                        {% endif %}
                        
                        <div class="schedule-slot {% if schedule %}has-class{% endif %} {{ merged_class }}" 
                             data-weekday="{{ day_index }}" 
                             data-period="{{ period.number }}"
                             {% if schedule %}
                                 {% if schedule.classroom_id %}
                                     style="background-color: {{ schedule.classroom.color }};"
                                     data-classroom-id="{{ schedule.classroom_id }}"
                                     data-type="classroom"
                                 {% elif schedule.mixed_group_id %}
                                     style="background-color: {{ schedule.mixed_group.color }};"
                                     data-mixed-group-id="{{ schedule.mixed_group_id }}"
                                     data-type="mixed_group"
                                 {% elif schedule.custom_task_title %}
                                     style="background-color: #6B7280;"
                                     data-custom-task="true"
                                     data-type="custom"
                                 {% endif %}
                             {% endif %}>
                            {% if schedule %}
                                {% if schedule.classroom_id %}
                                    <div class="class-name">{{ schedule.classroom.name }}</div>
                                    <div class="class-subject">{{ schedule.classroom.subject }}</div>
                                {% elif schedule.mixed_group_id %}
                                    <div class="class-name"><i class="fas fa-users"></i> {{ schedule.mixed_group.name }}</div>
                                    <div class="class-subject">{{ schedule.mixed_group.subject }}</div>
                                {% elif schedule.custom_task_title %}
                                    <div class="class-name"><i class="fas fa-tasks"></i> {{ schedule.custom_task_title }}</div>
                                    <div class="class-subject">Autre</div>
                                {% endif %}
                                
                                <!-- Indicateur de durée pour les périodes fusionnées -->
                                {% if schedule.has_merged_next %}
                                    {% set next_periods_count = 1 %}
                                    {% set found_end = false %}
                                    {% for p in periods if not found_end %}
                                        {% if p.number > period.number %}
                                            {% set next_slot_key = day_index ~ '_' ~ p.number %}
                                            {% set next_schedule = schedule_grid.get(next_slot_key) %}
                                            {% if next_schedule and next_schedule.merged_with_previous %}
                                                {% set next_periods_count = next_periods_count + 1 %}
                                            {% else %}
                                                {% set found_end = true %}
                                            {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                    {% set total_duration = next_periods_count * (current_user.period_duration or 45) %}
                                    <div class="merged-duration">{{ total_duration }}min</div>
                                {% endif %}
                            {% else %}
                                <div class="empty-slot">Cliquez pour ajouter</div>
                            {% endif %}
                        </div>
                        
                        <!-- Sélecteur de classe -->
                        <div class="class-selector" data-weekday="{{ day_index }}" data-period="{{ period.number }}">
                            <div class="class-options-container">
                                {% for item in classrooms_json %}
                                <div class="class-option" 
                                     {% if item.type == 'classroom' %}
                                         data-classroom-id="{{ item.id }}" data-type="classroom"
                                     {% else %}
                                         data-mixed-group-id="{{ item.id }}" data-type="mixed_group"
                                     {% endif %}>
                                    <div class="class-color-dot" style="background-color: {{ item.color }};"></div>
                                    <div class="class-option-info">
                                        <div class="class-option-name">
                                            {% if item.type == 'mixed_group' %}
                                                <i class="fas fa-users" style="margin-right: 0.25rem;"></i>
                                            {% endif %}
                                            {{ item.name }}
                                        </div>
                                        <div class="class-option-subject">{{ item.subject }}</div>
                                    </div>
                                </div>
                                {% endfor %}
                                
                                <!-- Option pour ajouter une tâche personnalisée -->
                                <div class="class-option" data-type="custom" onclick="showCustomTaskModal(this)">
                                    <div class="class-color-dot" style="background-color: #6B7280;"></div>
                                    <div class="class-option-info">
                                        <div class="class-option-name">
                                            <i class="fas fa-tasks" style="margin-right: 0.25rem;"></i>
                                            Autre tâche
                                        </div>
                                        <div class="class-option-subject">Tâche personnalisée</div>
                                    </div>
                                </div>
                            </div>
                            <div class="remove-option">
                                <i class="fas fa-times"></i> Retirer
                            </div>
                        </div>
                    </td>
                    {% endfor %}
                </tr>
                
                <!-- Ligne de connexion pour fusionner les périodes consécutives -->
                {% if not loop.last %}
                {% set next_period = periods[loop.index0 + 1] %}
                <tr class="connection-row">
                    <td class="connection-spacer"></td>
                    {% for day_index in range(5) %}
                    {% set current_slot_key = day_index ~ '_' ~ period.number %}
                    {% set next_slot_key = day_index ~ '_' ~ next_period.number %}
                    {% set current_schedule = schedule_grid.get(current_slot_key) %}
                    {% set next_schedule = schedule_grid.get(next_slot_key) %}
                    <td class="connection-cell">
                        {% if current_schedule and next_schedule %}
                            {% set can_merge = false %}
                            {% if current_schedule.classroom_id and next_schedule.classroom_id and current_schedule.classroom_id == next_schedule.classroom_id %}
                                {% set can_merge = true %}
                            {% elif current_schedule.mixed_group_id and next_schedule.mixed_group_id and current_schedule.mixed_group_id == next_schedule.mixed_group_id %}
                                {% set can_merge = true %}
                            {% elif current_schedule.custom_task_title and next_schedule.custom_task_title and current_schedule.custom_task_title == next_schedule.custom_task_title %}
                                {% set can_merge = true %}
                            {% endif %}
                            
                            {% if can_merge %}
                            {% set is_merged = current_schedule.has_merged_next or false %}
                            <div class="period-connector {% if is_merged %}break-mode{% endif %}" 
                                 data-weekday="{{ day_index }}" 
                                 data-period-start="{{ period.number }}" 
                                 data-period-end="{{ next_period.number }}"
                                 title="{% if is_merged %}Cliquez pour séparer ces périodes{% else %}Cliquez pour fusionner ces périodes{% endif %}">
                                <i class="fas {% if is_merged %}fa-unlink{% else %}fa-link{% endif %}"></i>
                            </div>
                            {% endif %}
                        {% endif %}
                    </td>
                    {% endfor %}
                </tr>
                {% endif %}
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="legend">
        {% for item in classrooms_json %}
        <div class="legend-item">
            <div class="legend-color" style="background-color: {{ item.color }};"></div>
            <span>
                {% if item.type == 'mixed_group' %}
                    <i class="fas fa-users" style="margin-right: 0.25rem;"></i>
                {% endif %}
                {{ item.name }} - {{ item.subject }}
            </span>
        </div>
        {% endfor %}
    </div>

    <div class="action-buttons">
        <a href="{{ url_for('planning.dashboard') }}" class="btn btn-outline">
            <i class="fas fa-arrow-left"></i> Retour au tableau de bord
        </a>
        <button type="button" class="btn btn-primary" onclick="saveAllChanges()">
            <i class="fas fa-save"></i> Enregistrer les modifications
        </button>
    </div>
</div>

<!-- Modal pour tâche personnalisée -->
<div id="customTaskModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 2000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 0.5rem; min-width: 400px;">
        <h3 style="margin-bottom: 1rem;">Ajouter une tâche personnalisée</h3>
        <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Titre de la tâche :</label>
            <input type="text" id="customTaskTitle" placeholder="Ex: Surveillance, Réunion, etc." style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 0.25rem;">
        </div>
        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
            <button onclick="closeCustomTaskModal()" style="padding: 0.75rem 1.5rem; border: 1px solid #D1D5DB; background: white; border-radius: 0.25rem; cursor: pointer;">Annuler</button>
            <button onclick="saveCustomTask()" style="padding: 0.75rem 1.5rem; background: #3B82F6; color: white; border: none; border-radius: 0.25rem; cursor: pointer;">Ajouter</button>
        </div>
    </div>
</div>

<div class="save-status" id="saveStatus">
    <i class="fas fa-check"></i> Modifications enregistrées !
</div>
{% endblock %}

{% block extra_js %}
<script>
// Variables globales
const classrooms = {{ classrooms_json | tojson }};
const periods = {{ periods_json | tojson }};
let currentSchedule = {{ schedule_grid_json | tojson }};
const currentUser = {{ current_user_json | tojson }};
let pendingChanges = new Set();
let currentSlotForCustomTask = null;

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
    initializeScheduleSlots();
    initializePeriodConnectors();
});

function initializeScheduleSlots() {
    const slots = document.querySelectorAll('.schedule-slot');
    const selectors = document.querySelectorAll('.class-selector');

    slots.forEach(slot => {
        slot.addEventListener('click', function(e) {
            e.stopPropagation();
            hideAllSelectors();
            showClassSelector(this);
        });
    });

    // Cacher les sélecteurs lors d'un clic ailleurs
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.class-selector')) {
            hideAllSelectors();
        }
    });

    // Gérer les options de classe
    selectors.forEach(selector => {
        const options = selector.querySelectorAll('.class-option');
        const removeOption = selector.querySelector('.remove-option');

        options.forEach(option => {
            option.addEventListener('click', function(e) {
                e.stopPropagation();
                const itemType = this.dataset.type;
                
                if (itemType === 'custom') {
                    // Ne pas traiter ici, c'est géré par showCustomTaskModal
                    return;
                }
                
                const itemId = this.dataset.classroomId || this.dataset.mixedGroupId;
                const weekday = selector.dataset.weekday;
                const period = selector.dataset.period;
                
                selectClass(weekday, period, itemId, itemType);
                hideAllSelectors();
            });
        });

        removeOption.addEventListener('click', function(e) {
            e.stopPropagation();
            const weekday = selector.dataset.weekday;
            const period = selector.dataset.period;
            
            removeClass(weekday, period);
            hideAllSelectors();
        });
    });
}

function showClassSelector(slot) {
    const weekday = slot.dataset.weekday;
    const period = slot.dataset.period;
    const selector = document.querySelector(`.class-selector[data-weekday="${weekday}"][data-period="${period}"]`);
    
    if (selector) {
        selector.style.display = 'block';
        
        // Positionner le sélecteur
        const rect = slot.getBoundingClientRect();
        const selectorRect = selector.getBoundingClientRect();
        
        // Ajuster la position si le sélecteur dépasse de l'écran
        if (rect.bottom + selectorRect.height > window.innerHeight) {
            selector.style.top = 'auto';
            selector.style.bottom = '100%';
        } else {
            selector.style.top = '100%';
            selector.style.bottom = 'auto';
        }
    }
}

function hideAllSelectors() {
    const selectors = document.querySelectorAll('.class-selector');
    selectors.forEach(selector => {
        selector.style.display = 'none';
    });
}

function selectClass(weekday, period, itemId, itemType = 'classroom') {
    let item;
    if (itemType === 'custom') {
        // Pour les tâches personnalisées, itemId est en fait le titre
        item = {
            id: null,
            name: itemId,
            subject: 'Autre',
            color: '#6B7280',
            type: 'custom'
        };
    } else {
        item = classrooms.find(c => c.id == itemId && c.type == itemType);
        if (!item) return;
    }

    // Mettre à jour l'interface
    updateSlotUI(weekday, period, item);
    
    // Marquer comme modifié
    pendingChanges.add(`${weekday}_${period}`);
    
    // Sauvegarder automatiquement
    if (itemType === 'custom') {
        saveScheduleSlot(weekday, period, null, itemType, itemId);
    } else {
        saveScheduleSlot(weekday, period, itemId, itemType);
    }
}

function removeClass(weekday, period) {
    // Mettre à jour l'interface
    updateSlotUI(weekday, period, null);
    
    // Marquer comme modifié
    pendingChanges.add(`${weekday}_${period}`);
    
    // Sauvegarder automatiquement
    saveScheduleSlot(weekday, period, null);
}

function updateSlotUI(weekday, period, item) {
    const slot = document.querySelector(`.schedule-slot[data-weekday="${weekday}"][data-period="${period}"]`);
    if (!slot) return;

    if (item) {
        slot.classList.add('has-class');
        slot.style.backgroundColor = item.color;
        
        // Nettoyer les anciens attributs
        slot.removeAttribute('data-classroom-id');
        slot.removeAttribute('data-mixed-group-id');
        slot.removeAttribute('data-custom-task');
        slot.removeAttribute('data-type');
        
        // Ajouter les nouveaux attributs selon le type
        if (item.type === 'mixed_group') {
            slot.dataset.mixedGroupId = item.id;
            slot.dataset.type = 'mixed_group';
            slot.innerHTML = `
                <div class="class-name"><i class="fas fa-users"></i> ${item.name}</div>
                <div class="class-subject">${item.subject}</div>
            `;
        } else if (item.type === 'custom') {
            slot.dataset.customTask = 'true';
            slot.dataset.type = 'custom';
            slot.innerHTML = `
                <div class="class-name"><i class="fas fa-tasks"></i> ${item.name}</div>
                <div class="class-subject">${item.subject}</div>
            `;
        } else {
            slot.dataset.classroomId = item.id;
            slot.dataset.type = 'classroom';
            slot.innerHTML = `
                <div class="class-name">${item.name}</div>
                <div class="class-subject">${item.subject}</div>
            `;
        }
    } else {
        slot.classList.remove('has-class');
        slot.style.backgroundColor = '';
        slot.removeAttribute('data-classroom-id');
        slot.removeAttribute('data-mixed-group-id');
        slot.removeAttribute('data-custom-task');
        slot.removeAttribute('data-type');
        slot.innerHTML = '<div class="empty-slot">Cliquez pour ajouter</div>';
    }
}

async function saveScheduleSlot(weekday, period, itemId, itemType = 'classroom', customTitle = null) {
    try {
        const requestData = {
            weekday: parseInt(weekday),
            period_number: parseInt(period),
            classroom_id: itemId && itemType === 'classroom' ? parseInt(itemId) : null,
            mixed_group_id: itemId && itemType === 'mixed_group' ? parseInt(itemId) : null,
            custom_task_title: itemType === 'custom' ? customTitle : null,
            type: itemType
        };
        
        const response = await fetch('/schedule/save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        });

        const result = await response.json();
        
        if (result.success) {
            pendingChanges.delete(`${weekday}_${period}`);
            showSaveStatus();
        } else {
            console.error('Erreur lors de la sauvegarde:', result.message);
            alert('Erreur lors de la sauvegarde: ' + result.message);
        }
    } catch (error) {
        console.error('Erreur:', error);
        alert('Erreur de connexion lors de la sauvegarde');
    }
}

function saveAllChanges() {
    if (pendingChanges.size === 0) {
        showSaveStatus();
        return;
    }

    // Pour l'instant, toutes les modifications sont déjà sauvegardées automatiquement
    showSaveStatus();
}

function showSaveStatus() {
    const status = document.getElementById('saveStatus');
    status.classList.add('show');
    
    setTimeout(() => {
        status.classList.remove('show');
    }, 3000);
}

// Fonctions pour le modal de tâche personnalisée
function showCustomTaskModal(element) {
    const selector = element.closest('.class-selector');
    currentSlotForCustomTask = {
        weekday: selector.dataset.weekday,
        period: selector.dataset.period
    };
    
    document.getElementById('customTaskModal').style.display = 'block';
    document.getElementById('customTaskTitle').value = '';
    document.getElementById('customTaskTitle').focus();
    
    hideAllSelectors();
}

function closeCustomTaskModal() {
    document.getElementById('customTaskModal').style.display = 'none';
    currentSlotForCustomTask = null;
}

function saveCustomTask() {
    const title = document.getElementById('customTaskTitle').value.trim();
    if (!title) {
        alert('Veuillez saisir un titre pour la tâche');
        return;
    }
    
    if (currentSlotForCustomTask) {
        selectClass(currentSlotForCustomTask.weekday, currentSlotForCustomTask.period, title, 'custom');
        closeCustomTaskModal();
    }
}

// Fermer le modal avec Escape
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeCustomTaskModal();
    }
});

// ========== FONCTIONS DE FUSION DES PÉRIODES ==========

function initializePeriodConnectors() {
    const connectors = document.querySelectorAll('.period-connector');
    console.log('Found', connectors.length, 'period connectors');
    
    connectors.forEach(connector => {
        connector.addEventListener('click', function() {
            const weekday = this.dataset.weekday;
            const periodStart = parseInt(this.dataset.periodStart);
            const periodEnd = parseInt(this.dataset.periodEnd);
            
            console.log('Connector clicked:', weekday, periodStart, periodEnd);
            
            if (this.classList.contains('break-mode')) {
                // Séparer les périodes fusionnées
                separatePeriods(weekday, periodStart, periodEnd);
            } else {
                // Fusionner les périodes
                mergePeriods(weekday, periodStart, periodEnd);
            }
        });
    });
}

async function mergePeriods(weekday, periodStart, periodEnd) {
    try {
        const response = await fetch('/schedule/merge-periods', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                weekday: parseInt(weekday),
                period_start: periodStart,
                period_end: periodEnd
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            console.log('Merge successful, updating UI...');
            // Mettre à jour l'interface
            updateMergedPeriodsUI(weekday, periodStart, periodEnd, true);
            showSaveStatus();
        } else {
            console.error('Erreur lors de la fusion:', result.message);
            alert('Erreur lors de la fusion: ' + result.message);
        }
    } catch (error) {
        console.error('Erreur:', error);
        alert('Erreur de connexion lors de la fusion');
    }
}

async function separatePeriods(weekday, periodStart, periodEnd) {
    try {
        const response = await fetch('/schedule/separate-periods', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                weekday: parseInt(weekday),
                period_start: periodStart,
                period_end: periodEnd
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Mettre à jour l'interface
            updateMergedPeriodsUI(weekday, periodStart, periodEnd, false);
            showSaveStatus();
        } else {
            console.error('Erreur lors de la séparation:', result.message);
            alert('Erreur lors de la séparation: ' + result.message);
        }
    } catch (error) {
        console.error('Erreur:', error);
        alert('Erreur de connexion lors de la séparation');
    }
}

function updateMergedPeriodsUI(weekday, periodStart, periodEnd, isMerged) {
    console.log('Updating UI for:', weekday, periodStart, periodEnd, isMerged);
    
    // Trouver le connecteur
    const connector = document.querySelector(
        `.period-connector[data-weekday="${weekday}"][data-period-start="${periodStart}"][data-period-end="${periodEnd}"]`
    );
    
    console.log('Connector found:', connector);
    
    if (connector) {
        if (isMerged) {
            connector.classList.add('break-mode');
            connector.title = 'Cliquez pour séparer ces périodes';
            connector.querySelector('i').className = 'fas fa-unlink';
        } else {
            connector.classList.remove('break-mode');
            connector.title = 'Cliquez pour fusionner ces périodes';
            connector.querySelector('i').className = 'fas fa-link';
        }
    }
    
    // Mettre à jour l'apparence des slots
    for (let period = periodStart; period <= periodEnd; period++) {
        const slot = document.querySelector(`.schedule-slot[data-weekday="${weekday}"][data-period="${period}"]`);
        console.log('Slot found for period', period, ':', slot);
        if (slot) {
            if (isMerged) {
                if (period === periodStart) {
                    slot.classList.add('merged-start');
                    // Ajouter indicateur de durée
                    const duration = (periodEnd - periodStart + 1) * (currentUser.period_duration || 45);
                    const durationElement = document.createElement('div');
                    durationElement.className = 'merged-duration';
                    durationElement.textContent = `${duration}min`;
                    slot.appendChild(durationElement);
                } else if (period === periodEnd) {
                    slot.classList.add('merged-end');
                } else {
                    slot.classList.add('merged-middle');
                }
            } else {
                slot.classList.remove('merged-start', 'merged-middle', 'merged-end');
                // Supprimer l'indicateur de durée
                const durationElement = slot.querySelector('.merged-duration');
                if (durationElement) {
                    durationElement.remove();
                }
            }
        }
    }
}

// Valider avec Enter dans le champ
document.getElementById('customTaskTitle').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        saveCustomTask();
    }
});
</script>
{% endblock %}